<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神思 - 管理面板</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <!-- ★★★ 新增：ZIP 打包與下載工具 ★★★ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
    /* === 莫蘭迪色系定義 === */
    :root {
        --m-green: #8fa398;   --m-blue: #94a7b5;    --m-purple: #b6a6ca;
        --m-red: #d69a92;     --m-brown: #c7b299;   --bg-color: #fdfcf8;
        --text-main: #5e5e5e; --border-color: #e0ddd7;
        --m-color-1: #8fa398; --m-color-2: #94a7b5; --m-color-3: #b6a6ca; 
        --m-color-4: #d69a92; --m-color-5: #c7b299;
    }

    body {
        font-family: 'Noto Serif TC', 'Songti TC', serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 60px;
        background: url('背景.png') center/cover fixed;
        background-color: #f4f4f4;
        color: var(--text-main);
        overflow-y: scroll;
    }

    /* === 登入遮罩 === */
    #loginOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #fdfcf8; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .login-box {
        background: white; padding: 40px; border-radius: 15px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-color);
        max-width: 400px; width: 90%;
    }
    .login-btn {
        background-color: var(--m-blue); color: white; padding: 12px 30px;
        border: none; border-radius: 50px; font-size: 1.1em; cursor: pointer;
        margin-top: 20px; transition: all 0.3s; width: 100%;
    }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(148, 167, 181, 0.4); }

    #mainApp { display: none; }

    /* === 通用容器 === */
    h1, h2 { text-align: center; color: var(--text-main); margin-bottom: 20px; letter-spacing: 2px; }
    h3 { color: var(--m-blue); border-left: 5px solid var(--m-blue); padding-left: 10px; margin-top: 30px; }
    .box { background: rgba(255, 255, 255, 0.98); border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); padding: 30px; margin-bottom: 25px; border: 1px solid var(--border-color); }
    
    /* === 導航與按鈕 === */
    .nav-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .nav-btn { padding: 12px 30px; border-radius: 50px; border: none; background: #e0e0e0; color: #666; cursor: pointer; font-size: 1.05em; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: bold; }
    .nav-btn.active { background: var(--m-blue); color: white; box-shadow: 0 4px 12px rgba(148, 167, 181, 0.4); transform: translateY(-2px); }
    .nav-btn:hover:not(.active) { background: #dcdcdc; }
    
    .btn-action { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; color: white; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-action:hover { filter: brightness(95%); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-action:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-view { background-color: var(--m-blue); } .btn-delete { background-color: var(--m-red); } .btn-manage { background-color: var(--m-brown); }
    .btn-publish { background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%); font-size: 1.2rem; padding: 15px 40px; width: 100%; justify-content: center; font-weight: bold; letter-spacing: 1px; border-radius: 50px; box-shadow: 0 5px 15px rgba(143, 163, 152, 0.4); }

    .filter-group { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 20px; background: #fcfcfc; border-radius: 12px; flex-wrap: wrap; border: 1px solid var(--border-color); }
    select, input { padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Noto Serif TC', serif; font-size: 1rem; outline: none; background: #fff; color: #555; }
    
    /* === 學生列表 === */
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
    .student-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); border-top: 5px solid var(--m-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s ease; }
    .student-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .student-name { font-size: 1.2em; font-weight: bold; color: #444; margin-bottom: 5px; }
    .last-sync { font-size: 0.85em; color: #999; display: flex; align-items: center; gap: 6px; }

    /* === 歷史檢閱與其他 UI === */
    .category-cards-container { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; padding: 20px; }
    .anime-card { position: relative; width: 140px; height: 200px; border-radius: 15px; background-image: var(--bg-img); background-size: cover; background-position: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); overflow: hidden; filter: grayscale(20%); margin-bottom: 20px; border: 2px solid #fff; }
    .anime-card:hover { transform: translateY(-10px) scale(1.05); filter: grayscale(0%); box-shadow: 0 15px 30px rgba(0,0,0,0.3); z-index: 10; }
    .card-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 60%); }
    .card-content { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; text-align: center; }
    .card-zh { display: block; color: #fff; font-size: 18px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 2px; }
    .card-en { display: block; color: rgba(255,255,255,0.7); font-size: 10px; letter-spacing: 1px; margin-top: 5px; }

    .history-grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 20px 0; }
    .history-folder-btn { background-color: #fff; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px 15px; text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; color: #555; }
    .history-folder-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); background-color: #fff; }
    .history-folder-btn i { font-size: 2em; margin-bottom: 10px; color: #ccc; transition: color 0.3s; }
    .history-theme-1 { border-color: #8fa398; color: #8fa398; } .history-theme-1:hover i { color: #8fa398; }
    .history-theme-2 { border-color: #94a7b5; color: #94a7b5; } .history-theme-2:hover i { color: #94a7b5; }
    .history-theme-3 { border-color: #b6a6ca; color: #b6a6ca; } .history-theme-3:hover i { color: #b6a6ca; }
    .history-theme-4 { border-color: #d69a92; color: #d69a92; } .history-theme-4:hover i { color: #d69a92; }
    .history-theme-5 { border-color: #c7b299; color: #c7b299; } .history-theme-5:hover i { color: #c7b299; }

    .history-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-top: 10px; }
    .history-card { background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 8px; padding: 20px 20px 20px 55px; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s; overflow: hidden; background-image: linear-gradient(to right, transparent 39px, #e0ddd7 40px, transparent 41px), radial-gradient(circle at 20px 50%, #d1cdc5 6px, transparent 7px); background-size: 100% 100%, 100% 35px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 12px; }
    .history-card:hover { transform: translateY(-3px); box-shadow: 6px 6px 0px rgba(0,0,0,0.08); background-color: #fff; }
    .history-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; z-index: 1; }
    .theme-1::before { background: #8fa398; } .theme-2::before { background: #94a7b5; } .theme-3::before { background: #b6a6ca; } .theme-4::before { background: #d69a92; } .theme-5::before { background: #c7b299; }
    .history-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #999; margin-bottom: 10px; border-bottom: 1px dashed #e0ddd7; padding-bottom: 5px; }
    .history-title { margin: 0; font-size: 1.1em; color: #444; font-weight: bold; line-height: 1.4; }
    
    /* 麵包屑 */
    .history-breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #999; margin-bottom: 20px; padding: 10px 5px; border-bottom: 1px dashed #ccc; }
    .breadcrumb-item { cursor: pointer; font-weight: bold; color: var(--m-blue); transition: color 0.2s; }
    .breadcrumb-item:hover { color: #5e5e5e; text-decoration: underline; }
    .breadcrumb-current { color: #5e5e5e; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; font-weight: bold; }

    /* === 內容結構化顯示樣式 (強制靠左) === */
    .history-parsed-container { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e1e4e8; border-left: 5px solid #ccc; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .history-item-block { margin-bottom: 15px; }
    .history-item-label { font-weight: bold; font-size: 1em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .history-item-label::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; opacity: 0.8; }
    .history-item-content { background: #fcfcfc; border: 1px solid #e1e4e8; border-radius: 4px; padding: 12px 16px; color: #444; line-height: 1.8; white-space: pre-wrap; word-break: break-word; text-align: left !important; }
    
    .history-theme-context-1 { border-left-color: var(--m-color-1); } .history-theme-context-1 .history-item-label { color: var(--m-color-1); } .history-theme-context-1 .history-item-label::before { background-color: var(--m-color-1); } .history-theme-context-1 .history-item-content { border-left: 4px solid var(--m-color-1); }
    /* ... (其他主題色省略，保持原樣) ... */

    /* 統計專用樣式 */
    .stat-card { padding: 20px; border-radius: 12px; text-align: center; flex: 1; min-width: 150px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: #fff; display: flex; flex-direction: column; justify-content: center; }
    .stat-card .val { font-size: 2.2em; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    .stat-card .label { font-size: 0.9em; opacity: 0.9; letter-spacing: 1px; }
    .stat-purple { background: linear-gradient(135deg, #b6a6ca 0%, #9e8fb0 100%); }
    .stat-blue { background: linear-gradient(135deg, #94a7b5 0%, #7a8f9e 100%); }
    .stat-red { background: linear-gradient(135deg, #d69a92 0%, #bf857d 100%); }
    .stat-sand { background: linear-gradient(135deg, #c7b299 0%, #b09b82 100%); }
    /* ★★★ 修改這裡：將原本的 stat-sand 改為 stat-green ★★★ */
.stat-green  { background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%); }
/* ★★★ 新增這行：莫蘭迪黃 (用於本月/本年的活躍人次，與藍色形成對比) ★★★ */
.stat-morandi-yellow { background: linear-gradient(135deg, #e0c38c 0%, #c7aa74 100%); }

    /* 學生選擇 Chips */
    .analytics-student-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #e0ddd7; border-radius: 8px; }
    .student-chip { padding: 6px 15px; border-radius: 50px; background: #f4f4f4; color: #666; cursor: pointer; border: 1px solid #ddd; font-size: 0.9em; transition: all 0.2s; }
    .student-chip:hover { background: #e0e0e0; }
    .student-chip.active { background: var(--m-blue); color: #fff; border-color: var(--m-blue); box-shadow: 0 2px 5px rgba(148, 167, 181, 0.4); }

    /* 課業與Modal */
    .assignment-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 12px; background: #fff; transition: all 0.2s; }
    .tag { background-color: #eee; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: normal; margin-right: 10px; }
    .publish-area { background: #fdfcf8; padding: 30px; border-radius: 15px; border: 2px dashed var(--m-green); margin-bottom: 40px; display: flex; flex-direction: column; gap: 20px; }
    .publish-inputs { display: flex; gap: 15px; width: 100%; flex-wrap: wrap; }
    .publish-inputs input { flex: 1 1 auto; min-width: 200px; padding: 15px; font-size: 1.1em; border: 1px solid #ddd; }
    
    /* === 模態視窗設定 (關鍵修正：解決貼邊與滾動) === */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); 
        display: none; 
        justify-content: center; 
        align-items: flex-start; 
        z-index: 1000; 
        backdrop-filter: blur(4px); 
        overflow-y: auto; /* 核心：允許視窗整體滾動 */
        padding: 60px 20px; /* 增加上下 Padding，避免貼邊 */
        box-sizing: border-box;
    }
    
    .modal-body { 
        background: #fff; 
        width: 100%; 
        max-width: 1100px; 
        /* 高度自動，移除限制 */
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        border-radius: 15px; 
        display: flex; 
        flex-direction: column; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
        animation: fadeIn 0.3s; 
        margin: 0 auto; 
        position: relative;
    }
    
    .modal-header { padding: 20px 30px; background: #fdfcf8; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-radius: 15px 15px 0 0; }
    .modal-content-scroll { flex: 1; overflow: visible !important; height: auto !important; padding: 20px 30px; }
    
    .detail-view { background: #fff; padding: 10px; }
    
    /* 詳細內容區塊內的表格樣式 */
    .detail-ai-box table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #8baea8; font-family: 'Noto Serif TC', 'Songti TC', serif; font-size: 1rem; }
    .detail-ai-box th { background-color: #2A9689; color: white; padding: 10px; border: 1px solid #1e7e72; text-align: left; }
    .detail-ai-box td { 
        padding: 10px 15px; border: 1px solid #8baea8; vertical-align: top; text-align: left !important;
        background-color: #fffcf6; 
        color: #2c3e50; line-height: 1.8;
        background-image: linear-gradient(transparent 39px, rgba(42, 150, 137, 0.2) 39px, rgba(42, 150, 137, 0.2) 40px, transparent 40px), linear-gradient(90deg, transparent 39px, rgba(0,0,0,0.02) 39px, rgba(0,0,0,0.02) 40px, transparent 40px);
        background-size: 40px 40px; background-attachment: local;
    }

    /* === 2025修訂：左右並置佈局 (Flexbox) === */
    
    /* 1. 容器：Flexbox，左右排列 */
    .grading-side-by-side {
        display: flex;
        flex-wrap: wrap; /* 允許換行，適應小螢幕 */
        gap: 30px;
        align-items: center;
        justify-content: center;
        margin-bottom: 50px;
    }

  /* 2. 左側評分條區塊 */
    .grading-scores {
        flex: 1;           /* 保持彈性，讓它在手機版能縮放 */
        max-width: 450px;  /* ★ 新增這一行：限制最大寬度，防止撐滿視窗 */
        min-width: 300px;  /* 保持原本設定 */
        padding: 20px;
        background: #fdfcf8;
        border-radius: 12px;
        border: 1px solid #eee;
    }
    
    .score-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
    .score-item label { font-weight: bold; color: #495057; flex-shrink: 0; width: 70px; text-align: left; }
    .slider-container { flex-grow: 1; display: flex; align-items: center; gap: 8px; max-width: none; }
    .progress-bar-container { flex-grow: 1; height: 10px; background-color: #e9ecef; border-radius: 6px; overflow: hidden; border: 1px solid #ced4da; }
    .progress-bar-fill { height: 100%; width: 0%; background-color: #007bff; border-radius: 6px; }
    .score-display { font-weight: bold; width: 25px; text-align: right; color: #0056b3; font-size: 1rem; }
    .total-score-container { margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
    
    /* 3. 右側雷達圖區塊 (縮圖) */
    .grading-radar-thumbnail {
        flex: 1;             /* 讓它有彈性 */
       width: auto;         /* 寬度自動 */
        /* 建議補上最小寬度，避免縮太小 */
        min-width: 220px;
         max-width: 300px;
        text-align: center;
        cursor: pointer; /* 手型游標 */
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 12px;
        background: #fff;
        padding: 10px;
        border: 1px solid transparent;
    }

    .grading-radar-thumbnail:hover {
        transform: scale(1.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: var(--m-blue);
    }
    
    .grading-radar-thumbnail::after {
        content: '\f00e  點擊放大圖表'; /* FontAwesome search-plus icon content */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.85);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        color: var(--m-blue);
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
    }

    .grading-radar-thumbnail:hover::after {
        opacity: 1;
    }

    .grading-radar-thumbnail h3 {
        color: var(--m-blue);
        border-bottom: none; 
        padding-bottom: 5px;
        width: 100%;
        text-align: center;
        margin: 0 0 10px 0;
        font-size: 1em;
    }

    /* 縮圖 Canvas 容器 */
    .radar-chart-mini-container { 
        position: relative; 
        width: 240px; 
        height: 240px;
        margin: 0 auto;
    }

    /* 報告樣式 */
    .report-section { display: block; margin-bottom: 50px; clear: both; } /* 確保不與上方浮動元素重疊 */
    .report-category-badge { display: inline-flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); letter-spacing: 1px; }
    .badge-narrative { background-color: #7da3c0; } .badge-argument { background-color: #a692c2; } .badge-reading { background-color: #8da399; } .badge-expand { background-color: #d69a92; }
    .badge-general { width: 100%; max-width: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 10px; margin-bottom: 10px; background: linear-gradient(135deg, #C5B4A1 0%, #A99885 100%); box-shadow: 0 8px 20px rgba(169, 152, 133, 0.35); color: white; border-radius: 12px; position: relative; overflow: hidden; }
    .badge-general-title { font-size: 1.6rem; font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .overall-grade-tag { background-color: #fff; color: #d9534f; padding: 5px 25px; border-radius: 50px; font-size: 1.4rem; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid #d69a92; display: flex; align-items: center; gap: 8px; }
    .overall-grade-label { font-size: 0.8rem; color: #888; font-weight: normal; text-transform: uppercase; letter-spacing: 1px; }
    .report-category-badge:not(.badge-general) { display: inline-flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); letter-spacing: 1px; }
    .report-text-card { background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 12px; padding: 25px; line-height: 1.9; color: #4a4a4a; font-size: 1.05rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); text-align: justify; margin-top: 10px; display: block; }
    /* 請確保您的 CSS 中，canvas 沒有被強制設為 absolute */
canvas {
    max-width: 100%;
    /* 不要加 position: absolute; 除非父容器有嚴格控制 */
}

/* 確保報告文字卡片是 block 且有間距 */
.report-text-card {
    display: block; 
    clear: both; /* 這行很重要，確保它不會擠到浮動元素旁邊 */
    margin-top: 20px;
}
    .report-quote-card { position: relative; background-color: #fffefb; border: 1px solid #e0ddd7; border-radius: 8px; padding: 30px 30px 30px 65px; margin-top: 40px; box-shadow: 4px 4px 0px rgba(0,0,0,0.05); text-align: left; background-image: linear-gradient(to right, transparent 49px, #eebdbd 50px, transparent 51px), radial-gradient(circle at 25px 50%, #d1cdc5 8px, transparent 9px); background-size: 100% 100%, 100% 40px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 15px; }
    .report-quote-content { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; font-weight: bold; color: #5d4037; font-style: italic; line-height: 1.6; }
    .report-quote-author { margin-top: 10px; font-size: 0.9rem; color: #888; text-align: right; font-style: normal; }
    .report-separator { position: relative; height: 1px; border: 0; border-top: 3px dashed #b6a6ca; margin: 40px 0 50px 0; opacity: 0.6; }
    .report-separator::after { content: '▼'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fdfcf8; padding: 0 10px; color: #b6a6ca; font-size: 12px; }
    
    .report-radar-wrapper { margin-bottom: 30px; background: #fff; padding: 0 20px; border-radius: 0; border: none; display: block; }

/* === 報告雷達圖專用修復樣式 === */

/* 確保雷達圖容器有固定高度，不會無限延伸或縮小 */
.report-radar-wrapper .radar-chart-container {
    position: relative;
    height: 320px !important; /* 強制高度，防止重疊 */
    width: 100%;
    margin-bottom: 15px;
}

/* 手機版適配 */
@media (max-width: 768px) {
    .report-radar-wrapper .radar-chart-container {
        height: 300px !important;
    }
}

    
    /* === 點評與建議列表 === */
    .rewrite-explanation-container { margin-top: 20px; display: block; }
    .explanation-point { display: flex; align-items: flex-start; margin-bottom: 20px; padding: 18px; background-color: #fff; border: 1px solid #e9ecef; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .explanation-point:last-child { margin-bottom: 0; }
    .explanation-number { flex-shrink: 0; width: 28px; height: 28px; background-color: #0288d1; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 15px; font-size: 1em; margin-top: 2px; }
    .explanation-text { font-size: 1em; line-height: 1.8; color: #444; text-align: left; font-family: 'Noto Serif TC', serif; }
    
    .rewrite-explanation-card p {
        font-size: 1em; line-height: 1.8; color: #444; text-align: left; margin: 0; font-family: 'Noto Serif TC', serif;
    }

    .modal-content-container { display: flex; height: 100%; overflow: hidden; }
    .submission-sidebar { width: 320px; border-right: 1px solid var(--border-color); overflow-y: auto; background: #fafafa; flex-shrink: 0; }
    .submission-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
    .submission-item:hover { background: #f0f0f0; }
    .submission-item.active { background: #eef2f5; border-left: 4px solid var(--m-blue); }
    .status-badge { font-size: 0.8em; padding: 3px 10px; border-radius: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    .status-done { background: #e8edea; color: #5e7067; }
    .status-pending { background: #f7ebea; color: #a67069; }
    
    .submission-detail-area { 
        flex-grow: 1; 
        padding: 30px; 
        padding-bottom: 100px !important; 
        overflow-y: auto; 
        background: #fff; 
    }
    
    .teacher-feedback-section { background-color: #fffaf5; border: 2px solid #e6dace; border-radius: 12px; padding: 20px; margin-top: 30px; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08); }
    .teacher-feedback-section input, .teacher-feedback-section textarea { width: 100%; padding: 10px; border: 1px solid #e6dace; border-radius: 8px; font-family: 'Noto Serif TC', serif; box-sizing: border-box; margin-top: 5px; background: #fff; font-size: 1rem; color: #555; outline: none; }
    .teacher-feedback-section input:focus, .teacher-feedback-section textarea:focus { border-color: var(--m-brown); box-shadow: 0 0 5px rgba(199, 178, 153, 0.3); }


/* === 優化後的工具區標題 === */
.section-title {
    display: flex;
    align-items: center;
    gap: 12px;
    
    /* 字體設定 */
    font-size: 1.25rem;
    font-weight: bold;
    color: #5e5e5e; /* 深灰主色 */
    
    /* 關鍵修訂：拉開與下方的距離 */
    margin-bottom: 30px; 
    padding-bottom: 15px;
    
    /* 增加底線，讓區塊感更明顯 */
    border-bottom: 1px solid #eee;
}

/* 圓形圖示裝飾 */
.section-icon-box {
    width: 38px;
    height: 38px;
    background-color: #f5f0e6; /* 莫蘭迪淺米色背景 */
    color: #c7b299;            /* 莫蘭迪褐圖示 */
    border-radius: 50%;        /* 圓形 */
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1rem;
}

/* 適用時機的標籤 (讓語意更清晰) */
.usage-tag {
    font-size: 0.75rem;
    background-color: #eceff1; /* 淺藍灰 */
    color: #78909c;            /* 深藍灰字 */
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: normal;
    letter-spacing: 0.5px;
    margin-left: 5px;
}


    
    .management-section { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
    .transfer-grid { display: flex; gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; align-items: flex-start; }
    .transfer-column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .transfer-list-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; height: 250px; overflow-y: auto; padding: 5px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); }
    .student-select-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
    .student-select-item:hover { background-color: #f5f5f5; }
    .student-select-item input[type="radio"] { transform: scale(1.3); accent-color: var(--m-green); cursor: pointer; }
   /* 學年過渡卡片 (步驟二) */
.year-transition-card {
    background-color: #fdfcf8;
    border: 2px solid var(--m-brown);
    border-radius: 15px;
    padding: 30px;
    
    /* ★ 修改這裡：原本是 center，改為 left 以靠左對齊 */
    text-align: left; 
    
    max-width: 600px;
    margin: 0 auto; /* 這行保留，確保「卡片本身」在螢幕中間，但「文字」在卡片內靠左 */
}

/* 建議：因為文字靠左了，原本中間的裝飾箭頭可能會變得很怪，建議隱藏 */
.year-arrow {
    display: none;
}
    .copyright-footer { position: fixed; bottom: 0; right: 0; padding: 5px 10px; background-color: #f1f1f1; z-index: 999; }
    .copyright-footer p { margin: 0; font-size: 14px; }
    
    @media (max-width: 600px) { 
        .copyright-footer p { font-size: 12px; } 
        /* 手機版：評分表與雷達圖改為垂直堆疊 */
        .grading-side-by-side { flex-direction: column; }
        .grading-scores { width: 100%; min-width: auto; }
        .grading-radar-thumbnail { width: 100% !important; flex: none; }
        
        .score-item label { width: auto; min-width: 60px; font-size: 0.9em; }
        .radar-chart-mini-container { width: 100% !important; max-width: 280px; height: 280px !important; }
        .modal-body { width: 100%; border-radius: 0; margin: 0; }
        .modal-overlay { padding: 40px 0 100px 0; }
    }






/* === 標題區塊優化：浮雕文字風格 (移除背景框) === */
    .title-container {
        /* 1. 清除所有背景與邊框，讓它完全透明 */
        background: transparent !important;
        box-shadow: none !important;
        border: none !important;
        backdrop-filter: none !important;
        
        /* 2. 排版設定 */
        padding: 20px 0;
        margin-bottom: 40px; /* 拉大與下方按鈕的距離 */
        display: flex;
        justify-content: center; /* 標題置中 */
        align-items: center;
        position: relative;      /* 讓右側按鈕可以絕對定位 */
    }

    .title-container h1 {
        margin: 0;
        /* 3. 字體強化 */
        font-size: 3rem;        /* 大幅放大字體 */
        font-weight: 900;       /* 極粗體 */
        letter-spacing: 8px;    /* 寬字距，增加大氣感 */
        color: #5e7067;         /* 使用深莫蘭迪綠 (比灰色更有質感) */
        
        /* 4. 核心魔法：文字多重陰影 (Text Shadow) */
        text-shadow: 
            /* 第一層：白色描邊 (讓文字與複雜背景分離) */
            2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff,
            /* 第二層：柔和的長投影 (營造浮空立體感) */
            0 10px 20px rgba(94, 112, 103, 0.3);
            
        z-index: 1;
        transition: transform 0.3s ease;
    }
    
    /* 增加一點互動感：滑鼠移過時輕微上浮 */
    .title-container h1:hover {
        transform: translateY(-2px);
    }

    /* 5. 右側使用者資訊：改為「懸浮膠囊」樣式 (不影響標題的通透感) */
    .title-container > div[style*="float: right"] {
        float: none !important;
        position: absolute;          /* 固定在右側 */
        right: 10px;
        top: 50%;
        transform: translateY(-50%); /* 垂直置中 */
        
        background: rgba(255, 255, 255, 0.95); /* 純白膠囊 */
        padding: 8px 20px;
        border-radius: 50px;         /* 圓潤膠囊狀 */
        box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* 輕微陰影 */
        border: 1px solid #fff;
        
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2;
    }

    /* 手機版適配：標題縮小，膠囊移到底部 */
    @media (max-width: 768px) {
        .title-container {
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .title-container h1 {
            font-size: 2rem;
            letter-spacing: 4px;
        }
        
        .title-container > div[style*="float: right"] {
            position: relative; /* 手機版不絕對定位 */
            right: auto;
            top: auto;
            transform: none;
            background: rgba(255, 255, 255, 0.6); /* 手機版稍微透明一點 */
        }
    }

/* === 手機版響應式優化 (請貼在 style 標籤最後面) === */
    @media (max-width: 768px) {
        
        /* --- 1. 標題與使用者資訊位置調整 --- */
        
        /* 標題容器改為直向，並為底部預留空間 */
        .title-container {
            flex-direction: column;
            margin-bottom: 20px;
            padding-bottom: 0;
        }

        /* 將「使用者資訊/登出」膠囊固定在螢幕左下角 */
        .title-container > div[style*="float: right"] {
            position: fixed !important;  /* 強制固定定位 */
            bottom: 15px;                /* 距離底部 */
            left: 15px;                  /* 距離左側 */
            top: auto !important;        /* 清除原本的定位 */
            right: auto !important;      /* 清除原本的靠右 */
            transform: none !important;  /* 清除垂直置中位移 */
            z-index: 10000;              /* 確保浮在最上層 */
            
            /* 手機版樣式優化 */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border: 1px solid #ccc;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            width: auto;
            max-width: 200px;
            font-size: 0.85rem;
        }

        /* 確保標題文字不會被切到 */
        .title-container h1 {
            font-size: 1.8rem;
            width: 100%;
            text-align: center;
            order: 1; /* 確保標題在視覺流的上方 */
        }

        /* 避免版權宣告與使用者膠囊重疊 (版權在右下，膠囊在左下) */
        .copyright-footer {
            background: rgba(241, 241, 241, 0.9);
            padding-left: 10px;
        }


        /* --- 2. 學年管理 (個別調動) 響應式修復 --- */

        /* 將原本左右並排的 Grid 改為上下堆疊 */
        .transfer-grid {
            flex-direction: column; /* 垂直排列 */
            gap: 15px;
            padding: 15px 10px;     /* 縮小內距 */
            align-items: center;    /* 置中對齊 */
        }

        /* 讓左右兩個區塊佔滿 100% 寬度 */
        .transfer-column {
            width: 100%;
            min-width: 0; /* 防止 Flex 子元素溢出 */
        }

        /* 將中間的箭頭轉向向下 */
        .transfer-arrow-icon {
            transform: rotate(90deg);
            margin: 5px 0;
            font-size: 1.2em;
        }

        /* --- 強制修復目標設定框內溢出的問題 --- */
        
        /* 針對目標設定區塊內的 Flex 容器 (原本是左右選單) */
        .transfer-column div[style*="display:flex"] {
            flex-direction: column !important; /* 強制變成垂直排列 */
            gap: 10px !important;
        }

        /* 強制所有下拉選單和輸入框佔滿 100% 寬度 */
        .transfer-column select, 
        .transfer-column input {
            width: 100% !important;
            flex: none !important; /* 取消 flex 伸縮 */
            margin: 0 0 10px 0;    /* 增加下方間距 */
            box-sizing: border-box; /* 確保 padding 不會撐破寬度 */
        }

        /* 調整按鈕區域，讓按鈕好按一點 */
        .transfer-column .btn-action {
            width: 100%;
            justify-content: center;
            margin-top: 5px;
            padding: 12px;
        }

        /* --- 2026 新增：選單防插行與重疊修復 --- */
        
        /* 針對篩選群組的優化 */
        .filter-group {
            gap: 10px; /* 縮小間距 */
            padding: 15px;
            justify-content: space-between; /* 讓內容自動分配 */
        }

        /* 強制標籤獨佔一行 */
        .filter-group label {
            width: 100%; 
            margin-bottom: 5px;
            display: block;
        }

        /* 強制選單 (Select) 並排顯示，不換行 */
        .filter-group select {
            width: 48% !important; /* 強制兩個各佔一半 */
            min-width: 0 !important; /* 允許縮小 */
            margin-bottom: 10px;
            flex: 0 0 auto !important; /* 禁止 flex 自動計算 */
        }

        /* 按鈕則佔滿一行 */
        .filter-group .btn-action {
            width: 100%;
            justify-content: center;
            margin-left: 0 !important; /* 移除可能的左邊距 */
        }
    }

/* === 底部使用者資訊膠囊 (頁尾置中版) - 全新莫蘭迪配色 === */
.user-footer-capsule {
    /* 1. 排版設定 (保持不變) */
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin: 60px auto 80px auto;
    width: fit-content; 
    clear: both; 
    position: relative;
    z-index: 10;
    
    /* 2. ★ 顏色修改：改為淺雲灰背景，搭配深藍灰文字 */
    background-color: #D4DCE1;  /* 淺莫蘭迪雲灰 */
    color: #546E7A;             /* 深藍灰字體 (因為背景變淺，字要變深才看得到) */
    
    padding: 12px 30px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(180, 190, 195, 0.3); /* 陰影改淡，看起來更飄逸 */
    font-size: 1rem;
}

.user-footer-capsule:hover {
    transform: translateY(-2px);
}

.user-footer-capsule span {
    font-weight: bold;
    letter-spacing: 1px;
}

/* 3. ★ 登出按鈕修改：改為暖米白，與背景形成柔和對比 */
.user-footer-capsule button {
    background: #FDFCF8;        /* 暖米白 */
    color: #8D6E63;             /* 莫蘭迪暖褐 (文字) */
    
    border: none; /* 移除邊框讓它更乾淨 */
    padding: 6px 18px;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9em;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* 輕微立體感 */
}

.user-footer-capsule button:hover {
    background: #FFFFFF;        /* 滑鼠移過變純白 */
    transform: translateY(-1px);
    color: #6D4C41;
}

    
    /* === 優化後的導航欄：島嶼式控制面板 === */
    .nav-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap; /* 手機版自動換行 */
        gap: 8px; /* 按鈕之間的微小間距 */
        
        /* 核心改變：統一的背景容器 */
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px); /* 磨砂玻璃質感 */
        padding: 8px 10px;
        border-radius: 16px; /* 整體圓角 */
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06); /* 讓導航欄浮起來 */
        
        /* 寬度控制 */
        width: fit-content;
        max-width: 95%;
        margin: 0 auto 30px auto;
    }

    .nav-btn {
        /* 移除原本的獨立膠囊樣式 */
        background: transparent;
        color: #666;
        border: none;
        box-shadow: none;
        
        /* 新樣式：方圓型按鈕 */
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        
        display: flex;
        align-items: center;
        gap: 8px;
        position: relative;
    }

    /* 滑鼠移過時的效果 (輕微灰色背景) */
    .nav-btn:hover:not(.active) {
        background: rgba(0, 0, 0, 0.04);
        color: var(--text-main);
        transform: none; /* 移除原本的位移 */
    }

    /* 激活狀態：莫蘭迪藍色塊，強調選中感 */
    .nav-btn.active {
        background-color: var(--m-blue);
        color: white;
        box-shadow: 0 4px 12px rgba(148, 167, 181, 0.3); /* 柔和陰影 */
        transform: translateY(-1px);
    }
    
    /* 手機版適配：讓按鈕稍微緊湊一點 */
    @media (max-width: 600px) {
        .nav-bar {
            width: 90%;
            padding: 8px;
            gap: 5px;
            border-radius: 20px;
        }
        
        .nav-btn {
            flex: 1 1 auto; /* 讓按鈕自動填滿空間 */
            justify-content: center;
            padding: 10px 12px;
            font-size: 0.9rem;
            white-space: nowrap; /* 防止文字換行 */
        }
        
        .nav-btn i {
            font-size: 1.1em;
        }
    }

/* 修改導航按鈕的 active 狀態樣式，每個按鈕使用不同的莫蘭迪色 */
.nav-btn[data-tab="students"].active {
  background-color: var(--m-green);
  box-shadow: 0 4px 12px rgba(143, 163, 152, 0.3);
}

.nav-btn[data-tab="reports"].active {
  background-color: var(--m-purple);
  box-shadow: 0 4px 12px rgba(182, 166, 202, 0.3);
}

.nav-btn[data-tab="assignments"].active {
  background-color: var(--m-red);
  box-shadow: 0 4px 12px rgba(214, 154, 146, 0.3);
}

.nav-btn[data-tab="analytics"].active {
  background-color: var(--m-brown);
  box-shadow: 0 4px 12px rgba(199, 178, 153, 0.3);
}

/* 保留一個備用色彩，避免與底部的藍色重複 */
.nav-btn[data-tab="management"].active {
  background: linear-gradient(135deg, var(--m-color-3) 0%, #9e8fb0 100%);
  box-shadow: 0 4px 12px rgba(182, 166, 202, 0.3);
}

/* 步驟標籤樣式 */
.step-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    color: white;
    font-weight: bold;
    font-size: 0.9em;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.step-1 { background-color: var(--m-red); }
.step-2 { background-color: var(--m-brown); }
.step-3 { background-color: #ffa726; }


    /* ========================================= */
/* === [移植] 解題指引專用樣式 (確保與學生端一致) === */
/* ========================================= */

/* 1. 標題區塊 */
.guide-section-header {
    padding: 10px 15px;
    margin-bottom: 15px;
    background-color: rgba(255, 255, 255, 0.8);
    border-radius: 0 8px 8px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    border-left-width: 5px; 
    border-left-style: solid;
}
.guide-section-header h3 {
    margin: 0;
    border: none; /* 移除教師端預設的 h3 邊框 */
    padding: 0;
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    gap: 10px;
    background: transparent;
}

/* 2. 介紹卡片 (Intro) */
.guide-intro-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 25px;
    line-height: 1.8;
    color: #444;
    font-size: 1.05rem;
    border: 1px solid #eee;
    text-align: justify;
}

/* 3. 三欄網格佈局 (核心排版) */
.guide-grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 強制三欄 */
    gap: 25px;
    width: 100%;
    box-sizing: border-box;
}

/* 4. 卡片本體 */
.guide-card {
    display: flex !important;
    flex-direction: column !important;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    height: 100%;
    overflow: hidden;
    position: relative;
    box-sizing: border-box;
}

/* 5. 卡片標題 */
.card-title, .seed-header {
    flex-shrink: 0;
    width: 100%;
    padding: 15px;
    font-size: 1.1rem;
    font-weight: bold;
    text-align: center;
    box-sizing: border-box;
}

/* 6. 卡片內容 */
.card-content, .seed-body {
    flex-grow: 1;
    padding: 20px;
    font-size: 1rem;
    line-height: 1.8;
    color: #444;
    text-align: justify;
    white-space: normal !important;
    word-wrap: break-word !important;
}

/* 7. 配色方案 */
/* 藍色卡片 (心情/題眼) */
.emotion-card { border-top: 5px solid #4A90E2; }
.emotion-card .card-title { background-color: #f0f7ff; color: #0056b3; }

/* 綠色卡片 (種子/寫作方向) */
.seed-card { border-top: 5px solid #28a745; }
.seed-card .seed-header { background-color: #f0fff4; color: #155724; }

/* 8. 內容強調樣式 */
.seed-body strong {
    color: #155724 !important;
    display: inline-block;
    margin-bottom: 5px;
    font-size: 1.05rem;
    border-bottom: 2px solid rgba(40, 167, 69, 0.4) !important;
}

/* 9. 手機版適配 (教師用手機看時變單欄) */
@media (max-width: 768px) {
    .guide-grid-3 {
        grid-template-columns: 1fr !important;
        gap: 20px;
    }
    .guide-card {
        margin-bottom: 15px;
        height: auto !important;
    }
}

    /* ========================================= */
/* === [修復] 閱讀點評與改寫範例專用樣式 === */
/* ========================================= */

/* 1. 答題步驟與思路 (修復標題不明顯與排版雜亂) */
.steps-container {
    display: flex;
    flex-direction: column;
    gap: 15px;       /* 卡片之間的間距 */
    margin-top: 15px;
}

.step-card {
    background-color: #fff;
    border: 1px solid #e0ddd7;
    border-left: 5px solid var(--m-blue); /* 左側加粗色條，突顯層次 */
    border-radius: 8px;
    padding: 18px 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
    transition: transform 0.2s;
}

.step-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.08);
}

.step-title {
    font-size: 1.15rem;
    font-weight: bold;
    color: var(--m-blue); /* 使用主題藍色 */
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1px dashed #ccc; /* 標題下方加虛線 */
    letter-spacing: 1px;
}

.step-content {
    font-size: 1.05rem;
    line-height: 1.9; /* 加寬行距，解決字體太窄問題 */
    color: #444;
    text-align: justify;
    white-space: pre-wrap; /* 保留換行 */
}

/* 2. 改寫範例 (修復擠在一起的問題) */
.rewrite-content {
    background-color: #fcfcfc;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 25px;       /* 增加內邊距 */
    margin-top: 15px;
    
    /* 字體與排版優化 */
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem;   /* 字體稍微加大 */
    line-height: 2.2;    /* 大幅增加行距，模擬原稿紙閱讀感 */
    color: #2c3e50;
    text-align: justify;
    white-space: pre-wrap;
    
    box-shadow: inset 0 0 15px rgba(0,0,0,0.02); /* 輕微內陰影增加質感 */
}

/* === [修復] 閱讀指引 - 答題詞匯網格樣式 === */

.vocab-grid {
    display: grid;
    /* 自動填滿，每格最小寬度 80px */
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px;
    padding: 10px 0;
    margin-top: 10px;
}

.vocab-item {
    background-color: #fff;
    border: 1px solid #e0ddd7;
    border-radius: 6px;
    padding: 10px 5px;
    text-align: center;
    
    font-family: 'Noto Serif TC', serif;
    font-size: 1rem;
    color: #555;
    
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    transition: all 0.2s ease;
    white-space: nowrap; /* 防止換行 */
    overflow: hidden;
    text-overflow: ellipsis;
}

.vocab-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    border-color: var(--m-blue);
    color: var(--m-blue);
}

    /* =======================================================
   === [新增] 閱卷員追問區 (畫布聊天室) 樣式 - 教師端移植版 ===
   ======================================================= */

/* 1. 聊天室外層容器 */
.canvas-chat-container {
    margin-top: 40px;
    padding-top: 25px;
    border-top: 3px dashed #2A9689; /* 標誌性的綠色虛線 */
    background-color: #fcfdfd;
    padding-bottom: 20px;
    font-family: 'Noto Serif TC', serif;
    animation: fadeIn 0.5s ease;
    border-radius: 8px; /* 增加圓角讓視覺更柔和 */
}

/* 2. 標題設計 */
.canvas-chat-header {
    color: #2A9689;
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-left: 5px;
}

/* 3. 聊天紀錄捲動區 (在歷史紀錄中我們通常希望它自動伸展，不要 Scroll，方便列印或閱讀) */
.canvas-chat-history {
    background-color: #f0f4f8; /* 淺藍灰背景 */
    border: 1px solid #d1d9e6;
    border-radius: 12px;
    padding: 25px;
    /* 這裡移除了固定高度，改為自動高度，讓歷史紀錄完整顯示 */
    height: auto !important; 
    min-height: 100px;
    display: flex;
    flex-direction: column;
    gap: 20px; /* 氣泡間距 */
}

/* 4. 訊息氣泡通用設定 */
.message-bubble {
    padding: 15px 20px;
    border-radius: 18px;
    line-height: 1.8;
    font-size: 1rem;
    max-width: 88%;
    word-wrap: break-word;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    margin-bottom: 10px; /* 確保氣泡間有間距 */
}

/* 5. AI (閱卷員) 氣泡 - 左側 */
.message-bubble.ai-message {
    background-color: #ffffff;
    color: #333;
    align-self: flex-start; /* 靠左 */
    border-top-left-radius: 4px;
    border: 1px solid #e0e0e0;
    margin-right: auto; /* 確保靠左 */
}

/* 6. 學生 (用戶) 氣泡 - 右側 */
.message-bubble.user-message {
    background-color: #2A9689; /* 主題綠 */
    color: white;
    align-self: flex-end; /* 靠右 */
    border-top-right-radius: 4px;
    box-shadow: 0 4px 10px rgba(42, 150, 137, 0.2);
    margin-left: auto; /* 確保靠右 */
}

/* 7. 強制隱藏歷史紀錄中的輸入框 (教師端不需要輸入) */
.canvas-input-area,
#writingGuideChatInputContainer,
#writingChatInputContainer,
#argumentChatInputContainer,
#chatInputContainer {
    display: none !important;
}

/* 8. 強制隱藏按鈕 */
.canvas-send-btn,
.btn-icon-action,
button[id^="continue"] {
    display: none !important;
}



    /* === 手機版響應式修正 (請貼在 style 標籤最後面) === */
@media (max-width: 768px) {

    /* --- 修復 1：學年管理 - 個別調動名單擠壓問題 --- */
    .student-select-item {
        display: flex !important;
        align-items: center !important;
        width: 100% !important;
        white-space: nowrap !important; /* 禁止文字換行 */
        padding: 12px 10px !important;  /* 增加手指點擊範圍 */
        box-sizing: border-box;
    }
    
    .student-select-item input[type="radio"] {
        flex-shrink: 0 !important;      /* 防止圓形按鈕變形 */
        margin-right: 12px !important;  /* 確保名字與按鈕有距離 */
        width: 20px;
        height: 20px;
    }

    /* --- 修復 2：數據統計 - 時間選單強制並排 --- */
    /* 針對數據統計頁面的選單容器 */
    #tab-analytics .filter-group {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between; /* 讓元件左右對齊 */
        gap: 2%; /* 間距 */
    }

    /* 強制所有選單和日期選擇器並排 (各佔 49%) */
    #tab-analytics select, 
    #tab-analytics input[type="date"] {
        width: 48% !important;
        flex: 0 0 48% !important; /* 禁止 Flex 自動拉伸 */
        min-width: 0 !important;
        margin-bottom: 10px;
        margin-left: 0 !important; /* 移除可能的左邊距 */
    }

    /* 標籤和按鈕則保持佔滿整行 */
    #tab-analytics label,
    #tab-analytics button {
        width: 100% !important;
        margin-left: 0 !important;
    }
    
    /* 修正標籤的顯示，避免擠在一起 */
    #tab-analytics label {
        margin-top: 10px;
        margin-bottom: 5px;
    }
}


    /* === [新增] 即時在線名單樣式 (莫蘭迪風格) === */

/* ========================================= */
/* === [即時在線名單] 完整樣式 (含手機版置中修復) === */
/* ========================================= */

/* 1. 左下角懸浮按鈕 */
.online-status-fab {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: #ffffff;
    color: #5e7067; /* 莫蘭迪深綠 */
    border: 1px solid #8fa398;
    padding: 10px 20px;
    border-radius: 50px;
    box-shadow: 0 4px 15px rgba(143, 163, 152, 0.4);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    z-index: 9999;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    font-size: 0.95rem;
}

.online-status-fab:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 8px 20px rgba(143, 163, 152, 0.6);
    background: #fdfcf8;
}

/* 綠色呼吸燈效果 */
.online-dot {
    width: 10px;
    height: 10px;
    background-color: #4caf50;
    border-radius: 50%;
    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
    animation: pulse-green 2s infinite;
}

@keyframes pulse-green {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
    70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(76, 175, 80, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

/* 2. 名單列表樣式 */
.online-user-list {
    display: flex;
    flex-direction: column;
}

.online-user-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    border-bottom: 1px solid #eee;
    background: #fff;
    transition: background 0.2s;
}

.online-user-item:hover {
    background: #fafafa;
}

.online-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 1rem;
    color: white;
    flex-shrink: 0;
}

.avatar-guest { background-color: #e0e0e0; color: #999; }
.avatar-student { background-color: #8fa398; } /* 莫蘭迪綠 */
.avatar-teacher { background-color: #94a7b5; } /* 莫蘭迪藍 */

.online-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.online-name {
    font-weight: bold;
    color: #555;
    font-size: 1rem;
}

.online-sub {
    font-size: 0.8rem;
    color: #999;
}

/* 3. 底部統計欄 */
.online-footer {
    padding: 10px 20px;
    background: #fff;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-around;
    font-size: 0.9rem;
    color: #666;
    border-radius: 0 0 15px 15px;
}
.online-footer div { display: flex; align-items: center; gap: 6px; }

/* 手機版適配 (懸浮按鈕) */
@media (max-width: 600px) {
    .online-status-fab {
        bottom: 25px; /* 稍微提高避免貼底 */
        left: 20px;
        padding: 10px 15px;
    }
    .online-text { display: none; } /* 手機版只顯示圖示 */
}

/* ========================================= */
/* === [修正] 在線名單視窗 UI 優化補丁 === */
/* ========================================= */

/* 1. 設定內容區域的最小高度 & 空狀態置中 */
#onlineUsersModal .modal-content-scroll {
    min-height: 300px !important;  /* 設定最小高度，避免太扁 */
    display: flex;                 /* 使用 Flex 佈局 */
    flex-direction: column;
}

/* 讓列表容器自動撐滿高度，以便空狀態能垂直置中 */
#onlineUserList {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* 有人時靠上 */
    width: 100%;
}

/* 當內容為空時的專用樣式 */
.empty-state-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #aaa;
    gap: 15px;
}

/* 2. 手機版響應式修正 (針對在線名單視窗) */
@media (max-width: 600px) {
    /* 遮罩層設定：強制使用 Flexbox 垂直水平置中 */
    #onlineUsersModal.modal-overlay {
        display: none; /* 預設隱藏 (JS 會切換為 flex) */
        
        /* ★★★ 核心修復：強制置中 ★★★ */
        align-items: center !important;     /* 垂直置中 */
        justify-content: center !important; /* 水平置中 */
        
        padding: 0 !important;
        margin: 0 !important;
    }

    /* 視窗本體設定 */
    #onlineUsersModal .modal-body {
        /* ★★★ 核心修復：移除所有位移屬性 ★★★ */
        position: relative !important;
        top: auto !important;
        transform: none !important;
        margin: 0 !important; /* Margin 0，因為父層已經幫忙置中了 */
        
        /* 尺寸與外觀 */
        width: 85% !important;
        max-width: 350px !important;
        height: auto !important;
        max-height: 80vh !important; /* 限制最大高度 */
        border-radius: 16px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3) !important;
    }
}

    		/* ========================================= */
/* === [手機版修復] 學年管理列表顯示修正 === */
/* ========================================= */
@media (max-width: 768px) {
    
    /* 1. 修正圓點按鈕 (Radio Button) */
    .transfer-column input[type="radio"] {
        width: 16px !important;        /* ★ 修改：縮小至 16px */
        height: 16px !important;       /* ★ 修改：縮小至 16px */
        flex: 0 0 16px !important;     /* 禁止伸縮，固定大小 */
        margin: 0 12px 0 0 !important; /* 右邊留白 */
        transform: none !important;    /* 移除任何放大效果 */
        box-shadow: none !important;
        background-color: transparent !important; /* 確保背景乾淨 */
    }

    /* 2. 修正列表項目的排版 */
    .student-select-item {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important; /* 垂直置中對齊 */
        justify-content: flex-start !important;
        text-align: left !important;
        
        width: 100% !important;
        padding: 12px 10px !important;
        box-sizing: border-box;
        
        /* 確保文字大小適中，讓圓點看起來相對較小 */
        font-size: 16px !important; 
        line-height: 1.5 !important;
    }
    
    /* 3. 優化列表容器高度 */
    .transfer-list-box {
        height: 300px !important;
    }
}


    /* ========================================= */
/* === [手機版修復] 數據統計選單並排顯示 === */
/* ========================================= */
@media (max-width: 768px) {

    /* 1. 設定容器為 Flexbox，並允許換行 */
    #tab-analytics .filter-group {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: space-between !important; /* 左右對齊 */
        gap: 10px !important; /* 元素之間的間距 */
        padding: 15px !important;
    }

    /* 2. 強制所有「標籤 (Label)」獨佔一行 */
    #tab-analytics .filter-group label {
        width: 100% !important;
        margin-bottom: 5px !important;
        margin-left: 0 !important;
        display: block !important;
    }

    /* 3. 核心：強制「時間模式」與「日期輸入」並排 */
    /* 設定寬度為 50% 減去一點間距，讓它們剛好塞進一行 */
    #statTimeMode, 
    #statDate, 
    #statMonth, 
    #statYear {
        width: calc(50% - 6px) !important; /* 扣除 gap 的一半 */
        min-width: 0 !important;           /* 防止被內容撐開 */
        flex: 0 0 auto !important;         /* 禁止自動伸縮 */
        margin: 0 !important;              /* 清除外邊距 */
        box-sizing: border-box !important;
    }

    /* 4. 針對「對象」選單 (上面的選單) 的特殊處理 */
    /* 如果是對象選單，因為它可能沒有配對的輸入框，我們讓它保持 100% 或視情況調整 */
    #statScope, #statGrade, #statClass {
        /* 如果您希望上面的年級/班別也並排，保留這行；如果希望它們佔滿，改為 100% */
        width: calc(50% - 6px) !important; 
    }
    
    /* 對象主選單 (Global/School/Class) 通常字較長，可以讓它獨佔一行，或者也並排 */
    #statScope {
        width: 100% !important;
        margin-bottom: 10px !important;
    }

    /* 5. 查詢按鈕獨佔一行 */
    #tab-analytics .btn-action {
        width: 100% !important;
        margin-top: 15px !important;
        margin-left: 0 !important;
        justify-content: center;
    }
}

    /* === 空狀態專用樣式 === */
.empty-state-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 250px; /* 確保有足夠高度置中 */
    color: #ccc;
    animation: fadeIn 0.5s ease;
}

.empty-state-box i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #e0e0e0;
}

.empty-state-box p {
    font-size: 1.1rem;
    margin: 0;
    font-weight: bold;
    color: #aaa;
    letter-spacing: 1px;
}

    /* ========================================= */
/* === [移植] 議論指引專用樣式 (莫蘭迪風格) === */
/* ========================================= */

.morandi-guide-container {
    padding: 10px 0;
    font-family: 'Noto Serif TC', serif;
}

.guide-section-card {
    background-color: #fdfcf8;
    border: 1px solid #e0ddd7;
    border-radius: 8px; /* 圓角稍微縮小，顯得更乾淨 */
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
}

.guide-card-header {
    background-color: #8fa398; /* 莫蘭迪灰綠 */
    color: white;
    padding: 12px 20px;
    font-size: 1.15rem; /* 標題縮小 */
    font-weight: bold;
    letter-spacing: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.guide-card-body {
    padding: 20px 25px; /* 縮減內邊距 */
    color: #4a4a4a;
    /* 核心修訂：更紮實的行距與字體 */
    line-height: 1.6 !important;
    font-size: 1.1rem !important;
    letter-spacing: 1px !important;
    text-align: justify;
    white-space: pre-wrap; /* 保留換行 */
    word-break: break-word;
}

/* 針對內容中的段落增加微量間距 */
.guide-card-body br {
    content: "";
    display: block;
    margin: 8px 0;
}

/* 標題樣式 (如果在 userContent 中使用) */
.argument-guide-topic {
    margin-bottom: 20px;
    border-bottom: 1px solid #e0ddd7;
    padding-bottom: 10px;
}
.argument-guide-topic h2 {
    color: #5e7067;
    font-size: 1.4rem;
    letter-spacing: 2px;
    margin: 0;
    text-align: left;
}
    
</style>
</head>
<body>

<!-- === 安全登入閘門 === -->

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color: var(--m-blue); margin-bottom: 10px;">神思・管理面板</h2>
        <p style="color: #888; margin-bottom: 30px;">請使用學校教師帳號登入以存取資料</p>
        <button id="loginBtn" class="login-btn" onclick="teacherLogin()">
            <i class="fab fa-google"></i> Google 帳號登入
        </button>
        <p id="loginMsg" style="color: var(--m-red); margin-top: 15px; font-size: 0.9em;"></p>
    </div>
</div>

<!-- === 主要應用程式 === -->

<div id="mainApp">
    <div class="title-container">
       
        <h1>神思・管理面板</h1>
    </div>

    <!-- 導航列 -->
   <div class="nav-bar">
  <button class="nav-btn active" data-tab="students" onclick="switchTab('students')"><i class="fas fa-user-graduate"></i> 歷程檢閱</button>
  <button class="nav-btn" data-tab="reports" onclick="switchTab('reports')"><i class="fas fa-chart-pie"></i> 學生報告</button>
  <button class="nav-btn" data-tab="assignments" onclick="switchTab('assignments')"><i class="fas fa-edit"></i> 課業管理</button>
  <button class="nav-btn" data-tab="analytics" onclick="switchTab('analytics')"><i class="fas fa-chart-bar"></i> 數據統計</button>
  <button class="nav-btn" data-tab="management" onclick="switchTab('management')"><i class="fas fa-calendar-alt"></i> 學年管理</button>
</div>

    <!-- 1. 學生管理頁面 -->
    <div id="tab-students" class="box">
        <h2>學生歷程檔案檢閱</h2>
        <div class="filter-group">
            <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> 篩選：</label>
           <select id="viewGrade" onchange="loadStudentList()">
    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
    <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
    <!-- 新增 -->
    <option value="System" style="color:red; font-weight:bold;">老師</option> 
               <!-- ★★★ 新增這行 ★★★ -->
<option value="Special" style="color:blue; font-weight:bold;">特許用家</option>
</select>
<!-- 找到這段 -->
<select id="viewClass" onchange="loadStudentList()">
    <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
    <option value="Test" style="color:red; font-weight:bold;">老師</option>
    
    <!-- ★★★ 新增這行：必須加入特許用家選項，否則 JS 無法自動跳轉 ★★★ -->
    <option value="User" style="color:blue; font-weight:bold;">特許用家</option>
</select>
            <button class="btn-action btn-view" onclick="loadStudentList()"><i class="fas fa-sync-alt"></i> 刷新列表</button>
        </div>
        <div id="studentListContainer" class="student-grid">
            <p style="text-align:center; width:100%; color:#aaa; padding:30px;">請選擇年級和班別以載入學生列表</p>
        </div>
    </div>

    <!-- 2. 學生報告頁面 -->
    <div id="tab-reports" class="box" style="display:none;">
        <h2>學生學習報告管理</h2>
        <div class="filter-group">
            <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> 篩選：</label>
           <select id="reportGrade" onchange="loadReportStudentList()">
    <!-- ... 原有選項 ... -->
    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
    <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
    <option value="System" style="color:red; font-weight:bold;">老師</option>
</select>
<select id="reportClass" onchange="loadReportStudentList()">
    <!-- ... 原有選項 ... -->
    <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
    <option value="Test" style="color:red; font-weight:bold;">老師</option>
    <!-- ★★★ 新增這行 ★★★ -->
<option value="User" style="color:blue; font-weight:bold;">特許用家</option>
</select>
            <button id="btnClassReport" class="btn-action btn-manage" style="background: linear-gradient(135deg, #7da3c0 0%, #5e7067 100%); margin-left: auto; box-shadow: 0 4px 10px rgba(94, 112, 103, 0.4);" onclick="generateClassReport()">
                <i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)
            </button>
        </div>
        <div id="classReportHistoryContainer" style="margin-bottom: 25px; padding: 20px; background: #fdfcf8; border-radius: 12px; border: 1px solid var(--border-color); border-left: 5px solid #7da3c0; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; border:none; padding:0; font-size:1.1em; color:var(--text-main); display:flex; align-items:center; gap:8px;"><i class="fas fa-history" style="color:#7da3c0;"></i> 過往全班綜合報告紀錄</h3>
                <small style="color:#999; font-style:italic;">點擊下方按鈕以重看報告</small>
            </div>
            <div id="classReportList" style="display:flex; gap:12px; overflow-x:auto; padding:5px 0; align-items: center; scroll-behavior: smooth;"></div>
        </div>
        <div id="reportStudentListContainer" class="student-grid">
            <p style="text-align:center; width:100%; color:#aaa; padding:30px;">請選擇年級和班別以載入報告列表</p>
        </div>
    </div>

    <!-- 3. 課業派發頁面 -->
    <div id="tab-assignments" class="box" style="display:none;">
        <h2>佈置課業</h2>
        <div class="filter-group">
            <label><i class="fas fa-users" style="color:var(--m-blue);"></i> 對象：</label>
            <select id="assignGrade" onchange="loadAssignmentHistory()">
    <!-- ... 原有選項 ... -->
    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
    <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
    <option value="System" style="color:red; font-weight:bold;">老師</option>
</select>
<select id="assignClass" onchange="loadAssignmentHistory()">
    <!-- ... 原有選項 ... -->
    <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
    <option value="Test" style="color:red; font-weight:bold;">老師</option>
</select>
        </div>
        <div class="publish-area">
            <div style="font-weight:bold; color:var(--m-green); margin-bottom:5px; font-size:1.1em;"><i class="fas fa-pen-fancy"></i> 創建新任務</div>
            <div class="publish-inputs">
                <input type="text" id="assignTopic" placeholder="課業題目">
                <select id="assignType"><option value="閱讀">閱讀</option><option value="敘事抒情">敘事抒情</option><option value="議論">議論</option><option value="整合拓展">整合拓展</option></select>
            </div>
            <button id="btnPublish" class="btn-action btn-publish" onclick="publishAssignment()"><i class="fas fa-paper-plane"></i> 立即派發</button>
        </div>
        <h3>已派發課業列表</h3>
        <div id="assignmentHistoryList"></div>
    </div>

    <!-- 4. 數據統計頁面 -->
    <div id="tab-analytics" class="box" style="display:none;">
        <h2>神思大數據統計</h2>
        
        <div class="filter-group">
            <label><i class="fas fa-cubes" style="color:var(--m-blue);"></i> 對象：</label>
            <select id="statScope" onchange="updateStatInputs()">
                <option value="global">所有用家 (含訪客)</option>
                <option value="school">全校 (僅已登入)</option>
                <option value="class">個別班級</option>
            </select>

            <span id="statClassInput" style="display:none;">
               <select id="statGrade" onchange="loadAnalyticsClassList()">
    <!-- ... 原有選項 ... -->
    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
    <option value="4">中四</option><option value="5">中五</option><option value="6">中六</option>
    <option value="System">老師</option>
</select>
<select id="statClass" onchange="loadAnalyticsClassList()">
    <!-- ... 原有選項 ... -->
    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
    <option value="Test">老師</option>
</select>
            </span>

            <label style="margin-left:15px;"><i class="far fa-clock" style="color:var(--m-brown);"></i> 時間：</label>
            <select id="statTimeMode" onchange="updateTimeInputs()">
                <option value="day">本日 (實時)</option>
                <option value="month">本月 (趨勢)</option>
                <option value="year">本年 (總覽)</option>
            </select>
            
            <input type="date" id="statDate" style="display:inline-block;">
            <select id="statMonth" style="display:none;"></select>
            <select id="statYear" style="display:none;"><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option></select>

            <button class="btn-action btn-view" onclick="fetchAndRenderStats()">
                <i class="fas fa-search"></i> 查詢
            </button>
        </div>

        <!-- 學生選擇區域 -->
        <div id="analyticsStudentListContainer" style="display:none;">
            <h4 style="margin:0 0 10px 0; font-size:1em; color:var(--text-main);">
                <i class="fas fa-user-friends"></i> 選擇學生 (點擊可切換，再次點擊取消)
            </h4>
            <div id="analyticsStudentList" class="analytics-student-list"></div>
        </div>

        <!-- 數據概覽卡片 -->
        <div style="display:flex; gap:20px; justify-content:center; margin:30px 0; flex-wrap:wrap;">
         <div class="stat-card stat-purple">
    <div class="val" id="dispUnique">0</div>
    <div class="label" id="labelUnique">訪問人數</div> <!-- ★ 加入 ID -->
</div>
            <div class="stat-card stat-blue">
                <div class="val" id="dispVisits">0</div>
                <div class="label">訪問次數</div>
            </div>
            <div class="stat-card stat-red">
                <div class="val" id="dispDuration">0</div>
                <div class="label">總訪問時長 (分鐘)</div>
            </div>
           <div class="stat-card stat-green">
        <div class="val" id="dispAvg">0</div>
        <div class="label">平均訪問時長 (分鐘)</div>
    </div>
</div>

        <div class="chart-container" style="position: relative; height:400px; width:100%;">
            <canvas id="analyticsChart"></canvas>
        </div>
    </div>

  <!-- 5. 學年管理頁面 (修訂版) -->
<div id="tab-management" class="box" style="display:none;">
    <h2>學年過渡管理</h2>
    
    <!-- 個別學生調動 (手動工具) - 整合到上方作為一般工具 -->
    <div class="management-section">
       <div class="section-title">
    <div class="section-icon-box"><i class="fas fa-user-edit"></i></div>
    <span>個別學生轉班／調動</span>
    <span class="usage-tag">僅限學期中途使用</span>
</div>
        <div class="transfer-grid">
            <div class="transfer-column">
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="font-weight:bold; color:var(--m-red);">來源：</span>
                    <select id="indivFromGrade" onchange="populateTransferStudentList()"><option value="6">中六</option><option value="5">中五</option><option value="4">中四</option><option value="3">中三</option><option value="2">中二</option><option value="1">中一</option></select>
                    <select id="indivFromClass" onchange="populateTransferStudentList()"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                </div>
                <div id="transferStudentListBox" class="transfer-list-box"><div style="padding:20px; text-align:center; color:#999;">請先選擇班級...</div></div>
            </div>
            <div class="transfer-arrow-icon" style="align-self:center; color:#ccc; font-size:1.5em;"><i class="fas fa-arrow-right"></i></div>
           <div class="transfer-column" style="justify-content:center;">
    <div style="background:#fff; border:1px solid #eee; padding:20px; border-radius:10px;">
        <div style="font-weight:bold; color:var(--m-green); margin-bottom:10px;">目標設定：</div>
        
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
            <select id="indivToGrade" style="flex:1;">
    <option value="6">中六</option>
    <option value="5">中五</option>
    <option value="4">中四</option>
    <option value="3">中三</option>
    <option value="2">中二</option>
    <option value="1">中一</option>
    <!-- ★★★ 新增以下兩行 ★★★ -->
    <option value="System" style="color:red; font-weight:bold;">老師</option>
    <option value="Special" style="color:blue; font-weight:bold;">特許用家</option>
</select>
         <select id="indivToClass" style="flex:1;">
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
    <!-- ★★★ 新增以下兩行 ★★★ -->
    <option value="Test" style="color:red; font-weight:bold;">老師</option>
    <option value="User" style="color:blue; font-weight:bold;">特許用家</option>
</select>
        </div>
 
        <!-- ★★★ 已刪除：原本在這裡的「分配新班號」輸入框 ★★★ -->
 
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn-action btn-manage" style="justify-content:center;" onclick="moveIndividualStudent()"><i class="fas fa-exchange-alt"></i> 確認調動</button>
            <button class="btn-action btn-delete" style="justify-content:center;" onclick="deleteStudent()"><i class="fas fa-trash-alt"></i> 刪除此學生</button>
        </div>
    </div>
</div>
        </div>
    </div>

    <!-- 步驟區塊：新學年過渡 -->
    <h3 style="margin-bottom: 20px;">新學年升班流程</h3>

    <!-- 步驟一：例外處理 -->
    <div style="padding: 25px; border-radius: 15px; border: 2px dashed #d9534f; background-color: #fff5f5; margin-bottom: 30px;">
        <span class="step-badge step-1">步驟一</span>
        <h3 style="color: #d9534f; margin-top:0; border:none; padding:0;"><i class="fas fa-user-clock"></i> 留班生／特殊個案</h3>
        <p style="color: #666; font-size: 0.9em;">
            在執行「一鍵升級」前，請先將<b>留班生</b>或<b>需要特殊處理</b>的學生移至「待分班區」。
        </p>
        
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 15px;">
            <select id="exceptionGrade" onchange="loadExceptionList()">
                <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                <option value="4">中四</option><option value="5">中五</option><option value="6">中六</option>
            </select>
            <select id="exceptionClass" onchange="loadExceptionList()">
                <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>
            <button class="btn-action btn-delete" onclick="moveSelectedToPending()">
                <i class="fas fa-sign-out-alt"></i> 移至待分班區
            </button>
        </div>
        
        <!-- 學生勾選列表 -->
        <div id="exceptionList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 200px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
            <div style="color:#999; text-align:center;">請選擇班級載入名單...</div>
        </div>
    </div>


    <!-- 步驟二：一鍵全校升班 -->
    <div class="year-transition-card" style="margin-bottom: 30px;">
        <span class="step-badge step-2">步驟二</span>
        <div style="font-size:1.3em; font-weight:bold; color:#555;"><i class="fas fa-rocket"></i> 全校升班</div>
        <p style="color: #d9534f; font-size: 0.9em; margin: 10px 0;">
            <i class="fas fa-exclamation-triangle"></i> 注意：此操作將清除所有舊功課、刪除中六學生，並將中三學生移至待分班區。
        </p>
        <div class="year-arrow"><i class="fas fa-chevron-down"></i></div>
        <button class="btn-action btn-manage" style="padding:15px 40px; font-size:1.1em; width:100%;" onclick="runYearTransition()">開始新學年過渡</button>
    </div>

    <!-- 步驟三：待分班區 -->
    <div id="pendingAllocationPanel" class="box" style="display:none; border-top: 5px solid #ffa726; background-color: #fff8e1; margin-top: 30px;">
        <span class="step-badge step-3">步驟三</span>
        <h2 style="color: #e65100; margin-top:0;"><i class="fas fa-random"></i> 待分班區</h2>
        <p style="color: #666; margin-bottom: 20px;">此處包含「原中三升中四」的學生，以及您手動移入的「留班/轉班」學生。</p>

        <!-- 佈局容器：左右兩欄 -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            
            <!-- 左欄：中三升中四專用 (標準升班) -->
            <div style="flex: 1; min-width: 300px; background: #fff; border: 1px solid #ffcc80; border-radius: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <h3 style="color: #e65100; border-bottom: 2px solid #ffe0b2; padding-bottom: 10px; margin-top: 0;">
                    <i class="fas fa-level-up-alt"></i> 中三 <i class="fas fa-arrow-right"></i> 中四 (分流)
                </h3>
                
                <div style="background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <span style="font-weight: bold; color: #ef6c00;">目標班別 (中四)：</span>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <select id="targetS4Class" style="flex: 1; padding: 8px; border:1px solid #ef6c00; border-radius:5px;">
                            <option value="A">4A 班</option>
                            <option value="B">4B 班</option>
                            <option value="C">4C 班</option>
                            <option value="D">4D 班</option>
                        </select>
                        <button class="btn-action" style="background-color: #ef6c00; padding: 8px 15px;" onclick="allocateS3Students()">
                            確認
                        </button>
                    </div>
                </div>

                <!-- S3 學生列表容器 -->
                <div id="listS3Students" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;"></div>
            </div>

            <!-- 右欄：留班/特殊轉班專用 (例外處理) -->
            <div style="flex: 1; min-width: 300px; background: #fff; border: 1px solid #90a4ae; border-radius: 10px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <h3 style="color: #455a64; border-bottom: 2px solid #cfd8dc; padding-bottom: 10px; margin-top: 0;">
                    <i class="fas fa-user-cog"></i> 留班 / 轉班處理 (其他年級)
                </h3>
                
                <div style="background: #eceff1; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <span style="font-weight: bold; color: #455a64;">分配至新位置：</span>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <select id="targetRetainGrade" style="width: 70px; padding: 8px; border:1px solid #78909c; border-radius:5px;">
                            <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                            <option value="4">中四</option><option value="5">中五</option><option value="6">中六</option>
                        </select>
                        <select id="targetRetainClass" style="width: 70px; padding: 8px; border:1px solid #78909c; border-radius:5px;">
                            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
                        </select>
                        <button class="btn-action" style="background-color: #546e7a; padding: 8px 15px; flex: 1;" onclick="allocateRetainStudents()">
                            確認調動
                        </button>
                    </div>
                </div>

                <!-- 留班生列表容器 -->
                <div id="listRetainStudents" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

</div>


<!-- ★★★ 請貼在這裡 (所有分頁框框的外面) ★★★ -->
<div class="user-footer-capsule">
    <i class="fas fa-user-circle" style="font-size: 1.2em;"></i>
    <span id="teacherNameDisplay"></span>
    <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> 登出</button>
</div>


        </div>
<!-- Modals -->

<!-- 歷史檢閱視窗 -->
<div id="historyViewerModal" class="modal-overlay">
    <div class="modal-body">
        <div class="modal-header">
            <h3 id="viewerTitle" style="margin:0; color:var(--m-blue);">學生歷程</h3>
            <button onclick="document.getElementById('historyViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div class="modal-content-scroll">
            <div id="teacherBreadcrumb" class="history-breadcrumb" style="display: none;">
                <span class="breadcrumb-item" onclick="renderLevel1()"><i class="fas fa-home"></i> 主範疇</span> 
                <span class="breadcrumb-sep"> &gt; </span>
                <span class="breadcrumb-item" id="breadCategory" onclick="renderLevel2(currentCategory)"></span>
                <span class="breadcrumb-sep" id="breadSep2"> &gt; </span>
                <span class="breadcrumb-current" id="breadSub"></span>
            </div>
            <div id="historyLevel1" class="category-cards-container"></div>
            <div id="historyLevel2" class="history-grid-menu" style="display: none;"></div>
            <div id="historyLevel3" class="history-list-container" style="display: none;"></div>
            <div id="historyDetail" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- 提交檢閱視窗 -->
<div id="submissionViewerModal" class="modal-overlay">
    <div class="modal-body">
        <div class="modal-header">
            <h3 id="submissionTitle" style="margin:0; color:var(--m-green);"></h3>
            <div style="font-size:0.9em; color:#888;">已繳交: <span id="submitCount" style="color:var(--m-green); font-weight:bold;">0</span> / 未繳交: <span id="pendingCount" style="color:var(--m-red); font-weight:bold;">0</span></div>
            <button onclick="document.getElementById('submissionViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div class="modal-content-container">
            <div class="submission-sidebar">
                <ul id="submissionList" style="list-style:none; padding:0; margin:0;"></ul>
            </div>
            <div id="submissionDetailArea" class="submission-detail-area">
                <div style="text-align:center; color:#ccc; margin-top:100px;"><i class="far fa-file-alt" style="font-size:48px;"></i><p>請選擇學生</p></div>
            </div>
        </div>
    </div>
</div>

<!-- 班級報告視窗 -->
<div id="classReportModal" class="modal-overlay">
    <div class="modal-body" style="max-width: 900px;">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--m-blue);"><i class="fas fa-chart-pie"></i> 全班綜合學習報告</h3>
            <button onclick="document.getElementById('classReportModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div id="classReportContent" class="modal-content-scroll" style="background:#f9f9f9; padding: 0;"></div>
    </div>
</div>

<!-- 2025 新增：圖表放大專用視窗 (Modal) -->
<div id="chartEnlargeModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-body" style="width: 90%; max-width: 700px; height: auto;">
        <div class="modal-header" style="background: #fff; border-bottom: none;">
            <h3 id="enlargeChartTitle" style="margin:0; color:var(--m-blue);">能力分析詳情</h3>
            <button onclick="document.getElementById('chartEnlargeModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div style="padding: 10px 30px 40px 30px; height: 500px; position: relative; width: 100%; box-sizing: border-box;">
            <canvas id="bigChartCanvas"></canvas>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
        authDomain: "sansidata.firebaseapp.com",
        projectId: "sansidata",
        storageBucket: "sansidata.firebasestorage.app",
        messagingSenderId: "580288358575",
        appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
        databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const READING_API_KEYS = ["pk_D77NeM4n6GnNCYbo", "pk_c17y17tQ3BY71cpd", "pk_Ax3rRTHkrdTQVIGD", "pk_dGVqEggn4T4dwQI3", "pk_YIFWnDFts0quviE0"];
    const READING_API_URL = "https://gen.pollinations.ai/v1/chat/completions";
    const READING_MODEL = "deepseek";

    const _k1 = "os_v2_app_";
    const _k2 = "7bo2joflvzgf5dnzzh2gh7eycxk5kn45q25uwymlyhqbq746uburtgfhd3xfyyxullklptksmnddfdwgpechno4byssraz7yysuusrq";
    const _OS_KEY = _k1 + _k2;

    async function sendClassNotification(targetGrade, targetClass, title, message) {
        const options = {
            method: 'POST',
            headers: { accept: 'application/json', 'Content-Type': 'application/json', Authorization: 'Basic ' + _OS_KEY },
            body: JSON.stringify({ app_id: "f85da4b8-abae-4c5e-8db9-c9f463fc9815", headings: { en: title, zh: title }, contents: { en: message, zh: message }, filters: [{ field: "tag", key: "grade", relation: "=", value: targetGrade }, { operator: "AND" }, { field: "tag", key: "class", relation: "=", value: targetClass }], url: "https://kenchan20141.github.io/AIChinese/" })
        };
        try { await fetch('https://onesignal.com/api/v1/notifications', options); console.log('推播發送成功'); } catch (err) { console.error('推播發送失敗:', err); }
    }

    function determineGrade(score) {
        if (score >= 72) return "5**"; if (score >= 69) return "5*"; if (score >= 64) return "5";
        if (score >= 57) return "4"; if (score >= 50) return "3"; if (score >= 45) return "2"; return "1";
    }

   // 定義特殊管理員電郵常量
     const SPECIAL_ADMIN_B64 = "czIxMTA5QGNjY2t5Yy5lZHUuaGs="; 

    function teacherLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        document.getElementById('loginMsg').innerText = "驗證中...";

        // Debug 用戶 (Base64)
        const debugUser = atob('a2VuY2hhbjIwMTQxQGdtYWlsLmNvbQ==');
        // 特殊管理員 (Base64 解碼)
        const specialAdmin = atob(SPECIAL_ADMIN_B64);

        auth.signInWithPopup(provider).then((result) => {
            const user = result.user;
            
            // 檢查：是學校教職員 OR Debug帳號 OR 特殊管理員
            if (user.email.endsWith('@ccckyc.edu.hk') || user.email === debugUser || user.email === specialAdmin) { 
                showApp(user); 
            }
            else { 
                auth.signOut(); 
                document.getElementById('loginMsg').innerText = "非授權帳號"; 
            }
        }).catch((error) => { 
            document.getElementById('loginMsg').innerText = "登入失敗：" + error.message; 
        });
    }

    // 必須保留這個登出函式
    function logout() { auth.signOut().then(() => location.reload()); }

    // 監聽登入狀態改變
    auth.onAuthStateChanged(user => { 
        const debugUser = atob('a2VuY2hhbjIwMTQxQGdtYWlsLmNvbQ==');
        const specialAdmin = atob(SPECIAL_ADMIN_B64);

        if (user && (user.email.endsWith('@ccckyc.edu.hk') || user.email === debugUser || user.email === specialAdmin)) {
            showApp(user);
        }
    });

    function showApp(user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('teacherNameDisplay').innerText = user.displayName || user.email;
        
        db.ref('config/currentYear').once('value', s => { 
            if(s.exists()) document.getElementById('currentYearInput').value = s.val(); 
        });
        
        // ★★★ 特殊管理員 UI 限制邏輯 ★★★
        const specialAdmin = atob(SPECIAL_ADMIN_B64);

        if (user.email === specialAdmin) {
            console.log("偵測到特殊管理員身份，執行權限限制...");

            // 1. 隱藏導航列中除了「數據統計」以外的所有按鈕
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                const tab = btn.getAttribute('data-tab');
                // 隱藏所有非 'analytics' 的按鈕
                if (tab !== 'analytics') {
                    btn.style.display = 'none';
                }
            });

            // 2. 強制切換到數據統計頁籤
            switchTab('analytics');

            // 3. 移除「對象」下拉選單中的「個別班級」選項
            const scopeSelect = document.getElementById('statScope');
            if (scopeSelect) {
                for (let i = 0; i < scopeSelect.options.length; i++) {
                    if (scopeSelect.options[i].value === 'class') {
                        scopeSelect.remove(i);
                        break;
                    }
                }
                // 確保預設選中 Global
                scopeSelect.value = 'global';
                
                // 觸發 UI 更新以隱藏班級選擇器
                if (typeof updateStatInputs === 'function') {
                    updateStatInputs(); 
                }
            }
        }

        populateTransferStudentList();
    }


    // === Tab 切換 ===
   function switchTab(tabId) {
  // 移除所有按鈕的 active 類
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  // 為當前選中的按鈕添加 active 類
  document.querySelector(`.nav-btn[data-tab="${tabId}"]`).classList.add('active');
  
  // 隱藏所有標籤頁
  document.querySelectorAll('.box').forEach(b => b.style.display = 'none');
  // 顯示選中的標籤頁
  document.getElementById('tab-' + tabId).style.display = 'block';
  
  // 其他頁面加載邏輯保持不變
  if(tabId === 'students') loadStudentList();
  if(tabId === 'assignments') loadAssignmentHistory();
  if(tabId === 'reports') loadReportStudentList();
  if(tabId === 'analytics') {
    if(document.getElementById('statMonth').options.length === 0) initStatUI();
    loadAnalyticsClassList();
  }
}

    // === 歷史檢閱 ===
    let currentStudentHistory = [], currentCategory = '', currentSubFunction = '', currentThemeIndex = 1, currentViewingAssignmentId = ''; 
    const HISTORY_STRUCTURE = { "閱讀": ["點評", "指引"], "敘事抒情": ["文章點評", "大綱點評", "解題指引", "敘事物象"], "議論": ["文章點評", "大綱點評", "指引"], "整合拓展": ["點評", "指引"],  "學習報告": ["綜合分析"] };
    const CATEGORY_ASSETS = { "閱讀": { img: '郵筒.png', en: 'READING' }, "敘事抒情": { img: '相機.png', en: 'NARRATIVE' }, "議論": { img: '筆.png', en: 'ARGUMENT' }, "整合拓展": { img: '火車.png', en: 'EXPAND' },  "學習報告": { img: '書.png', en: 'REPORT' } };
    const SUB_ICONS = { "文章點評": "fa-file-alt", "大綱點評": "fa-list-ol", "綜合分析": "fa-chart-pie", "敘事物象": "fa-tree", "解題指引": "fa-compass", "指引": "fa-lightbulb", "點評": "fa-comment-dots", "討論紀錄": "fa-comments" };

    // === 1. 修訂：學生列表載入 (加入點擊偵測除錯) ===
// === 優化版 V2：省流載入列表 (Lazy Loading) ===
async function loadStudentList() {
    const gradeSelect = document.getElementById('viewGrade');
    const classSelect = document.getElementById('viewClass');
    
    // 自動鎖定邏輯 (保持不變)
    if (gradeSelect.value === 'System') {
        classSelect.value = 'Test'; classSelect.disabled = true;
    } else if (gradeSelect.value === 'Special') {
        classSelect.value = 'User'; classSelect.disabled = true;
    } else {
        classSelect.disabled = false;
        if (classSelect.value === 'Test' || classSelect.value === 'User') classSelect.value = 'A';
    }
 
    const g = gradeSelect.value;
    const c = classSelect.value;
    const container = document.getElementById('studentListContainer');
    
    container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> 正在獲取名單 (省流模式)...</p>';
 
    try {
        // 1. 獲取登入 Token (用於 REST API)
        const user = firebase.auth().currentUser;
        if (!user) return;
        const token = await user.getIdToken();
 
        // 2. 使用 REST API 的 shallow=true 只抓取「學生名字清單」(不抓內容)
        const dbUrl = "https://sansidata-default-rtdb.firebaseio.com"; // 請確認這是您的 DB URL
        const resp = await fetch(`${dbUrl}/students/${g}/${c}.json?shallow=true&auth=${token}`);
        const nameData = await resp.json();
 
        if (!nameData) {
            container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">暫無資料。</p>';
            return;
        }
 
        // 3. 拿到名單後，並行讀取每位學生的 Profile (只讀 Profile，不讀 History)
        // 這樣流量非常小，因為 Profile 只有名字和班號
        const names = Object.keys(nameData);
        
        // 建立一個 Promise 陣列來快速抓取班號
        const profilePromises = names.map(async (name) => {
            const snap = await db.ref(`students/${g}/${c}/${name}/profile`).once('value');
            return { name: name, profile: snap.val() || {} };
        });
 
        const students = await Promise.all(profilePromises);
 
        // 4. 排序並渲染
        container.innerHTML = '';
        
        students.sort((a, b) => {
            const numA = parseInt(a.profile.number) || 99;
            const numB = parseInt(b.profile.number) || 99;
            return numA - numB;
        });
 
        students.forEach(s => {
            const name = s.name;
            const profile = s.profile;
            const num = profile.number || '';
 
            // 顯示名稱邏輯
            let displayNameHtml = '';
            if (g === 'System') displayNameHtml = `<span style="color:var(--m-blue); font-weight:bold;">老師</span> - ${name}`;
            else if (g === 'Special') displayNameHtml = `<span style="color:var(--m-purple); font-weight:bold;">特許用家</span> - ${name}`;
            else displayNameHtml = `${name} <small>(${num})</small>`;
 
            const div = document.createElement('div');
            div.className = 'student-card';
            // 注意：這裡移除了 "紀錄: XX 筆" 的顯示，因為我們還沒下載歷史紀錄
            // 改為顯示 "點擊查看詳情"
            div.innerHTML = `
                <div class="student-name">${displayNameHtml}</div>
               
            `;
 
            // ★ 點擊時才去下載該學生的 History
            div.onclick = () => fetchHistoryAndOpenModal(g, c, name);
            
            container.appendChild(div);
        });
 
    } catch (error) {
        console.error("載入失敗", error);
        container.innerHTML = '<p style="text-align:center; color:red;">載入失敗，請重試。</p>';
    }
}


    // === 新增：按需下載歷史紀錄 ===
async function fetchHistoryAndOpenModal(grade, cls, name) {
    // 1. 顯示簡單的 Loading 提示 (或者您可以用更漂亮的 Modal Loading)
    const btn = event.currentTarget; // 獲取被點擊的卡片
    const originalContent = btn.innerHTML;
    
    // 在卡片上顯示讀取中
    btn.innerHTML = `<div style="text-align:center; padding:10px;"><i class="fas fa-circle-notch fa-spin"></i> 下載大數據中...</div>`;
    btn.style.pointerEvents = 'none'; // 防止連點
 
    try {
        // 2. 精準下載：只下載該學生的 history 節點
        const snapshot = await db.ref(`students/${grade}/${cls}/${name}/history`).once('value');
        const historyData = snapshot.val();
        
        // 轉換為陣列 (處理 Firebase 物件格式)
        let historyArray = [];
        if (historyData) {
            historyArray = Array.isArray(historyData) ? historyData : Object.values(historyData);
        }
 
        // 3. 呼叫原本的開啟視窗函式
        // (注意：這裡的 openHistoryModal 需要微調，因為我們現在才傳入 history)
        openHistoryModal(name, historyArray);
 
    } catch (error) {
        alert("讀取失敗：" + error.message);
    } finally {
        // 還原卡片顯示
        btn.innerHTML = originalContent;
        btn.style.pointerEvents = 'auto';
    }
}
    

    // === 報告管理 ===
// === 優化版 V2：學生報告列表 (Lazy Loading) ===
async function loadReportStudentList() {
    const gradeSelect = document.getElementById('reportGrade');
    const classSelect = document.getElementById('reportClass');
 
    // 自動鎖定邏輯 (保持不變)
    if (gradeSelect.value === 'System') {
        classSelect.value = 'Test'; classSelect.disabled = true;
    } else if (gradeSelect.value === 'Special') {
        classSelect.value = 'User'; classSelect.disabled = true;
    } else {
        classSelect.disabled = false;
        if (classSelect.value === 'Test' || classSelect.value === 'User') classSelect.value = 'A';
    }
 
    const g = gradeSelect.value;
    const c = classSelect.value;
    const container = document.getElementById('reportStudentListContainer');
    
    // 顯示 Loading
    container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> 正在獲取名單 (省流模式)...</p>';
    
    // 同時載入上方的班級綜合報告 (這個流量很小，保留)
    loadClassReportHistory();
 
    try {
        // 1. 獲取 Token
        const user = firebase.auth().currentUser;
        if (!user) return;
        const token = await user.getIdToken();
 
        // 2. 使用 REST API 只抓取學生名單
        const dbUrl = "https://sansidata-default-rtdb.firebaseio.com";
        const resp = await fetch(`${dbUrl}/students/${g}/${c}.json?shallow=true&auth=${token}`);
        const nameData = await resp.json();
 
        if (!nameData) {
            container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">暫無資料。</p>';
            return;
        }
 
        // 3. 並行讀取 Profile (取得班號)
        const names = Object.keys(nameData);
        const profilePromises = names.map(async (name) => {
            const snap = await db.ref(`students/${g}/${c}/${name}/profile`).once('value');
            return { name: name, profile: snap.val() || {} };
        });
 
        const students = await Promise.all(profilePromises);
 
        // 4. 排序並渲染
        container.innerHTML = '';
        
        students.sort((a, b) => {
            const numA = parseInt(a.profile.number) || 99;
            const numB = parseInt(b.profile.number) || 99;
            return numA - numB;
        });
 
        students.forEach(s => {
            const name = s.name;
            const num = s.profile.number || '';
 
            // 顯示名稱邏輯
            let displayNameHtml = '';
            if (g === 'System') displayNameHtml = `<span style="color:var(--m-blue); font-weight:bold;">老師</span> - ${name}`;
            else if (g === 'Special') displayNameHtml = `<span style="color:var(--m-purple); font-weight:bold;">特許用家</span> - ${name}`;
            else displayNameHtml = `${name} <small>(${num})</small>`;
 
            const div = document.createElement('div');
            div.className = 'student-card';
            
            // 這裡不再根據報告數量變灰，因為我們還不知道誰有報告
            div.style.cssText = '';
            
            div.innerHTML = `
                <div class="student-name">${displayNameHtml}</div>
             
            `;
            
            // ★ 點擊時觸發：下載數據 -> 檢查是否有報告 -> 打開
            div.onclick = () => fetchReportAndOpenModal(g, c, name);
            
            container.appendChild(div);
        });
 
    } catch (error) {
        console.error("載入失敗", error);
        container.innerHTML = '<p style="text-align:center; color:red;">載入失敗，請重試。</p>';
    }
}


    // === 新增：按需下載並檢查報告 ===
async function fetchReportAndOpenModal(grade, cls, name) {
    // 1. UI 反饋
    const btn = event.currentTarget;
    const originalContent = btn.innerHTML;
    
    btn.innerHTML = `<div style="text-align:center; padding:10px;"><i class="fas fa-circle-notch fa-spin"></i> 搜尋報告中...</div>`;
    btn.style.pointerEvents = 'none';
 
    try {
        // 2. 下載該學生的完整歷史紀錄
        const snapshot = await db.ref(`students/${grade}/${cls}/${name}/history`).once('value');
        const historyData = snapshot.val();
        
        let historyArray = [];
        if (historyData) {
            historyArray = Array.isArray(historyData) ? historyData : Object.values(historyData);
        }
 
        // 3. 檢查是否有「學習報告」類別的紀錄
        const reports = historyArray.filter(r => r.category === "學習報告");
 
        if (reports.length > 0) {
            // A. 有報告 -> 打開視窗並自動跳轉
            openHistoryModal(name, historyArray);
            
            // 自動導航到報告頁面 (模擬點擊流程)
            setTimeout(() => {
                renderLevel2('學習報告');
                setTimeout(() => renderLevel3('綜合分析', 5), 100);
            }, 300);
        } else {
            // B. 無報告 -> 提示並恢復
            alert(`提示：學生「${name}」尚未生成任何學習報告。`);
        }
 
    } catch (error) {
        alert("讀取失敗：" + error.message);
    } finally {
        // 還原按鈕狀態
        btn.innerHTML = originalContent;
        btn.style.pointerEvents = 'auto';
    }
}

// === 優化版 V4：基於學生報告全文 + 隱私去名保護 ===
async function generateClassReport() {
    const btn = document.getElementById('btnClassReport');
    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;
    
    btn.disabled = true; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在匿名處理全班資料...';

    try {
        // 1. 下載該班級資料
        const snapshot = await db.ref(`students/${g}/${c}`).once('value');
        const data = snapshot.val();
        
        if (!data) { alert("此班級無學生資料！"); return; }

        let fullClassTextPrompt = ""; // 用於累積所有學生的完整文字報告
        
        // 用於累加全班的平均分 (作為數據參考)
        let narrativeStats = { content: 0, expression: 0, structure: 0, count: 0 };
        let argumentStats = { content: 0, expression: 0, structure: 0, count: 0 };
        
        let reportCount = 0; 

        // 2. 遍歷每位學生
        Object.entries(data).forEach(([name, d]) => {
            const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
            
            // 過濾出「學習報告」並取最新的一份
            const reports = h.filter(r => r.category === "學習報告").sort((a,b) => b.timestamp - a.timestamp);
            
            if (reports.length > 0) { 
                const latestReport = reports[0];
                reportCount++;
                
                // === A. 隱私去名與全文提取 ===
                // 1. 移除 HTML 標籤，轉為純文字 (保留換行以便閱讀)
                let rawText = latestReport.aiContent.replace(/<br\s*\/?>/gi, '\n') // 將 <br> 轉為換行
                                                    .replace(/<[^>]+>/g, '')       // 移除所有其他 HTML 標籤
                                                    .replace(/\s+/g, ' ')          // 將多餘空白縮減
                                                    .trim();

                // 2. 組合匿名資料 (不包含 name)
                // 限制每位學生最多傳送 800 字，避免總 Prompt 超出 AI 上限 (通常夠用)
                fullClassTextPrompt += `\n【學生 ${reportCount} 的個人報告內容】:\n${rawText.substring(0, 800)}...\n----------------\n`;

                // === B. 提取分數數據 (保持不變，用於計算平均) ===
                const scores = latestReport.scoreData;
                if (scores) {
                    if (scores["敘事抒情"]) {
                        narrativeStats.content += scores["敘事抒情"].content || 0;
                        narrativeStats.expression += scores["敘事抒情"].expression || 0;
                        narrativeStats.structure += scores["敘事抒情"].structure || 0;
                        narrativeStats.count++;
                    }
                    if (scores["議論"]) {
                        argumentStats.content += scores["議論"].content || 0;
                        argumentStats.expression += scores["議論"].expression || 0;
                        argumentStats.structure += scores["議論"].structure || 0;
                        argumentStats.count++;
                    }
                }
            }
        });

        if (reportCount === 0) { 
            alert("此班級的學生尚未生成任何「學習報告」。\n請先請學生在學生端生成個人報告，老師端才能進行彙整。"); 
            return; 
        }

        // 3. 計算全班平均分 (0-10分制)
        const calcAvg = (stats) => {
            if (stats.count === 0) return { content: 0, expr: 0, struct: 0 };
            return {
                content: Math.round(stats.content / stats.count),
                expr: Math.round(stats.expression / stats.count),
                struct: Math.round(stats.structure / stats.count)
            };
        };

        const narrAvg = calcAvg(narrativeStats);
        const argAvg = calcAvg(argumentStats);

        // 4. 構建 Prompt (包含匿名後的全文資料)
        const prompt = `你是一位中文科科主任。已收集 ${g}年${c}班 共 ${reportCount} 位學生的個人學習報告。

        【全班硬性指標 (平均分)】：
        - 敘事抒情：內容${narrAvg.content}/10, 表達${narrAvg.expr}/10, 結構${narrAvg.struct}/10 (樣本數:${narrativeStats.count})
        - 議論：內容${argAvg.content}/10, 表達${argAvg.expr}/10, 結構${argAvg.struct}/10 (樣本數:${argumentStats.count})

        【個別學生報告內容 (已去名)】：
        ${fullClassTextPrompt}

        任務：請綜合分析上述所有學生的文字報告內容，歸納出全班的共同強項與弱項，生成一份「全班綜合學習評估報告」。

        【格式要求 (必須嚴格遵守 HTML)】：
        1. <div class="report-section"><div class="report-category-badge badge-general"><div class="badge-general-title">${g}${c}班 綜合評估</div></div><div class="report-text-card"><p>(總結全班整體表現，約200字，請具體引用普遍現象，例如「多數學生在...方面表現出色」)</p></div></div><div class="report-separator"></div>
        
        2. 請針對有數據的範疇撰寫分析 (若該範疇無數據則不寫)，必須使用以下 HTML 格式：
           
           (敘事)：
           <div class="report-section">
               <div class="report-category-badge badge-narrative"><i class="fas fa-feather-alt"></i> 敘事抒情</div>
               <div class="report-text-card"><p>(詳細分析全班在敘事文的具體表現，歸納出 2 個優點和 2 個通病)</p></div>
           </div>

           (議論)：
           <div class="report-section">
               <div class="report-category-badge badge-argument"><i class="fas fa-gavel"></i> 議論</div>
               <div class="report-text-card"><p>(詳細分析全班在議論文的具體表現，歸納出 2 個優點和 2 個通病)</p></div>
           </div>
        
        3. 【教學建議部分 - 必須使用此格式】：
           <div class="rewrite-explanation-container">
             <div class="rewrite-explanation-card">
               <h3><i class="fas fa-chalkboard-teacher"></i> 重點教學建議</h3>
               <div class="explanation-point"><div class="explanation-number">1</div><div class="explanation-text">(針對上述通病，提出具體的教學建議一)</div></div>
               <div class="explanation-point"><div class="explanation-number">2</div><div class="explanation-text">(針對上述通病，提出具體的教學建議二)</div></div>
               <div class="explanation-point"><div class="explanation-number">3</div><div class="explanation-text">(針對上述通病，提出具體的教學建議三)</div></div>
             </div>
           </div>
        `;

        btn.innerHTML = '<i class="fas fa-robot"></i> AI 正在閱讀全班報告...';
        
        // 5. 呼叫 API
        const response = await callAPI(prompt);
        
        // 6. 存檔與顯示
        const reportData = { 
            timestamp: firebase.database.ServerValue.TIMESTAMP, 
            dateStr: new Date().toLocaleString(), 
            stats: { 
                narrAvg, 
                argAvg, 
                narrativeCount: narrativeStats.count, 
                argumentCount: argumentStats.count 
            }, 
            aiHtml: response 
        };
        
        await db.ref(`class_reports/${g}/${c}`).push(reportData);
        loadClassReportHistory(); 
        openClassReportModal(reportData);

    } catch (e) { 
        console.error(e); 
        alert("生成失敗：" + e.message); 
    } finally { 
        btn.disabled = false; 
        btn.innerHTML = '<i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)'; 
    }
}

    function loadClassReportHistory() {
        const g = document.getElementById('reportGrade').value, c = document.getElementById('reportClass').value;
        const container = document.getElementById('classReportHistoryContainer');
        const list = document.getElementById('classReportList');
        db.ref(`class_reports/${g}/${c}`).once('value', snapshot => {
            const data = snapshot.val();
            if (!data) { container.style.display = 'none'; return; }
            container.style.display = 'block'; list.innerHTML = '';
            Object.entries(data).sort(([,a], [,b]) => b.timestamp - a.timestamp).forEach(([key, report]) => {
                const w = document.createElement('div');
                w.style.cssText = `display:inline-flex;align-items:center;background:#fff;border:1px solid #ccc;border-radius:50px;padding:5px 5px 5px 15px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,0.05);`;
                w.innerHTML = `<span style="cursor:pointer;color:#555;font-weight:bold;margin-right:10px;" onclick='openClassReportModal(${JSON.stringify(report).replace(/'/g, "&#39;")})'><i class="far fa-file-alt"></i> ${report.dateStr.split(' ')[0]}</span><button class="btn-action" style="background:#fbecec;color:#d69a92;border-radius:50%;width:32px;height:32px;padding:0;justify-content:center;" onclick="deleteClassReport('${key}')"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(w);
            });
        });
    }
    function deleteClassReport(key) { if(confirm("確定刪除此報告？")) { const g=document.getElementById('reportGrade').value, c=document.getElementById('reportClass').value; db.ref(`class_reports/${g}/${c}/${key}`).remove().then(()=>loadClassReportHistory()); }}
    function openClassReportModal(data) {
    const m = document.getElementById('classReportModal');
    const c = document.getElementById('classReportContent');

    if (!m || !c) return alert("系統錯誤：找不到報告視窗元件");

    document.body.appendChild(m);
    m.style.zIndex = "99999";

    const d = document.createElement('div'); 
    d.innerHTML = data.aiHtml;

    // 這裡使用 data.stats.narrativeCount (我們在第一步修改了變數名)
    if(data.stats.narrativeCount > 0) { 
        const b = d.querySelector('.badge-narrative'); 
        if(b) b.outerHTML = generateClassChartHTML('narrative', data.stats.narrAvg, data.stats.narrativeCount); 
    }
    if(data.stats.argumentCount > 0) { 
        const b = d.querySelector('.badge-argument'); 
        if(b) b.outerHTML = generateClassChartHTML('argument', data.stats.argAvg, data.stats.argumentCount); 
    }

    c.innerHTML = `<div style="text-align:right;color:#999;padding:20px 20px 0 0;">報告日期：${data.dateStr}</div><div style="padding:20px;">${d.innerHTML}</div>`;
    
    m.style.display = 'flex';

    setTimeout(() => { 
        if(data.stats.narrativeCount > 0) renderClassChart('narrativeClassChart', data.stats.narrAvg); 
        if(data.stats.argumentCount > 0) renderClassChart('argumentClassChart', data.stats.argAvg); 
    }, 200);
}
    
   // === 關鍵修訂：生成左右並置的 HTML ===
// === 修訂：生成左右並置的 HTML (改用 Flexbox 防止重疊) ===
function generateClassChartHTML(type, avg, count) {
    const id = type === 'narrative' ? 'narrativeClassChart' : 'argumentClassChart';
    const title = type === 'narrative' ? '敘事抒情' : '議論'; 
    const cls = type === 'narrative' ? 'badge-narrative' : 'badge-argument';
    
    // 計算分數邏輯
    const scoreContent = avg.content * 4;
    const scoreExpr = avg.expr * 3;
    const scoreStruct = avg.struct * 2;
    const scorePunc = 5; 
    const scoreTypo = 1; 
    const totalScore = Math.min(100, scoreContent + scoreExpr + scoreStruct + scorePunc + scoreTypo);
    
    return `
    <!-- 
       ★ 修正重點：最外層使用 display: block 確保獨佔一行 
       margin-bottom: 50px 強制推開下方文字
    -->
    <div class="report-section" style="display: block; width: 100%; margin-bottom: 50px; border-bottom: 1px dashed #e0ddd7; padding-bottom: 30px;">
        
        <!-- 標題 -->
        <div class="report-category-badge ${cls}" style="margin-bottom: 25px; display: inline-flex;">
            <i class="fas fa-book"></i> ${title}
        </div>
        
        <!-- 
           Flex 容器：負責左右排列
           align-items: flex-start 確保高度不會互相拉伸導致變形
           flex-wrap: wrap 確保手機版會自動換行
        -->
        <div style="display: flex; flex-wrap: wrap; gap: 30px; align-items: flex-start; width: 100%;">
            
            <!-- 左側：評分條 (設定 min-width 防止被擠壓) -->
            <div style="flex: 1; min-width: 300px; background: #fdfcf8; border: 1px solid #eee; border-radius: 12px; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-top:0; border-left:none; padding-left:0; text-align:center; color:#555; margin-bottom: 20px;">
                    班級平均表現 <small style="font-weight:normal; color:#999;">(${count}份)</small>
                </h3>
                
                <div class="score-item"><label>內容 (40)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.content*10}%" class="progress-bar-fill"></div></div><span class="score-display">${scoreContent}</span></div></div>
                <div class="score-item"><label>表達 (30)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.expr*10}%" class="progress-bar-fill"></div></div><span class="score-display">${scoreExpr}</span></div></div>
                <div class="score-item"><label>結構 (20)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.struct*10}%" class="progress-bar-fill"></div></div><span class="score-display">${scoreStruct}</span></div></div>
                <div class="score-item"><label>標點 (10)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:50%" class="progress-bar-fill"></div></div><span class="score-display">${scorePunc}</span></div></div>
                <div class="score-item"><label>錯別字 (+3)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:33%" class="progress-bar-fill"></div></div><span class="score-display">+${scoreTypo}</span></div></div>

                <div class="total-score-container" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size:1.1em; color:#555;">平均總分: ${totalScore} / 100</span>
                    <span style="font-size:2em; font-weight:bold; color:#d9534f;">${determineGrade(totalScore)}</span>
                </div>
            </div>
            
            <!-- 
               右側：雷達圖容器
               ★ 關鍵修正：這裡不依賴 flex 計算高度，而是內部撐開
            -->
            <div style="flex: 1; min-width: 300px; background:#fff; border:1px solid #eee; border-radius:12px; padding:20px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <h3 style="margin-top:0; border-left:none; padding-left:0; text-align:center; color:#555; margin-bottom: 15px;">能力分佈</h3>
                
                <!-- 
                   ★ 絕對防禦：強制設定高度 height: 320px
                   這樣就算 Chart 還沒畫出來，這個 div 也會佔據 320px 的高度，
                   下方的文字絕對不可能跑上來重疊。
                -->
                <div style="position: relative; width: 100%; max-width: 350px; height: 320px !important; overflow: hidden;">
                    <canvas id="${id}"></canvas>
                </div>
            </div>

        </div>
        
        <!-- 墊片：確保下方內容被推開 -->
        <div style="height: 20px; width: 100%; clear: both;"></div>
        
    </div>`;
}

    
   // === 新增：全域變數，用來儲存班級報告的圖表實例 ===
let classReportChartInstances = {}; 

// === 修訂：渲染縮圖 (加入銷毀舊圖表邏輯) ===
function renderClassChart(id, avg) {
    const ctx = document.getElementById(id); 
    if(!ctx) return;

    // 1. 關鍵修復：檢查該 ID 是否已有存在的圖表實例，若有則銷毀
    if (classReportChartInstances[id]) {
        classReportChartInstances[id].destroy();
        delete classReportChartInstances[id];
    }

    // 2. 建立新圖表並存入全域變數
    classReportChartInstances[id] = new Chart(ctx.getContext('2d'), {
        type: 'radar',
        data: { 
            labels: ['立意','取材','扣題','詳略','詞彙','文學性'], 
            datasets: [{ 
                label: '班級平均', 
                data: [
                    (avg.content*0.6+avg.struct*0.4).toFixed(1), 
                    (avg.content*0.8+avg.expr*0.2).toFixed(1), 
                    (avg.content*0.7+avg.struct*0.3).toFixed(1), 
                    (avg.struct*0.7+avg.content*0.3).toFixed(1), 
                    avg.expr, 
                    avg.expr
                ], 
                backgroundColor: 'rgba(94, 112, 103, 0.4)', 
                borderColor: '#5e7067', 
                borderWidth: 2, 
                pointBackgroundColor: '#5e7067' 
            }] 
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } }, // 縮圖不顯示刻度
            plugins: { legend: { display: false } } 
        }
    });
}
    
    // === 新增：打開放大圖表的 Modal 並渲染大圖 ===
    let bigChartInstance = null;
    function openEnlargedChart(title, avg) {
        document.getElementById('chartEnlargeModal').style.display = 'flex';
        document.getElementById('enlargeChartTitle').innerHTML = `<i class="fas fa-chart-area"></i> ${title} - 能力詳細分析`;
        
        const ctx = document.getElementById('bigChartCanvas').getContext('2d');
        if (bigChartInstance) bigChartInstance.destroy(); // 銷毀舊圖表

        bigChartInstance = new Chart(ctx, {
            type: 'radar',
            data: { 
                labels: ['立意 (深淺)', '取材 (廣度)', '扣題 (緊密)', '詳略 (佈局)', '詞彙 (豐富)', '文學性 (修辭)'], 
                datasets: [{ 
                    label: '班級平均', 
                    data: [
                        (avg.content*0.6+avg.struct*0.4).toFixed(1), 
                        (avg.content*0.8+avg.expr*0.2).toFixed(1), 
                        (avg.content*0.7+avg.struct*0.3).toFixed(1), 
                        (avg.struct*0.7+avg.content*0.3).toFixed(1), 
                        avg.expr, 
                        avg.expr
                    ], 
                    backgroundColor: 'rgba(148, 167, 181, 0.5)', 
                    borderColor: '#94a7b5', 
                    borderWidth: 3, 
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#94a7b5',
                    pointHoverBackgroundColor: '#94a7b5',
                    pointHoverBorderColor: '#fff',
                    pointRadius: 5,
                    pointHoverRadius: 8
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    r: { 
                        suggestedMin: 0, 
                        suggestedMax: 10,
                        angleLines: { color: '#eee' },
                        grid: { color: '#e0ddd7' },
                        pointLabels: {
                            font: { size: 14, family: "'Noto Serif TC', serif", weight: 'bold' },
                            color: '#555'
                        },
                        ticks: { display: true, backdropColor: 'transparent', z: 10 }
                    } 
                }, 
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 16 },
                        bodyFont: { size: 14 },
                        padding: 12
                    }
                } 
            }
        });
    }

    async function callAPI(prompt) {
        let k = READING_API_KEYS[Math.floor(Math.random() * READING_API_KEYS.length)];
        const r = await fetch(READING_API_URL, { method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: READING_MODEL, messages: [{ role: "user", content: prompt }], max_tokens: 4000 }) });
        const d = await r.json(); return d.choices[0].message.content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>/gis, '').trim();
    }

    // === 數據統計 ===
    let selectedAnalyticsStudent = null; 

    function initStatUI() {
        const now = new Date();
        const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0');
        document.getElementById('statDate').value = `${y}-${m}-${d}`;
        document.getElementById('statYear').value = y;
        const ms = document.getElementById('statMonth'); ms.innerHTML = '';
        for(let i=1; i<=12; i++) { const o=document.createElement('option'); o.value=String(i).padStart(2,'0'); o.text=i+'月'; if(o.value===m) o.selected=true; ms.add(o); }
        updateStatInputs(); updateTimeInputs();
    }
    function updateStatInputs() { 
        const s=document.getElementById('statScope').value; 
        document.getElementById('statClassInput').style.display=(s==='class')?'inline-block':'none';
        document.getElementById('analyticsStudentListContainer').style.display=(s==='class')?'block':'none';
        if(s==='class') loadAnalyticsClassList();
    }
    function updateTimeInputs() { const m=document.getElementById('statTimeMode').value; document.getElementById('statDate').style.display=(m==='day')?'inline-block':'none'; document.getElementById('statMonth').style.display=(m==='month')?'inline-block':'none'; document.getElementById('statYear').style.display=(m==='month'||m==='year')?'inline-block':'none'; }
    
  // === 數據統計學生列表 (自動鎖定 + 優化顯示) ===
function loadAnalyticsClassList() {
    const gradeSelect = document.getElementById('statGrade');
    const classSelect = document.getElementById('statClass');

    // ★ 自動化邏輯 ★
    if (gradeSelect.value === 'System') {
        classSelect.value = 'Test';
        classSelect.disabled = true;
    } else {
        classSelect.disabled = false;
        if (classSelect.value === 'Test') classSelect.value = 'A';
    }

    const g = gradeSelect.value;
    const c = classSelect.value;
    const list = document.getElementById('analyticsStudentList');
    selectedAnalyticsStudent = null; 
    
    list.innerHTML = '載入學生中...';
    
    db.ref(`students/${g}/${c}`).once('value', s => {
        const data = s.val();
        list.innerHTML = '';
        if(!data) { list.innerHTML = '此班級無學生'; return; }
        
        const sorted = Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99));
        
        sorted.forEach(([name, d]) => {
            const chip = document.createElement('div');
            chip.className = 'student-chip';
            
            // ★ 顯示邏輯優化 ★
            if (g === 'System') {
                chip.innerHTML = `<i class="fas fa-user-tie"></i> ${name}`; // 老師加個圖示
            } else {
                chip.innerText = `${d.profile?.number||''}. ${name}`;
            }
            
            chip.onclick = () => {
                if (selectedAnalyticsStudent === name) {
                    selectedAnalyticsStudent = null; 
                    document.querySelectorAll('.student-chip').forEach(el => el.classList.remove('active'));
                } else {
                    selectedAnalyticsStudent = name;
                    document.querySelectorAll('.student-chip').forEach(el => el.classList.remove('active'));
                    chip.classList.add('active');
                }
            };
            list.appendChild(chip);
        });
    });
}

let analyticsChartInstance = null;

// === 雙軌制數據統計函式 (精準讀取優化版 + 流量監控) ===
// === 雙軌制數據統計函式 (精準讀取優化版 + 流量監控 + 顏色對比修正 V3) ===
async function fetchAndRenderStats() {
    const btn = document.querySelector('button[onclick="fetchAndRenderStats()"]');
    const originalBtnText = btn.innerHTML;
    
    // 1. 獲取篩選條件
    const scope = document.getElementById('statScope').value; 
    const mode = document.getElementById('statTimeMode').value; 
    
    // 2. 處理時間參數
    let y, m, d;
    if (mode === 'day') { 
        const p = document.getElementById('statDate').value.split('-'); 
        y=p[0]; m=p[1]; d=p[2]; 
    } else { 
        y = document.getElementById('statYear').value; 
        if(mode === 'month') m = document.getElementById('statMonth').value; 
    }

    // 3. 智能構建路徑
    let fetchPath = "";
    const selectedStudent = (scope === 'class' && typeof selectedAnalyticsStudent !== 'undefined' && selectedAnalyticsStudent) ? selectedAnalyticsStudent : null;

    if (selectedStudent) {
        const g = document.getElementById('statGrade').value;
        const c = document.getElementById('statClass').value;
        const safeName = selectedStudent.replace(/[.#$/[\]]/g, '_');
        fetchPath = `stats_students/${g}${c}/${safeName}/${y}`;
    } else if (scope === 'class') {
        const g = document.getElementById('statGrade').value;
        const c = document.getElementById('statClass').value;
        fetchPath = `stats_classes/${g}${c}/${y}`;
    } else if (scope === 'school') {
        fetchPath = `stats_school/${y}`;
    } else {
        fetchPath = `stats_global/${y}`;
    }

    if (mode === 'month' || mode === 'day') fetchPath += `/${m}`;
    if (mode === 'day') fetchPath += `/${d}`;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 數據分析中...';
    
    ['dispUnique','dispVisits','dispDuration','dispAvg'].forEach(id=>document.getElementById(id).innerText='-');
    if(analyticsChartInstance) {
        analyticsChartInstance.destroy();
        analyticsChartInstance = null;
    }

    // ★★★ [顏色控制區 - 莫蘭迪黃版] ★★★
    const labelEl = document.getElementById('labelUnique');
    const cardEl = document.getElementById('dispUnique').parentElement; // 獲取卡片容器
    
    let uniqueLabelText = "";
    let uniqueColor = "";

    // 根據模式設定 標籤文字、卡片顏色 Class、圖表顏色
    if (mode === 'day') {
        uniqueLabelText = "訪問人數";
        uniqueColor = "#b6a6ca"; // 保持紫色
        
        // 設定卡片樣式
        if (cardEl) {
            cardEl.classList.remove('stat-morandi-yellow'); // 移除黃色
            cardEl.classList.add('stat-purple');            // 加回紫色
        }
    } else {
        uniqueLabelText = "活躍人次";
        uniqueColor = "#e0c38c"; // ★ 改為莫蘭迪黃
        
        // 設定卡片樣式
        if (cardEl) {
            cardEl.classList.remove('stat-purple');         // 移除紫色
            cardEl.classList.add('stat-morandi-yellow');    // ★ 加入黃色
        }
    }

    if(labelEl) labelEl.innerText = uniqueLabelText;

    try {
        console.log(`🔍 [Stats] 準備讀取路徑: ${fetchPath}`);
        const snap = await db.ref(fetchPath).once('value');
        const dataNode = snap.val();
        
        // 流量監控
        if (dataNode) {
            try {
                const jsonString = JSON.stringify(dataNode);
                const bytes = new TextEncoder().encode(jsonString).length;
                const kb = (bytes / 1024).toFixed(2);
                console.log(`📊 數據統計流量: ${kb} KB`);
            } catch (e) {}
        }
        
        if (!dataNode) { 
            alert("此時段無數據紀錄"); 
            ['dispUnique','dispVisits','dispDuration','dispAvg'].forEach(id=>document.getElementById(id).innerText=0);
            throw new Error("No Data");
        }

        // === 數據聚合邏輯 ===
        let totalUnique = 0, totalVisits = 0, totalDuration = 0;
        let chartLabels = [], chartVisits = [], chartUnique = [], chartDuration = [];

        const getStats = (obj) => ({
            v: parseInt(obj?.visits || 0),
            u: parseInt(obj?.unique || 0),
            d: parseInt(obj?.duration || 0)
        });

        if (mode === 'day') {
            const s = getStats(dataNode);
            totalVisits = s.v;
            totalDuration = s.d;
            if (selectedStudent && s.v > 0) totalUnique = 1; else totalUnique = s.u;
            chartLabels.push(`${d}日`);
            chartVisits.push(s.v);
            chartUnique.push(totalUnique);
            chartDuration.push(Math.round(s.d/60));

        } else if (mode === 'month') {
            Object.keys(dataNode).sort().forEach(dayKey => {
                const s = getStats(dataNode[dayKey]);
                totalVisits += s.v;
                totalDuration += s.d;
                let dailyUnique = s.u;
                if (selectedStudent && s.v > 0) dailyUnique = 1;
                totalUnique += dailyUnique;
                chartLabels.push(`${parseInt(dayKey)}日`);
                chartVisits.push(s.v);
                chartUnique.push(dailyUnique);
                chartDuration.push(Math.round(s.d/60));
            });

        } else if (mode === 'year') {
            Object.keys(dataNode).sort().forEach(monthKey => {
                let mVisits = 0, mUnique = 0, mDuration = 0;
                const monthData = dataNode[monthKey];
                Object.values(monthData).forEach(dayNode => {
                    const s = getStats(dayNode);
                    mVisits += s.v;
                    mDuration += s.d;
                    let dailyU = s.u;
                    if (selectedStudent && s.v > 0) dailyU = 1;
                    mUnique += dailyU;
                });
                totalVisits += mVisits;
                totalUnique += mUnique;
                totalDuration += mDuration;
                chartLabels.push(`${parseInt(monthKey)}月`);
                chartVisits.push(mVisits);
                chartUnique.push(mUnique);
                chartDuration.push(Math.round(mDuration/60));
            });
        }

        document.getElementById('dispUnique').innerText = totalUnique;
        document.getElementById('dispVisits').innerText = totalVisits;
        document.getElementById('dispDuration').innerText = Math.round(totalDuration/60);
        
        let avgTime = 0;
        if (selectedStudent) {
             if (totalVisits > 0) avgTime = Math.round((totalDuration/60) / totalVisits);
        } else {
             if (totalUnique > 0) avgTime = Math.round((totalDuration/60) / totalUnique);
        }
        document.getElementById('dispAvg').innerText = avgTime;

        const ctx = document.getElementById('analyticsChart').getContext('2d');
        analyticsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: chartLabels, 
                datasets: [
                    { label: '訪問次數', data: chartVisits, backgroundColor: '#94a7b5', hoverBackgroundColor: '#7a8f9e', maxBarThickness: 50, order: 3 },
                    // ★ 使用更新後的 uniqueColor (莫蘭迪黃)
                    { label: uniqueLabelText, data: chartUnique, backgroundColor: uniqueColor, hoverBackgroundColor: uniqueColor, maxBarThickness: 25, order: 2 },
                    { label: '總訪問時長 (分)', data: chartDuration, type: 'line', borderColor: '#d69a92', backgroundColor: '#d69a92', borderWidth: 2, pointRadius: 3, yAxisID: 'y1', tension: 0.3, order: 1 }
                ]
            },
            options: { 
                maintainAspectRatio: false, 
                interaction: { mode: 'index', intersect: false },
                scales: { 
                    x: { stacked: true, grid: { display: false } },
                    y: { beginAtZero: true, position: 'left', title: {display:true, text:'數量'}, stacked: false }, 
                    y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: {display:true, text:'分鐘'} } 
                }
            }
        });

    } catch(e) { 
        console.error(e);
        if (e.message !== "No Data") alert("讀取數據失敗");
    } finally {
        btn.innerHTML = originalBtnText;
        btn.disabled = false;
    }
}
   

    // --- 輔助函式：處理原始數據 (保持原有邏輯，無需變動，但需確保它存在) ---
    function processRawData(data, scope, mode, selectedStudent) {
        let agg = {};
        let globalUniqueSet = new Set();
        let grandTotalVisits = 0;
        let grandTotalDuration = 0;
 
        function proc(node, label) {
            if(!node) return;
            if(!agg[label]) agg[label] = { uniqueSet: new Set(), visits: 0, duration: 0 };
 
            if (node.students) {
                if (scope === 'class') {
                    const g = document.getElementById('statGrade').value;
                    const c = document.getElementById('statClass').value;
                    if(node.students[g] && node.students[g][c]) {
                            Object.keys(node.students[g][c]).forEach(sName => {
                            if (selectedStudent && sName !== selectedStudent) return;
                            const sData = node.students[g][c][sName];
                            const v = parseInt(sData.visits||0);
                            const t = parseInt(sData.duration||0);
                            agg[label].uniqueSet.add(sName);
                            agg[label].visits += v;
                            agg[label].duration += t;
                            globalUniqueSet.add(sName);
                            grandTotalVisits += v;
                            grandTotalDuration += t;
                        });
                    }
                } else {
                    Object.keys(node.students).forEach(gKey => {
                        Object.keys(node.students[gKey]).forEach(cKey => {
                            Object.keys(node.students[gKey][cKey]).forEach(sName => {
                                const sData = node.students[gKey][cKey][sName];
                                const uid = `${gKey}${cKey}_${sName}`;
                                const v = parseInt(sData.visits || 0);
                                const t = parseInt(sData.duration || 0);
                                agg[label].uniqueSet.add(uid);
                                agg[label].visits += v;
                                agg[label].duration += t;
                                globalUniqueSet.add(uid);
                                grandTotalVisits += v;
                                grandTotalDuration += t;
                            });
                        });
                    });
                }
            }
            if (scope === 'global' && node.guests) {
                Object.keys(node.guests).forEach(guestID => {
                    const gData = node.guests[guestID];
                    const v = parseInt(gData.visits || 0);
                    const t = parseInt(gData.duration || 0);
                    agg[label].uniqueSet.add(guestID);
                    agg[label].visits += v;
                    agg[label].duration += t;
                    globalUniqueSet.add(guestID);
                    grandTotalVisits += v;
                    grandTotalDuration += t;
                });
            }
        }
 
        if(mode==='day') proc(data, '本日');
        else if(mode==='month') Object.keys(data).sort().forEach(k=>proc(data[k], parseInt(k)+'日'));
        else if(mode==='year') Object.keys(data).sort().forEach(mk=>{ Object.keys(data[mk]).forEach(dk=>proc(data[mk][dk], parseInt(mk)+'月')); });
 
        document.getElementById('dispUnique').innerText = globalUniqueSet.size;
        document.getElementById('dispVisits').innerText = grandTotalVisits;
        document.getElementById('dispDuration').innerText = Math.round(grandTotalDuration/60);
        document.getElementById('dispAvg').innerText = globalUniqueSet.size ? Math.round((grandTotalDuration/60)/globalUniqueSet.size) : 0;
 
        renderAnalyticsChart(agg);
    }

    // --- 輔助函式：渲染詳細圖表 (保持原有邏輯) ---
    function renderAnalyticsChart(agg) {
        const labels = Object.keys(agg);
        const uniqueData = Object.values(agg).map(a => a.uniqueSet.size);
        const totalVisitsData = Object.values(agg).map(a => a.visits);
        const durationData = Object.values(agg).map(a => Math.round(a.duration/60));
 
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        analyticsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '訪問次數', data: totalVisitsData, backgroundColor: '#94a7b5', order: 2 },
                    { label: '訪問人數', data: uniqueData, backgroundColor: '#b6a6ca', order: 1 },
                    { label: '總時長(分)', data: durationData, type: 'line', borderColor: '#d69a92', backgroundColor:'#d69a92', yAxisID: 'y1', order: 0 }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, position: 'left' },
                    y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        });
    }
 
    // --- 輔助函式：渲染簡易圖表 (給 Summary 模式用) ---
    function renderSimpleChart(sData, mode) {
        // 這裡需要根據 sData 的結構將其轉換為圖表數據
        // 如果是月份模式，sData key 是日期；如果是年份模式，sData key 是月份
        let labels = Object.keys(sData).sort((a,b)=>parseInt(a)-parseInt(b));
        let visitsData = [];
        
        labels.forEach(k => {
            // 簡單累加該節點下的 visits
            let v = 0;
            function sumV(n) { if(n.visits) v+=parseInt(n.visits); if(typeof n==='object') Object.values(n).forEach(c=>typeof c==='object'?sumV(c):null); }
            sumV(sData[k]);
            visitsData.push(v);
        });
 
        const ctx = document.getElementById('analyticsChart').getContext('2d');
        analyticsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => l + (mode==='year'?'月':'日')),
                datasets: [{ label: '訪問次數 (快速預覽)', data: visitsData, backgroundColor: '#94a7b5' }]
            },
            options: { maintainAspectRatio: false }
        });
    }
    // === 共用功能與共用 HTML 解析函式 ===
// === 修訂：開啟歷史視窗 (接收傳入的數據) ===
function openHistoryModal(name, historyArray) {
    console.log(`[系統] 開啟 ${name} 的紀錄，共 ${historyArray.length} 筆`);
 
    const modal = document.getElementById('historyViewerModal');
    const title = document.getElementById('viewerTitle');
 
    if (!modal || !title) return;
 
    document.body.appendChild(modal);
    modal.style.zIndex = "99999";
 
    title.innerHTML = `<i class="fas fa-user-graduate"></i> ${name}`;
    
    // 更新全域變數 (供 renderLevel1 等函式使用)
    currentStudentHistory = historyArray;
    
    modal.style.display = 'flex';
    
    // 渲染第一層
    renderLevel1();
}
    
    // 渲染主範疇 (已修訂：隱藏學習報告)
  // === 修訂後的 renderLevel1 (移除黑白濾鏡) ===
function renderLevel1() {
    ['historyLevel2','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('historyLevel1').style.display='flex'; 
    document.getElementById('teacherBreadcrumb').style.display='none';
    
    const c = document.getElementById('historyLevel1'); 
    c.innerHTML='';
    
    Object.keys(HISTORY_STRUCTURE).forEach(cat => {
        // 隱藏學習報告 (保持原本邏輯)
        if (cat === '學習報告') return;

        const count = currentStudentHistory.filter(r => r.category === cat).length;
        const asset = CATEGORY_ASSETS[cat] || { img: '背景.png', en: 'RECORD' };
        
        // ★ 修改處：直接移除 style 變數，或者只保留透明度但不變黑白
        // 這裡我將 style 設為空字串，這樣圖片永遠是彩色的
        const style = ''; 

        // 如果你希望沒資料時稍微半透明，但保持彩色，可以用下面這行取代上面那行：
        // const style = count === 0 ? 'opacity: 0.8;' : '';

        c.innerHTML += `<div class="anime-card" style="--bg-img: url('${asset.img}'); ${style}" onclick="renderLevel2('${cat}')"><div class="card-overlay"></div><div class="card-content"><span class="card-zh">${cat}</span><span class="card-en">${count} 筆</span></div></div>`;
    });
}

    
    function renderLevel2(cat) {
        currentCategory=cat; ['historyLevel1','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('historyLevel2').style.display='grid'; updateBreadcrumb(cat);
        const c = document.getElementById('historyLevel2'); c.innerHTML='';
        const subs = HISTORY_STRUCTURE[cat] || [];
        subs.forEach((sub,i)=>{
            const count=currentStudentHistory.filter(r=>r.category===cat&&r.subFunction===sub).length;
            const theme=(i%5)+1;
            c.innerHTML+=`<div class="history-folder-btn history-theme-${theme}" style="${count===0?'opacity:0.6':''}" onclick="renderLevel3('${sub}',${theme})"><i class="fas ${SUB_ICONS[sub]||'fa-file'}"></i><span style="font-weight:bold;font-size:1.1em;">${sub}</span><span style="font-size:0.8em;margin-top:5px;color:#999;">(${count})</span></div>`;
        });
    }
    function renderLevel3(sub, theme) {
        currentSubFunction=sub; currentThemeIndex=theme; ['historyLevel1','historyLevel2','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('historyLevel3').style.display='grid'; updateBreadcrumb(currentCategory,sub);
        const c=document.getElementById('historyLevel3'); c.innerHTML='';
        const recs=currentStudentHistory.filter(r=>r.category===currentCategory&&r.subFunction===sub).sort((a,b)=>b.timestamp-a.timestamp);
        if(recs.length===0){c.innerHTML='<p style="text-align:center;width:100%;color:#999;grid-column:1/-1;">無紀錄</p>';return;}
        recs.forEach(r=>{
            // ★★★ 核心修改：使用與學生端一致的卡片結構 (打孔風格) ★★★
            const dateStr = r.dateStr ? r.dateStr.split(' ')[0] : '未知';
            
            c.innerHTML+=`
            <div class="history-card theme-${theme}" onclick='renderDetail(${JSON.stringify(r).replace(/'/g, "&#39;")})'>
                <div style="flex-grow: 1;">
                    <div class="history-meta">
                        <span class="tag" style="background:var(--m-color-${theme}); color:white; border:none; margin:0;">${r.subFunction}</span>
                        <span style="font-family: 'Courier New', monospace; font-size: 0.85em; color: #aaa; margin-left: auto;">${dateStr}</span>
                    </div>
                    <h4 class="history-title">${r.title||'無標題'}</h4>
                </div>
            </div>`;
        });
    }
    
   // 共用解析函式 (修正版：保留學生分段空行)
    function renderParsedUserContent(userContent, themeIndex = 1) {
        if (!userContent) return '<div style="padding:20px; color:#999; text-align:center;">無使用者輸入內容</div>';
        
        const lines = userContent.split('\n');
        let html = `<div class="history-parsed-container history-theme-context-${themeIndex}">`;
        let currentLabel = '輸入內容'; 
        let currentContent = []; 
        const labelRegex = /^(.{2,10}?)[：:](.*)$/;
        
        lines.forEach((line) => {
            const match = line.match(labelRegex);
            if (match) {
                // 如果遇到新標籤，先輸出上一段累積的內容
                if (currentContent.length > 0) {
                    // ★ 這裡使用 trim() 去除頭尾多餘空白，但中間的換行會因為 join('\n') 與 CSS pre-wrap 被保留
                    html += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${currentContent.join('\n')}</div></div>`;
                }
                currentLabel = match[1].trim(); 
                const rest = match[2].trim(); 
                // 如果標籤後有內容，直接放入；如果沒有，陣列保持空
                currentContent = rest ? [rest] : [];
            } else {
                // ★★★ 關鍵修改處 ★★★
                // 原本是： else if (line.trim() !== "") { currentContent.push(line); }
                // 修改為： 直接 push(line)，不再過濾空行
                // 這樣學生按 Enter 產生的空字串才會被保留下來，形成分段
                currentContent.push(line);
            }
        });

        // 處理最後一段
        if (currentContent.length > 0 || lines.length === 0) {
             const finalContent = currentContent.length > 0 ? currentContent.join('\n') : userContent;
             html += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${finalContent}</div></div>`;
        }
        
        html += `</div>`;
        return `<div style="background:#fff;padding:20px;border:1px solid #eee;border-radius:12px;margin-bottom:25px; box-shadow:0 2px 10px rgba(0,0,0,0.03);">${html}</div>`;
    }
    // 歷史紀錄詳情
// 歷史紀錄詳情 (修訂版：支援動態繪製 Canvas)
// ==========================================
// === 歷史紀錄詳情 (修訂版：議論指引專用優化) ===
// ==========================================
function renderDetail(r) {
    ['historyLevel1','historyLevel2','historyLevel3'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('historyDetail').style.display='block';
    document.getElementById('teacherBreadcrumb').style.display='none';
    
    let uContent = '';
    
    // 1. 處理使用者輸入內容 (userContent)
    if (r.category === "學習報告") {
        uContent = ''; 
    } 
    // ★★★ 特殊處理：議論指引的使用者輸入 (卡片式) ★★★
    else if (r.category === "議論" && r.subFunction === "指引" && r.userContent) {
        const lines = r.userContent.split('\n');
        let cardsHTML = '';
        let topicTitle = '';

        lines.forEach(line => {
            if (line.startsWith('題目：')) {
                topicTitle = line.replace('題目：', '').trim();
            } else {
                const parts = line.split(/[:：]/);
                if (parts.length >= 2) {
                    const label = parts[0].trim();
                    const content = parts.slice(1).join('：').trim();
                    if (content && content !== '（未輸入）') {
                        cardsHTML += `
                        <div class="history-item-block" style="background:#fdfcf8; border:1px solid #e0ddd7; border-radius:8px; padding:15px; margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.03);">
                            <div class="history-item-label" style="font-size:0.9rem; color:#888; margin-bottom:8px; border-bottom:1px dashed #e0e0e0; padding-bottom:5px;">${label}</div>
                            <div class="history-item-content" style="background:transparent; border:none; padding:0; font-size:1.1rem; color:#444;">${content}</div>
                        </div>`;
                    }
                }
            }
        });

        // 第一個區塊 (題目)
        let firstBlock = '';
        if (topicTitle) {
            firstBlock = `
            <div class="history-item-block" style="background:#f4f6f9; border-left:4px solid var(--m-color-3); border-radius:8px; padding:15px; margin-bottom:15px;">
                <div class="history-item-label" style="color:#888;">題目</div>
                <div class="history-item-content" style="background:transparent; border:none; padding:0; font-size:1.2rem; font-weight:bold; color:#333;">${topicTitle}</div>
            </div>`;
        }

        uContent = `
            <div style="background:#fff; padding:20px; border-radius:12px; margin-bottom:25px; border:1px solid #eee; box-shadow: 0 4px 20px rgba(0,0,0,0.04);">
                <div class="history-parsed-container argument-guide-layout" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; border:none; box-shadow:none; padding:0;">
                    <div style="grid-column: 1 / -1;">${firstBlock}</div>
                    ${cardsHTML}
                </div>
            </div>`;
    }
    // 一般情況
    else {
        if(r.userContent) {
            // 決定主題色
            let themeIndex = 1;
            if (HISTORY_STRUCTURE[r.category]) {
                const subIndex = HISTORY_STRUCTURE[r.category].indexOf(r.subFunction);
                if (subIndex !== -1) themeIndex = (subIndex % 5) + 1;
            }
            uContent = renderParsedUserContent(r.userContent, themeIndex);
        } else {
            uContent = `<div style="padding:20px; color:#999; text-align:center;">無使用者輸入內容</div>`;
        }
    }

    // 2. 處理 AI 生成內容 (aiContent)
    let aiHtml = r.aiContent;

    // ★★★ 特殊處理：修復議論指引的 AI 內容顯示 ★★★
    // 如果是舊格式 (純文字或未被 div 包裹)，嘗試重新包裝
    if (r.category === "議論" && r.subFunction === "指引") {
        // 如果內容不包含 morandi-guide-container，代表可能是舊資料，嘗試手動格式化
        if (aiHtml && !aiHtml.includes('morandi-guide-container')) {
            // 嘗試解析原始 HTML 結構 (通常是 <h3>...</h3><p>...</p>)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = aiHtml;
            
            let newHtml = `<div class="morandi-guide-container">`;
            
            // 提取標題 (如果有)
            const h3s = tempDiv.querySelectorAll('h3');
            if (h3s.length > 0) {
                // 假設第一個 h3 是總標題，或者是分段標題
                // 這裡做一個簡單的轉換：將所有 h3 + p 轉為卡片
                
                // 尋找所有 "參考..." 的區塊
                const sections = aiHtml.split(/(?=###|<h3>)/);
                
                sections.forEach(sec => {
                    // 移除 HTML 標籤取純文字標題
                    let title = "指引內容";
                    let content = sec;
                    
                    const titleMatch = sec.match(/<h3>(.*?)<\/h3>/) || sec.match(/###\s*(.*)/);
                    if (titleMatch) {
                        title = titleMatch[1].trim();
                        content = sec.replace(titleMatch[0], '');
                    }
                    
                    // 清理內容標籤
                    content = content.replace(/<p>/g, '').replace(/<\/p>/g, '<br>').trim();
                    
                    if (content) {
                        newHtml += `
                        <div class="guide-section-card">
                            <div class="guide-card-header">${title}</div>
                            <div class="guide-card-body">${content}</div>
                        </div>`;
                    }
                });
            } else {
                // 如果完全沒有標題結構，直接包在一個卡片裡
                newHtml += `
                <div class="guide-section-card">
                    <div class="guide-card-header">AI 指引</div>
                    <div class="guide-card-body">${aiHtml}</div>
                </div>`;
            }
            
            newHtml += `</div>`;
            aiHtml = newHtml;
        }
        
        // 如果內容已經包含 morandi-guide-container (新資料)，
        // 我們只需要確保它的 CSS class 能在教師端生效即可 (CSS 已在第一步加入)
    }

    // 3. 渲染 HTML 結構
    document.getElementById('historyDetail').innerHTML = `
        <div style="margin-bottom:15px;">
            <button class="nav-btn" onclick="renderLevel3('${currentSubFunction}',${currentThemeIndex})" style="padding:5px 15px;font-size:0.9em;">
                <i class="fas fa-arrow-left"></i> 返回列表
            </button>
        </div>
        <div class="detail-view">
            <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                <h2 style="text-align:left; margin:0; color:#333;">${r.title}</h2>
                <p style="color:#888; margin-top:5px;">${r.dateStr || ''}</p>
            </div>
            ${uContent}
            <div class="detail-ai-box" style="margin-top:20px;" id="aiContentContainer">
                <h4 style="color:var(--m-green); margin-bottom:10px;">AI 生成結果：</h4>
                ${aiHtml}
            </div>
        </div>`;

    // 4. 重繪圖表邏輯 (保持不變)
    setTimeout(() => {
        const container = document.getElementById('aiContentContainer');
        if (!container) return;
        
        let prefix = '';
        if (r.category === '敘事抒情') prefix = 'narrative';
        else if (r.category === '議論') prefix = 'argument';

        if (prefix && r.scoreData) {
            // (分數還原邏輯省略，與原代碼相同)
        }

        if (r.category !== "學習報告" && r.scoreData && r.scoreData.radar) {
            const canvas = container.querySelector('canvas');
            if (canvas) {
                const parent = canvas.parentNode;
                parent.style.height = '350px'; 
                parent.style.position = 'relative';

                new Chart(canvas.getContext('2d'), {
                    type: 'radar',
                    data: {
                        labels: ['立意', '取材', '扣題', '詳略', '詞彙', '文學性'],
                        datasets: [{
                            label: '能力分佈',
                            data: [
                                r.scoreData.radar.立意, r.scoreData.radar.取材, r.scoreData.radar.扣題,
                                r.scoreData.radar.詳略, r.scoreData.radar.詞彙, r.scoreData.radar.文學性
                            ],
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2 } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        else if (r.category === "學習報告" && r.scoreData) {
            // (學習報告圖表邏輯省略，與原代碼相同)
            if (r.scoreData["敘事抒情"]?.radar) {
                const narrBadge = container.querySelector('.badge-narrative');
                if (narrBadge) {
                    const section = narrBadge.closest('.report-section');
                    const narrCanvas = section ? section.querySelector('canvas') : null;
                    if (narrCanvas) drawReportChart(narrCanvas, r.scoreData["敘事抒情"].radar);
                }
            }
            if (r.scoreData["議論"]?.radar) {
                const argBadge = container.querySelector('.badge-argument');
                if (argBadge) {
                    const section = argBadge.closest('.report-section');
                    const argCanvas = section ? section.querySelector('canvas') : null;
                    if (argCanvas) drawReportChart(argCanvas, r.scoreData["議論"].radar);
                }
            }
        }
    }, 150);
}

// 輔助函數：繪製報告圖表
// 輔助函數：繪製報告圖表 (通用)
function drawReportChart(canvas, radarData) {
    // 確保父容器有高度，否則 Canvas 會縮成 0
    const parent = canvas.parentNode;
    parent.style.height = '320px'; 
    parent.style.width = '100%';
    parent.style.position = 'relative';

    new Chart(canvas.getContext('2d'), {
        type: 'radar',
        data: {
            labels: ['立意', '取材', '扣題', '詳略', '詞彙', '文學性'],
            datasets: [{
                label: '平均能力',
                data: radarData, // 報告的 radar 數據已經是 array 格式 [7.0, 6.5, ...]
                backgroundColor: 'rgba(94, 112, 103, 0.4)',
                borderColor: '#5e7067',
                borderWidth: 2,
                pointBackgroundColor: '#5e7067'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: { 
                    suggestedMin: 0, 
                    suggestedMax: 10, 
                    ticks: { display: false },
                    pointLabels: { font: { size: 12, family: "'Noto Serif TC', serif" } }
                }
            },
            plugins: { legend: { display: false } }
        }
    });
}

    
    function updateBreadcrumb(c,s) { const b=document.getElementById('teacherBreadcrumb'); b.style.display='flex'; document.getElementById('breadCategory').innerText=c; document.getElementById('breadSub').innerText=s||''; document.getElementById('breadSep2').style.display=s?'inline':'none'; }
    
    // === 課業管理 ===
function loadAssignmentHistory() {
    const gradeSelect = document.getElementById('assignGrade');
    const classSelect = document.getElementById('assignClass');
 
    // 自動鎖定邏輯
    if (gradeSelect.value === 'System') {
        classSelect.value = 'Test';
        classSelect.disabled = true;
    } else {
        classSelect.disabled = false;
        if (classSelect.value === 'Test') classSelect.value = 'A';
    }
 
    const g = gradeSelect.value;
    const c = classSelect.value;
    const list = document.getElementById('assignmentHistoryList');
    
    list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> 載入中...</p>';
    
    db.ref(`assignments/${g}/${c}`).on('value', (snapshot) => {
        const data = snapshot.val();
        list.innerHTML = '';
        if (!data) { list.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc;">無課業</div>'; return; }
        
        Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp).forEach(([key, task]) => {
            const div = document.createElement('div');
            div.className = 'assignment-item';
            const safeTopic = task.topic.replace(/'/g, "\\'");
 
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold;">${task.topic}</div>
                    <div style="font-size:0.9em;color:#888;">
                        <span class="tag">${task.type}</span>${new Date(task.timestamp).toLocaleDateString()}
                    </div>
                </div>
                <div style="display:flex;gap:10px;">
                    <!-- 檢閱按鈕 -->
                    <button class="btn-action btn-view" title="線上檢閱" onclick="viewSubmissions('${key}', '${safeTopic}', '${g}', '${c}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    <!-- ★★★ 新增：下載 ZIP 按鈕 ★★★ -->
                    <button class="btn-action btn-manage" title="下載全班 HTML (ZIP)" style="background-color: var(--m-green);" onclick="downloadAssignmentZip('${key}', '${safeTopic}', '${g}', '${c}')">
                        <i class="fas fa-file-archive"></i>
                    </button>
 
                    <!-- 刪除按鈕 -->
                    <button class="btn-action btn-delete" title="刪除課業" onclick="deleteAssignment('${key}', '${g}', '${c}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>`;
            list.appendChild(div);
        });
    });
}

    
    function publishAssignment() {
        const g = document.getElementById('assignGrade').value, c = document.getElementById('assignClass').value, topic = document.getElementById('assignTopic').value.trim(), type = document.getElementById('assignType').value;
        if (!topic) return alert("請輸入題目");
        db.ref(`assignments/${g}/${c}`).push().set({ topic, type, timestamp: Date.now() }, e => { if(e) alert("失敗"); else { sendClassNotification(g, c, "新課業發佈", `老師發佈了：${topic}`); alert("發佈成功"); document.getElementById('assignTopic').value=''; } });
    }
   // === 修改後的刪除函式 ===
    function deleteAssignment(id, g, c) { 
        if(confirm("確定刪除此課業？\n警告：這將一併刪除所有學生的提交紀錄且無法復原。")) { 
            const updates = {};
            // 1. 刪除課業本身的設定檔
            updates[`assignments/${g}/${c}/${id}`] = null;
            // 2. 同步刪除該課業的所有提交紀錄
            updates[`assignments_submissions/${id}`] = null;
            
            db.ref().update(updates)
              .then(() => console.log("刪除成功"))
              .catch(e => alert("刪除失敗：" + e.message));
        } 
    }
    
// 1. [修正] 檢閱列表：修復 404 錯誤，確保正確讀取名單
async function viewSubmissions(aid, title, g, c) {
    currentViewingAssignmentId = aid;
    
    // 記錄當前環境，供單一下載使用
    currentAssignmentContext = { topic: title, grade: g, class: c };
 
    const modal = document.getElementById('submissionViewerModal');
    const titleEl = document.getElementById('submissionTitle');
 
    if (!modal) return alert("錯誤：找不到檢閱視窗");
 
    document.body.appendChild(modal);
    modal.style.zIndex = "99999";
    
    titleEl.innerText = title;
    modal.style.display = 'flex';
    
    const list = document.getElementById('submissionList');
    list.innerHTML = '<li style="padding:20px; text-align:center; color:#999;"><i class="fas fa-spinner fa-spin"></i> 讀取名單中...</li>';
    
    // 清空詳情區域
    document.getElementById('submissionDetailArea').innerHTML = `
        <div style="text-align:center; color:#ccc; margin-top:100px;">
            <i class="far fa-file-alt" style="font-size:48px;"></i>
            <p>請從左側選擇學生<br><span style="font-size:0.8em">(點擊後將下載該生作業)</span></p>
        </div>`;
 
    try {
        const user = firebase.auth().currentUser;
        if (!user) throw new Error("未登入");
        const token = await user.getIdToken();
 
        // ★★★ 修正 404：使用您正確的資料庫網址 ★★★
        const dbUrl = "https://sansidata-default-rtdb.firebaseio.com";
        
        // 平行執行：(A) 抓全班名單 (B) 用 REST API 抓 "誰交了" (Shallow Fetch)
        const [stusSnap, subKeysResp] = await Promise.all([
            db.ref(`students/${g}/${c}`).once('value'),
            fetch(`${dbUrl}/assignments_submissions/${aid}.json?shallow=true&auth=${token}`)
        ]);
 
        const stus = stusSnap.val() || {};
        let subKeys = {};
        
        // 處理 REST API 回傳結果
        if (subKeysResp.ok) {
            subKeys = await subKeysResp.json() || {};
        } else {
            console.warn("REST API 讀取失敗，改用 SDK 讀取 (流量可能稍大)");
            // 如果 REST API 失敗 (例如權限問題)，回退使用 SDK (保險起見)
            const fallbackSnap = await db.ref(`assignments_submissions/${aid}`).shallow().once('value').catch(()=>({val:()=>({})}));
            // 注意：Firebase JS SDK 不支援 shallow()，這裡僅為示意，若 REST 失敗通常是 401/403。
            // 這裡我們假設 REST 成功，若失敗 subKeys 為空，顯示未繳交。
        }
 
        list.innerHTML = '';
        let done = 0, total = 0;
        
        Object.entries(stus)
            .sort((a,b)=>(parseInt(a[1].profile?.number)||99)-(parseInt(b[1].profile?.number)||99))
            .forEach(([name, d]) => {
                total++;
                const hasSub = subKeys && subKeys.hasOwnProperty(name);
                if(hasSub) done++;
                
                const li = document.createElement('li');
                li.className = 'submission-item';
                li.innerHTML = `<span>${d.profile?.number||'??'}. ${name}</span> ${hasSub ? '<span class="status-badge status-done">已繳交</span>' : '<span class="status-badge status-pending">未繳交</span>'}`;
                
                // ★ 這裡呼叫 loadAndShowStudentSubmission
                li.onclick = () => {
                    document.querySelectorAll('.submission-item').forEach(i=>i.classList.remove('active'));
                    li.classList.add('active');
                    
                    if(hasSub) {
                        loadAndShowStudentSubmission(aid, name);
                    } else {
                        document.getElementById('submissionDetailArea').innerHTML = `<div style="text-align:center;margin-top:50px; color:#a67069;"><p>${name} 尚未繳交作業</p></div>`;
                    }
                };
                list.appendChild(li);
            });
            
        document.getElementById('submitCount').innerText = done;
        document.getElementById('pendingCount').innerText = total - done;
 
    } catch(e) {
        console.error(e);
        list.innerHTML = `<li style="color:red; padding:15px;">載入失敗: ${e.message}</li>`;
    }
}


    // 2. [補回] 單一學生下載邏輯 (您之前可能漏了這個)
async function loadAndShowStudentSubmission(aid, studentName) {
    const area = document.getElementById('submissionDetailArea');
    
    // 顯示讀取中動畫
    area.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#666;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:3em; margin-bottom:15px; color:var(--m-green);"></i>
            <div>正在下載 <b>${studentName}</b> 的作業...</div>
        </div>
    `;
 
    try {
        // 精準下載：只抓 assignments_submissions/{aid}/{studentName}
        const snapshot = await db.ref(`assignments_submissions/${aid}/${studentName}`).once('value');
        const subData = snapshot.val();
 
        if (!subData) {
            area.innerHTML = `<div style="text-align:center; margin-top:50px;">資料讀取錯誤 (可能已被刪除)</div>`;
            return;
        }
 
        // 下載完成，呼叫渲染函式
        renderSubmissionDetail(subData);
 
    } catch (e) {
        area.innerHTML = `<div style="text-align:center; color:red; margin-top:50px;">下載失敗: ${e.message}</div>`;
    }
}
    // 課業詳情檢閱 (修訂：確保與歷史紀錄顯示一致)
 // === 修正後的課業詳情檢閱函式 (修復雷達圖顯示) ===
// 3. [補回] 渲染介面 (取代原本的 showSubDetail)
function renderSubmissionDetail(sub) {
    // 儲存當前學生資料 (供單一下載使用)
    window.currentViewingSub = sub;
 
    const fb = sub.teacherFeedback || {};
    let uContent = renderParsedUserContent(sub.userContent, 1);
 
    document.getElementById('submissionDetailArea').innerHTML = `
        <div class="detail-view" style="animation: fadeIn 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>${sub.studentName}</h2>
                <button class="btn-action" style="background-color:var(--m-green); padding:8px 15px;" onclick="downloadSingleSubmission('${sub.studentName}')">
                    <i class="fas fa-download"></i> 下載此份作業 (HTML)
                </button>
            </div>
            
            <div style="font-size:0.9em; color:#888; margin-bottom:10px;">提交時間：${sub.submittedAt}</div>
            ${uContent}
            
            <div class="detail-ai-box" style="margin-top:20px;" id="subAiContentBox">
                <h4 style="color:var(--m-green); margin-bottom:10px;">AI 分析結果：</h4>
                ${sub.aiContent}
            </div>
 
            <div class="teacher-feedback-section">
                <h3><i class="fas fa-pen-alt"></i> 老師批改</h3>
                <div style="margin-bottom:15px;">
                    <label style="font-weight:bold; color:#8d6e63;">分數：</label>
                    <input id="ts" value="${fb.score||''}" placeholder="例如：5**" type="text">
                </div>
                <div style="margin-bottom:15px;">
                    <label style="font-weight:bold; color:#8d6e63;">評語：</label>
                    <textarea id="tc" rows="3" placeholder="請輸入評語...">${fb.comment||''}</textarea>
                </div>
                <button class="btn-action btn-manage" onclick="sendFb('${sub.studentName}')">發還給學生</button>
            </div>
        </div>`;
 
    setTimeout(() => {
        const container = document.getElementById('subAiContentBox');
        if (!container || !sub.scoreData) return;
 
        let canvas = container.querySelector('canvas');
        if (!canvas) {
            const chartWrapper = document.createElement('div');
            chartWrapper.style.height = '350px';
            chartWrapper.style.position = 'relative';
            chartWrapper.style.marginTop = '20px';
            chartWrapper.style.marginBottom = '20px';
            chartWrapper.innerHTML = '<canvas id="assignmentRadarCanvas"></canvas>';
            container.insertBefore(chartWrapper, container.firstChild.nextSibling);
            canvas = chartWrapper.querySelector('canvas');
        } else {
            canvas.parentNode.style.height = '350px';
            canvas.parentNode.style.position = 'relative';
        }
 
        let radarData = null;
        if (sub.scoreData.radar) radarData = [sub.scoreData.radar.立意, sub.scoreData.radar.取材, sub.scoreData.radar.扣題, sub.scoreData.radar.詳略, sub.scoreData.radar.詞彙, sub.scoreData.radar.文學性];
        else if (sub.scoreData["敘事抒情"]?.radar) radarData = sub.scoreData["敘事抒情"].radar;
        else if (sub.scoreData["議論"]?.radar) radarData = sub.scoreData["議論"].radar;
 
        if (radarData && canvas) {
            new Chart(canvas.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['立意', '取材', '扣題', '詳略', '詞彙', '文學性'],
                    datasets: [{
                        label: '能力分佈',
                        data: radarData,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2 } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    }, 100);
}
    
    function sendFb(name) { db.ref(`assignments_submissions/${currentViewingAssignmentId}/${name}/teacherFeedback`).set({score:document.getElementById('ts').value, comment:document.getElementById('tc').value, timestamp:Date.now(), status:'returned'}, e=>alert(e?'失敗':'成功')); }

    // === 學年管理 ===
    function populateTransferStudentList() {
        const g=document.getElementById('indivFromGrade').value, c=document.getElementById('indivFromClass').value, b=document.getElementById('transferStudentListBox'); b.innerHTML='載入中...';
        db.ref(`students/${g}/${c}`).once('value', s=>{
            const d=s.val(); b.innerHTML=''; if(!d) { b.innerHTML='無學生'; return; }
            Object.entries(d).sort((a,b)=>(parseInt(a[1].profile?.number)||99)-(parseInt(b[1].profile?.number)||99)).forEach(([n,i])=>{ b.innerHTML+=`<label class="student-select-item"><input type="radio" name="ts" value="${n}"> ${i.profile?.number||'??'}. ${n}</label>`; });
        });
    }
 // === 修訂：個別轉班 (同步更新 Email Mapping) ===
async function moveIndividualStudent() {
    const n = document.querySelector('input[name="ts"]:checked')?.value;
    if (!n) return alert("請選擇學生");
    
    const fg = document.getElementById('indivFromGrade').value;
    const fc = document.getElementById('indivFromClass').value;
    const tg = document.getElementById('indivToGrade').value;
    const tc = document.getElementById('indivToClass').value;
    
    if (fg === tg && fc === tc) return alert("來源與目標班級相同，無需調動。");
 
    const oldPath = `students/${fg}/${fc}/${n}`;
    const newPath = `students/${tg}/${tc}/${n}`;
    
    try {
        // 1. 讀取學生完整資料
        const snapshot = await db.ref(oldPath).once('value');
        const data = snapshot.val();
        if (!data) return alert("找不到學生資料");
 
        // 2. 更新 Profile
        if (!data.profile) data.profile = {};
        data.profile.grade = tg;
        data.profile.class = tc;
        data.profile.number = ""; // 清空班號，讓學生自己填
 
        // 3. 準備原子更新 (Atomic Update)
        const updates = {};
        
        // A. 寫入新位置
        updates[newPath] = data;
        
        // B. 刪除舊位置
        updates[oldPath] = null;
 
        // C. ★★★ 關鍵：更新 Email Mapping 指向新位置 ★★★
        if (data.profile.email) {
            const emailKey = btoa(data.profile.email);
            // 只需要更新 Mapping 中的 grade, class, number
            updates[`email_mapping/${emailKey}/grade`] = tg;
            updates[`email_mapping/${emailKey}/class`] = tc;
            updates[`email_mapping/${emailKey}/number`] = ""; // 索引中也清空班號
        }
 
        // 4. 執行更新
        await db.ref().update(updates);
 
        alert(`✅ 轉班成功！\n${n} 已從 ${fg}${fc} 調動至 ${tg}${tc}。\n學生下次登入時將自動彈出更新班號視窗。`);
        populateTransferStudentList();
 
    } catch (e) {
        console.error("轉班失敗", e);
        alert("轉班失敗：" + e.message);
    }
}



// === 核心：新學年過渡邏輯 (徹底清理版) ===

// === 1. 例外處理區邏輯 ===

function loadExceptionList() {
    const g = document.getElementById('exceptionGrade').value;
    const c = document.getElementById('exceptionClass').value;
    const container = document.getElementById('exceptionList');
    
    container.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 載入中...';
    
    db.ref(`students/${g}/${c}`).once('value', snapshot => {
        const data = snapshot.val();
        container.innerHTML = '';
        
        if (!data) {
            container.innerHTML = '<div style="color:#999; padding:10px;">此班級無學生</div>';
            return;
        }
        
        Object.entries(data).forEach(([name, student]) => {
            const num = student.profile?.number || '?';
            const label = document.createElement('label');
            label.style.cssText = "display:flex; align-items:center; padding:5px; cursor:pointer; hover:background:#eee;";
            label.innerHTML = `
                <input type="checkbox" class="exception-check" value="${name}" style="margin-right:8px;">
                <span>(${num}) ${name}</span>
            `;
            container.appendChild(label);
        });
    });
}

async function moveSelectedToPending() {
    const g = document.getElementById('exceptionGrade').value;
    const c = document.getElementById('exceptionClass').value;
    const checks = document.querySelectorAll('.exception-check:checked');
    
    if (checks.length === 0) return alert("請先勾選學生");
    if (!confirm(`確定將這 ${checks.length} 位學生移至待分班區？\n他們將不會隨大隊升班。`)) return;
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
 
    const updates = {};
    
    try {
        // 批次讀取並準備移動
        for (const chk of checks) {
            const name = chk.value;
            const snap = await db.ref(`students/${g}/${c}/${name}`).once('value');
            const sData = snap.val();
            
            if (sData) {
                // 1. 清空班號
                if (sData.profile) sData.profile.number = "";
                
                // ★★★ 2. 強制刪除歷史紀錄 (Clean Slate) ★★★
                if (sData.history) delete sData.history;
                
                // 3. 寫入 Pending 區
                updates[`pending_allocation/${name}`] = sData;
                
                // 4. 從原班級移除
                updates[`students/${g}/${c}/${name}`] = null;
            }
        }
        
        await db.ref().update(updates);
        
        alert("✅ 已成功移至待分班區 (歷史紀錄已清除)");
        
        loadExceptionList();
        if (typeof checkAndRenderPendingPanel === 'function') {
            checkAndRenderPendingPanel();
        }
 
    } catch (error) {
        console.error("移動失敗:", error);
        alert("移動失敗：" + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}


// === 2. 一鍵升級邏輯 (核心修訂) ===

// === 核心邏輯更新：學年過渡 ===
// === 核心邏輯更新：學年過渡 (修復 NaN 與特殊帳號問題) ===
async function runYearTransition() {
    if (prompt("請輸入密碼以確認清除舊紀錄並升班：") !== "23262036") return;
    
    if (!confirm("確定執行？\n警告：\n1. 中六學生將被移除 (及其索引)\n2. 中三學生移至待分班 (移除索引，等待分配)\n3. 其他學生升級 (同步更新索引)\n4. 特殊帳號 (System/Special) 將保留")) return;
 
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
 
    try {
        const snapshot = await db.ref('students').once('value');
        const allStudents = snapshot.val() || {};
 
        let newStudentsMap = {};
        let pendingMap = {};
        let mappingUpdates = {}; // 用於收集所有 Email Mapping 的變更
 
        for (const grade in allStudents) {
            const g = parseInt(grade);
 
            // 保留 System / Special 帳號
            if (isNaN(g)) {
                newStudentsMap[grade] = allStudents[grade];
                continue;
            }
 
            for (const cls in allStudents[grade]) {
                const studentsInClass = allStudents[grade][cls];
                for (const studentName in studentsInClass) {
                    const studentData = studentsInClass[studentName];
                    const email = studentData.profile?.email;
                    const emailKey = email ? btoa(email) : null;
 
                    // A. 清空班號 & 刪除歷史
                    if (studentData.profile) studentData.profile.number = "";
                    if (studentData.history) delete studentData.history;
 
                    // B. 處理各年級邏輯
                    if (g === 6) {
                        // 中六畢業 -> 刪除 Mapping
                        if (emailKey) mappingUpdates[`email_mapping/${emailKey}`] = null;
                    }
                    else if (g === 3) {
                        // 中三 -> 待分班 -> 暫時刪除 Mapping (或保留但標記pending)
                        // 建議：暫時刪除 Mapping，讓學生無法登入，直到老師將其分配到新班級
                        // 這樣分配後，executeAllocation 會重新建立 Mapping
                        if (emailKey) mappingUpdates[`email_mapping/${emailKey}`] = null;
                        pendingMap[studentName] = studentData;
                    }
                    else {
                        // 其他年級 -> 升班 (1->2, 2->3, 4->5, 5->6)
                        const newG = (g + 1).toString();
                        
                        // 更新資料庫結構
                        if (studentData.profile) studentData.profile.grade = newG;
                        if (!newStudentsMap[newG]) newStudentsMap[newG] = {};
                        if (!newStudentsMap[newG][cls]) newStudentsMap[newG][cls] = {};
                        newStudentsMap[newG][cls][studentName] = studentData;
 
                        // ★★★ 關鍵：更新 Mapping 指向新位置 ★★★
                        if (emailKey) {
                            mappingUpdates[`email_mapping/${emailKey}/grade`] = newG;
                            mappingUpdates[`email_mapping/${emailKey}/class`] = cls;
                            mappingUpdates[`email_mapping/${emailKey}/number`] = "";
                        }
                    }
                }
            }
        }
 
        // 執行所有資料庫寫入
        const updates = {};
        updates['students'] = newStudentsMap;
        updates['pending_allocation'] = pendingMap;
        updates['assignments'] = null; // 清除舊功課
        updates['assignments_submissions'] = null;
        updates['class_reports'] = null;
        
        // 合併 Mapping 的更新
        Object.assign(updates, mappingUpdates);
 
        await db.ref().update(updates);
 
        alert("✅ 新學年過渡成功！\n- 中六已畢業刪除\n- 中三已移至待分班\n- 其他年級已升班\n- 所有 Email 索引已同步更新");
        
        checkAndRenderPendingPanel();
 
    } catch (e) {
        console.error(e);
        alert("失敗：" + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '開始新學年過渡';
    }
}

// === 重點：智慧型待分班面板渲染 ===
function checkAndRenderPendingPanel() {
    const panel = document.getElementById('pendingAllocationPanel');
    const s3List = document.getElementById('listS3Students');
    const retainList = document.getElementById('listRetainStudents');
    
    db.ref('pending_allocation').once('value', snapshot => {
        const data = snapshot.val();
        
        if (!data) {
            panel.style.display = 'none';
            return;
        }

        panel.style.display = 'block';
        s3List.innerHTML = '';
        retainList.innerHTML = '';

        // 建立排序陣列
        const entries = Object.entries(data).sort((a, b) => {
            // 先按班級排序，再按姓名/班號
            const clsA = a[1].profile?.class || '';
            const clsB = b[1].profile?.class || '';
            return clsA.localeCompare(clsB);
        });

        let s3Count = 0;
        let retainCount = 0;

        entries.forEach(([name, studentData]) => {
            const originalGrade = studentData.profile?.grade || "?";
            const originalClass = studentData.profile?.class || "?";
            
            // 建立卡片 HTML
            const card = document.createElement('label');
            card.style.cssText = "display: flex; align-items: center; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: background 0.2s;";
            card.onmouseover = () => card.style.background = "#f5f5f5";
            card.onmouseout = () => card.style.background = "#fff";

            // ★★★ 核心分流邏輯 ★★★
            // 如果原年級是 "3"，放入左邊 S3 列表
            // 如果原年級是 "1, 2, 4, 5, 6"，放入右邊 留班 列表
            if (String(originalGrade) === "3") {
                s3Count++;
                card.style.borderLeft = "4px solid #ffa726"; // 橙色邊條
                card.innerHTML = `
                    <input type="checkbox" class="chk-s3" value="${name}" style="transform: scale(1.3); margin-right: 12px; accent-color: #ef6c00;">
                    <div>
                        <div style="font-weight:bold; font-size:1.05em; color:#333;">${name}</div>
                        <div style="font-size: 0.85em; color: #888;">原班級: <span style="color:#e65100; font-weight:bold;">3${originalClass}</span></div>
                    </div>
                `;
                s3List.appendChild(card);
            } else {
                retainCount++;
                card.style.borderLeft = "4px solid #78909c"; // 藍灰色邊條
                card.innerHTML = `
                    <input type="checkbox" class="chk-retain" value="${name}" style="transform: scale(1.3); margin-right: 12px; accent-color: #546e7a;">
                    <div>
                        <div style="font-weight:bold; font-size:1.05em; color:#333;">${name}</div>
                        <div style="font-size: 0.85em; color: #888;">原班級: <span style="color:#455a64; font-weight:bold;">${originalGrade}${originalClass}</span></div>
                    </div>
                `;
                retainList.appendChild(card);
            }
        });

        if (s3Count === 0) s3List.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">無中三待分班學生</div>';
        if (retainCount === 0) retainList.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">無留班/特殊個案</div>';
    });
}

// === 功能 1：處理 S3 -> S4 分流 ===
async function allocateS3Students() {
    const targetClass = document.getElementById('targetS4Class').value; // A/B/C/D
    const checkboxes = document.querySelectorAll('.chk-s3:checked');
    
    if (checkboxes.length === 0) return alert("請選擇學生");
    if (!confirm(`確定將選取的 ${checkboxes.length} 名學生編入【中四 ${targetClass} 班】？`)) return;

    await executeAllocation(checkboxes, "4", targetClass);
}

// === 功能 2：處理留班/特殊轉班 ===
async function allocateRetainStudents() {
    const targetGrade = document.getElementById('targetRetainGrade').value;
    const targetClass = document.getElementById('targetRetainClass').value;
    const checkboxes = document.querySelectorAll('.chk-retain:checked');
    
    if (checkboxes.length === 0) return alert("請選擇學生");
    if (!confirm(`確定將選取的 ${checkboxes.length} 名學生編入【${targetGrade}${targetClass} 班】？`)) return;

    await executeAllocation(checkboxes, targetGrade, targetClass);
}

// === 修訂：執行分配 (同步重建 Email Mapping) ===
async function executeAllocation(checkboxElements, targetGrade, targetClass) {
    try {
        const pendingSnap = await db.ref('pending_allocation').once('value');
        const pendingData = pendingSnap.val() || {};
        
        const updates = {};
 
        checkboxElements.forEach(cb => {
            const name = cb.value;
            const studentData = pendingData[name];
            
            if (studentData) {
                // 更新 Profile
                if (!studentData.profile) studentData.profile = {};
                studentData.profile.grade = targetGrade;
                studentData.profile.class = targetClass;
                // 班號應已在過渡時清空，這裡確保一下
                studentData.profile.number = "";
                
                // 1. 寫入新位置
                updates[`students/${targetGrade}/${targetClass}/${name}`] = studentData;
                
                // 2. 從 Pending 移除
                updates[`pending_allocation/${name}`] = null;
 
                // 3. ★★★ 關鍵：重建 Email Mapping ★★★
                // 因為他們在進入 Pending 時 Mapping 被刪除了，現在要加回來
                if (studentData.profile.email) {
                    const emailKey = btoa(studentData.profile.email);
                    updates[`email_mapping/${emailKey}`] = studentData.profile;
                }
            }
        });
 
        // 執行所有更新
        await db.ref().update(updates);
 
        alert("✅ 分班成功！\n索引已重建，學生登入時將自動指向新班級。");
        checkAndRenderPendingPanel(); // 刷新列表
 
    } catch (error) {
        console.error(error);
        alert("錯誤：" + error.message);
    }
}
// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', () => {
    // 如果頁面上原本有 checkAndRenderS3AllocationPanel 的呼叫，請改為：
    checkAndRenderPendingPanel();
    
    // 同時也保留例外名單的初始化 (如果有的話)
    if(document.getElementById('exceptionList')) {
        // loadExceptionList(); // 可選，視乎你想不想一進來就載入
    }
});

 // === 修訂：刪除學生 (同步刪除 Email Mapping) ===
async function deleteStudent() {
    const n = document.querySelector('input[name="ts"]:checked')?.value;
    const g = document.getElementById('indivFromGrade').value;
    const c = document.getElementById('indivFromClass').value;
 
    if (!n) return alert("請選擇要刪除的學生");
    if (!confirm(`⚠️ 危險操作\n\n確定要永久刪除學生「${n}」嗎？\n這將一併刪除該學生的所有歷史紀錄、課業提交及雲端索引，且無法復原。`)) return;
 
    try {
        // 1. 先讀取該學生的 Profile 以獲取 Email
        const path = `students/${g}/${c}/${n}`;
        const snapshot = await db.ref(path + '/profile').once('value');
        const profile = snapshot.val();
 
        const updates = {};
        
        // 2. 準備刪除學生資料的指令
        updates[path] = null;
 
        // 3. 準備刪除 Email Mapping 的指令 (如果有 Email)
        if (profile && profile.email) {
            const emailKey = btoa(profile.email);
            updates[`email_mapping/${emailKey}`] = null;
            console.log(`準備刪除索引: ${profile.email}`);
        }
 
        // 4. 原子化執行 (一次過刪除)
        await db.ref().update(updates);
        
        alert("✅ 學生及關聯索引已刪除。");
        populateTransferStudentList(); // 刷新列表
 
    } catch (e) {
        console.error("刪除失敗", e);
        alert("刪除失敗：" + e.message);
    }
}



// === [新增] 即時在線名單功能邏輯 ===

let isOnlineModalOpen = false;
let onlineUsersListener = null;

// 1. 開關視窗與監聽器管理 (省流核心)
function toggleOnlineUsersModal() {
    const modal = document.getElementById('onlineUsersModal');
    const list = document.getElementById('onlineUserList');
    
    if (!isOnlineModalOpen) {
        // === 開啟時 ===
        modal.style.display = 'flex';
        isOnlineModalOpen = true;
        
        // 開始監聽 (Listen)
        list.innerHTML = '<div style="text-align:center; padding:30px; color:#999;"><i class="fas fa-spinner fa-spin"></i> 正在連線獲取名單...</div>';
        startListeningOnlineUsers();
    } else {
        // === 關閉時 ===
        modal.style.display = 'none';
        isOnlineModalOpen = false;
        
        // 停止監聽 (Stop Listen) - 這是省流的關鍵
        stopListeningOnlineUsers();
    }
}

// 2. 啟動 Firebase 監聽
function startListeningOnlineUsers() {
    // 指向 Rules 中新增的節點
    const onlineRef = db.ref('online_users');
    
    // 使用 .on('value') 進行即時監聽
    onlineUsersListener = onlineRef.on('value', (snapshot) => {
        const data = snapshot.val();
        renderOnlineUsers(data);
    });
}

// 3. 停止 Firebase 監聽
// 3. 停止 Firebase 監聽
function stopListeningOnlineUsers() {
    if (onlineUsersListener) {
        db.ref('online_users').off('value', onlineUsersListener);
        onlineUsersListener = null;
        console.log("已停止在線名單監聽 (省流模式)");
    }
}

// 4. 渲染名單 (最終版：合併訪客 + F12流量 + 中文顯示)
function renderOnlineUsers(data) {
    const list = document.getElementById('onlineUserList');
    const totalEl = document.getElementById('onlineTotalCount');
    const cntStudentEl = document.getElementById('cntStudent');
    const cntTeacherEl = document.getElementById('cntTeacher');
    const cntGuestEl = document.getElementById('cntGuest');

    // ==========================================
    // ★★★ F12 流量數據監控 ★★★
    // ==========================================
    if (data) {
        try {
            const jsonString = JSON.stringify(data);
            const bytes = new TextEncoder().encode(jsonString).length;
            const kb = (bytes / 1024).toFixed(2);
            
            console.group("📊 在線名單流量報告");
            console.log(`📉 數據大小: ${bytes} bytes (約 ${kb} KB)`);
            console.log(`🔢 原始筆數: ${Object.keys(data).length} 筆`);
            console.groupEnd();
        } catch (e) {
            console.log("流量計算錯誤", e);
        }
    } else {
        console.log(`📊 [流量監控] 本次下載: 0 bytes (無人)`);
    }
    // ==========================================

    list.innerHTML = '';

    let users = [];
    let stats = { student: 0, teacher: 0, guest: 0 };
    let activeGuestCount = 0;

    // 1. 資料處理與分類
    if (data) {
        Object.entries(data).forEach(([uid, info]) => {
            const now = Date.now();
            // 過濾逾時資料 (10分鐘)
            if (info.timestamp && (now - info.timestamp > 10 * 60 * 1000)) return;

            // A. 老師 / 特許用家
            if (info.grade === 'Special' || info.grade === 'System' || info.role === 'teacher') {
                users.push({ 
                    uid, 
                    type: 'teacher', 
                    displayName: info.name || '老師', 
                    subInfo: '教師/特許', 
                    sortWeight: 1 
                });
                stats.teacher++;
            }
            // B. 學生 (已登入)
            // ★★★ 關鍵修訂：增加 info.grade !== 'Guest' 條件 ★★★
            // 防止訪客資料因具備 grade/class 欄位而被誤判為學生並逐一顯示
            else if (info.grade && info.class && info.name && info.grade !== 'Guest') {
                users.push({ 
                    uid, 
                    type: 'student', 
                    displayName: `${info.grade}${info.class} ${info.name}`, 
                    subInfo: '學生', 
                    sortWeight: 2 
                });
                stats.student++;
            }
            // C. 訪客 (★ 關鍵邏輯：只計數，不加入列表 ★)
            else {
                activeGuestCount++; // 這裡只增加數字，絕對不加入 users 陣列
                stats.guest++;
            }
        });
    }

    // 2. 只有當訪客數 > 0 時，才手動加入「單一一行」訪客欄位
    // 這裡硬性規定顯示文字，確保不會出現 "GUESTVISITOR"
    if (activeGuestCount > 0) {
        users.push({
            uid: 'merged_guest_node',
            type: 'guest',
            displayName: '訪客',          // ★ 強制顯示中文「訪客」
            subInfo: `共 ${activeGuestCount} 人`, // ★ 統一顯示人數
            sortWeight: 3
        });
    }

    // 3. 空狀態處理
    if (users.length === 0) {
        list.innerHTML = `
            <div class="empty-state-box">
                <i class="fas fa-coffee"></i>
                <p>目前無人在線</p>
            </div>
        `;
        list.style.justifyContent = 'center';
        
        totalEl.innerText = 0;
        cntStudentEl.innerText = 0;
        cntTeacherEl.innerText = 0;
        cntGuestEl.innerText = 0;
        return;
    }

    // 4. 排序並渲染
    list.style.justifyContent = 'flex-start';
    users.sort((a, b) => a.sortWeight - b.sortWeight);

    users.forEach(u => {
        let icon = 'fa-user';
        let avatarClass = 'avatar-guest';
        
        if (u.type === 'student') { icon = 'fa-user-graduate'; avatarClass = 'avatar-student'; }
        if (u.type === 'teacher') { icon = 'fa-user-tie'; avatarClass = 'avatar-teacher'; }

        const item = document.createElement('div');
        item.className = 'online-user-item';
        item.innerHTML = `
            <div class="online-avatar ${avatarClass}"><i class="fas ${icon}"></i></div>
            <div class="online-info">
                <div class="online-name">${u.displayName}</div>
                <div class="online-sub">${u.subInfo}</div>
            </div>
            <div style="width:8px; height:8px; background:#4caf50; border-radius:50%; box-shadow:0 0 5px #4caf50;"></div>
        `;
        list.appendChild(item);
    });

    // 5. 更新統計數字
    totalEl.innerText = stats.student + stats.teacher + stats.guest;
    cntStudentEl.innerText = stats.student;
    cntTeacherEl.innerText = stats.teacher;
    cntGuestEl.innerText = stats.guest;
}
    
  
</script>

<footer class="copyright-footer">
    <p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>


<!-- === [新增] 即時在線名單按鈕 (左下角懸浮) === -->
<div id="onlineUserBtn" class="online-status-fab" onclick="toggleOnlineUsersModal()">
    <div class="online-dot"></div>
    <i class="fas fa-wifi"></i>
    <span class="online-text">在線名單</span>
</div>

<!-- === [新增] 即時在線名單視窗 === -->
<div id="onlineUsersModal" class="modal-overlay">
    <div class="modal-body" style="max-width: 400px; height: 60vh;">
        <div class="modal-header" style="background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%); color: white; border: none;">
            <h3 style="margin:0; color:white; font-size:1.1rem; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-users"></i> 即時在線
                <span id="onlineTotalCount" style="background:rgba(255,255,255,0.2); padding:2px 10px; border-radius:10px; font-size:0.8em;">0</span>
            </h3>
            <button onclick="toggleOnlineUsersModal()" style="font-size:24px; border:none; background:none; cursor:pointer; color:white; opacity:0.8;">&times;</button>
        </div>
        <div class="modal-content-scroll" style="background:#f4f4f4; padding:0;">
            <!-- 清單容器 -->
            <div id="onlineUserList" class="online-user-list">
                <div style="text-align:center; padding:30px; color:#999;">
                    <i class="fas fa-spinner fa-spin"></i> 連線中...
                </div>
            </div>
        </div>
        <!-- 底部統計欄 -->
        <div class="online-footer">
            <div><i class="fas fa-user-graduate" style="color:#8fa398;"></i> <span id="cntStudent">0</span></div>
            <div><i class="fas fa-user-tie" style="color:#94a7b5;"></i> <span id="cntTeacher">0</span></div>
            <div><i class="fas fa-user-secret" style="color:#ccc;"></i> <span id="cntGuest">0</span></div>
        </div>
    </div>
</div>

<script>

// =========================================
// === [新增] 全班課業 ZIP 下載功能 (高保真版) ===
// =========================================
 
async function downloadAssignmentZip(aid, topic, grade, cls) {
    const btn = event.currentTarget;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 打包中...';
 
    try {
        const snapshot = await db.ref(`assignments_submissions/${aid}`).once('value');
        const submissions = snapshot.val();
 
        if (!submissions) {
            alert("此課業尚未有學生提交。");
            btn.disabled = false; btn.innerHTML = originalHtml; return;
        }
 
        const zip = new JSZip();
        const folderName = `${grade}${cls}_${topic}_作業存檔`;
        const folder = zip.folder(folderName);
 
        Object.entries(submissions).forEach(([studentName, sub]) => {
            // ★ 呼叫共用生成器
            const fileContent = generateStudentHtmlString(studentName, sub, topic, grade, cls);
            const fileName = `${sub.profile?.number || ''}_${studentName}.html`;
            folder.file(fileName, fileContent);
        });
 
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, `${folderName}.zip`);
 
    } catch (e) {
        console.error("打包失敗", e);
        alert("打包失敗：" + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}
 

    
</script>


<script>


// =========================================
// === [核心] 1. 定義共用的 HTML 生成器 (確保樣式一致) ===
// =========================================
 
// 用來儲存當前正在檢閱的課業資訊 (供單一下載使用)
let currentAssignmentContext = { topic: '', grade: '', class: '' };
 
function generateStudentHtmlString(studentName, sub, topic, grade, cls) {
    // 1. 獲取當前頁面所有 CSS (確保樣式 100% 還原)
    let allStyles = "";
    document.querySelectorAll('style').forEach(styleTag => {
        allStyles += styleTag.innerHTML;
    });
    
    // 補充下載版專用 CSS
    allStyles += `
        body { background: #f4f4f4; padding: 40px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .download-hide { display: none !important; }
        .chart-wrapper { position: relative; height: 400px; width: 100%; margin: 20px 0; }
    `;
 
    // 2. 準備雷達圖數據與腳本
    let chartScript = "";
    let chartHtml = "";
    
    if (sub.scoreData) {
        let radarData = null;
        if (sub.scoreData.radar) radarData = sub.scoreData.radar;
        else if (sub.scoreData["敘事抒情"]?.radar) radarData = sub.scoreData["敘事抒情"].radar;
        else if (sub.scoreData["議論"]?.radar) radarData = sub.scoreData["議論"].radar;
 
        if (radarData) {
            const dataArray = [
                radarData.立意 || 0, radarData.取材 || 0, radarData.扣題 || 0,
                radarData.詳略 || 0, radarData.詞彙 || 0, radarData.文學性 || 0
            ];
            
            chartHtml = `<div class="chart-wrapper"><canvas id="radarChart"></canvas></div>`;
            
            chartScript = `
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('radarChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['立意', '取材', '扣題', '詳略', '詞彙', '文學性'],
                            datasets: [{
                                label: '能力分佈',
                                data: [${dataArray.join(',')}],
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { stepSize: 2 } } },
                            plugins: { legend: { display: false } }
                        }
                    });
                });
            <\/script>`;
        }
    }
 
    // 3. 解析學生內容 (保持原有邏輯)
    let parsedUserContent = `<div class="history-parsed-container history-theme-context-1">`;
    const lines = (sub.userContent || "").split('\n');
    let currentLabel = "內容";
    let contentAcc = [];
    
    lines.forEach(line => {
        const match = line.match(/^(.{2,10}?)[：:](.*)$/);
        if (match) {
            if (contentAcc.length > 0) {
                parsedUserContent += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${contentAcc.join('<br>')}</div></div>`;
            }
            currentLabel = match[1];
            if(match[2].trim()) contentAcc = [match[2].trim()]; else contentAcc = [];
        } else {
            contentAcc.push(line);
        }
    });
    if (contentAcc.length > 0) parsedUserContent += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${contentAcc.join('<br>')}</div></div>`;
    parsedUserContent += `</div>`;
 
    // 4. 組裝完整 HTML
    return `
    <!DOCTYPE html>
    <html lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${grade}${cls} - ${studentName}</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
        <style>${allStyles}</style>
    </head>
    <body>
        <div class="container">
            <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                <h1 style="text-align:center; color:#555;">${topic}</h1>
                <div style="display:flex; justify-content:space-between; color:#888; font-weight:bold;">
                    <span>班級：${grade}${cls}</span>
                    <span>姓名：${studentName} (${sub.profile?.number || '--'})</span>
                    <span>提交時間：${new Date(sub.submittedAt).toLocaleString()}</span>
                </div>
            </div>
            <h3 style="color:var(--m-blue);"><i class="fas fa-pen-nib"></i> 學生作答</h3>
            ${parsedUserContent}
            <div class="detail-ai-box" style="margin-top:30px;">
                 <h3 style="color:var(--m-green);"><i class="fas fa-robot"></i> 神思 AI 分析</h3>
                 ${chartHtml}
                 ${sub.aiContent}
            </div>
            ${sub.teacherFeedback ? `
            <div style="margin-top:30px; background:#fffaf5; border:2px solid #e6dace; padding:20px; border-radius:12px;">
                <h3 style="color:#8d6e63; margin-top:0;"><i class="fas fa-chalkboard-teacher"></i> 老師批改</h3>
                <div style="font-size:1.2em; font-weight:bold; color:#d69a92; margin-bottom:10px;">
                    分數：${sub.teacherFeedback.score || '未評分'}
                </div>
                <div style="line-height:1.8; color:#555;">${sub.teacherFeedback.comment || '無評語'}</div>
            </div>` : ''}
        </div>
        ${chartScript}
    </body>
    </html>`;
}
 
// =========================================
// === [核心] 2. 單一學生下載功能 ===
// =========================================
// 4. [補回] 單一下載功能 (如果之前沒貼到的話)
function downloadSingleSubmission(studentName) {
    if (!window.currentViewingSub) return alert("無法讀取當前學生資料");
    const { topic, grade, class: cls } = currentAssignmentContext;
    const htmlContent = generateStudentHtmlString(studentName, window.currentViewingSub, topic, grade, cls);
    const blob = new Blob([htmlContent], { type: "text/html;charset=utf-8" });
    saveAs(blob, `${window.currentViewingSub.profile?.number || ''}_${studentName}_${topic}.html`);
}
    
</script>

    

    
</body>
</html>
