<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神思 - 教師後台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <!-- 引入 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
    /* === 莫蘭迪色系定義 === */
    :root {
        --m-green: #8fa398;   --m-blue: #94a7b5;    --m-purple: #b6a6ca;
        --m-red: #d69a92;     --m-brown: #c7b299;   --bg-color: #fdfcf8;
        --text-main: #5e5e5e; --border-color: #e0ddd7;
        --m-color-1: #8fa398; --m-color-2: #94a7b5; --m-color-3: #b6a6ca; 
        --m-color-4: #d69a92; --m-color-5: #c7b299;
    }

    body {
        font-family: 'Noto Serif TC', 'Songti TC', serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        padding-bottom: 60px;
        background: url('背景.png') center/cover fixed;
        background-color: #f4f4f4;
        color: var(--text-main);
        overflow-y: scroll;
    }

    /* === 登入遮罩 === */
    #loginOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #fdfcf8; z-index: 9999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .login-box {
        background: white; padding: 40px; border-radius: 15px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-color);
        max-width: 400px; width: 90%;
    }
    .login-btn {
        background-color: var(--m-blue); color: white; padding: 12px 30px;
        border: none; border-radius: 50px; font-size: 1.1em; cursor: pointer;
        margin-top: 20px; transition: all 0.3s; width: 100%;
    }
    .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(148, 167, 181, 0.4); }

    #mainApp { display: none; }

    /* === 通用容器 === */
    h1, h2 { text-align: center; color: var(--text-main); margin-bottom: 20px; letter-spacing: 2px; }
    h3 { color: var(--m-blue); border-left: 5px solid var(--m-blue); padding-left: 10px; margin-top: 30px; }
    .box { background: rgba(255, 255, 255, 0.98); border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); padding: 30px; margin-bottom: 25px; border: 1px solid var(--border-color); }
    
    /* === 導航與按鈕 === */
    .nav-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
    .nav-btn { padding: 12px 30px; border-radius: 50px; border: none; background: #e0e0e0; color: #666; cursor: pointer; font-size: 1.05em; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: bold; }
    .nav-btn.active { background: var(--m-blue); color: white; box-shadow: 0 4px 12px rgba(148, 167, 181, 0.4); transform: translateY(-2px); }
    .nav-btn:hover:not(.active) { background: #dcdcdc; }
    
    .btn-action { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; color: white; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-action:hover { filter: brightness(95%); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-action:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-view { background-color: var(--m-blue); } .btn-delete { background-color: var(--m-red); } .btn-manage { background-color: var(--m-brown); }
    .btn-publish { background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%); font-size: 1.2rem; padding: 15px 40px; width: 100%; justify-content: center; font-weight: bold; letter-spacing: 1px; border-radius: 50px; box-shadow: 0 5px 15px rgba(143, 163, 152, 0.4); }

    .filter-group { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 20px; background: #fcfcfc; border-radius: 12px; flex-wrap: wrap; border: 1px solid var(--border-color); }
    select, input { padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Noto Serif TC', serif; font-size: 1rem; outline: none; background: #fff; color: #555; }
    
    /* === 學生列表 === */
    .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
    .student-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); border-top: 5px solid var(--m-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s ease; }
    .student-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .student-name { font-size: 1.2em; font-weight: bold; color: #444; margin-bottom: 5px; }
    .last-sync { font-size: 0.85em; color: #999; display: flex; align-items: center; gap: 6px; }

    /* === 歷史檢閱與其他 UI === */
    .category-cards-container { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; padding: 20px; }
    .anime-card { position: relative; width: 140px; height: 200px; border-radius: 15px; background-image: var(--bg-img); background-size: cover; background-position: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); overflow: hidden; filter: grayscale(20%); margin-bottom: 20px; border: 2px solid #fff; }
    .anime-card:hover { transform: translateY(-10px) scale(1.05); filter: grayscale(0%); box-shadow: 0 15px 30px rgba(0,0,0,0.3); z-index: 10; }
    .card-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 60%); }
    .card-content { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; text-align: center; }
    .card-zh { display: block; color: #fff; font-size: 18px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 2px; }
    .card-en { display: block; color: rgba(255,255,255,0.7); font-size: 10px; letter-spacing: 1px; margin-top: 5px; }

    .history-grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 20px 0; }
    .history-folder-btn { background-color: #fff; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px 15px; text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; color: #555; }
    .history-folder-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); background-color: #fff; }
    .history-folder-btn i { font-size: 2em; margin-bottom: 10px; color: #ccc; transition: color 0.3s; }
    .history-theme-1 { border-color: #8fa398; color: #8fa398; } .history-theme-1:hover i { color: #8fa398; }
    .history-theme-2 { border-color: #94a7b5; color: #94a7b5; } .history-theme-2:hover i { color: #94a7b5; }
    .history-theme-3 { border-color: #b6a6ca; color: #b6a6ca; } .history-theme-3:hover i { color: #b6a6ca; }
    .history-theme-4 { border-color: #d69a92; color: #d69a92; } .history-theme-4:hover i { color: #d69a92; }
    .history-theme-5 { border-color: #c7b299; color: #c7b299; } .history-theme-5:hover i { color: #c7b299; }

    .history-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-top: 10px; }
    .history-card { background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 8px; padding: 20px 20px 20px 55px; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s; overflow: hidden; background-image: linear-gradient(to right, transparent 39px, #e0ddd7 40px, transparent 41px), radial-gradient(circle at 20px 50%, #d1cdc5 6px, transparent 7px); background-size: 100% 100%, 100% 35px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 12px; }
    .history-card:hover { transform: translateY(-3px); box-shadow: 6px 6px 0px rgba(0,0,0,0.08); background-color: #fff; }
    .history-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; z-index: 1; }
    .theme-1::before { background: #8fa398; } .theme-2::before { background: #94a7b5; } .theme-3::before { background: #b6a6ca; } .theme-4::before { background: #d69a92; } .theme-5::before { background: #c7b299; }
    .history-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #999; margin-bottom: 10px; border-bottom: 1px dashed #e0ddd7; padding-bottom: 5px; }
    .history-title { margin: 0; font-size: 1.1em; color: #444; font-weight: bold; line-height: 1.4; }
    
    /* 麵包屑 */
    .history-breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #999; margin-bottom: 20px; padding: 10px 5px; border-bottom: 1px dashed #ccc; }
    .breadcrumb-item { cursor: pointer; font-weight: bold; color: var(--m-blue); transition: color 0.2s; }
    .breadcrumb-item:hover { color: #5e5e5e; text-decoration: underline; }
    .breadcrumb-current { color: #5e5e5e; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; font-weight: bold; }

    /* === 內容結構化顯示樣式 (強制靠左) === */
    .history-parsed-container { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e1e4e8; border-left: 5px solid #ccc; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    .history-item-block { margin-bottom: 15px; }
    .history-item-label { font-weight: bold; font-size: 1em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .history-item-label::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; opacity: 0.8; }
    .history-item-content { background: #fcfcfc; border: 1px solid #e1e4e8; border-radius: 4px; padding: 12px 16px; color: #444; line-height: 1.8; white-space: pre-wrap; word-break: break-word; text-align: left !important; }
    
    .history-theme-context-1 { border-left-color: var(--m-color-1); } .history-theme-context-1 .history-item-label { color: var(--m-color-1); } .history-theme-context-1 .history-item-label::before { background-color: var(--m-color-1); } .history-theme-context-1 .history-item-content { border-left: 4px solid var(--m-color-1); }
    /* ... (其他主題色省略，保持原樣) ... */

    /* 統計專用樣式 */
    .stat-card { padding: 20px; border-radius: 12px; text-align: center; flex: 1; min-width: 150px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: #fff; display: flex; flex-direction: column; justify-content: center; }
    .stat-card .val { font-size: 2.2em; font-weight: bold; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    .stat-card .label { font-size: 0.9em; opacity: 0.9; letter-spacing: 1px; }
    .stat-purple { background: linear-gradient(135deg, #b6a6ca 0%, #9e8fb0 100%); }
    .stat-blue { background: linear-gradient(135deg, #94a7b5 0%, #7a8f9e 100%); }
    .stat-red { background: linear-gradient(135deg, #d69a92 0%, #bf857d 100%); }
    .stat-sand { background: linear-gradient(135deg, #c7b299 0%, #b09b82 100%); }

    /* 學生選擇 Chips */
    .analytics-student-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #e0ddd7; border-radius: 8px; }
    .student-chip { padding: 6px 15px; border-radius: 50px; background: #f4f4f4; color: #666; cursor: pointer; border: 1px solid #ddd; font-size: 0.9em; transition: all 0.2s; }
    .student-chip:hover { background: #e0e0e0; }
    .student-chip.active { background: var(--m-blue); color: #fff; border-color: var(--m-blue); box-shadow: 0 2px 5px rgba(148, 167, 181, 0.4); }

    /* 課業與Modal */
    .assignment-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 12px; background: #fff; transition: all 0.2s; }
    .tag { background-color: #eee; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: normal; margin-right: 10px; }
    .publish-area { background: #fdfcf8; padding: 30px; border-radius: 15px; border: 2px dashed var(--m-green); margin-bottom: 40px; display: flex; flex-direction: column; gap: 20px; }
    .publish-inputs { display: flex; gap: 15px; width: 100%; flex-wrap: wrap; }
    .publish-inputs input { flex: 1 1 auto; min-width: 200px; padding: 15px; font-size: 1.1em; border: 1px solid #ddd; }
    
    /* === 模態視窗設定 (關鍵修正：解決貼邊與滾動) === */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.6); 
        display: none; 
        justify-content: center; 
        align-items: flex-start; 
        z-index: 1000; 
        backdrop-filter: blur(4px); 
        overflow-y: auto; /* 核心：允許視窗整體滾動 */
        padding: 60px 20px; /* 增加上下 Padding，避免貼邊 */
        box-sizing: border-box;
    }
    
    .modal-body { 
        background: #fff; 
        width: 100%; 
        max-width: 1100px; 
        /* 高度自動，移除限制 */
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
        border-radius: 15px; 
        display: flex; 
        flex-direction: column; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
        animation: fadeIn 0.3s; 
        margin: 0 auto; 
        position: relative;
    }
    
    .modal-header { padding: 20px 30px; background: #fdfcf8; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-radius: 15px 15px 0 0; }
    .modal-content-scroll { flex: 1; overflow: visible !important; height: auto !important; padding: 20px 30px; }
    
    .detail-view { background: #fff; padding: 10px; }
    
    /* 詳細內容區塊內的表格樣式 */
    .detail-ai-box table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #8baea8; font-family: 'Noto Serif TC', 'Songti TC', serif; font-size: 1rem; }
    .detail-ai-box th { background-color: #2A9689; color: white; padding: 10px; border: 1px solid #1e7e72; text-align: left; }
    .detail-ai-box td { 
        padding: 10px 15px; border: 1px solid #8baea8; vertical-align: top; text-align: left !important;
        background-color: #fffcf6; 
        color: #2c3e50; line-height: 1.8;
        background-image: linear-gradient(transparent 39px, rgba(42, 150, 137, 0.2) 39px, rgba(42, 150, 137, 0.2) 40px, transparent 40px), linear-gradient(90deg, transparent 39px, rgba(0,0,0,0.02) 39px, rgba(0,0,0,0.02) 40px, transparent 40px);
        background-size: 40px 40px; background-attachment: local;
    }

    /* === 2025修訂：左右並置佈局 (Flexbox) === */
    
    /* 1. 容器：Flexbox，左右排列 */
    .grading-side-by-side {
        display: flex;
        flex-wrap: wrap; /* 允許換行，適應小螢幕 */
        gap: 30px;
        align-items: center;
        justify-content: center;
        margin-bottom: 50px;
    }

  /* 2. 左側評分條區塊 */
    .grading-scores {
        flex: 1;           /* 保持彈性，讓它在手機版能縮放 */
        max-width: 450px;  /* ★ 新增這一行：限制最大寬度，防止撐滿視窗 */
        min-width: 300px;  /* 保持原本設定 */
        padding: 20px;
        background: #fdfcf8;
        border-radius: 12px;
        border: 1px solid #eee;
    }
    
    .score-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; }
    .score-item label { font-weight: bold; color: #495057; flex-shrink: 0; width: 70px; text-align: left; }
    .slider-container { flex-grow: 1; display: flex; align-items: center; gap: 8px; max-width: none; }
    .progress-bar-container { flex-grow: 1; height: 10px; background-color: #e9ecef; border-radius: 6px; overflow: hidden; border: 1px solid #ced4da; }
    .progress-bar-fill { height: 100%; width: 0%; background-color: #007bff; border-radius: 6px; }
    .score-display { font-weight: bold; width: 25px; text-align: right; color: #0056b3; font-size: 1rem; }
    .total-score-container { margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
    
    /* 3. 右側雷達圖區塊 (縮圖) */
    .grading-radar-thumbnail {
        flex: 1;             /* 讓它有彈性 */
       width: auto;         /* 寬度自動 */
        /* 建議補上最小寬度，避免縮太小 */
        min-width: 220px;
         max-width: 300px;
        text-align: center;
        cursor: pointer; /* 手型游標 */
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 12px;
        background: #fff;
        padding: 10px;
        border: 1px solid transparent;
    }

    .grading-radar-thumbnail:hover {
        transform: scale(1.03);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        border-color: var(--m-blue);
    }
    
    .grading-radar-thumbnail::after {
        content: '\f00e  點擊放大圖表'; /* FontAwesome search-plus icon content */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.85);
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        color: var(--m-blue);
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
    }

    .grading-radar-thumbnail:hover::after {
        opacity: 1;
    }

    .grading-radar-thumbnail h3 {
        color: var(--m-blue);
        border-bottom: none; 
        padding-bottom: 5px;
        width: 100%;
        text-align: center;
        margin: 0 0 10px 0;
        font-size: 1em;
    }

    /* 縮圖 Canvas 容器 */
    .radar-chart-mini-container { 
        position: relative; 
        width: 240px; 
        height: 240px;
        margin: 0 auto;
    }

    /* 報告樣式 */
    .report-section { display: block; margin-bottom: 50px; clear: both; } /* 確保不與上方浮動元素重疊 */
    .report-category-badge { display: inline-flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); letter-spacing: 1px; }
    .badge-narrative { background-color: #7da3c0; } .badge-argument { background-color: #a692c2; } .badge-reading { background-color: #8da399; } .badge-expand { background-color: #d69a92; }
    .badge-general { width: 100%; max-width: 100%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 10px; margin-bottom: 10px; background: linear-gradient(135deg, #C5B4A1 0%, #A99885 100%); box-shadow: 0 8px 20px rgba(169, 152, 133, 0.35); color: white; border-radius: 12px; position: relative; overflow: hidden; }
    .badge-general-title { font-size: 1.6rem; font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .overall-grade-tag { background-color: #fff; color: #d9534f; padding: 5px 25px; border-radius: 50px; font-size: 1.4rem; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid #d69a92; display: flex; align-items: center; gap: 8px; }
    .overall-grade-label { font-size: 0.8rem; color: #888; font-weight: normal; text-transform: uppercase; letter-spacing: 1px; }
    .report-category-badge:not(.badge-general) { display: inline-flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); letter-spacing: 1px; }
    .report-text-card { background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 12px; padding: 25px; line-height: 1.9; color: #4a4a4a; font-size: 1.05rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); text-align: justify; margin-top: 10px; display: block; }
    
    .report-quote-card { position: relative; background-color: #fffefb; border: 1px solid #e0ddd7; border-radius: 8px; padding: 30px 30px 30px 65px; margin-top: 40px; box-shadow: 4px 4px 0px rgba(0,0,0,0.05); text-align: left; background-image: linear-gradient(to right, transparent 49px, #eebdbd 50px, transparent 51px), radial-gradient(circle at 25px 50%, #d1cdc5 8px, transparent 9px); background-size: 100% 100%, 100% 40px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 15px; }
    .report-quote-content { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; font-weight: bold; color: #5d4037; font-style: italic; line-height: 1.6; }
    .report-quote-author { margin-top: 10px; font-size: 0.9rem; color: #888; text-align: right; font-style: normal; }
    .report-separator { position: relative; height: 1px; border: 0; border-top: 3px dashed #b6a6ca; margin: 40px 0 50px 0; opacity: 0.6; }
    .report-separator::after { content: '▼'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fdfcf8; padding: 0 10px; color: #b6a6ca; font-size: 12px; }
    
    .report-radar-wrapper { margin-bottom: 30px; background: #fff; padding: 0 20px; border-radius: 0; border: none; display: block; }

    /* === 點評與建議列表 === */
    .rewrite-explanation-container { margin-top: 20px; display: block; }
    .explanation-point { display: flex; align-items: flex-start; margin-bottom: 20px; padding: 18px; background-color: #fff; border: 1px solid #e9ecef; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .explanation-point:last-child { margin-bottom: 0; }
    .explanation-number { flex-shrink: 0; width: 28px; height: 28px; background-color: #0288d1; color: white; font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 15px; font-size: 1em; margin-top: 2px; }
    .explanation-text { font-size: 1em; line-height: 1.8; color: #444; text-align: left; font-family: 'Noto Serif TC', serif; }
    
    .rewrite-explanation-card p {
        font-size: 1em; line-height: 1.8; color: #444; text-align: left; margin: 0; font-family: 'Noto Serif TC', serif;
    }

    .modal-content-container { display: flex; height: 100%; overflow: hidden; }
    .submission-sidebar { width: 320px; border-right: 1px solid var(--border-color); overflow-y: auto; background: #fafafa; flex-shrink: 0; }
    .submission-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
    .submission-item:hover { background: #f0f0f0; }
    .submission-item.active { background: #eef2f5; border-left: 4px solid var(--m-blue); }
    .status-badge { font-size: 0.8em; padding: 3px 10px; border-radius: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
    .status-done { background: #e8edea; color: #5e7067; }
    .status-pending { background: #f7ebea; color: #a67069; }
    
    .submission-detail-area { 
        flex-grow: 1; 
        padding: 30px; 
        padding-bottom: 100px !important; 
        overflow-y: auto; 
        background: #fff; 
    }
    
    .teacher-feedback-section { background-color: #fffaf5; border: 2px solid #e6dace; border-radius: 12px; padding: 20px; margin-top: 30px; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08); }
    .teacher-feedback-section input, .teacher-feedback-section textarea { width: 100%; padding: 10px; border: 1px solid #e6dace; border-radius: 8px; font-family: 'Noto Serif TC', serif; box-sizing: border-box; margin-top: 5px; background: #fff; font-size: 1rem; color: #555; outline: none; }
    .teacher-feedback-section input:focus, .teacher-feedback-section textarea:focus { border-color: var(--m-brown); box-shadow: 0 0 5px rgba(199, 178, 153, 0.3); }

    .management-section { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
    .transfer-grid { display: flex; gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; align-items: flex-start; }
    .transfer-column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .transfer-list-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; height: 250px; overflow-y: auto; padding: 5px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); }
    .student-select-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
    .student-select-item:hover { background-color: #f5f5f5; }
    .student-select-item input[type="radio"] { transform: scale(1.3); accent-color: var(--m-green); cursor: pointer; }
    .year-transition-card { background-color: #fdfcf8; border: 2px solid var(--m-brown); border-radius: 15px; padding: 30px; text-align: center; max-width: 600px; margin: 0 auto; }

    .copyright-footer { position: fixed; bottom: 0; right: 0; padding: 5px 10px; background-color: #f1f1f1; z-index: 999; }
    .copyright-footer p { margin: 0; font-size: 14px; }
    
    @media (max-width: 600px) { 
        .copyright-footer p { font-size: 12px; } 
        /* 手機版：評分表與雷達圖改為垂直堆疊 */
        .grading-side-by-side { flex-direction: column; }
        .grading-scores { width: 100%; min-width: auto; }
        .grading-radar-thumbnail { width: 100% !important; flex: none; }
        
        .score-item label { width: auto; min-width: 60px; font-size: 0.9em; }
        .radar-chart-mini-container { width: 100% !important; max-width: 280px; height: 280px !important; }
        .modal-body { width: 100%; border-radius: 0; margin: 0; }
        .modal-overlay { padding: 40px 0 100px 0; }
    }
</style>
</head>
<body>

<!-- === 安全登入閘門 === -->

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color: var(--m-blue); margin-bottom: 10px;">神思・教師後台</h2>
        <p style="color: #888; margin-bottom: 30px;">請使用學校教師帳號登入以存取資料</p>
        <button id="loginBtn" class="login-btn" onclick="teacherLogin()">
            <i class="fab fa-google"></i> Google 帳號登入
        </button>
        <p id="loginMsg" style="color: var(--m-red); margin-top: 15px; font-size: 0.9em;"></p>
    </div>
</div>

<!-- === 主要應用程式 === -->

<div id="mainApp">
    <div class="title-container">
        <div style="float: right; font-size: 0.9rem;">
            <span id="teacherNameDisplay" style="color: var(--m-blue); margin-right: 10px;"></span>
            <button onclick="logout()" style="background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; color: #666;">登出</button>
        </div>
        <h1>神思・教師後台</h1>
    </div>

    <!-- 導航列 -->
    <div class="nav-bar">
        <button class="nav-btn active" onclick="switchTab('students')"><i class="fas fa-user-graduate"></i> 學生管理</button>
        <button class="nav-btn" onclick="switchTab('reports')"><i class="fas fa-chart-pie"></i> 學生報告</button>
        <button class="nav-btn" onclick="switchTab('assignments')"><i class="fas fa-edit"></i> 課業管理</button>
        <button class="nav-btn" onclick="switchTab('analytics')"><i class="fas fa-chart-bar"></i> 數據統計</button>
        <button class="nav-btn" onclick="switchTab('management')"><i class="fas fa-calendar-alt"></i> 學年管理</button>
    </div>

    <!-- 1. 學生管理頁面 -->
    <div id="tab-students" class="box">
        <h2>學生紀錄檢閱</h2>
        <div class="filter-group">
            <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> 篩選：</label>
            <select id="viewGrade" onchange="loadStudentList()">
                <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
            </select>
            <select id="viewClass" onchange="loadStudentList()">
                <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
            </select>
            <button class="btn-action btn-view" onclick="loadStudentList()"><i class="fas fa-sync-alt"></i> 刷新列表</button>
        </div>
        <div id="studentListContainer" class="student-grid">
            <p style="text-align:center; width:100%; color:#aaa; padding:30px;">請選擇年級和班別以載入學生列表</p>
        </div>
    </div>

    <!-- 2. 學生報告頁面 -->
    <div id="tab-reports" class="box" style="display:none;">
        <h2>學生學習報告管理</h2>
        <div class="filter-group">
            <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> 篩選：</label>
            <select id="reportGrade" onchange="loadReportStudentList()">
                <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
            </select>
            <select id="reportClass" onchange="loadReportStudentList()">
                <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
            </select>
            <button id="btnClassReport" class="btn-action btn-manage" style="background: linear-gradient(135deg, #7da3c0 0%, #5e7067 100%); margin-left: auto; box-shadow: 0 4px 10px rgba(94, 112, 103, 0.4);" onclick="generateClassReport()">
                <i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)
            </button>
        </div>
        <div id="classReportHistoryContainer" style="margin-bottom: 25px; padding: 20px; background: #fdfcf8; border-radius: 12px; border: 1px solid var(--border-color); border-left: 5px solid #7da3c0; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; border:none; padding:0; font-size:1.1em; color:var(--text-main); display:flex; align-items:center; gap:8px;"><i class="fas fa-history" style="color:#7da3c0;"></i> 過往全班綜合報告紀錄</h3>
                <small style="color:#999; font-style:italic;">點擊下方按鈕以重看報告</small>
            </div>
            <div id="classReportList" style="display:flex; gap:12px; overflow-x:auto; padding:5px 0; align-items: center; scroll-behavior: smooth;"></div>
        </div>
        <div id="reportStudentListContainer" class="student-grid">
            <p style="text-align:center; width:100%; color:#aaa; padding:30px;">請選擇年級和班別以載入報告列表</p>
        </div>
    </div>

    <!-- 3. 課業派發頁面 -->
    <div id="tab-assignments" class="box" style="display:none;">
        <h2>佈置課業</h2>
        <div class="filter-group">
            <label><i class="fas fa-users" style="color:var(--m-blue);"></i> 對象：</label>
            <select id="assignGrade" onchange="loadAssignmentHistory()">
                <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
            </select>
            <select id="assignClass" onchange="loadAssignmentHistory()">
                <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
            </select>
        </div>
        <div class="publish-area">
            <div style="font-weight:bold; color:var(--m-green); margin-bottom:5px; font-size:1.1em;"><i class="fas fa-pen-fancy"></i> 創建新任務</div>
            <div class="publish-inputs">
                <input type="text" id="assignTopic" placeholder="課業題目">
                <select id="assignType"><option value="閱讀">閱讀</option><option value="敘事抒情">敘事抒情</option><option value="議論">議論</option><option value="整合拓展">整合拓展</option></select>
            </div>
            <button id="btnPublish" class="btn-action btn-publish" onclick="publishAssignment()"><i class="fas fa-paper-plane"></i> 立即派發</button>
        </div>
        <h3>已派發課業列表</h3>
        <div id="assignmentHistoryList"></div>
    </div>

    <!-- 4. 數據統計頁面 -->
    <div id="tab-analytics" class="box" style="display:none;">
        <h2>神思大數據統計</h2>
        
        <div class="filter-group">
            <label><i class="fas fa-cubes" style="color:var(--m-blue);"></i> 對象：</label>
            <select id="statScope" onchange="updateStatInputs()">
                <option value="global">所有用家 (含訪客)</option>
                <option value="school">全校 (僅已登入)</option>
                <option value="class">個別班級</option>
            </select>

            <span id="statClassInput" style="display:none;">
                <select id="statGrade" onchange="loadAnalyticsClassList()"><option value="1">中一</option><option value="2">中二</option><option value="3">中三</option><option value="4">中四</option><option value="5">中五</option><option value="6">中六</option></select>
                <select id="statClass" onchange="loadAnalyticsClassList()"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
            </span>

            <label style="margin-left:15px;"><i class="far fa-clock" style="color:var(--m-brown);"></i> 時間：</label>
            <select id="statTimeMode" onchange="updateTimeInputs()">
                <option value="day">本日 (實時)</option>
                <option value="month">本月 (趨勢)</option>
                <option value="year">本年 (總覽)</option>
            </select>
            
            <input type="date" id="statDate" style="display:inline-block;">
            <select id="statMonth" style="display:none;"></select>
            <select id="statYear" style="display:none;"><option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option></select>

            <button class="btn-action btn-view" onclick="fetchAndRenderStats()">
                <i class="fas fa-search"></i> 查詢
            </button>
        </div>

        <!-- 學生選擇區域 -->
        <div id="analyticsStudentListContainer" style="display:none;">
            <h4 style="margin:0 0 10px 0; font-size:1em; color:var(--text-main);">
                <i class="fas fa-user-friends"></i> 選擇學生 (點擊可切換，再次點擊取消)
            </h4>
            <div id="analyticsStudentList" class="analytics-student-list"></div>
        </div>

        <!-- 數據概覽卡片 -->
        <div style="display:flex; gap:20px; justify-content:center; margin:30px 0; flex-wrap:wrap;">
            <div class="stat-card stat-purple">
                <div class="val" id="dispUnique">0</div>
                <div class="label">總使用人數 (不重複)</div>
            </div>
            <div class="stat-card stat-blue">
                <div class="val" id="dispVisits">0</div>
                <div class="label">總進入次數</div>
            </div>
            <div class="stat-card stat-red">
                <div class="val" id="dispDuration">0</div>
                <div class="label">總使用時長 (分鐘)</div>
            </div>
            <div class="stat-card stat-sand">
                <div class="val" id="dispAvg">0</div>
                <div class="label">平均每人時長 (分鐘)</div>
            </div>
        </div>

        <div class="chart-container" style="position: relative; height:400px; width:100%;">
            <canvas id="analyticsChart"></canvas>
        </div>
    </div>

    <!-- 5. 學年管理頁面 -->
    <div id="tab-management" class="box" style="display:none;">
        <h2>學年過渡管理</h2>
        <div style="text-align:center; margin-bottom:30px;">
            <div style="font-size:1.2em; color:var(--m-brown); font-weight:bold; margin-bottom:10px;">當前學年設定</div>
            <div style="display:inline-flex; align-items:center; gap:10px; background:#fff; padding:10px 20px; border-radius:50px; border:1px solid #ccc;">
                <input type="text" id="currentYearInput" value="2025-2026" style="border:none; text-align:center; font-weight:bold; font-size:1.1em; width:120px;">
                <button class="btn-action btn-manage" style="padding:5px 15px; font-size:0.8em;" onclick="updateYearConfig()">儲存</button>
            </div>
        </div>
        <div class="management-section">
            <div class="section-title"><i class="fas fa-user-cog"></i> 個別學生調動 / 刪除</div>
            <div class="transfer-grid">
                <div class="transfer-column">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span style="font-weight:bold; color:var(--m-red);">來源：</span>
                        <select id="indivFromGrade" onchange="populateTransferStudentList()"><option value="6">中六</option><option value="5">中五</option><option value="4">中四</option><option value="3">中三</option><option value="2">中二</option><option value="1">中一</option></select>
                        <select id="indivFromClass" onchange="populateTransferStudentList()"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                    </div>
                    <div id="transferStudentListBox" class="transfer-list-box"><div style="padding:20px; text-align:center; color:#999;">請先選擇班級...</div></div>
                </div>
                <div class="transfer-arrow-icon" style="align-self:center; color:#ccc; font-size:1.5em;"><i class="fas fa-arrow-right"></i></div>
                <div class="transfer-column" style="justify-content:center;">
                    <div style="background:#fff; border:1px solid #eee; padding:20px; border-radius:10px;">
                        <div style="font-weight:bold; color:var(--m-green); margin-bottom:10px;">目標設定：</div>
                        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                            <select id="indivToGrade" style="flex:1;"><option value="6">中六</option><option value="5">中五</option><option value="4">中四</option><option value="3">中三</option><option value="2">中二</option><option value="1">中一</option></select>
                            <select id="indivToClass" style="flex:1;"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="font-size:0.9em; color:#666;">分配新班號：</label>
                            <input type="number" id="indivNewNumber" placeholder="例如：25" style="width:100%; margin-top:5px; text-align:center; box-sizing:border-box;">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px;">
                            <button class="btn-action btn-manage" style="justify-content:center;" onclick="moveIndividualStudent()"><i class="fas fa-exchange-alt"></i> 確認調動</button>
                            <button class="btn-action btn-delete" style="justify-content:center;" onclick="deleteStudent()"><i class="fas fa-trash-alt"></i> 刪除此學生</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="year-transition-card">
            <div style="font-size:1.3em; font-weight:bold; color:#555;">一鍵全校升班 (學年過渡)</div>
            <div class="year-arrow"><i class="fas fa-chevron-down"></i></div>
            <button class="btn-action btn-manage" style="padding:15px 40px; font-size:1.1em; width:100%;" onclick="runYearTransition()"><i class="fas fa-rocket"></i> 開始新學年過渡</button>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- 歷史檢閱視窗 -->
<div id="historyViewerModal" class="modal-overlay">
    <div class="modal-body">
        <div class="modal-header">
            <h3 id="viewerTitle" style="margin:0; color:var(--m-blue);">學生歷程</h3>
            <button onclick="document.getElementById('historyViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div class="modal-content-scroll">
            <div id="teacherBreadcrumb" class="history-breadcrumb" style="display: none;">
                <span class="breadcrumb-item" onclick="renderLevel1()"><i class="fas fa-home"></i> 主範疇</span> 
                <span class="breadcrumb-sep"> &gt; </span>
                <span class="breadcrumb-item" id="breadCategory" onclick="renderLevel2(currentCategory)"></span>
                <span class="breadcrumb-sep" id="breadSep2"> &gt; </span>
                <span class="breadcrumb-current" id="breadSub"></span>
            </div>
            <div id="historyLevel1" class="category-cards-container"></div>
            <div id="historyLevel2" class="history-grid-menu" style="display: none;"></div>
            <div id="historyLevel3" class="history-list-container" style="display: none;"></div>
            <div id="historyDetail" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- 提交檢閱視窗 -->
<div id="submissionViewerModal" class="modal-overlay">
    <div class="modal-body">
        <div class="modal-header">
            <h3 id="submissionTitle" style="margin:0; color:var(--m-green);"></h3>
            <div style="font-size:0.9em; color:#888;">已繳交: <span id="submitCount" style="color:var(--m-green); font-weight:bold;">0</span> / 未繳交: <span id="pendingCount" style="color:var(--m-red); font-weight:bold;">0</span></div>
            <button onclick="document.getElementById('submissionViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div class="modal-content-container">
            <div class="submission-sidebar">
                <ul id="submissionList" style="list-style:none; padding:0; margin:0;"></ul>
            </div>
            <div id="submissionDetailArea" class="submission-detail-area">
                <div style="text-align:center; color:#ccc; margin-top:100px;"><i class="far fa-file-alt" style="font-size:48px;"></i><p>請選擇學生</p></div>
            </div>
        </div>
    </div>
</div>

<!-- 班級報告視窗 -->
<div id="classReportModal" class="modal-overlay">
    <div class="modal-body" style="max-width: 900px;">
        <div class="modal-header">
            <h3 style="margin:0; color:var(--m-blue);"><i class="fas fa-chart-pie"></i> 全班綜合學習報告</h3>
            <button onclick="document.getElementById('classReportModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div id="classReportContent" class="modal-content-scroll" style="background:#f9f9f9; padding: 0;"></div>
    </div>
</div>

<!-- 2025 新增：圖表放大專用視窗 (Modal) -->
<div id="chartEnlargeModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-body" style="width: 90%; max-width: 700px; height: auto;">
        <div class="modal-header" style="background: #fff; border-bottom: none;">
            <h3 id="enlargeChartTitle" style="margin:0; color:var(--m-blue);">能力分析詳情</h3>
            <button onclick="document.getElementById('chartEnlargeModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
        </div>
        <div style="padding: 10px 30px 40px 30px; height: 500px; position: relative; width: 100%; box-sizing: border-box;">
            <canvas id="bigChartCanvas"></canvas>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
        authDomain: "sansidata.firebaseapp.com",
        projectId: "sansidata",
        storageBucket: "sansidata.firebasestorage.app",
        messagingSenderId: "580288358575",
        appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
        databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const READING_API_KEYS = ["pk_D77NeM4n6GnNCYbo", "pk_c17y17tQ3BY71cpd", "pk_Ax3rRTHkrdTQVIGD", "pk_dGVqEggn4T4dwQI3", "pk_YIFWnDFts0quviE0"];
    const READING_API_URL = "https://gen.pollinations.ai/v1/chat/completions";
    const READING_MODEL = "deepseek";

    const _k1 = "os_v2_app_";
    const _k2 = "7bo2joflvzgf5dnzzh2gh7eycxk5kn45q25uwymlyhqbq746uburtgfhd3xfyyxullklptksmnddfdwgpechno4byssraz7yysuusrq";
    const _OS_KEY = _k1 + _k2;

    async function sendClassNotification(targetGrade, targetClass, title, message) {
        const options = {
            method: 'POST',
            headers: { accept: 'application/json', 'Content-Type': 'application/json', Authorization: 'Basic ' + _OS_KEY },
            body: JSON.stringify({ app_id: "f85da4b8-abae-4c5e-8db9-c9f463fc9815", headings: { en: title, zh: title }, contents: { en: message, zh: message }, filters: [{ field: "tag", key: "grade", relation: "=", value: targetGrade }, { operator: "AND" }, { field: "tag", key: "class", relation: "=", value: targetClass }], url: "https://kenchan20141.github.io/AIChinese/" })
        };
        try { await fetch('https://onesignal.com/api/v1/notifications', options); console.log('推播發送成功'); } catch (err) { console.error('推播發送失敗:', err); }
    }

    function determineGrade(score) {
        if (score >= 72) return "5**"; if (score >= 69) return "5*"; if (score >= 64) return "5";
        if (score >= 57) return "4"; if (score >= 50) return "3"; if (score >= 45) return "2"; return "1";
    }

    function teacherLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        document.getElementById('loginMsg').innerText = "驗證中...";
        auth.signInWithPopup(provider).then((result) => {
            const user = result.user;
            if (user.email.endsWith('@ccckyc.edu.hk')) { showApp(user); }
            else { auth.signOut(); document.getElementById('loginMsg').innerText = "非授權帳號"; }
        }).catch((error) => { document.getElementById('loginMsg').innerText = "登入失敗：" + error.message; });
    }
    function logout() { auth.signOut().then(() => location.reload()); }
    function showApp(user) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('teacherNameDisplay').innerText = user.displayName || user.email;
        db.ref('config/currentYear').once('value', s => { if(s.exists()) document.getElementById('currentYearInput').value = s.val(); });
        populateTransferStudentList();
    }
    auth.onAuthStateChanged(user => { if (user && user.email.endsWith('@ccckyc.edu.hk')) showApp(user); });

    // === Tab 切換 ===
    function switchTab(tabId) {
        document.querySelectorAll('.box').forEach(b => b.style.display = 'none');
        document.getElementById('tab-' + tabId).style.display = 'block';
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        if(tabId === 'students') loadStudentList();
        if(tabId === 'assignments') loadAssignmentHistory();
        if(tabId === 'reports') loadReportStudentList();
        if(tabId === 'analytics') {
            if(document.getElementById('statMonth').options.length === 0) initStatUI();
            loadAnalyticsClassList();
        }
    }

    // === 歷史檢閱 ===
    let currentStudentHistory = [], currentCategory = '', currentSubFunction = '', currentThemeIndex = 1, currentViewingAssignmentId = ''; 
    const HISTORY_STRUCTURE = { "閱讀": ["點評", "指引"], "敘事抒情": ["文章點評", "大綱點評", "解題指引", "敘事物象"], "議論": ["文章點評", "大綱點評", "指引"], "整合拓展": ["點評", "指引"], "課外書籍": ["討論紀錄"], "學習報告": ["綜合分析"] };
    const CATEGORY_ASSETS = { "閱讀": { img: '郵筒.png', en: 'READING' }, "敘事抒情": { img: '相機.png', en: 'NARRATIVE' }, "議論": { img: '筆.png', en: 'ARGUMENT' }, "整合拓展": { img: '火車.png', en: 'EXPAND' }, "課外書籍": { img: '書.png', en: 'LIBRARY' }, "學習報告": { img: '書.png', en: 'REPORT' } };
    const SUB_ICONS = { "文章點評": "fa-file-alt", "大綱點評": "fa-list-ol", "綜合分析": "fa-chart-pie", "敘事物象": "fa-tree", "解題指引": "fa-compass", "指引": "fa-lightbulb", "點評": "fa-comment-dots", "討論紀錄": "fa-comments" };

    function loadStudentList() {
        const g = document.getElementById('viewGrade').value, c = document.getElementById('viewClass').value;
        const container = document.getElementById('studentListContainer');
        container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> 載入中...</p>';
        db.ref(`students/${g}/${c}`).once('value', snapshot => {
            const data = snapshot.val();
            if (!data) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">暫無資料。</p>'; return; }
            container.innerHTML = '';
            Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99)).forEach(([name, d]) => {
                const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                const div = document.createElement('div'); div.className = 'student-card';
                div.innerHTML = `<div class="student-name">${name} <small>(${d.profile?.number||''})</small></div><div class="last-sync"><i class="fas fa-history"></i> 紀錄: ${h.length} 筆</div>`;
                div.onclick = () => openHistoryModal(name, h);
                container.appendChild(div);
            });
        });
    }

    // === 報告管理 ===
    function loadReportStudentList() {
        const g = document.getElementById('reportGrade').value, c = document.getElementById('reportClass').value;
        const container = document.getElementById('reportStudentListContainer');
        container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> 載入中...</p>';
        loadClassReportHistory();
        db.ref(`students/${g}/${c}`).once('value', snapshot => {
            const data = snapshot.val();
            if (!data) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">暫無資料。</p>'; return; }
            container.innerHTML = '';
            Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99)).forEach(([name, d]) => {
                const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                const reports = h.filter(r => r.category === "學習報告");
                const div = document.createElement('div'); div.className = 'student-card';
                const style = reports.length > 0 ? '' : 'opacity: 0.6; filter: grayscale(100%);';
                div.style.cssText = style;
                div.innerHTML = `<div class="student-name">${name} <small>(${d.profile?.number||''})</small></div><div class="last-sync" style="color:${reports.length>0?'var(--m-red)':'#ccc'}; font-weight:bold;"><i class="fas fa-chart-pie"></i> 已生成報告: ${reports.length} 份</div>`;
                if (reports.length > 0) { div.onclick = () => { openHistoryModal(name, h); setTimeout(() => { renderLevel2('學習報告'); setTimeout(() => renderLevel3('綜合分析', 5), 100); }, 300); }; }
                container.appendChild(div);
            });
        });
    }

    async function generateClassReport() {
        const btn = document.getElementById('btnClassReport');
        const g = document.getElementById('reportGrade').value, c = document.getElementById('reportClass').value;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析全班數據中...';
        try {
            const snapshot = await db.ref(`students/${g}/${c}`).once('value');
            const data = snapshot.val();
            if (!data) { alert("此班級無學生資料！"); return; }
            let classSummary="", outlineSummary="", readingSummary="", expandSummary="";
            let narrativeTotal={content:0,expr:0,struct:0,count:0}, argumentTotal={content:0,expr:0,struct:0,count:0};
            let studentCount = 0;
            Object.entries(data).forEach(([name, d]) => {
                const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                const reports = h.filter(r => r.category === "學習報告").sort((a,b) => b.timestamp - a.timestamp);
                if (reports.length > 0) { studentCount++; classSummary += `學生 ${studentCount}: ${reports[0].aiContent.replace(/<[^>]*>?/gm, ' ').substring(0, 300)}...\n`; }
                h.forEach(r => {
                    const scoreMatch = r.aiContent.match(/總分:\s*(\d+)/);
                    if (scoreMatch) {
                        const score = parseInt(scoreMatch[1]);
                        if (r.category === "敘事抒情") { narrativeTotal.content+=score*0.4; narrativeTotal.expr+=score*0.3; narrativeTotal.struct+=score*0.2; narrativeTotal.count++; }
                        else if (r.category === "議論") { argumentTotal.content+=score*0.4; argumentTotal.expr+=score*0.3; argumentTotal.struct+=score*0.2; argumentTotal.count++; }
                    }
                    if (r.subFunction && r.subFunction.includes("大綱")) { let t=r.aiContent.replace(/<[^>]*>?/gm, ' '); let i=t.indexOf("點評"); if(i!==-1) outlineSummary+=`[${r.category}大綱]: ${t.substring(i, i+120)}...\n`; }
                    if (r.category==="閱讀" && r.subFunction==="點評") { let t=r.aiContent.replace(/<[^>]*>?/gm, ' '); let i=t.indexOf("點評"); if(i!==-1) readingSummary+=`[閱讀]: ${t.substring(i, i+150)}...\n`; }
                    if (r.category==="整合拓展" && r.subFunction==="點評") { let t=r.aiContent.replace(/<[^>]*>?/gm, ' '); let i=t.indexOf("點評"); if(i!==-1) expandSummary+=`[整合]: ${t.substring(i, i+150)}...\n`; }
                });
            });
            if (studentCount === 0 && narrativeTotal.count === 0 && argumentTotal.count === 0 && !outlineSummary) { alert("此班級數據不足。"); return; }
            const narrAvg = { content: narrativeTotal.count ? Math.round((narrativeTotal.content/narrativeTotal.count)/4) : 0, expr: narrativeTotal.count ? Math.round((narrativeTotal.expr/narrativeTotal.count)/3) : 0, struct: narrativeTotal.count ? Math.round((narrativeTotal.struct/narrativeTotal.count)/2) : 0 };
            const argAvg = { content: argumentTotal.count ? Math.round((argumentTotal.content/argumentTotal.count)/4) : 0, expr: argumentTotal.count ? Math.round((argumentTotal.expr/argumentTotal.count)/3) : 0, struct: argumentTotal.count ? Math.round((argumentTotal.struct/argumentTotal.count)/2) : 0 };
            const prompt = `你是一位中文科科主任。分析 ${g}年${c}班 數據：敘事平均(內容${narrAvg.content},表達${narrAvg.expr},結構${narrAvg.struct})，議論平均(內容${argAvg.content},表達${argAvg.expr},結構${argAvg.struct})。\n大綱表現：${outlineSummary}\n閱讀表現：${readingSummary}\n整合表現：${expandSummary}\n成品摘要：${classSummary}\n\n任務：生成「全班綜合學習評估報告」。\n格式要求(HTML)：\n1. <div class="report-section"><div class="report-category-badge badge-general"><div class="badge-general-title">${g}${c}班 綜合評估</div></div><div class="report-text-card"><p>總結</p></div></div><div class="report-separator"></div>\n2. 分別為閱讀(.badge-reading)、敘事(.badge-narrative)、議論(.badge-argument)、整合拓展(.badge-expand)提供 .report-text-card 分析。\n3. <div class="report-quote-card"><div class="report-quote-content">教學建議</div></div>`;
            const response = await callAPI(prompt);
            const reportData = { timestamp: firebase.database.ServerValue.TIMESTAMP, dateStr: new Date().toLocaleString(), stats: { narrAvg, argAvg, narrativeTotal: Math.round((narrativeTotal.content+narrativeTotal.expr+narrativeTotal.struct)/narrativeTotal.count)||0, argumentTotal: Math.round((argumentTotal.content+argumentTotal.expr+argumentTotal.struct)/argumentTotal.count)||0 }, aiHtml: response };
            await db.ref(`class_reports/${g}/${c}`).push(reportData);
            loadClassReportHistory(); openClassReportModal(reportData);
        } catch (e) { console.error(e); alert("生成失敗"); } finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)'; }
    }

    function loadClassReportHistory() {
        const g = document.getElementById('reportGrade').value, c = document.getElementById('reportClass').value;
        const container = document.getElementById('classReportHistoryContainer');
        const list = document.getElementById('classReportList');
        db.ref(`class_reports/${g}/${c}`).once('value', snapshot => {
            const data = snapshot.val();
            if (!data) { container.style.display = 'none'; return; }
            container.style.display = 'block'; list.innerHTML = '';
            Object.entries(data).sort(([,a], [,b]) => b.timestamp - a.timestamp).forEach(([key, report]) => {
                const w = document.createElement('div');
                w.style.cssText = `display:inline-flex;align-items:center;background:#fff;border:1px solid #ccc;border-radius:50px;padding:5px 5px 5px 15px;flex-shrink:0;box-shadow:0 2px 5px rgba(0,0,0,0.05);`;
                w.innerHTML = `<span style="cursor:pointer;color:#555;font-weight:bold;margin-right:10px;" onclick='openClassReportModal(${JSON.stringify(report).replace(/'/g, "&#39;")})'><i class="far fa-file-alt"></i> ${report.dateStr.split(' ')[0]}</span><button class="btn-action" style="background:#fbecec;color:#d69a92;border-radius:50%;width:32px;height:32px;padding:0;justify-content:center;" onclick="deleteClassReport('${key}')"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(w);
            });
        });
    }
    function deleteClassReport(key) { if(confirm("確定刪除此報告？")) { const g=document.getElementById('reportGrade').value, c=document.getElementById('reportClass').value; db.ref(`class_reports/${g}/${c}/${key}`).remove().then(()=>loadClassReportHistory()); }}
    function openClassReportModal(data) {
        const m = document.getElementById('classReportModal'), c = document.getElementById('classReportContent');
        const d = document.createElement('div'); d.innerHTML = data.aiHtml;
        if(data.stats.narrativeTotal>0) { const b=d.querySelector('.badge-narrative'); if(b) b.outerHTML=generateClassChartHTML('narrative', data.stats.narrAvg, data.stats.narrativeTotal); }
        if(data.stats.argumentTotal>0) { const b=d.querySelector('.badge-argument'); if(b) b.outerHTML=generateClassChartHTML('argument', data.stats.argAvg, data.stats.argumentTotal); }
        c.innerHTML = `<div style="text-align:right;color:#999;padding:20px 20px 0 0;">報告日期：${data.dateStr}</div><div style="padding:20px;">${d.innerHTML}</div>`;
        m.style.display = 'flex';
        // Render charts slightly delayed to ensure DOM is ready
        setTimeout(() => { if(data.stats.narrativeTotal>0) renderClassChart('narrativeClassChart', data.stats.narrAvg); if(data.stats.argumentTotal>0) renderClassChart('argumentClassChart', data.stats.argAvg); }, 200);
    }
    
   // === 關鍵修訂：生成左右並置的 HTML ===
   function generateClassChartHTML(type, avg, total) {
        const id = type==='narrative'?'narrativeClassChart':'argumentClassChart';
        const title = type==='narrative'?'敘事抒情':'議論';
        const cls = type==='narrative'?'badge-narrative':'badge-argument';
        
        // 將 avg 物件轉換為 JSON 字串，以便 onclick 傳遞
        const avgStr = JSON.stringify(avg).replace(/"/g, '&quot;');
        
        return `
        <div class="report-section">
            <div class="report-category-badge ${cls}"><i class="fas fa-book"></i> ${title}</div>
            
            <div class="report-radar-wrapper">
                <!-- 左右並置容器 -->
                <div class="grading-side-by-side">
                    
                    <!-- 1. 左側：評分條 -->
                    <div class="grading-scores">
                        <h3 style="margin-top:0; border-left:none; padding-left:0; text-align:center;">班級平均表現</h3>
                        <div class="score-item"><label>內容 (40)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.content*10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.content*4}</span></div></div>
                        <div class="score-item"><label>表達 (30)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.expr*10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.expr*3}</span></div></div>
                        <div class="score-item"><label>結構 (20)</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.struct*10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.struct*2}</span></div></div>
                        <div class="total-score-container"><span style="font-size:1.1em; color:#555;">平均總分: ${total} / 100</span><span style="font-size:2em; font-weight:bold; color:#d9534f;">${determineGrade(total)}</span></div>
                    </div>
                    
                    <!-- 2. 右側：雷達圖 (縮圖，點擊放大) -->
                    <div class="grading-radar-thumbnail" onclick='openEnlargedChart("${title}", ${avgStr})'>
                        <h3>能力分佈圖</h3>
                        <div class="radar-chart-mini-container">
                            <canvas id="${id}"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    // 渲染縮圖 (保持原有邏輯)
    function renderClassChart(id, avg) {
        const ctx = document.getElementById(id); if(!ctx) return;
        new Chart(ctx.getContext('2d'), {
            type: 'radar',
            data: { labels: ['立意','取材','扣題','詳略','詞彙','文學性'], datasets: [{ label: '班級平均', data: [(avg.content*0.6+avg.struct*0.4).toFixed(1), (avg.content*0.8+avg.expr*0.2).toFixed(1), (avg.content*0.7+avg.struct*0.3).toFixed(1), (avg.struct*0.7+avg.content*0.3).toFixed(1), avg.expr, avg.expr], backgroundColor: 'rgba(94, 112, 103, 0.4)', borderColor: '#5e7067', borderWidth: 2, pointBackgroundColor: '#5e7067' }] },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } }, // 縮圖不顯示刻度
                plugins: { legend: { display: false } } 
            }
        });
    }
    
    // === 新增：打開放大圖表的 Modal 並渲染大圖 ===
    let bigChartInstance = null;
    function openEnlargedChart(title, avg) {
        document.getElementById('chartEnlargeModal').style.display = 'flex';
        document.getElementById('enlargeChartTitle').innerHTML = `<i class="fas fa-chart-area"></i> ${title} - 能力詳細分析`;
        
        const ctx = document.getElementById('bigChartCanvas').getContext('2d');
        if (bigChartInstance) bigChartInstance.destroy(); // 銷毀舊圖表

        bigChartInstance = new Chart(ctx, {
            type: 'radar',
            data: { 
                labels: ['立意 (深淺)', '取材 (廣度)', '扣題 (緊密)', '詳略 (佈局)', '詞彙 (豐富)', '文學性 (修辭)'], 
                datasets: [{ 
                    label: '班級平均', 
                    data: [
                        (avg.content*0.6+avg.struct*0.4).toFixed(1), 
                        (avg.content*0.8+avg.expr*0.2).toFixed(1), 
                        (avg.content*0.7+avg.struct*0.3).toFixed(1), 
                        (avg.struct*0.7+avg.content*0.3).toFixed(1), 
                        avg.expr, 
                        avg.expr
                    ], 
                    backgroundColor: 'rgba(148, 167, 181, 0.5)', 
                    borderColor: '#94a7b5', 
                    borderWidth: 3, 
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#94a7b5',
                    pointHoverBackgroundColor: '#94a7b5',
                    pointHoverBorderColor: '#fff',
                    pointRadius: 5,
                    pointHoverRadius: 8
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    r: { 
                        suggestedMin: 0, 
                        suggestedMax: 10,
                        angleLines: { color: '#eee' },
                        grid: { color: '#e0ddd7' },
                        pointLabels: {
                            font: { size: 14, family: "'Noto Serif TC', serif", weight: 'bold' },
                            color: '#555'
                        },
                        ticks: { display: true, backdropColor: 'transparent', z: 10 }
                    } 
                }, 
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 16 },
                        bodyFont: { size: 14 },
                        padding: 12
                    }
                } 
            }
        });
    }

    async function callAPI(prompt) {
        let k = READING_API_KEYS[Math.floor(Math.random() * READING_API_KEYS.length)];
        const r = await fetch(READING_API_URL, { method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" }, body: JSON.stringify({ model: READING_MODEL, messages: [{ role: "user", content: prompt }], max_tokens: 4000 }) });
        const d = await r.json(); return d.choices[0].message.content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>/gis, '').trim();
    }

    // === 數據統計 ===
    let selectedAnalyticsStudent = null; 

    function initStatUI() {
        const now = new Date();
        const y = now.getFullYear(); const m = String(now.getMonth() + 1).padStart(2, '0'); const d = String(now.getDate()).padStart(2, '0');
        document.getElementById('statDate').value = `${y}-${m}-${d}`;
        document.getElementById('statYear').value = y;
        const ms = document.getElementById('statMonth'); ms.innerHTML = '';
        for(let i=1; i<=12; i++) { const o=document.createElement('option'); o.value=String(i).padStart(2,'0'); o.text=i+'月'; if(o.value===m) o.selected=true; ms.add(o); }
        updateStatInputs(); updateTimeInputs();
    }
    function updateStatInputs() { 
        const s=document.getElementById('statScope').value; 
        document.getElementById('statClassInput').style.display=(s==='class')?'inline-block':'none';
        document.getElementById('analyticsStudentListContainer').style.display=(s==='class')?'block':'none';
        if(s==='class') loadAnalyticsClassList();
    }
    function updateTimeInputs() { const m=document.getElementById('statTimeMode').value; document.getElementById('statDate').style.display=(m==='day')?'inline-block':'none'; document.getElementById('statMonth').style.display=(m==='month')?'inline-block':'none'; document.getElementById('statYear').style.display=(m==='month'||m==='year')?'inline-block':'none'; }
    
    function loadAnalyticsClassList() {
        const g = document.getElementById('statGrade').value;
        const c = document.getElementById('statClass').value;
        const list = document.getElementById('analyticsStudentList');
        selectedAnalyticsStudent = null; 
        list.innerHTML = '載入學生中...';
        
        db.ref(`students/${g}/${c}`).once('value', s => {
            const data = s.val();
            list.innerHTML = '';
            if(!data) { list.innerHTML = '此班級無學生'; return; }
            const sorted = Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99));
            sorted.forEach(([name, d]) => {
                const chip = document.createElement('div');
                chip.className = 'student-chip';
                chip.innerText = `${d.profile?.number||''}. ${name}`;
                chip.onclick = () => {
                    if (selectedAnalyticsStudent === name) {
                        selectedAnalyticsStudent = null; 
                        document.querySelectorAll('.student-chip').forEach(el => el.classList.remove('active'));
                    } else {
                        selectedAnalyticsStudent = name;
                        document.querySelectorAll('.student-chip').forEach(el => el.classList.remove('active'));
                        chip.classList.add('active');
                    }
                };
                list.appendChild(chip);
            });
        });
    }

let analyticsChartInstance = null;

    async function fetchAndRenderStats() {
        const scope = document.getElementById('statScope').value;
        const mode = document.getElementById('statTimeMode').value;
        let y, m, d;
        
        if (mode === 'day') { 
            const p = document.getElementById('statDate').value.split('-'); 
            y=p[0]; m=p[1]; d=p[2]; 
        } else { 
            y=document.getElementById('statYear').value; 
            if(mode==='month') m=document.getElementById('statMonth').value; 
        }
        
        let path = `analytics/${y}`; 
        if(mode==='day') path+=`/${m}/${d}`; 
        else if(mode==='month') path+=`/${m}`;

        try {
            const snap = await db.ref(path).once('value');
            const data = snap.val();
            
            // 無數據處理
            if (!data) { 
                alert("此時段無數據紀錄"); 
                ['dispUnique','dispVisits','dispDuration','dispAvg'].forEach(id=>document.getElementById(id).innerText=0);
                if(analyticsChartInstance) analyticsChartInstance.destroy(); 
                return; 
            }

            // 初始化統計容器
            // agg[時間標籤] = { uniqueSet: Set(), totalVisits: 0, totalDuration: 0 }
            let agg = {};
            
            // 全域統計 (用於上方卡片顯示)
            let globalUniqueSet = new Set();
            let grandTotalVisits = 0;
            let grandTotalDuration = 0;

            function proc(node, label) {
                if(!node) return;
                
                // 初始化該時間點的數據結構
                if(!agg[label]) agg[label] = { uniqueSet: new Set(), visits: 0, duration: 0 };

                // 1. 處理學生數據
                if (node.students) {
                    if(scope === 'global' || scope === 'school') {
                        Object.keys(node.students).forEach(gKey => {
                            Object.keys(node.students[gKey]).forEach(cKey => {
                                Object.keys(node.students[gKey][cKey]).forEach(sName => {
                                    const sData = node.students[gKey][cKey][sName];
                                    const uid = `${gKey}${cKey}_${sName}`;
                                    
                                    // 統計邏輯
                                    const v = parseInt(sData.visits || 0);
                                    const t = parseInt(sData.duration || 0);
                                    
                                    // 加入該時間點的統計
                                    agg[label].uniqueSet.add(uid);
                                    agg[label].visits += v;
                                    agg[label].duration += t;

                                    // 加入全域統計
                                    globalUniqueSet.add(uid);
                                    grandTotalVisits += v;
                                    grandTotalDuration += t;
                                });
                            });
                        });
                    } else if (scope === 'class') {
                        const g = document.getElementById('statGrade').value;
                        const c = document.getElementById('statClass').value;
                        if(node.students[g] && node.students[g][c]) {
                             Object.keys(node.students[g][c]).forEach(sName => {
                                if (selectedAnalyticsStudent && sName !== selectedAnalyticsStudent) return;
                                const sData = node.students[g][c][sName];
                                const v = parseInt(sData.visits||0);
                                const t = parseInt(sData.duration||0);
                                
                                agg[label].uniqueSet.add(sName);
                                agg[label].visits += v;
                                agg[label].duration += t;

                                globalUniqueSet.add(sName);
                                grandTotalVisits += v;
                                grandTotalDuration += t;
                            });
                        }
                    }
                }

                // 2. 處理訪客數據 (僅 Global 模式)
                if (scope === 'global' && node.guests) {
                    Object.keys(node.guests).forEach(guestID => {
                        const gData = node.guests[guestID];
                        const v = parseInt(gData.visits || 0);
                        const t = parseInt(gData.duration || 0);
                        
                        agg[label].uniqueSet.add(guestID);
                        agg[label].visits += v;
                        agg[label].duration += t;

                        globalUniqueSet.add(guestID);
                        grandTotalVisits += v;
                        grandTotalDuration += t;
                    });
                }
            }

            // 執行遍歷
            if(mode==='day') proc(data, '本日');
            else if(mode==='month') Object.keys(data).sort().forEach(k=>proc(data[k], parseInt(k)+'日'));
            else if(mode==='year') Object.keys(data).sort().forEach(mk=>{ Object.keys(data[mk]).forEach(dk=>proc(data[mk][dk], parseInt(mk)+'月')); });

            // 更新上方卡片數據
            const totalPeople = globalUniqueSet.size;
            const safeDivisor = totalPeople === 0 ? 1 : totalPeople;

            document.getElementById('dispUnique').innerText = totalPeople;
            document.getElementById('dispVisits').innerText = grandTotalVisits;
            document.getElementById('dispDuration').innerText = Math.round(grandTotalDuration/60);
            document.getElementById('dispAvg').innerText = Math.round((grandTotalDuration/60) / safeDivisor);

            // === 準備圖表數據 ===
            const labels = Object.keys(agg);
            
            // 數據集 1 (底層): 使用人數 (不重複)
            const uniqueData = Object.values(agg).map(a => a.uniqueSet.size);
            
            // 數據集 2 (上層): 重複進入次數 = (總次數 - 不重複人數)
            // 這樣堆疊起來的總高度就會等於「總次數」
            const repeatData = Object.values(agg).map(a => {
                const unique = a.uniqueSet.size;
                const total = a.visits;
                // 防止數據異常導致負數 (理論上 total >= unique)
                return Math.max(0, total - unique);
            });

            const durationData = Object.values(agg).map(a => Math.round(a.duration/60));

            // 繪圖
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            if(analyticsChartInstance) analyticsChartInstance.destroy();
            
            analyticsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [
                        { 
                            label: '使用人數 (不重複)', 
                            data: uniqueData, 
                            backgroundColor: '#b6a6ca', // 紫色 (底層)
                            stack: 'Stack 0',
                            maxBarThickness: 50,
                            minBarLength: 2 
                        },
                        { 
                            label: '重複進入次數', 
                            data: repeatData, 
                            backgroundColor: '#94a7b5', // 藍色 (上層)
                            stack: 'Stack 0',
                            maxBarThickness: 50,
                            minBarLength: 2
                        },
                        { 
                            label: '總時長(分)', 
                            data: durationData, 
                            type: 'line', 
                            borderColor: '#d69a92', 
                            borderWidth: 2, 
                            yAxisID: 'y1',
                            tension: 0.1
                        }
                    ] 
                },
                options: { 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            position: 'left', 
                            title: {display:true, text:'人次 (總高度=總次數)'}, 
                            stacked: true, // 啟用堆疊
                            ticks: {
                                stepSize: 1, // 強制整數
                                callback: function(value) { if (value % 1 === 0) return value; }
                            }
                        }, 
                        y1: { 
                            beginAtZero: true, 
                            position: 'right', 
                            grid: { drawOnChartArea: false }, 
                            title: {display:true, text:'分鐘'},
                            ticks: {
                                stepSize: 1, // 強制整數
                                callback: function(value) { if (value % 1 === 0) return value; }
                            }
                        } 
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // 優化 Tooltip 顯示，讓使用者知道總數
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        if(tooltipItem.dataset.type !== 'line') {
                                            total += tooltipItem.raw;
                                        }
                                    });
                                    // 只有當有堆疊數據時才顯示總和
                                    if(total > 0 && tooltipItems[0].dataset.type !== 'line') {
                                        return '總進入次數: ' + total;
                                    }
                                    return '';
                                }
                            }
                        }
                    }
                }
            });

        } catch(e) { console.error(e); alert("讀取失敗"); }
    }
    // === 共用功能與共用 HTML 解析函式 ===
    function openHistoryModal(name, h) {
        document.getElementById('viewerTitle').innerHTML = `<i class="fas fa-user-graduate"></i> ${name}`;
        currentStudentHistory = h; document.getElementById('historyViewerModal').style.display = 'flex'; renderLevel1();
    }
    
    // 渲染主範疇 (已修訂：隱藏學習報告)
    function renderLevel1() {
        ['historyLevel2','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('historyLevel1').style.display='flex'; document.getElementById('teacherBreadcrumb').style.display='none';
        const c = document.getElementById('historyLevel1'); c.innerHTML='';
        Object.keys(HISTORY_STRUCTURE).forEach(cat => {
            // 修訂：隱藏學習報告
            if (cat === '學習報告') return;

            const count = currentStudentHistory.filter(r => r.category === cat).length;
            const asset = CATEGORY_ASSETS[cat] || { img: '背景.png', en: 'RECORD' };
            const style = count===0 ? 'filter: grayscale(100%); opacity: 0.6;' : '';
            c.innerHTML += `<div class="anime-card" style="--bg-img: url('${asset.img}'); ${style}" onclick="renderLevel2('${cat}')"><div class="card-overlay"></div><div class="card-content"><span class="card-zh">${cat}</span><span class="card-en">${count} 筆</span></div></div>`;
        });
    }
    function renderLevel2(cat) {
        currentCategory=cat; ['historyLevel1','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('historyLevel2').style.display='grid'; updateBreadcrumb(cat);
        const c = document.getElementById('historyLevel2'); c.innerHTML='';
        const subs = HISTORY_STRUCTURE[cat] || [];
        subs.forEach((sub,i)=>{
            const count=currentStudentHistory.filter(r=>r.category===cat&&r.subFunction===sub).length;
            const theme=(i%5)+1;
            c.innerHTML+=`<div class="history-folder-btn history-theme-${theme}" style="${count===0?'opacity:0.6':''}" onclick="renderLevel3('${sub}',${theme})"><i class="fas ${SUB_ICONS[sub]||'fa-file'}"></i><span style="font-weight:bold;font-size:1.1em;">${sub}</span><span style="font-size:0.8em;margin-top:5px;color:#999;">(${count})</span></div>`;
        });
    }
    function renderLevel3(sub, theme) {
        currentSubFunction=sub; currentThemeIndex=theme; ['historyLevel1','historyLevel2','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
        document.getElementById('historyLevel3').style.display='grid'; updateBreadcrumb(currentCategory,sub);
        const c=document.getElementById('historyLevel3'); c.innerHTML='';
        const recs=currentStudentHistory.filter(r=>r.category===currentCategory&&r.subFunction===sub).sort((a,b)=>b.timestamp-a.timestamp);
        if(recs.length===0){c.innerHTML='<p style="text-align:center;width:100%;color:#999;grid-column:1/-1;">無紀錄</p>';return;}
        recs.forEach(r=>{
            // ★★★ 核心修改：使用與學生端一致的卡片結構 (打孔風格) ★★★
            const dateStr = r.dateStr ? r.dateStr.split(' ')[0] : '未知';
            
            c.innerHTML+=`
            <div class="history-card theme-${theme}" onclick='renderDetail(${JSON.stringify(r).replace(/'/g, "&#39;")})'>
                <div style="flex-grow: 1;">
                    <div class="history-meta">
                        <span class="tag" style="background:var(--m-color-${theme}); color:white; border:none; margin:0;">${r.subFunction}</span>
                        <span style="font-family: 'Courier New', monospace; font-size: 0.85em; color: #aaa; margin-left: auto;">${dateStr}</span>
                    </div>
                    <h4 class="history-title">${r.title||'無標題'}</h4>
                </div>
            </div>`;
        });
    }
    
    // 共用解析函式
    function renderParsedUserContent(userContent, themeIndex = 1) {
        if (!userContent) return '<div style="padding:20px; color:#999; text-align:center;">無使用者輸入內容</div>';
        const lines = userContent.split('\n');
        let html = `<div class="history-parsed-container history-theme-context-${themeIndex}">`;
        let currentLabel = '輸入內容'; 
        let currentContent = []; 
        const labelRegex = /^(.{2,10}?)[：:](.*)$/;
        lines.forEach((line) => {
            const match = line.match(labelRegex);
            if (match) {
                if (currentContent.length > 0) {
                    html += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${currentContent.join('\n')}</div></div>`;
                }
                currentLabel = match[1].trim(); 
                const rest = match[2].trim(); 
                currentContent = rest ? [rest] : [];
            } else if (line.trim() !== "") {
                currentContent.push(line);
            }
        });
        if (currentContent.length > 0 || lines.length === 0) {
             const finalContent = currentContent.length > 0 ? currentContent.join('\n') : userContent;
             html += `<div class="history-item-block"><div class="history-item-label">${currentLabel}</div><div class="history-item-content">${finalContent}</div></div>`;
        }
        html += `</div>`;
        return `<div style="background:#fff;padding:20px;border:1px solid #eee;border-radius:12px;margin-bottom:25px; box-shadow:0 2px 10px rgba(0,0,0,0.03);">${html}</div>`;
    }

    // 歷史紀錄詳情
  function renderDetail(r) {
            ['historyLevel1','historyLevel2','historyLevel3'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyDetail').style.display='block';
            document.getElementById('teacherBreadcrumb').style.display='none';
            
            let uContent = '';
            if (r.category === "學習報告") {
                uContent = ''; 
            } else {
                if(r.userContent) {
                    uContent = renderParsedUserContent(r.userContent, currentThemeIndex);
                } else {
                    uContent = `<div style="padding:20px; color:#999; text-align:center;">無使用者輸入內容</div>`;
                }
            }

            document.getElementById('historyDetail').innerHTML = `
                <div style="margin-bottom:15px;">
                    <button class="nav-btn" onclick="renderLevel3('${currentSubFunction}',${currentThemeIndex})" style="padding:5px 15px;font-size:0.9em;">
                        <i class="fas fa-arrow-left"></i> 返回列表
                    </button>
                </div>
                <div class="detail-view">
                    <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                        <h2 style="text-align:left; margin:0; color:#333;">${r.title}</h2>
                        <p style="color:#888; margin-top:5px;">${r.dateStr}</p>
                    </div>
                    ${uContent}
                    <div class="detail-ai-box" style="margin-top:20px;">
                        <h4 style="color:var(--m-green); margin-bottom:10px;">AI 生成結果：</h4>
                        ${r.aiContent}
                    </div>
                </div>`;
        }

    
    function updateBreadcrumb(c,s) { const b=document.getElementById('teacherBreadcrumb'); b.style.display='flex'; document.getElementById('breadCategory').innerText=c; document.getElementById('breadSub').innerText=s||''; document.getElementById('breadSep2').style.display=s?'inline':'none'; }
    
    // === 課業管理 ===
    function loadAssignmentHistory() {
        const g = document.getElementById('assignGrade').value, c = document.getElementById('assignClass').value, list = document.getElementById('assignmentHistoryList');
        list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> 載入中...</p>';
        db.ref(`assignments/${g}/${c}`).on('value', (snapshot) => {
            const data = snapshot.val(); list.innerHTML = '';
            if (!data) { list.innerHTML = '<div style="text-align:center; padding:30px; color:#ccc;">無課業</div>'; return; }
            Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp).forEach(([key, task]) => {
                const div = document.createElement('div'); div.className = 'assignment-item';
                div.innerHTML = `<div><div style="font-weight:bold;">${task.topic}</div><div style="font-size:0.9em;color:#888;"><span class="tag">${task.type}</span>${new Date(task.timestamp).toLocaleDateString()}</div></div><div style="display:flex;gap:10px;"><button class="btn-action btn-view" onclick="viewSubmissions('${key}', '${task.topic}', '${g}', '${c}')"><i class="fas fa-eye"></i></button><button class="btn-action btn-delete" onclick="deleteAssignment('${key}', '${g}', '${c}')"><i class="fas fa-trash-alt"></i></button></div>`;
                list.appendChild(div);
            });
        });
    }
    function publishAssignment() {
        const g = document.getElementById('assignGrade').value, c = document.getElementById('assignClass').value, topic = document.getElementById('assignTopic').value.trim(), type = document.getElementById('assignType').value;
        if (!topic) return alert("請輸入題目");
        db.ref(`assignments/${g}/${c}`).push().set({ topic, type, timestamp: Date.now() }, e => { if(e) alert("失敗"); else { sendClassNotification(g, c, "新課業發佈", `老師發佈了：${topic}`); alert("發佈成功"); document.getElementById('assignTopic').value=''; } });
    }
    function deleteAssignment(id, g, c) { if(confirm("確定刪除？")) db.ref(`assignments/${g}/${c}/${id}`).remove(); }
    
    async function viewSubmissions(aid, title, g, c) {
        currentViewingAssignmentId = aid; document.getElementById('submissionTitle').innerText = title; document.getElementById('submissionViewerModal').style.display = 'flex';
        const list = document.getElementById('submissionList'); list.innerHTML = '<li>載入中...</li>';
        try {
            const [stus, subs] = await Promise.all([db.ref(`students/${g}/${c}`).once('value').then(s=>s.val()||{}), db.ref(`assignments_submissions/${aid}`).once('value').then(s=>s.val()||{})]);
            list.innerHTML = ''; let done=0, total=0;
            Object.entries(stus).sort((a,b)=>(parseInt(a[1].profile?.number)||99)-(parseInt(b[1].profile?.number)||99)).forEach(([name, d]) => {
                total++; const hasSub = subs[name]; if(hasSub) done++;
                const li = document.createElement('li'); li.className = 'submission-item';
                li.innerHTML = `<span>${d.profile?.number||'??'}. ${name}</span> ${hasSub ? '<span class="status-badge status-done">已繳交</span>' : '<span class="status-badge status-pending">未繳交</span>'}`;
                li.onclick = () => { document.querySelectorAll('.submission-item').forEach(i=>i.classList.remove('active')); li.classList.add('active'); if(hasSub) showSubDetail(hasSub); else document.getElementById('submissionDetailArea').innerHTML = `<div style="text-align:center;margin-top:50px; color:#a67069;"><p>${name} 未繳交</p></div>`; };
                list.appendChild(li);
            });
            document.getElementById('submitCount').innerText = done; document.getElementById('pendingCount').innerText = total - done;
        } catch(e) { console.error(e); }
    }

    // 課業詳情檢閱 (修訂：確保與歷史紀錄顯示一致)
    function showSubDetail(sub) {
        const fb = sub.teacherFeedback || {};
        
        // 使用共用解析函式，確保 100% 一致 (預設傳入主題色 1)
        let uContent = renderParsedUserContent(sub.userContent, 1);

        document.getElementById('submissionDetailArea').innerHTML = `
            <div class="detail-view">
                <h2>${sub.studentName}</h2>
                <div style="font-size:0.9em; color:#888; margin-bottom:10px;">提交時間：${sub.submittedAt}</div>
                ${uContent}
                <div class="detail-ai-box" style="margin-top:20px;">${sub.aiContent}</div>
                <div class="teacher-feedback-section">
                    <h3><i class="fas fa-pen-alt"></i> 老師批改</h3>
                    <div style="margin-bottom:15px;">
                        <label style="font-weight:bold; color:#8d6e63;">分數：</label>
                        <input id="ts" value="${fb.score||''}" placeholder="例如：5**" type="text">
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="font-weight:bold; color:#8d6e63;">評語：</label>
                        <textarea id="tc" rows="3" placeholder="請輸入評語...">${fb.comment||''}</textarea>
                    </div>
                    <button class="btn-action btn-manage" onclick="sendFb('${sub.studentName}')">發還給學生</button>
                </div>
            </div>`;
    }
    
    function sendFb(name) { db.ref(`assignments_submissions/${currentViewingAssignmentId}/${name}/teacherFeedback`).set({score:document.getElementById('ts').value, comment:document.getElementById('tc').value, timestamp:Date.now(), status:'returned'}, e=>alert(e?'失敗':'成功')); }

    // === 學年管理 ===
    function populateTransferStudentList() {
        const g=document.getElementById('indivFromGrade').value, c=document.getElementById('indivFromClass').value, b=document.getElementById('transferStudentListBox'); b.innerHTML='載入中...';
        db.ref(`students/${g}/${c}`).once('value', s=>{
            const d=s.val(); b.innerHTML=''; if(!d) { b.innerHTML='無學生'; return; }
            Object.entries(d).sort((a,b)=>(parseInt(a[1].profile?.number)||99)-(parseInt(b[1].profile?.number)||99)).forEach(([n,i])=>{ b.innerHTML+=`<label class="student-select-item"><input type="radio" name="ts" value="${n}"> ${i.profile?.number||'??'}. ${n}</label>`; });
        });
    }
    function moveIndividualStudent() {
        const n = document.querySelector('input[name="ts"]:checked')?.value; if (!n) return alert("請選擇學生");
        const fg = document.getElementById('indivFromGrade').value, fc = document.getElementById('indivFromClass').value, tg = document.getElementById('indivToGrade').value, tc = document.getElementById('indivToClass').value, nn = document.getElementById('indivNewNumber').value; if (!nn) return alert("請輸入新班號");
        const oldPath = `students/${fg}/${fc}/${n}`, newPath = `students/${tg}/${tc}/${n}`;
        db.ref(oldPath).once('value', s => { const d = s.val(); if (!d) return; d.profile = d.profile || {}; d.profile.grade = tg; d.profile.class = tc; d.profile.number = nn; if (oldPath === newPath) db.ref(newPath).update(d, e => { if (!e) { alert("更新成功"); populateTransferStudentList(); }}); else db.ref(newPath).set(d, e => { if (!e) { db.ref(oldPath).remove(); alert("轉班成功"); populateTransferStudentList(); }}); });
    }
    function deleteStudent() { const n=document.querySelector('input[name="ts"]:checked')?.value; if(n && confirm(`刪除 ${n}?`)) db.ref(`students/${document.getElementById('indivFromGrade').value}/${document.getElementById('indivFromClass').value}/${n}`).remove(e=>{ if(!e) populateTransferStudentList(); }); }
    function updateYearConfig() { db.ref('config/currentYear').set(document.getElementById('currentYearInput').value, e=>alert(e?'失敗':'成功')); }
    async function runYearTransition() {
        if(prompt("密碼")!=="23262036") return; if(!confirm("確定全校升班？")) return;
        const all = (await db.ref('students').once('value')).val(); if(!all) return;
        const y = document.getElementById('currentYearInput').value; await db.ref(`archives/${y}/students`).set(all);
        let n = {}; for(let g=1; g<=5; g++) { if(all[g]) { n[g+1] = all[g]; for(let c in n[g+1]) for(let s in n[g+1][c]) if(n[g+1][c][s].profile) n[g+1][c][s].profile.grade=(g+1).toString(); } }
        if(all[6]) await db.ref(`graduates/${y}`).set(all[6]);
        db.ref('students').set(n, e=>alert(e?'失敗':'成功'));
    }
</script>

<footer class="copyright-footer">
    <p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>
</body>
</html>
