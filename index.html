<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥æ€ - æ•™ç ”å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- å¼•å…¥ Chart.js ä»¥ç¹ªè£½é›·é”åœ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* === è«è˜­è¿ªè‰²ç³»å®šç¾© === */
        :root {
            --m-green: #8fa398;   --m-blue: #94a7b5;    --m-purple: #b6a6ca;
            --m-red: #d69a92;     --m-brown: #c7b299;   --bg-color: #fdfcf8;
            --text-main: #5e5e5e; --border-color: #e0ddd7;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: url('èƒŒæ™¯.png') center/cover fixed;
            background-color: #f4f4f4;
            color: var(--text-main);
            overflow-y: scroll;
        }

        /* === ç™»å…¥é®ç½© (å®‰å…¨é–˜é–€) === */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdfcf8; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-color);
            max-width: 400px; width: 90%;
        }
        .login-btn {
            background-color: var(--m-blue); color: white; padding: 12px 30px;
            border: none; border-radius: 50px; font-size: 1.1em; cursor: pointer;
            margin-top: 20px; transition: all 0.3s; width: 100%;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(148, 167, 181, 0.4); }

        /* === éš±è—ä¸»è¦å…§å®¹ï¼Œç™»å…¥å¾Œæ‰é¡¯ç¤º === */
        #mainApp { display: none; }

        /* === é€šç”¨å®¹å™¨ === */
        h1, h2 { text-align: center; color: var(--text-main); margin-bottom: 20px; letter-spacing: 2px; }
        h3 { color: var(--m-blue); border-left: 5px solid var(--m-blue); padding-left: 10px; margin-top: 30px; }
        .box { background: rgba(255, 255, 255, 0.98); border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); padding: 30px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        
        /* === å°èˆªèˆ‡æŒ‰éˆ• === */
        .nav-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-btn { padding: 12px 30px; border-radius: 50px; border: none; background: #e0e0e0; color: #666; cursor: pointer; font-size: 1.05em; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .nav-btn.active { background: var(--m-blue); color: white; box-shadow: 0 4px 12px rgba(148, 167, 181, 0.4); transform: translateY(-2px); }
        .nav-btn:hover:not(.active) { background: #dcdcdc; }
        
        .btn-action { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; color: white; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-action:hover { filter: brightness(95%); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-action:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-view { background-color: var(--m-blue); } .btn-delete { background-color: var(--m-red); } .btn-manage { background-color: var(--m-brown); }
        .btn-publish { background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%); font-size: 1.2rem; padding: 15px 40px; width: 100%; justify-content: center; font-weight: bold; letter-spacing: 1px; border-radius: 50px; box-shadow: 0 5px 15px rgba(143, 163, 152, 0.4); }

        .filter-group { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 20px; background: #fcfcfc; border-radius: 12px; flex-wrap: wrap; border: 1px solid var(--border-color); }
        select, input { padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Noto Serif TC', serif; font-size: 1rem; outline: none; background: #fff; color: #555; }
        
        /* === å­¸ç”Ÿåˆ—è¡¨ === */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .student-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); border-top: 5px solid var(--m-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s ease; }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .student-name { font-size: 1.2em; font-weight: bold; color: #444; margin-bottom: 5px; }
        .last-sync { font-size: 0.85em; color: #999; display: flex; align-items: center; gap: 6px; }

        /* === æ­·å²æª¢é–± UI === */
        .category-cards-container { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; padding: 20px; }
        .anime-card {
            position: relative; width: 140px; height: 200px; border-radius: 15px;
            background-image: var(--bg-img); background-size: cover; background-position: center;
            cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden; filter: grayscale(20%); margin-bottom: 20px; border: 2px solid #fff;
        }
        .anime-card:hover { transform: translateY(-10px) scale(1.05); filter: grayscale(0%); box-shadow: 0 15px 30px rgba(0,0,0,0.3); z-index: 10; }
        .card-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 60%); }
        .card-content { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; text-align: center; }
        .card-zh { display: block; color: #fff; font-size: 18px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 2px; }
        .card-en { display: block; color: rgba(255,255,255,0.7); font-size: 10px; letter-spacing: 1px; margin-top: 5px; }

        /* ç¬¬äºŒå±¤ï¼šå­åŠŸèƒ½ Grid æŒ‰éˆ• */
        .history-grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 20px 0; }
        .history-folder-btn {
            background-color: #fff; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px 15px; 
            text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 120px; color: #555;
        }
        .history-folder-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); background-color: #fff; }
        .history-folder-btn i { font-size: 2em; margin-bottom: 10px; color: #ccc; transition: color 0.3s; }
        
        .history-theme-1 { border-color: #8fa398; color: #8fa398; } .history-theme-1:hover i { color: #8fa398; }
        .history-theme-2 { border-color: #94a7b5; color: #94a7b5; } .history-theme-2:hover i { color: #94a7b5; }
        .history-theme-3 { border-color: #b6a6ca; color: #b6a6ca; } .history-theme-3:hover i { color: #b6a6ca; }
        .history-theme-4 { border-color: #d69a92; color: #d69a92; } .history-theme-4:hover i { color: #d69a92; }
        .history-theme-5 { border-color: #c7b299; color: #c7b299; } .history-theme-5:hover i { color: #c7b299; }

        /* ç¬¬ä¸‰å±¤ï¼šç´€éŒ„åˆ—è¡¨å¡ç‰‡ */
        .history-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-top: 10px; }
        .history-card {
            background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 8px; 
            padding: 20px 20px 20px 55px; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.03); 
            cursor: pointer; transition: all 0.3s; overflow: hidden;
            background-image: linear-gradient(to right, transparent 39px, #e0ddd7 40px, transparent 41px), radial-gradient(circle at 20px 50%, #d1cdc5 6px, transparent 7px);
            background-size: 100% 100%, 100% 35px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 12px;
        }
        .history-card:hover { transform: translateY(-3px); box-shadow: 6px 6px 0px rgba(0,0,0,0.08); background-color: #fff; }
        .history-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; z-index: 1; }
        
        .theme-1::before { background: #8fa398; } .theme-2::before { background: #94a7b5; }
        .theme-3::before { background: #b6a6ca; } .theme-4::before { background: #d69a92; } .theme-5::before { background: #c7b299; }

        .history-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #999; margin-bottom: 10px; border-bottom: 1px dashed #e0ddd7; padding-bottom: 5px; }
        .history-title { margin: 0; font-size: 1.1em; color: #444; font-weight: bold; line-height: 1.4; }

        .history-breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #999; margin-bottom: 20px; padding: 10px 5px; border-bottom: 1px dashed #ccc; }
        .breadcrumb-item { cursor: pointer; font-weight: bold; color: var(--m-blue); transition: color 0.2s; }
        .breadcrumb-item:hover { color: #5e5e5e; text-decoration: underline; }
        .breadcrumb-current { color: #5e5e5e; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; font-weight: bold; }

        /* === èª²æ¥­åˆ—è¡¨ === */
        .assignment-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 12px; background: #fff; transition: all 0.2s; }
        .tag { background-color: #eee; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: normal; margin-right: 10px; }
        .publish-area { background: #fdfcf8; padding: 30px; border-radius: 15px; border: 2px dashed var(--m-green); margin-bottom: 40px; display: flex; flex-direction: column; gap: 20px; }
        .publish-inputs { display: flex; gap: 15px; width: 100%; flex-wrap: wrap; }
        .publish-inputs input { flex: 1 1 auto; min-width: 200px; padding: 15px; font-size: 1.1em; border: 1px solid #ddd; }

        /* === Modals === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-body { background: #fff; width: 95%; max-width: 1100px; height: 90vh; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 20px 30px; background: #fdfcf8; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-content-scroll { flex: 1; overflow-y: auto; padding: 20px 30px; -webkit-overflow-scrolling: touch; }
        
        /* è©³æƒ…é å…§å®¹ */
        .detail-view { background: #fff; padding: 10px; }
        .history-parsed-container { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e1e4e8; border-left: 5px solid var(--m-blue); margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .history-item-block { margin-bottom: 15px; }
        .history-item-label { font-weight: bold; color: var(--m-blue); font-size: 1em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .history-item-label::before { content: ''; display: block; width: 8px; height: 8px; background-color: var(--m-blue); border-radius: 50%; opacity: 0.8; }
        .history-item-content { background: #fcfcfc; border: 1px solid #e1e4e8; border-radius: 4px; padding: 12px 16px; color: #444; line-height: 1.8; white-space: pre-wrap; }
        
        /* ç¹³äº¤æª¢é–± */
        .modal-content-container { display: flex; height: 100%; overflow: hidden; }
        .submission-sidebar { width: 320px; border-right: 1px solid var(--border-color); overflow-y: auto; background: #fafafa; flex-shrink: 0; }
        .submission-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .submission-item:hover { background: #f0f0f0; }
        .submission-item.active { background: #eef2f5; border-left: 4px solid var(--m-blue); }
        .status-badge { font-size: 0.8em; padding: 3px 10px; border-radius: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .status-done { background: #e8edea; color: #5e7067; }
        .status-pending { background: #f7ebea; color: #a67069; }
        .submission-detail-area { flex-grow: 1; padding: 30px; overflow-y: auto; background: #fff; }
        .teacher-feedback-section { background-color: #fffaf5; border: 2px solid #e6dace; border-radius: 12px; padding: 20px; margin-top: 30px; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08); }

        /* å­¸å¹´ç®¡ç† */
        .management-section { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .transfer-grid { display: flex; gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; align-items: flex-start; }
        .transfer-column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .transfer-list-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; height: 250px; overflow-y: auto; padding: 5px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); }
        .student-select-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
        .student-select-item:hover { background-color: #f5f5f5; }
        .student-select-item input[type="radio"] { transform: scale(1.3); accent-color: var(--m-green); cursor: pointer; }
        .year-transition-card { background-color: #fdfcf8; border: 2px solid var(--m-brown); border-radius: 15px; padding: 30px; text-align: center; max-width: 600px; margin: 0 auto; }

        /* ============================================== */
        /* === å­¸ç¿’å ±å‘Šå°ˆç”¨æ¨£å¼ (æ”¯æ´å¾Œå°æª¢è¦–) === */
        /* ============================================== */
        .report-section { margin-bottom: 50px; }
        
        /* 1. ç¯„ç–‡æ¨™é¡Œ (è† å›Šå‹æ¨™ç±¤) */
        .report-category-badge { display: inline-flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); letter-spacing: 1px; }
        .badge-narrative { background-color: #7da3c0; }
        .badge-argument { background-color: #a692c2; }
        .badge-reading { background-color: #8da399; }
        .badge-expand { background-color: #d69a92; }
        
        /* 2. æ•´é«”æ¦‚æ³æ¨™é¡Œå®¹å™¨ (å¢å¼·ç‰ˆ) */
        /* 2. æ•´é«”æ¦‚æ³æ¨™é¡Œå®¹å™¨ (ä¿®æ”¹ç‚ºç„¡å°ç±³è‰²é¢¨æ ¼) */
.badge-general {
    width: 100%; 
    max-width: 100%; 
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
    padding: 20px 10px; 
    margin-bottom: 10px; 
    
    /* === ä¿®æ”¹é‡é»ï¼šç„¡å°é¢¨ï¼æš–éº»ç±³è‰² === */
    background: linear-gradient(135deg, #C5B4A1 0%, #A99885 100%);
    box-shadow: 0 8px 20px rgba(169, 152, 133, 0.35);
    /* ============================== */

    color: white; 
    border-radius: 12px; 
    position: relative; 
    overflow: hidden;
}
        .badge-general-title { font-size: 1.6rem; font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* 3. ç¶œåˆè©•ç´š */
        .overall-grade-tag { background-color: #fff; color: #d9534f; padding: 5px 25px; border-radius: 50px; font-size: 1.4rem; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid #d69a92; display: flex; align-items: center; gap: 8px; }
        .overall-grade-label { font-size: 0.8rem; color: #888; font-weight: normal; text-transform: uppercase; letter-spacing: 1px; }

        /* 4. æ–‡å­—åˆ†æå¡ç‰‡ */
        .report-text-card { background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 12px; padding: 25px; line-height: 1.9; color: #4a4a4a; font-size: 1.05rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); text-align: justify; margin-top: 10px; }

        /* 5. é‡‘å¥å®¹å™¨ (æ‰“æ´ Note Card) */
        .report-quote-card { position: relative; background-color: #fffefb; border: 1px solid #e0ddd7; border-radius: 8px; padding: 30px 30px 30px 65px; margin-top: 40px; box-shadow: 4px 4px 0px rgba(0,0,0,0.05); text-align: left; background-image: linear-gradient(to right, transparent 49px, #eebdbd 50px, transparent 51px), radial-gradient(circle at 25px 50%, #d1cdc5 8px, transparent 9px); background-size: 100% 100%, 100% 40px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 15px; }
        .report-quote-content { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; font-weight: bold; color: #5d4037; font-style: italic; line-height: 1.6; }
        .report-quote-author { margin-top: 10px; font-size: 0.9rem; color: #888; text-align: right; font-style: normal; }

        /* 6. åˆ†éš”ç·š */
        .report-separator { position: relative; height: 1px; border: 0; border-top: 3px dashed #b6a6ca; margin: 40px 0 50px 0; opacity: 0.6; }
        .report-separator::after { content: 'â–¼'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fdfcf8; padding: 0 10px; color: #b6a6ca; font-size: 12px; }

        /* 7. è©•åˆ†å„€è¡¨æ¿ (é›·é”åœ–ã€é€²åº¦æ¢) */
        .report-radar-wrapper { margin-bottom: 30px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .grading-container { margin-top: 0; border-top: none; }
        .grading-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grading-scores, .grading-radar { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
        .score-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .slider-container { display: flex; align-items: center; gap: 10px; width: 60%; }
        .progress-bar-container { width: 100%; height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: #007bff; border-radius: 5px; }
        .score-display { font-weight: bold; width: 30px; text-align: right; }
        .total-score-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; }
        .radar-chart-container { position: relative; height: 300px; width: 100%; }
        .radar-chart-history-img { width: 100%; height: auto; max-width: 100%; display: block; margin: 0 auto; }

        @media (max-width: 768px) {
            .grading-grid { display: flex !important; flex-direction: column !important; gap: 20px !important; width: 100% !important; margin: 0 !important; }
            .grading-scores, .grading-radar, .report-radar-wrapper { width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; padding: 15px !important; margin: 0 !important; overflow: hidden !important; }
            .radar-chart-container { width: 100% !important; height: auto !important; aspect-ratio: 1 / 1 !important; max-height: 350px !important; margin: 0 auto !important; }
            
            /* æ‰‹æ©Ÿç‰ˆï¼šæ•´é«”æ¦‚æ³æ‹‰å¯¬ï¼Œå…¶ä»–ç¯„ç–‡ç¸®å°ç½®ä¸­ */
            .badge-general { width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; border-radius: 8px !important; }
            .report-category-badge:not(.badge-general) { width: -moz-fit-content !important; width: fit-content !important; max-width: 90% !important; display: flex !important; justify-content: center !important; margin-left: auto !important; margin-right: auto !important; border-radius: 50px !important; }
            
            .box { padding: 15px; } .nav-btn { width: 100%; } .filter-group { flex-direction: column; }
            .filter-group select, .filter-group input { width: 100%; } .transfer-grid { flex-direction: column; }
            .modal-content-container { flex-direction: column; } .submission-sidebar { width: 100%; height: 40%; }
        }


.copyright-footer {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 5px 10px;
    background-color: #f1f1f1;
}

.copyright-footer p {
    margin: 0;
    font-size: 14px;
}

@media (max-width: 600px) {
    .copyright-footer p {
        font-size: 12px;
    }
}



        
    </style>
</head>
<body>

    <!-- === å®‰å…¨ç™»å…¥é–˜é–€ === -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: var(--m-blue); margin-bottom: 10px;">ç¥æ€ãƒ»æ•™ç ”å¹³å°</h2>
            <p style="color: #888; margin-bottom: 30px;">è«‹ä½¿ç”¨å­¸æ ¡æ•™å¸«å¸³è™Ÿç™»å…¥ä»¥å­˜å–è³‡æ–™</p>
            <button id="loginBtn" class="login-btn" onclick="teacherLogin()">
                <i class="fab fa-google"></i> Google å¸³è™Ÿç™»å…¥
            </button>
            <p id="loginMsg" style="color: var(--m-red); margin-top: 15px; font-size: 0.9em;"></p>
        </div>
    </div>

    <!-- === ä¸»è¦æ‡‰ç”¨ç¨‹å¼ === -->
    <div id="mainApp">
        <div class="title-container">
            <div style="float: right; font-size: 0.9rem;">
                <span id="teacherNameDisplay" style="color: var(--m-blue); margin-right: 10px;"></span>
                <button onclick="logout()" style="background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; color: #666;">ç™»å‡º</button>
            </div>
            <h1>ç¥æ€ãƒ»æ•™å¸«å¾Œå°</h1>
        </div>

        <!-- å°èˆªåˆ— -->
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('students')"><i class="fas fa-user-graduate"></i> å­¸ç”Ÿç®¡ç†</button>
            
            <button class="nav-btn" onclick="switchTab('reports')"><i class="fas fa-chart-pie"></i> å­¸ç”Ÿå ±å‘Š</button>
            <button class="nav-btn" onclick="switchTab('assignments')"><i class="fas fa-edit"></i> èª²æ¥­ç®¡ç†</button>
            <!-- åœ¨ nav-bar å…§åŠ å…¥é€™è¡Œ -->
<button class="nav-btn" onclick="switchTab('analytics')"><i class="fas fa-chart-bar"></i> æ•¸æ“šçµ±è¨ˆ</button>
            <button class="nav-btn" onclick="switchTab('management')"><i class="fas fa-calendar-alt"></i> å­¸å¹´ç®¡ç†</button>
        </div>

        <!-- 1. å­¸ç”Ÿç®¡ç†é é¢ -->
        <div id="tab-students" class="box">
            <h2>å­¸ç”Ÿç´€éŒ„æª¢é–±</h2>
            <div class="filter-group">
                <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> ç¯©é¸ï¼š</label>
                <select id="viewGrade" onchange="loadStudentList()">
                    <option value="1">ä¸­ä¸€</option><option value="2">ä¸­äºŒ</option><option value="3">ä¸­ä¸‰</option>
                    <option value="4">ä¸­å››</option><option value="5">ä¸­äº”</option><option value="6" selected>ä¸­å…­</option>
                </select>
                <select id="viewClass" onchange="loadStudentList()">
                    <option value="A">A ç­</option><option value="B">B ç­</option><option value="C">C ç­</option><option value="D">D ç­</option>
                </select>
                <button class="btn-action btn-view" onclick="loadStudentList()"><i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="studentListContainer" class="student-grid">
                <p style="text-align:center; width:100%; color:#aaa; padding:30px;">è«‹é¸æ“‡å¹´ç´šå’Œç­åˆ¥ä»¥è¼‰å…¥å­¸ç”Ÿåˆ—è¡¨</p>
            </div>
        </div>

        <!-- 2. èª²æ¥­æ´¾ç™¼é é¢ -->
        <div id="tab-assignments" class="box" style="display:none;">
            <h2>ä½ˆç½®èª²æ¥­</h2>
            <div class="filter-group">
                <label><i class="fas fa-users" style="color:var(--m-blue);"></i> å°è±¡ï¼š</label>
                <select id="assignGrade" onchange="loadAssignmentHistory()">
                    <option value="1">ä¸­ä¸€</option><option value="2">ä¸­äºŒ</option><option value="3">ä¸­ä¸‰</option>
                    <option value="4">ä¸­å››</option><option value="5">ä¸­äº”</option><option value="6" selected>ä¸­å…­</option>
                </select>
                <select id="assignClass" onchange="loadAssignmentHistory()">
                    <option value="A">A ç­</option><option value="B">B ç­</option><option value="C">C ç­</option><option value="D">D ç­</option>
                </select>
            </div>
            <div class="publish-area">
                <div style="font-weight:bold; color:var(--m-green); margin-bottom:5px; font-size:1.1em;">
                    <i class="fas fa-pen-fancy"></i> å‰µå»ºæ–°ä»»å‹™
                </div>
                <div class="publish-inputs">
                    <input type="text" id="assignTopic" placeholder="èª²æ¥­é¡Œç›®">
                    <select id="assignType">
                        <option value="é–±è®€">é–±è®€</option>
                        <option value="æ•˜äº‹æŠ’æƒ…">æ•˜äº‹æŠ’æƒ…</option>
                        <option value="è­°è«–">è­°è«–</option>
                        <option value="æ•´åˆæ‹“å±•">æ•´åˆæ‹“å±•</option>
                    </select>
                </div>
                <button id="btnPublish" class="btn-action btn-publish" onclick="publishAssignment()">
                    <i class="fas fa-paper-plane"></i> ç«‹å³æ´¾ç™¼
                </button>
            </div>
            <h3>å·²æ´¾ç™¼èª²æ¥­åˆ—è¡¨</h3>
            <div id="assignmentHistoryList"></div>
        </div>

        <!-- 3. å­¸ç”Ÿå ±å‘Šé é¢ (æ–°å¢) -->
        <div id="tab-reports" class="box" style="display:none;">
            <h2>å­¸ç”Ÿå­¸ç¿’å ±å‘Šç®¡ç†</h2>
            
            <!-- ç¯©é¸èˆ‡æ“ä½œå€ -->
            <div class="filter-group">
                <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> ç¯©é¸ï¼š</label>
                <select id="reportGrade" onchange="loadReportStudentList()">
                    <option value="1">ä¸­ä¸€</option><option value="2">ä¸­äºŒ</option><option value="3">ä¸­ä¸‰</option>
                    <option value="4">ä¸­å››</option><option value="5">ä¸­äº”</option><option value="6" selected>ä¸­å…­</option>
                </select>
                <select id="reportClass" onchange="loadReportStudentList()">
                    <option value="A">A ç­</option><option value="B">B ç­</option><option value="C">C ç­</option><option value="D">D ç­</option>
                </select>
                
                <!-- ç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘ŠæŒ‰éˆ• -->
                <button id="btnClassReport" class="btn-action btn-manage" 
                        style="background: linear-gradient(135deg, #7da3c0 0%, #5e7067 100%); margin-left: auto; box-shadow: 0 4px 10px rgba(94, 112, 103, 0.4);" 
                        onclick="generateClassReport()">
                    <i class="fas fa-chart-line"></i> ç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘Š (AI)
                </button>
            </div>
            
            <!-- === æ–°å¢ï¼šå…¨ç­å ±å‘Šæ­·å²ç´€éŒ„å€å¡Š === -->
            <!-- é è¨­éš±è— (display:none)ï¼Œç•¶ JS åµæ¸¬åˆ°æœ‰ç´€éŒ„æ™‚æ‰æœƒé¡¯ç¤º -->
            <div id="classReportHistoryContainer" style="margin-bottom: 25px; padding: 20px; background: #fdfcf8; border-radius: 12px; border: 1px solid var(--border-color); border-left: 5px solid #7da3c0; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; border:none; padding:0; font-size:1.1em; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-history" style="color:#7da3c0;"></i> éå¾€å…¨ç­ç¶œåˆå ±å‘Šç´€éŒ„
                    </h3>
                    <small style="color:#999; font-style:italic;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä»¥é‡çœ‹å ±å‘Š</small>
                </div>
                
                <!-- é€™è£¡çš„å…§å®¹æœƒç”± JS (loadClassReportHistory) å‹•æ…‹å¡«å…… -->
                <div id="classReportList" style="display:flex; gap:12px; overflow-x:auto; padding:5px 0; align-items: center; scroll-behavior: smooth;">
                </div>
            </div>
            <!-- === æ­·å²ç´€éŒ„å€å¡ŠçµæŸ === -->

            <!-- å€‹åˆ¥å­¸ç”Ÿåˆ—è¡¨ -->
            <div id="reportStudentListContainer" class="student-grid">
                <p style="text-align:center; width:100%; color:#aaa; padding:30px;">è«‹é¸æ“‡å¹´ç´šå’Œç­åˆ¥ä»¥è¼‰å…¥å ±å‘Šåˆ—è¡¨</p>
            </div>
        </div>

        <!-- 4. å­¸å¹´ç®¡ç†é é¢ -->
        <div id="tab-management" class="box" style="display:none;">
            <h2>å­¸å¹´éæ¸¡ç®¡ç†</h2>
            <div style="text-align:center; margin-bottom:30px;">
                <div style="font-size:1.2em; color:var(--m-brown); font-weight:bold; margin-bottom:10px;">ç•¶å‰å­¸å¹´è¨­å®š</div>
                <div style="display:inline-flex; align-items:center; gap:10px; background:#fff; padding:10px 20px; border-radius:50px; border:1px solid #ccc;">
                    <input type="text" id="currentYearInput" value="2025-2026" style="border:none; text-align:center; font-weight:bold; font-size:1.1em; width:120px;">
                    <button class="btn-action btn-manage" style="padding:5px 15px; font-size:0.8em;" onclick="updateYearConfig()">å„²å­˜</button>
                </div>
            </div>
            <div class="management-section">
                <div class="section-title"><i class="fas fa-user-cog"></i> å€‹åˆ¥å­¸ç”Ÿèª¿å‹• / åˆªé™¤</div>
                <div class="transfer-grid">
                    <div class="transfer-column">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-weight:bold; color:var(--m-red);">ä¾†æºï¼š</span>
                            <select id="indivFromGrade" onchange="populateTransferStudentList()"><option value="6">ä¸­å…­</option><option value="5">ä¸­äº”</option><option value="4">ä¸­å››</option><option value="3">ä¸­ä¸‰</option><option value="2">ä¸­äºŒ</option><option value="1">ä¸­ä¸€</option></select>
                            <select id="indivFromClass" onchange="populateTransferStudentList()"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                        </div>
                        <div id="transferStudentListBox" class="transfer-list-box">
                            <div style="padding:20px; text-align:center; color:#999;">è«‹å…ˆé¸æ“‡ç­ç´š...</div>
                        </div>
                    </div>
                    <div class="transfer-arrow-icon" style="align-self:center; color:#ccc; font-size:1.5em;"><i class="fas fa-arrow-right"></i></div>
                    <div class="transfer-column" style="justify-content:center;">
                        <div style="background:#fff; border:1px solid #eee; padding:20px; border-radius:10px;">
                            <div style="font-weight:bold; color:var(--m-green); margin-bottom:10px;">ç›®æ¨™è¨­å®šï¼š</div>
                            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                                <select id="indivToGrade" style="flex:1;"><option value="6">ä¸­å…­</option><option value="5">ä¸­äº”</option><option value="4">ä¸­å››</option><option value="3">ä¸­ä¸‰</option><option value="2">ä¸­äºŒ</option><option value="1">ä¸­ä¸€</option></select>
                                <select id="indivToClass" style="flex:1;"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                            </div>
                            <div style="margin-bottom:20px;">
                                <label style="font-size:0.9em; color:#666;">åˆ†é…æ–°ç­è™Ÿï¼š</label>
                                <input type="number" id="indivNewNumber" placeholder="ä¾‹å¦‚ï¼š25" style="width:100%; margin-top:5px; text-align:center; box-sizing:border-box;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <button class="btn-action btn-manage" style="justify-content:center;" onclick="moveIndividualStudent()"><i class="fas fa-exchange-alt"></i> ç¢ºèªèª¿å‹•</button>
                                <button class="btn-action btn-delete" style="justify-content:center;" onclick="deleteStudent()"><i class="fas fa-trash-alt"></i> åˆªé™¤æ­¤å­¸ç”Ÿ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="year-transition-card">
                <div style="font-size:1.3em; font-weight:bold; color:#555;">ä¸€éµå…¨æ ¡å‡ç­ (å­¸å¹´éæ¸¡)</div>
                <div class="year-arrow"><i class="fas fa-chevron-down"></i></div>
                <button class="btn-action btn-manage" style="padding:15px 40px; font-size:1.1em; width:100%;" onclick="runYearTransition()"><i class="fas fa-rocket"></i> é–‹å§‹æ–°å­¸å¹´éæ¸¡</button>
            </div>
        </div>
    </div>


<!-- 5. æ•¸æ“šçµ±è¨ˆé é¢ (å…¨æ–°) -->
<div id="tab-analytics" class="box" style="display:none;">
    <h2>ç¥æ€å¤§æ•¸æ“šçµ±è¨ˆ</h2>
    
    <div class="filter-group">
        <!-- çµ±è¨ˆå°è±¡é¸æ“‡ -->
        <label><i class="fas fa-cubes" style="color:var(--m-blue);"></i> å°è±¡ï¼š</label>
        <select id="statScope" onchange="updateStatInputs()">
            <option value="global">æ‰€æœ‰ç”¨å®¶ (å«è¨ªå®¢)</option>
            <option value="school">å…¨æ ¡ (åƒ…å·²ç™»å…¥)</option>
            <option value="class">å€‹åˆ¥ç­ç´š</option>
            <option value="student">å€‹åˆ¥å­¸ç”Ÿ</option>
        </select>

        <!-- å‹•æ…‹é¡¯ç¤ºçš„è¼¸å…¥æ¡† (ç­ç´š/å­¸ç”Ÿ) -->
        <span id="statClassInput" style="display:none;">
            <select id="statGrade">
                <option value="1">ä¸­ä¸€</option><option value="2">ä¸­äºŒ</option><option value="3">ä¸­ä¸‰</option>
                <option value="4">ä¸­å››</option><option value="5">ä¸­äº”</option><option value="6">ä¸­å…­</option>
            </select>
            <select id="statClass">
                <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
            </select>
        </span>
        <span id="statStudentInput" style="display:none;">
            <input type="text" id="statStudentName" placeholder="å­¸ç”Ÿå§“å" style="width:120px;">
        </span>

        <!-- æ™‚é–“ç¶­åº¦é¸æ“‡ -->
        <label style="margin-left:15px;"><i class="far fa-clock" style="color:var(--m-brown);"></i> æ™‚é–“ï¼š</label>
        <select id="statTimeMode" onchange="updateTimeInputs()">
            <option value="day">æœ¬æ—¥ (å¯¦æ™‚)</option>
            <option value="month">æœ¬æœˆ (è¶¨å‹¢)</option>
            <option value="year">æœ¬å¹´ (ç¸½è¦½)</option>
        </select>
        
        <!-- æ—¥æœŸ/æœˆä»½/å¹´ä»½ é¸æ“‡å™¨ -->
        <input type="date" id="statDate" style="display:inline-block;">
        <select id="statMonth" style="display:none;">
            <!-- JS è‡ªå‹•å¡«å…… 1-12 æœˆ -->
        </select>
        <select id="statYear" style="display:none;">
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
        </select>

        <button class="btn-action btn-view" onclick="fetchAndRenderStats()">
            <i class="fas fa-search"></i> æŸ¥è©¢
        </button>
    </div>

    <!-- æ•¸æ“šæ¦‚è¦½å¡ç‰‡ -->
    <div style="display:flex; gap:20px; justify-content:center; margin-bottom:30px; flex-wrap:wrap;">
        <div style="background:#f0f7ff; padding:20px; border-radius:12px; text-align:center; flex:1; min-width:150px; border:1px solid #cce5ff;">
            <div style="color:#007bff; font-size:2em; font-weight:bold;" id="dispVisits">0</div>
            <div style="color:#666;">ç¸½é€²å…¥æ¬¡æ•¸</div>
        </div>
        <div style="background:#fff0f0; padding:20px; border-radius:12px; text-align:center; flex:1; min-width:150px; border:1px solid #ffcccc;">
            <div style="color:#dc3545; font-size:2em; font-weight:bold;" id="dispDuration">0</div>
            <div style="color:#666;">ç¸½ä½¿ç”¨æ™‚é•· (åˆ†é˜)</div>
        </div>
        <div style="background:#f0fff4; padding:20px; border-radius:12px; text-align:center; flex:1; min-width:150px; border:1px solid #c3e6cb;">
            <div style="color:#28a745; font-size:2em; font-weight:bold;" id="dispAvg">0</div>
            <div style="color:#666;">å¹³å‡æ¯æ¬¡æ™‚é•· (åˆ†é˜)</div>
        </div>
    </div>

    <!-- åœ–è¡¨å®¹å™¨ -->
    <div class="chart-container" style="position: relative; height:400px; width:100%;">
        <canvas id="analyticsChart"></canvas>
    </div>
</div>
    

    <!-- Modal: å­¸ç”Ÿæ­·å²æª¢é–± (é€šç”¨) -->
    <div id="historyViewerModal" class="modal-overlay">
        <div class="modal-body">
            <div class="modal-header">
                <h3 id="viewerTitle" style="margin:0; color:var(--m-blue);">å­¸ç”Ÿæ­·ç¨‹</h3>
                <button onclick="document.getElementById('historyViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div class="modal-content-scroll">
                <!-- éºµåŒ…å±‘å°èˆª -->
                <div id="teacherBreadcrumb" class="history-breadcrumb" style="display: none;">
                    <span class="breadcrumb-item" onclick="renderLevel1()"><i class="fas fa-home"></i> ä¸»ç¯„ç–‡</span> 
                    <span class="breadcrumb-sep"> &gt; </span>
                    <span class="breadcrumb-item" id="breadCategory" onclick="renderLevel2(currentCategory)"></span>
                    <span class="breadcrumb-sep" id="breadSep2"> &gt; </span>
                    <span class="breadcrumb-current" id="breadSub"></span>
                </div>

                <!-- Level 1: ä¸»ç¯„ç–‡å¡ç‰‡ -->
                <div id="historyLevel1" class="category-cards-container"></div>

                <!-- Level 2: å­åŠŸèƒ½æŒ‰éˆ• -->
                <div id="historyLevel2" class="history-grid-menu" style="display: none;"></div>

                <!-- Level 3: ç´€éŒ„åˆ—è¡¨ -->
                <div id="historyLevel3" class="history-list-container" style="display: none;"></div>

                <!-- Detail: è©³ç´°å…§å®¹ -->
                <div id="historyDetail" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal: èª²æ¥­ç¹³äº¤æª¢é–± -->
    <div id="submissionViewerModal" class="modal-overlay">
        <div class="modal-body">
            <div class="modal-header">
                <h3 id="submissionTitle" style="margin:0; color:var(--m-green);"></h3>
                <div style="font-size:0.9em; color:#888;">å·²ç¹³äº¤: <span id="submitCount" style="color:var(--m-green); font-weight:bold;">0</span> / æœªç¹³äº¤: <span id="pendingCount" style="color:var(--m-red); font-weight:bold;">0</span></div>
                <button onclick="document.getElementById('submissionViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div class="modal-content-container">
                <div class="submission-sidebar">
                    <ul id="submissionList" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
                <div id="submissionDetailArea" class="submission-detail-area">
                    <div style="text-align:center; color:#ccc; margin-top:100px;"><i class="far fa-file-alt" style="font-size:48px;"></i><p>è«‹é¸æ“‡å­¸ç”Ÿ</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: å…¨ç­ç¶œåˆå ±å‘Šé¡¯ç¤ºè¦–çª— (æ–°å¢) -->
    <div id="classReportModal" class="modal-overlay">
        <div class="modal-body" style="max-width: 900px;">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--m-blue);"><i class="fas fa-chart-pie"></i> å…¨ç­ç¶œåˆå­¸ç¿’å ±å‘Š</h3>
                <button onclick="document.getElementById('classReportModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div id="classReportContent" class="modal-content-scroll" style="background:#f9f9f9; padding: 0;">
                <!-- AI ç”Ÿæˆå…§å®¹å°‡æ³¨å…¥æ­¤è™• -->
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
            authDomain: "sansidata.firebaseapp.com",
            projectId: "sansidata",
            storageBucket: "sansidata.firebasestorage.app",
            messagingSenderId: "580288358575",
            appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
            databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // API Key (ç”¨æ–¼ç”Ÿæˆå…¨ç­å ±å‘Šï¼Œè«‹æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„æœ‰æ•ˆ Key)
        const READING_API_KEYS = [
            "pk_D77NeM4n6GnNCYbo", "pk_c17y17tQ3BY71cpd", "pk_Ax3rRTHkrdTQVIGD", "pk_dGVqEggn4T4dwQI3", "pk_YIFWnDFts0quviE0"
        ];
        const READING_API_URL = "https://gen.pollinations.ai/v1/chat/completions";
        const READING_MODEL = "deepseek";


// ==============================================
// === OneSignal æ¨æ’­é€šçŸ¥è¨­å®š (å®‰å…¨æ€§æ··æ·†ç‰ˆ) ===
// ==============================================

// åŸå§‹ Key è¢«æ‹†åˆ†ä¸¦éš±è—åœ¨é›œè¨Šä¸­ï¼Œé˜²æ­¢ç°¡å–®çˆ¬èŸ²æŠ“å–
const _noise_start = "7bo2joflvzgf5dnzzh2gh7eycx";
const _part_head = "k5kn45q25uw"; // Key çš„å‰æ®µ
const _noise_mid = "rtgfhd3xfyyxull";
const _part_tail = "ymlyhqbq746ubu"; // Key çš„å¾Œæ®µ
const _noise_end = "klptksmnddfdwgpechno4byssraz";

// å‹•æ…‹çµ„è£ API Key
const _OS_Auth = _part_head + _part_tail; 

/**
 * å‘¼å« OneSignal REST API ç™¼é€æ¨æ’­
 */
async function sendClassNotification(targetGrade, targetClass, topic, type) {
    const notificationData = {
        // è«‹ç¢ºä¿é€™è£¡å¡«å…¥ä½ è‡ªå·±çš„ OneSignal App ID
        app_id: "f85da4b8-abae-4c5e-8db9-c9f463fc9815", 
        
        // æ¨™é¡Œèˆ‡å…§å®¹
        headings: { en: "æ–°èª²æ¥­é€šçŸ¥", zh: "ğŸ“š æ–°èª²æ¥­ç™¼å¸ƒ" },
        contents: { 
            en: `New Assignment: ${topic}`, 
            zh: `è€å¸«å·²ç™¼å¸ƒã€${type}ã€‘èª²æ¥­ï¼šã€Š${topic}ã€‹ï¼Œè«‹ç›¡å¿«æŸ¥é–±ã€‚` 
        },
        
        // é—œéµï¼šåªç™¼é€çµ¦ç¬¦åˆ Grade å’Œ Class Tag çš„å­¸ç”Ÿ
        filters: [
            { field: "tag", key: "grade", relation: "=", value: targetGrade },
            { operator: "AND" },
            { field: "tag", key: "class", relation: "=", value: targetClass }
        ],
        
        // é»æ“Šé€šçŸ¥å¾Œé–‹å•Ÿçš„ç¶²å€ (å­¸ç”Ÿç«¯ç¶²å€)
        // å¦‚æœå­¸ç”Ÿç«¯ç¶²å€ä¸åŒï¼Œè«‹åœ¨æ­¤ä¿®æ”¹ï¼Œä¾‹å¦‚ 'https://yourschool.com/student-portal'
        url: window.location.href 
    };

    const options = {
        method: 'POST',
        headers: {
            accept: 'application/json',
            'Content-Type': 'application/json',
            Authorization: 'Basic ' + _OS_Auth
        },
        body: JSON.stringify(notificationData)
    };

    try {
        const response = await fetch('https://onesignal.com/api/v1/notifications', options);
        const data = await response.json();
        console.log('âœ… æ¨æ’­ç™¼é€æˆåŠŸ:', data);
    } catch (err) {
        console.error('âŒ æ¨æ’­ç™¼é€å¤±æ•—:', err);
    }
}

        
        // è¼”åŠ©å‡½å¼ï¼šDSEç­‰ç´šè¨ˆç®—
        function determineGrade(score) {
            if (score >= 72) return "5**";
            if (score >= 69) return "5*";
            if (score >= 64) return "5";
            if (score >= 57) return "4";
            if (score >= 50) return "3";
            if (score >= 45) return "2";
            return "1";
        }

        // === ç™»å…¥èˆ‡åŸºç¤é‚è¼¯ ===
        function teacherLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            document.getElementById('loginMsg').innerText = "é©—è­‰ä¸­...";
            auth.signInWithPopup(provider).then((result) => {
                const user = result.user;
                if (user.email.endsWith('@ccckyc.edu.hk')) { showApp(user); }
                else { auth.signOut(); document.getElementById('loginMsg').innerText = "éæˆæ¬Šå¸³è™Ÿ"; }
            }).catch((error) => { document.getElementById('loginMsg').innerText = "ç™»å…¥å¤±æ•—ï¼š" + error.message; });
        }
        function logout() { auth.signOut().then(() => location.reload()); }
        function showApp(user) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('teacherNameDisplay').innerText = user.displayName || user.email;
            db.ref('config/currentYear').once('value', s => { if(s.exists()) document.getElementById('currentYearInput').value = s.val(); });
        }
        auth.onAuthStateChanged(user => { if (user && user.email.endsWith('@ccckyc.edu.hk')) showApp(user); });



// ==============================================
        // === è£œå…¨ï¼šèª²æ¥­ç®¡ç†é‚è¼¯ (ä¿®å¾© ReferenceError) ===
        // ==============================================

        // 1. è¼‰å…¥å·²æ´¾ç™¼èª²æ¥­åˆ—è¡¨
        function loadAssignmentHistory() {
            const g = document.getElementById('assignGrade').value;
            const c = document.getElementById('assignClass').value;
            const list = document.getElementById('assignmentHistoryList');
            
            list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>';

            db.ref(`assignments/${g}/${c}`).once('value', snapshot => {
                const data = snapshot.val();
                list.innerHTML = '';
                
                if (!data) {
                    list.innerHTML = '<p style="text-align:center; width:100%; color:#aaa; padding:20px;">æ­¤ç­ç´šæš«ç„¡å·²æ´¾ç™¼çš„èª²æ¥­ã€‚</p>';
                    return;
                }

                // æŒ‰æ™‚é–“å€’åºæ’åˆ—
                Object.entries(data)
                    .sort(([,a], [,b]) => b.timestamp - a.timestamp)
                    .forEach(([id, item]) => {
                        const div = document.createElement('div');
                        div.className = 'assignment-item';
                        div.innerHTML = `
                            <div style="flex:1;">
                                <div style="font-weight:bold; font-size:1.2em; color:#444;">${item.topic}</div>
                                <div style="font-size:0.9em; color:#888; margin-top:5px;">
                                    <span class="tag">${item.type}</span> 
                                    <i class="far fa-clock"></i> ${item.dateStr || 'æœªçŸ¥æ—¥æœŸ'}
                                </div>
                            </div>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="btn-action btn-view" onclick="viewSubmissions('${id}', '${item.topic}')">
                                    <i class="fas fa-eye"></i> æª¢é–±ç¹³äº¤
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteAssignment('${id}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `;
                        list.appendChild(div);
                    });
            });
        }

       // 2. ç™¼å¸ƒæ–°èª²æ¥­ (å·²ä¿®è¨‚ï¼šåŠ å…¥æ¨æ’­åŠŸèƒ½)
        function publishAssignment() {
            const g = document.getElementById('assignGrade').value;
            const c = document.getElementById('assignClass').value;
            const topic = document.getElementById('assignTopic').value.trim();
            const type = document.getElementById('assignType').value;
            const btn = document.getElementById('btnPublish');

            if (!topic) {
                alert("è«‹è¼¸å…¥èª²æ¥­é¡Œç›®ï¼");
                return;
            }

            // é–å®šæŒ‰éˆ•é¿å…é‡è¤‡ç™¼é€
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™¼å¸ƒä¸­...';

            const newAssignment = {
                topic: topic,
                type: type,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                dateStr: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            // å¯«å…¥ Firebase
            db.ref(`assignments/${g}/${c}`).push(newAssignment)
                .then(() => {
                    // === ä¿®æ”¹é»é–‹å§‹ï¼šåœ¨é€™è£¡å‘¼å«æ¨æ’­å‡½å¼ ===
                    console.log("æ­£åœ¨ç™¼é€æ¨æ’­é€šçŸ¥...");
                    
                    // å‘¼å«æˆ‘å€‘åœ¨ç¬¬ä¸€æ­¥å¯«å¥½çš„å‡½å¼ (ä¸éœ€ç­‰å¾…å®ƒå®Œæˆå³å¯é¡¯ç¤ºæˆåŠŸ alert)
                    sendClassNotification(g, c, topic, type); 
                    
                    // === ä¿®æ”¹é»çµæŸ ===

                    alert("ç™¼å¸ƒæˆåŠŸï¼å­¸ç”Ÿå°‡æ”¶åˆ°é€šçŸ¥ã€‚");
                    document.getElementById('assignTopic').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                    loadAssignmentHistory(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                })
                .catch(err => alert("ç™¼å¸ƒå¤±æ•—ï¼š" + err.message))
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> ç«‹å³æ´¾ç™¼';
                });
        }
        // 3. åˆªé™¤èª²æ¥­
        function deleteAssignment(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤èª²æ¥­å—ï¼Ÿ\n(æ³¨æ„ï¼šé€™ä¸æœƒåˆªé™¤å­¸ç”Ÿå·²æäº¤çš„å…§å®¹ï¼Œä½†æœƒå¾åˆ—è¡¨ä¸­ç§»é™¤)")) return;
            
            const g = document.getElementById('assignGrade').value;
            const c = document.getElementById('assignClass').value;

            db.ref(`assignments/${g}/${c}/${id}`).remove()
                .then(() => loadAssignmentHistory())
                .catch(err => alert("åˆªé™¤å¤±æ•—ï¼š" + err.message));
        }

        // 4. æª¢é–±ç¹³äº¤ç‹€æ³ (é–‹å•Ÿ Modal)
        async function viewSubmissions(assignmentId, topic) {
            const g = document.getElementById('assignGrade').value;
            const c = document.getElementById('assignClass').value;
            
            // é–‹å•Ÿ Modal ä¸¦è¨­å®šæ¨™é¡Œ
            document.getElementById('submissionViewerModal').style.display = 'flex';
            document.getElementById('submissionTitle').innerText = topic;
            document.getElementById('submissionList').innerHTML = '<li style="padding:20px; text-align:center; color:#999;">è¼‰å…¥åå–®ä¸­...</li>';
            document.getElementById('submissionDetailArea').innerHTML = '<div style="text-align:center; color:#ccc; margin-top:100px;"><i class="far fa-file-alt" style="font-size:48px;"></i><p>è«‹é¸æ“‡å­¸ç”Ÿä»¥æª¢è¦–å…§å®¹</p></div>';

            try {
                // 4.1 ç²å–è©²ç­æ‰€æœ‰å­¸ç”Ÿåå–®
                const studentsSnap = await db.ref(`students/${g}/${c}`).once('value');
                const students = studentsSnap.val() || {};

                // 4.2 ç²å–è©²ä½œæ¥­çš„æ‰€æœ‰ç¹³äº¤ç´€éŒ„ (å‡è¨­ç¹³äº¤ç´€éŒ„å­˜åœ¨ submissions ç¯€é»ä¸‹ï¼Œæˆ–è€…ä½ éœ€è¦æ ¹æ“šä½ çš„æ•¸æ“šçµæ§‹èª¿æ•´)
                // é€™è£¡å‡è¨­çµæ§‹æ˜¯: submissions/{assignmentId}/{studentName} 
                // æˆ–è€…å¦‚æœä½ çš„ç¹³äº¤æ˜¯ç›´æ¥å¯«å…¥å­¸ç”Ÿæ­·å²ç´€éŒ„ï¼Œé€™è£¡éœ€è¦éæ­·å­¸ç”Ÿçš„ historyã€‚
                // *åŸºæ–¼ä½ çš„ç³»çµ±çœ‹èµ·ä¾†æ˜¯å¯«å…¥å­¸ç”Ÿå€‹äºº historyï¼Œé€™è£¡æˆ‘å€‘æ¡ç”¨éæ­·å­¸ç”Ÿ History çš„æ–¹å¼*

                const submissionListEl = document.getElementById('submissionList');
                submissionListEl.innerHTML = '';

                let submittedCount = 0;
                let pendingCount = 0;

                // æ’åºå­¸ç”Ÿ (æŒ‰å­¸è™Ÿ)
                const sortedStudentNames = Object.keys(students).sort((a,b) => 
                    (parseInt(students[a].profile?.number)||99) - (parseInt(students[b].profile?.number)||99)
                );

                sortedStudentNames.forEach(name => {
                    const studentData = students[name];
                    const history = studentData.history ? Object.values(studentData.history) : [];
                    
                    // å°‹æ‰¾æ˜¯å¦æœ‰åŒ¹é…æ­¤ assignmentId æˆ– é¡Œç›®çš„ç´€éŒ„
                    // æ³¨æ„ï¼šå¦‚æœä½ çš„å­¸ç”Ÿæäº¤æ™‚æ²’æœ‰å­˜ assignmentIdï¼Œé€™è£¡å¯èƒ½éœ€è¦ç”¨é¡Œç›®(title)ä¾†åŒ¹é…
                    const submission = history.find(h => h.assignmentId === assignmentId || h.title === topic);

                    const li = document.createElement('li');
                    li.className = `submission-item ${submission ? '' : ''}`;
                    
                    const statusHtml = submission 
                        ? `<span class="status-badge status-done"><i class="fas fa-check"></i> å·²äº¤</span>`
                        : `<span class="status-badge status-pending"><i class="fas fa-times"></i> æœªäº¤</span>`;
                    
                    if(submission) submittedCount++; else pendingCount++;

                    li.innerHTML = `
                        <div>
                            <div style="font-weight:bold;">${name} <small style="color:#888;">(${studentData.profile?.number || '?'})</small></div>
                            <div style="font-size:0.8em; color:#aaa;">${submission ? submission.dateStr.split(' ')[0] : '-'}</div>
                        </div>
                        ${statusHtml}
                    `;

                    // é»æ“Šäº‹ä»¶
                    if (submission) {
                        li.onclick = () => {
                            // ç§»é™¤å…¶ä»– active
                            document.querySelectorAll('.submission-item').forEach(i => i.classList.remove('active'));
                            li.classList.add('active');
                            showSubmissionDetail(submission, name);
                        };
                    } else {
                        li.style.cursor = 'default';
                        li.style.opacity = '0.6';
                    }

                    submissionListEl.appendChild(li);
                });

                // æ›´æ–°è¨ˆæ•¸
                document.getElementById('submitCount').innerText = submittedCount;
                document.getElementById('pendingCount').innerText = pendingCount;

            } catch (e) {
                console.error(e);
                alert("è¼‰å…¥åå–®å¤±æ•—");
            }
        }

        // 5. é¡¯ç¤ºå–®ä¸€ç¹³äº¤å…§å®¹ (åœ¨å³å´é¡¯ç¤º)
        function showSubmissionDetail(data, studentName) {
            const container = document.getElementById('submissionDetailArea');
            container.innerHTML = `
                <h2 style="border-bottom:1px solid #eee; padding-bottom:10px;">${studentName} çš„ä½œæ¥­</h2>
                <div style="margin-top:20px;">
                    <h4 style="color:var(--m-blue);"><i class="fas fa-align-left"></i> å­¸ç”Ÿä½œç­”ï¼š</h4>
                    <div style="background:#f9f9f9; padding:20px; border-radius:8px; line-height:1.6; white-space:pre-wrap; border:1px solid #eee;">${data.userContent || '(ç„¡æ–‡å­—å…§å®¹)'}</div>
                </div>
                <div style="margin-top:30px;">
                    <h4 style="color:var(--m-green);"><i class="fas fa-robot"></i> AI è©•èªï¼š</h4>
                    <div class="detail-ai-box">${data.aiContent || 'è©•èªç”Ÿæˆä¸­...'}</div>
                </div>
            `;
        }



        
        // === Tab åˆ‡æ›é‚è¼¯ ===
        function switchTab(tabId) {
            document.querySelectorAll('.box').forEach(b => b.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tabId === 'students') loadStudentList();
            if(tabId === 'assignments') loadAssignmentHistory();
            if(tabId === 'reports') loadReportStudentList();
        }

        // === æ­·å²æª¢é–±é‚è¼¯ (å…±ç”¨) ===
        let currentStudentHistory = [], currentCategory = '', currentSubFunction = '', currentThemeIndex = 1; 
        const HISTORY_STRUCTURE = { 
            "é–±è®€": ["é»è©•", "æŒ‡å¼•"], "æ•˜äº‹æŠ’æƒ…": ["æ–‡ç« é»è©•", "å¤§ç¶±é»è©•", "è§£é¡ŒæŒ‡å¼•", "æ•˜äº‹ç‰©è±¡"], 
            "è­°è«–": ["æ–‡ç« é»è©•", "å¤§ç¶±é»è©•", "æŒ‡å¼•"], "æ•´åˆæ‹“å±•": ["é»è©•", "æŒ‡å¼•"],
            "èª²å¤–æ›¸ç±": ["è¨è«–ç´€éŒ„"], "å­¸ç¿’å ±å‘Š": ["ç¶œåˆåˆ†æ"] 
        };
        const CATEGORY_ASSETS = { 
            "é–±è®€": { img: 'éƒµç­’.png', en: 'READING' }, "æ•˜äº‹æŠ’æƒ…": { img: 'ç›¸æ©Ÿ.png', en: 'NARRATIVE' }, 
            "è­°è«–": { img: 'ç­†.png', en: 'ARGUMENT' }, "æ•´åˆæ‹“å±•": { img: 'ç«è»Š.png', en: 'EXPAND' }, 
            "èª²å¤–æ›¸ç±": { img: 'æ›¸.png', en: 'LIBRARY' }, "å­¸ç¿’å ±å‘Š": { img: 'æ›¸.png', en: 'REPORT' }
        };
        const SUB_ICONS = { "æ–‡ç« é»è©•": "fa-file-alt", "å¤§ç¶±é»è©•": "fa-list-ol", "ç¶œåˆåˆ†æ": "fa-chart-pie", "æ•˜äº‹ç‰©è±¡": "fa-tree", "è§£é¡ŒæŒ‡å¼•": "fa-compass", "æŒ‡å¼•": "fa-lightbulb", "é»è©•": "fa-comment-dots", "è¨è«–ç´€éŒ„": "fa-comments" };

        function loadStudentList() {
            const g = document.getElementById('viewGrade').value;
            const c = document.getElementById('viewClass').value;
            const container = document.getElementById('studentListContainer');
            container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>';
            db.ref(`students/${g}/${c}`).once('value', snapshot => {
                const data = snapshot.val();
                if (!data) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">æš«ç„¡è³‡æ–™ã€‚</p>'; return; }
                container.innerHTML = '';
                Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99))
                .forEach(([name, d]) => {
                    const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                    const div = document.createElement('div'); div.className = 'student-card';
                    div.innerHTML = `<div class="student-name">${name} <small>(${d.profile?.number||''})</small></div><div class="last-sync"><i class="fas fa-history"></i> ç´€éŒ„: ${h.length} ç­†</div>`;
                    div.onclick = () => openHistoryModal(name, h);
                    container.appendChild(div);
                });
            });
        }

        // === æ–°å¢ï¼šè¼‰å…¥å­¸ç”Ÿå ±å‘Šåˆ—è¡¨èˆ‡æ­·å²ç´€éŒ„ ===
        function loadReportStudentList() {
            const g = document.getElementById('reportGrade').value;
            const c = document.getElementById('reportClass').value;
            const container = document.getElementById('reportStudentListContainer');
            container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</p>';
            
            // åŒæ™‚è¼‰å…¥æ­·å²å ±å‘Šåˆ—è¡¨
            loadClassReportHistory();

            db.ref(`students/${g}/${c}`).once('value', snapshot => {
                const data = snapshot.val();
                if (!data) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">æš«ç„¡è³‡æ–™ã€‚</p>'; return; }
                container.innerHTML = '';
                
                Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99))
                .forEach(([name, d]) => {
                    const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                    const reports = h.filter(r => r.category === "å­¸ç¿’å ±å‘Š");
                    
                    const div = document.createElement('div'); 
                    div.className = 'student-card';
                    const style = reports.length > 0 ? '' : 'opacity: 0.6; filter: grayscale(100%);';
                    const iconColor = reports.length > 0 ? 'var(--m-red)' : '#ccc';
                    
                    div.style.cssText = style;
                    div.innerHTML = `
                        <div class="student-name">${name} <small>(${d.profile?.number||''})</small></div>
                        <div class="last-sync" style="color:${iconColor}; font-weight:bold;">
                            <i class="fas fa-chart-pie"></i> å·²ç”Ÿæˆå ±å‘Š: ${reports.length} ä»½
                        </div>`;
                    
                    if (reports.length > 0) {
                        div.onclick = () => {
                            openHistoryModal(name, h);
                            setTimeout(() => {
                                renderLevel2('å­¸ç¿’å ±å‘Š');
                                setTimeout(() => renderLevel3('ç¶œåˆåˆ†æ', 5), 100);
                            }, 300);
                        };
                    }
                    container.appendChild(div);
                });
            });
        }

        // === æ–°å¢ï¼šç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘Šé‚è¼¯ ===
// === æœ€çµ‚å…¨åŠŸèƒ½ç‰ˆ V3ï¼šç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘Š (å«å¤§ç¶± + é–±è®€ + å¯«ä½œ + æ•´åˆæ‹“å±•) ===
async function generateClassReport() {
    const btn = document.getElementById('btnClassReport');
    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ†æå…¨ç­æ•¸æ“šä¸­...';

    try {
        // 1. æŠ“å–å…¨ç­è³‡æ–™
        const snapshot = await db.ref(`students/${g}/${c}`).once('value');
        const data = snapshot.val();
        
        if (!data) { alert("æ­¤ç­ç´šç„¡å­¸ç”Ÿè³‡æ–™ï¼"); btn.disabled=false; btn.innerHTML = '<i class="fas fa-chart-line"></i> ç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘Š (AI)'; return; }

        // 2. èšåˆæ•¸æ“š
        let classSummary = "";      // æˆå“æ–‡ç« æ‘˜è¦ (éå¾€å ±å‘Š)
        let outlineSummary = "";    // å¤§ç¶±é»è©•æ‘˜è¦
        let readingSummary = "";    // é–±è®€é»è©•æ‘˜è¦
        let expandSummary = "";     // â˜… æ–°å¢ï¼šæ•´åˆæ‹“å±•æ‘˜è¦
        let studentCount = 0;
        
        // åˆ†æ•¸çµ±è¨ˆ (å¯«ä½œ)
        let narrativeTotal = { content:0, expr:0, struct:0, count:0 };
        let argumentTotal = { content:0, expr:0, struct:0, count:0 };

        // éæ­·æ¯ä½å­¸ç”Ÿ
        Object.entries(data).forEach(([name, d]) => {
            const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
            
            // A. æ”¶é›†éå¾€ã€Œå­¸ç¿’å ±å‘Šã€æ‘˜è¦ (å¯«ä½œæˆå“è¡¨ç¾)
            const reports = h.filter(r => r.category === "å­¸ç¿’å ±å‘Š").sort((a,b) => b.timestamp - a.timestamp);
            if (reports.length > 0) {
                studentCount++;
                const latestReport = reports[0].aiContent.replace(/<[^>]*>?/gm, ' ').substring(0, 300);
                classSummary += `å­¸ç”Ÿ ${studentCount}: ${latestReport}...\n`;
            }

            // B. éæ­·æ‰€æœ‰ç´€éŒ„ (åˆ†æ•¸ + å„ç¯„ç–‡é»è©•)
            h.forEach(r => {
                // --- 1. è™•ç†å¯«ä½œåˆ†æ•¸ ---
                const scoreMatch = r.aiContent.match(/ç¸½åˆ†:\s*(\d+)/);
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    if (r.category === "æ•˜äº‹æŠ’æƒ…") {
                        narrativeTotal.content += score * 0.4;
                        narrativeTotal.expr += score * 0.3;
                        narrativeTotal.struct += score * 0.2;
                        narrativeTotal.count++;
                    } else if (r.category === "è­°è«–") {
                        argumentTotal.content += score * 0.4;
                        argumentTotal.expr += score * 0.3;
                        argumentTotal.struct += score * 0.2;
                        argumentTotal.count++;
                    }
                }

                // --- 2. è™•ç†å¤§ç¶±é»è©• ---
                if (r.subFunction && r.subFunction.includes("å¤§ç¶±")) {
                    let rawText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                    let extract = "";
                    const commentIdx = rawText.indexOf("é»è©•");
                    if (commentIdx !== -1) {
                        extract = rawText.substring(commentIdx, commentIdx + 120);
                        outlineSummary += `[${r.category}å¤§ç¶±è¡¨ç¾]: ${extract}...\n`;
                    }
                }

                // --- 3. è™•ç†é–±è®€ç†è§£ ---
                if (r.category === "é–±è®€" && r.subFunction === "é»è©•") {
                    let rawText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                    let extract = "";
                    const commentIdx = rawText.indexOf("é»è©•");
                    if (commentIdx !== -1) {
                        extract = rawText.substring(commentIdx, commentIdx + 150); 
                        readingSummary += `[é–±è®€ç­”é¡Œè¡¨ç¾]: ${extract}...\n`;
                    }
                }

                // --- 4. â˜… æ–°å¢ï¼šè™•ç†æ•´åˆæ‹“å±• ---
                if (r.category === "æ•´åˆæ‹“å±•" && r.subFunction === "é»è©•") {
                    let rawText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                    let extract = "";
                    // æ•´åˆæ‹“å±•é€šå¸¸åŒ…å«ã€Œé»è©•ã€å’Œã€Œå»ºè­°ã€
                    const commentIdx = rawText.indexOf("é»è©•");
                    if (commentIdx !== -1) {
                        extract = rawText.substring(commentIdx, commentIdx + 150);
                        expandSummary += `[æ•´åˆæ‹“å±•è¡¨ç¾]: ${extract}...\n`;
                    }
                }
            });
        });

        // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ æ•¸æ“š
        if (studentCount === 0 && narrativeTotal.count === 0 && argumentTotal.count === 0 && 
            outlineSummary === "" && readingSummary === "" && expandSummary === "") {
            alert("æ­¤ç­ç´šæ•¸æ“šä¸è¶³ï¼Œç„¡æ³•ç”Ÿæˆå ±å‘Šã€‚");
            btn.disabled=false; 
            btn.innerHTML = '<i class="fas fa-chart-line"></i> ç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘Š (AI)';
            return;
        }

        // è¨ˆç®—å¹³å‡åˆ† (å¯«ä½œ)
        const narrAvg = {
            content: narrativeTotal.count ? Math.round((narrativeTotal.content / narrativeTotal.count) / 4) : 0, 
            expr: narrativeTotal.count ? Math.round((narrativeTotal.expr / narrativeTotal.count) / 3) : 0,    
            struct: narrativeTotal.count ? Math.round((narrativeTotal.struct / narrativeTotal.count) / 2) : 0 
        };
        const argAvg = {
            content: argumentTotal.count ? Math.round((argumentTotal.content / argumentTotal.count) / 4) : 0,
            expr: argumentTotal.count ? Math.round((argumentTotal.expr / argumentTotal.count) / 3) : 0,
            struct: argumentTotal.count ? Math.round((argumentTotal.struct / argumentTotal.count) / 2) : 0
        };

        // 3. å‘¼å« AI ç”Ÿæˆ (ä¿ç•™å®Œæ•´çš„æŒ‡ä»¤èˆ‡æ ¼å¼è¦æ±‚)
        const prompt = `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ä¸­æ–‡ç§‘ç§‘ä¸»ä»»ã€‚ä»¥ä¸‹æ˜¯ ${g}å¹´ç´š${c}ç­ çš„å­¸ç¿’æ•¸æ“šæ‘˜è¦ã€‚
        
        ### ç­ç´šæ•¸æ“šæ¦‚è¦½ (å¯«ä½œè©•åˆ†)ï¼š
        - æ•˜äº‹æŠ’æƒ…æ–‡ (å¹³å‡åˆ† 0-10)ï¼šå…§å®¹${narrAvg.content}, è¡¨é”${narrAvg.expr}, çµæ§‹${narrAvg.struct}
        - è­°è«–æ–‡ (å¹³å‡åˆ† 0-10)ï¼šå…§å®¹${argAvg.content}, è¡¨é”${argAvg.expr}, çµæ§‹${argAvg.struct}

        ### å­¸ç”Ÿå¯«ä½œè¡¨ç¾ (å¤§ç¶±æ§‹æ€ + æˆå“)ï¼š
        ${outlineSummary || "ï¼ˆæš«ç„¡å¤§ç¶±ç´€éŒ„ï¼‰"}
        ${classSummary}

        ### å­¸ç”Ÿé–±è®€ç†è§£è¡¨ç¾ (ä¾†è‡ªé–±è®€ç·´ç¿’ç´€éŒ„)ï¼š
        ${readingSummary || "ï¼ˆæš«ç„¡é–±è®€ç·´ç¿’ç´€éŒ„ï¼‰"}

        ### å­¸ç”Ÿæ•´åˆæ‹“å±•è¡¨ç¾ (ä¾†è‡ªç·´ç¿’ç´€éŒ„)ï¼š
        ${expandSummary || "ï¼ˆæš«ç„¡æ•´åˆæ‹“å±•ç´€éŒ„ï¼‰"}

        ### ä½ çš„ä»»å‹™ï¼š
        è«‹ç”Ÿæˆä¸€ä»½ã€Œå…¨ç­ç¶œåˆå­¸ç¿’è©•ä¼°å ±å‘Šã€ã€‚
        **é—œéµè¦æ±‚ï¼š**
        1. æ•´åˆã€Œè®€ã€ã€ã€Œå¯«ã€ã€ã€Œè½/èªª(æ•´åˆæ‹“å±•)ã€çš„å…¨æ–¹ä½è¡¨ç¾ã€‚
        2. å°‡ã€Œå¤§ç¶±æ§‹æ€ã€èåˆåˆ°å¯«ä½œåˆ†æä¸­ï¼Œåˆ†æå­¸ç”Ÿåœ¨æ§‹æ€èˆ‡å¯¦ä½œé–“çš„è½å·®ã€‚
        3. å¿…é ˆç‚ºæ¯å€‹ç¯„ç–‡ï¼ˆé–±è®€ã€æ•˜äº‹ã€è­°è«–ã€æ•´åˆæ‹“å±•ï¼‰æä¾›ç¨ç«‹çš„åˆ†æå€å¡Šã€‚

        ### æ ¸å¿ƒæŒ‡ä»¤ (Privacy Protocols)ï¼š
        1. **å®è§€è¦–è§’**ï¼šå ±å‘Šå¿…é ˆå®Œå…¨èšç„¦æ–¼ã€Œç­ç´šæ•´é«”è¡¨ç¾ã€æˆ–ã€Œå¤§éƒ¨åˆ†å­¸ç”Ÿã€ã€‚
        2. **åš´ç¦å€‹åˆ¥æåŠ**ï¼šçµ•å°**ä¸å¯ä»¥**åœ¨å ±å‘Šä¸­æåŠä»»ä½•ç‰¹å®šå­¸ç”Ÿç·¨è™Ÿæˆ–å…·é«”å€‹æ¡ˆã€‚
        3. **è¶¨å‹¢åˆ†æ**ï¼šè«‹å°‡å€‹åˆ¥æ¨£æœ¬ä¸­çš„å…·é«”å•é¡Œï¼ˆå¦‚é›¢é¡Œã€è«–æ“šä¸è¶³ã€æ‹“å±•æ–¹å‘éŒ¯èª¤ï¼‰è½‰åŒ–ç‚ºå…¨ç­æ€§çš„å¼·å¼±é …åˆ†æã€‚

        ### è¼¸å‡ºæ ¼å¼è¦æ±‚ (åš´æ ¼éµå®ˆ HTMLï¼Œæ¨£å¼éœ€èˆ‡å­¸ç”Ÿå ±å‘Šä¸€è‡´)ï¼š
        è«‹ç›´æ¥è¼¸å‡º HTML ä»£ç¢¼ï¼Œä¸è¦ä½¿ç”¨ Markdownã€‚

        1. **ç­ç´šæ•´é«”æ¦‚æ³**ï¼š
           <div class="report-section">
               <div class="report-category-badge badge-general">
                   <div class="badge-general-title"><i class="fas fa-users"></i> ${g}${c}ç­ ç¶œåˆè©•ä¼°</div>
               </div>
               <div class="report-text-card">
                   <p>(ç´„150å­—ï¼Œç¸½çµç­ç´šåœ¨ã€Œè®€ã€ã€ã€Œå¯«ã€ã€ã€Œæ•´åˆã€ä¸‰æ–¹é¢çš„æ•´é«”å¼·å¼±é …ï¼Œä¸¦çµ¦äºˆä¸€å€‹ç¸½é«”çš„å­¸ç¿’æ°›åœè©•åƒ¹ã€‚)</p>
               </div>
           </div>
           <div class="report-separator"></div>

        2. **ç¯„ç–‡æ·±å…¥åˆ†æ**ï¼š
           <div class="report-section">
               <div class="report-category-badge badge-reading"><i class="fas fa-book-open"></i> é–±è®€</div>
               <div class="report-text-card">
                   <p>(åˆ†æç­ç´šåœ¨é–±è®€ç†è§£ä¸Šçš„æ™®éå•é¡Œï¼Œä¾‹å¦‚ç†è§£é¡Œæ„ã€æ¨è«–èƒ½åŠ›æˆ–æ–‡æœ¬ä¾æ“šé‹ç”¨ç­‰ã€‚)</p>
               </div>
           </div>
           
           <div class="report-section">
               <div class="report-category-badge badge-narrative"><i class="fas fa-pen-nib"></i> æ•˜äº‹æŠ’æƒ…</div>
               <div class="report-text-card">
                   <p>(åˆ†ææ•˜äº‹æ–‡çš„é€šç—…èˆ‡äº®é»ï¼Œè«‹èåˆå°å¤§ç¶±æ§‹æ€çš„è§€å¯Ÿï¼Œä¾‹å¦‚ç«‹æ„æ˜¯å¦æ·±åˆ»ã€è©³ç•¥æ˜¯å¦å¾—ç•¶ã€‚)</p>
               </div>
           </div>
           
           <div class="report-section">
               <div class="report-category-badge badge-argument"><i class="fas fa-gavel"></i> è­°è«–</div>
               <div class="report-text-card">
                   <p>(åˆ†æè­°è«–æ–‡çš„é€šç—…èˆ‡äº®é»ï¼Œè«‹èåˆå°å¤§ç¶±æ§‹æ€çš„è§€å¯Ÿï¼Œä¾‹å¦‚è«–é»æ˜¯å¦æ¸…æ™°ã€è«–è­‰æ˜¯å¦åš´è¬¹ã€‚)</p>
               </div>
           </div>

           <div class="report-section">
               <div class="report-category-badge badge-expand"><i class="fas fa-layer-group"></i> æ•´åˆæ‹“å±•</div>
               <div class="report-text-card">
                   <p>(åˆ†æç­ç´šåœ¨æ•´åˆæ‹“å±•ç·´ç¿’ä¸Šçš„è¡¨ç¾ï¼Œä¾‹å¦‚æ˜¯å¦èƒ½æº–ç¢ºå›æ‡‰ä¸»é¡Œå¥ã€æ‹“å±•æ–¹å‘æ˜¯å¦åˆç†ã€è³‡æ–™é‹ç”¨æ˜¯å¦æ°ç•¶ã€‚)</p>
               </div>
           </div>

        3. **æ•™å­¸å»ºè­°**ï¼š
           <div class="report-quote-card">
               <div class="report-quote-content">ã€Œ(çµ¦ä»»æ•™è€å¸«çš„æ•´é«”æ•™å­¸ç­–ç•¥å»ºè­°ï¼Œæ¶µè“‹è®€å¯«çµåˆåŠæ€ç¶­è¨“ç·´çš„æ–¹å‘)ã€</div>
               <div class="report-quote-author">â€”â€” AI ç§‘ä¸»ä»»</div>
           </div>`;

        const response = await callAPI(prompt);

        // --- 4. å„²å­˜èˆ‡é¡¯ç¤º ---
        const reportData = {
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            dateStr: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString(),
            stats: {
                narrAvg: narrAvg,
                argAvg: argAvg,
                narrativeTotal: Math.round((narrativeTotal.content+narrativeTotal.expr+narrativeTotal.struct)/narrativeTotal.count) || 0,
                argumentTotal: Math.round((argumentTotal.content+argumentTotal.expr+argumentTotal.struct)/argumentTotal.count) || 0
            },
            aiHtml: response
        };

        await db.ref(`class_reports/${g}/${c}`).push(reportData);
        loadClassReportHistory();
        openClassReportModal(reportData);

    } catch (e) {
        console.error(e);
        alert("ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-chart-line"></i> ç”Ÿæˆå…¨ç­ç¶œåˆå ±å‘Š (AI)';
    }
}
        // === æ–°å¢ï¼šè¼‰å…¥èˆ‡é¡¯ç¤ºæ­·å²å…¨ç­å ±å‘Š ===
       function loadClassReportHistory() {
    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;
    const container = document.getElementById('classReportHistoryContainer');
    const list = document.getElementById('classReportList');

    db.ref(`class_reports/${g}/${c}`).once('value', snapshot => {
        const data = snapshot.val();
        if (!data) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        list.innerHTML = '';

        // å°‡è³‡æ–™è½‰ç‚ºé™£åˆ—ä¸¦æŒ‰æ™‚é–“å€’åºæ’åˆ—
        Object.entries(data)
            .sort(([,a], [,b]) => b.timestamp - a.timestamp)
            .forEach(([key, report]) => {
                
                // å»ºç«‹ä¸€å€‹å¤–å±¤å®¹å™¨ (è† å›Šç‹€)
                const wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    display: inline-flex; 
                    align-items: center; 
                    background: #fff; 
                    border: 1px solid #ccc; 
                    border-radius: 50px; 
                    padding: 5px 5px 5px 15px; 
                    flex-shrink: 0; 
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                    transition: transform 0.2s;
                `;

                // 1. æª¢é–±æŒ‰éˆ• (æ–‡å­—éƒ¨åˆ†)
                const viewSpan = document.createElement('span');
                viewSpan.style.cssText = "cursor: pointer; color: #555; font-size: 0.95em; font-weight: bold; margin-right: 10px;";
                viewSpan.innerHTML = `<i class="far fa-file-alt"></i> ${report.dateStr || 'æœªçŸ¥æ—¥æœŸ'}`;
                viewSpan.onclick = () => openClassReportModal(report);

                // 2. åˆªé™¤æŒ‰éˆ• (ç´…è‰²åœ“å½¢åœ–ç¤ºï¼Œç„¡æ–‡å­—)
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-action';
                delBtn.title = "åˆªé™¤æ­¤å ±å‘Š"; // æ»‘é¼ æ‡¸åœæç¤º
                delBtn.style.cssText = `
                    background: #fbecec; 
                    color: #d69a92; 
                    border: none; 
                    border-radius: 50%; 
                    width: 32px; 
                    height: 32px; 
                    padding: 0;
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    font-size: 14px;
                    box-shadow: none;
                `;
                
                delBtn.innerHTML = `<i class="fas fa-trash-alt"></i>`;
                
                // æŒ‰éˆ•äº’å‹•æ•ˆæœ
                delBtn.onmouseover = function() { this.style.background = '#d69a92'; this.style.color = 'white'; };
                delBtn.onmouseout = function() { this.style.background = '#fbecec'; this.style.color = '#d69a92'; };
                
                delBtn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¸ç™¼æª¢é–±
                    deleteClassReport(key);
                };

                // çµ„åˆå…ƒç´ 
                wrapper.appendChild(viewSpan);
                wrapper.appendChild(delBtn);
                list.appendChild(wrapper);
            });
    });
}

        // === æ–°å¢ï¼šåˆªé™¤å…¨ç­å ±å‘Šé‚è¼¯ ===
function deleteClassReport(reportKey) {
    // äºŒæ¬¡ç¢ºèª (é›–ç„¶ä¸é¡¯ç¤ºæ–‡å­—æŒ‰éˆ•ï¼Œä½† Alert é‚„æ˜¯è¦æœ‰æ–‡å­—æç¤ºæ¯”è¼ƒå®‰å…¨)
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ä»½å…¨ç­å ±å‘Šå—ï¼Ÿ\n(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)")) return;

    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;

    // åŸ·è¡Œ Firebase åˆªé™¤
    db.ref(`class_reports/${g}/${c}/${reportKey}`).remove()
        .then(() => {
            // åˆªé™¤æˆåŠŸå¾Œï¼Œé‡æ–°è¼‰å…¥åˆ—è¡¨
            loadClassReportHistory();
        })
        .catch(err => {
            console.error(err);
            alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
        });
}

        function openClassReportModal(reportData) {
            const modal = document.getElementById('classReportModal');
            const content = document.getElementById('classReportContent');
            
            // æ§‹å»º HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = reportData.aiHtml;

            // è™•ç†æ•˜äº‹åœ–è¡¨ (å–ä»£ AI çš„æ¨™ç±¤)
            const narrBadge = tempDiv.querySelector('.badge-narrative');
            if (narrBadge && reportData.stats.narrativeTotal > 0) {
                const chartHTML = generateClassChartHTML('narrative', reportData.stats.narrAvg, reportData.stats.narrativeTotal);
                narrBadge.outerHTML = chartHTML; 
            }

            // è™•ç†è­°è«–åœ–è¡¨ (å–ä»£ AI çš„æ¨™ç±¤)
            const argBadge = tempDiv.querySelector('.badge-argument');
            if (argBadge && reportData.stats.argumentTotal > 0) {
                const chartHTML = generateClassChartHTML('argument', reportData.stats.argAvg, reportData.stats.argumentTotal);
                argBadge.outerHTML = chartHTML;
            }

            // å¡«å…¥å…§å®¹
            content.innerHTML = `
                <div style="text-align:right; color:#999; padding:20px 20px 0 0;">
                    å ±å‘Šæ—¥æœŸï¼š${reportData.dateStr}
                </div>
                <div style="padding:20px;">
                    ${tempDiv.innerHTML}
                </div>`;
            
            modal.style.display = 'flex';

            // å»¶é²æ¸²æŸ“ Canvas åœ–è¡¨
            setTimeout(() => {
                if(reportData.stats.narrativeTotal > 0) renderClassChart('narrativeClassChart', reportData.stats.narrAvg);
                if(reportData.stats.argumentTotal > 0) renderClassChart('argumentClassChart', reportData.stats.argAvg);
            }, 200);
        }

        // ç”Ÿæˆåœ–è¡¨ HTML çµæ§‹ (èˆ‡å­¸ç”Ÿç«¯ä¸€è‡´)
        function generateClassChartHTML(type, avg, total) {
            const uniqueId = type === 'narrative' ? 'narrativeClassChart' : 'argumentClassChart';
            const title = type === 'narrative' ? 'æ•˜äº‹æŠ’æƒ…' : 'è­°è«–';
            const badgeClass = type === 'narrative' ? 'badge-narrative' : 'badge-argument';
            const level = determineGrade(total);

            return `
            <div class="report-section">
                <div class="report-category-badge ${badgeClass}"><i class="fas fa-book"></i> ${title}</div>
                <div class="report-radar-wrapper">
                    <div class="grading-container" style="margin:0; border:none; padding:0;">
                        <div class="grading-grid">
                            <div class="grading-scores" style="padding:15px;">
                                <h3>ç­ç´šå¹³å‡è¡¨ç¾</h3>
                                <div class="score-item"><label>å…§å®¹</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.content * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.content * 4}</span></div></div>
                                <div class="score-item"><label>è¡¨é”</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.expr * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.expr * 3}</span></div></div>
                                <div class="score-item"><label>çµæ§‹</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.struct * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.struct * 2}</span></div></div>
                                <div class="total-score-container">
                                    <span style="font-size:1.1em; color:#555;">å¹³å‡ç¸½åˆ†: ${total} / 100</span>
                                    <span style="font-size:2em; font-weight:bold; color:#d9534f; margin-left:auto;">${level}</span>
                                </div>
                            </div>
                            <div class="grading-radar" style="padding:15px;">
                                <h3>èƒ½åŠ›åˆ†ä½ˆ</h3>
                                <div class="radar-chart-container" style="height:250px;">
                                    <canvas id="${uniqueId}"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // æ¸²æŸ“åœ–è¡¨ JS
        function renderClassChart(canvasId, avg) {
            const ctxEl = document.getElementById(canvasId);
            if (!ctxEl) return;
            
            // ä¼°ç®—ç´°é …
            const radarData = [
                (avg.content * 0.6 + avg.struct * 0.4).toFixed(1), // ç«‹æ„
                (avg.content * 0.8 + avg.expr * 0.2).toFixed(1),   // å–æ
                (avg.content * 0.7 + avg.struct * 0.3).toFixed(1), // æ‰£é¡Œ
                (avg.struct * 0.7 + avg.content * 0.3).toFixed(1), // è©³ç•¥
                avg.expr, // è©å½™
                avg.expr  // æ–‡å­¸æ€§
            ];

            new Chart(ctxEl.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['ç«‹æ„', 'å–æ', 'æ‰£é¡Œ', 'è©³ç•¥', 'è©å½™', 'æ–‡å­¸æ€§'],
                    datasets: [{
                        label: 'ç­ç´šå¹³å‡',
                        data: radarData,
                        backgroundColor: 'rgba(94, 112, 103, 0.4)', // è«è˜­è¿ªæ·±ç¶ åŠé€æ˜
                        borderColor: '#5e7067',
                        borderWidth: 2,
                        pointBackgroundColor: '#5e7067',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0, suggestedMax: 10,
                            pointLabels: { font: { size: 12, family: "'Noto Serif TC', serif" } },
                            ticks: { stepSize: 2, display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function callAPI(prompt) {
            let currentKeyIndex = Math.floor(Math.random() * READING_API_KEYS.length);
            try {
                const response = await fetch(READING_API_URL, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${READING_API_KEYS[currentKeyIndex]}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: READING_MODEL, messages: [{ role: "user", content: prompt }], max_tokens: 4000 })
                });
                const data = await response.json();
                let content = data.choices[0].message.content.trim();
                return content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>/gis, '').trim();
            } catch (e) { throw new Error("API Error"); }
        }

        // === æ­·å²æª¢é–±å…±ç”¨é‚è¼¯ ===
        function openHistoryModal(name, h) {
            document.getElementById('viewerTitle').innerHTML = `<i class="fas fa-user-graduate"></i> ${name}`;
            currentStudentHistory = h;
            document.getElementById('historyViewerModal').style.display = 'flex';
            renderLevel1();
        }
        function renderLevel1() {
            ['historyLevel2','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyLevel1').style.display='flex';
            document.getElementById('teacherBreadcrumb').style.display='none';
            const c = document.getElementById('historyLevel1'); c.innerHTML='';
            Object.keys(HISTORY_STRUCTURE).forEach(cat => {
                const count = currentStudentHistory.filter(r => r.category === cat).length;
                const asset = CATEGORY_ASSETS[cat] || { img: 'èƒŒæ™¯.png', en: 'RECORD' };
                const style = count===0 ? 'filter: grayscale(100%); opacity: 0.6;' : '';
                c.innerHTML += `<div class="anime-card" style="--bg-img: url('${asset.img}'); ${style}" onclick="renderLevel2('${cat}')"><div class="card-overlay"></div><div class="card-content"><span class="card-zh">${cat}</span><span class="card-en">${count} ç­†</span></div></div>`;
            });
        }
        function renderLevel2(cat) {
            currentCategory=cat; 
            ['historyLevel1','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyLevel2').style.display='grid';
            updateBreadcrumb(cat);
            const c = document.getElementById('historyLevel2'); c.innerHTML='';
            const subs = HISTORY_STRUCTURE[cat] || [];
            subs.forEach((sub,i)=>{
                const count=currentStudentHistory.filter(r=>r.category===cat&&r.subFunction===sub).length;
                const theme=(i%5)+1;
                c.innerHTML+=`<div class="history-folder-btn history-theme-${theme}" style="${count===0?'opacity:0.6':''}" onclick="renderLevel3('${sub}',${theme})"><i class="fas ${SUB_ICONS[sub]||'fa-file'}"></i><span style="font-weight:bold;font-size:1.1em;">${sub}</span><span style="font-size:0.8em;margin-top:5px;color:#999;">(${count})</span></div>`;
            });
        }
        function renderLevel3(sub, theme) {
            currentSubFunction=sub; currentThemeIndex=theme;
            ['historyLevel1','historyLevel2','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyLevel3').style.display='grid';
            updateBreadcrumb(currentCategory,sub);
            const c=document.getElementById('historyLevel3'); c.innerHTML='';
            const recs=currentStudentHistory.filter(r=>r.category===currentCategory&&r.subFunction===sub).sort((a,b)=>b.timestamp-a.timestamp);
            if(recs.length===0){c.innerHTML='<p style="text-align:center;width:100%;color:#999;grid-column:1/-1;">ç„¡ç´€éŒ„</p>';return;}
            recs.forEach(r=>{
                c.innerHTML+=`<div class="history-card theme-${theme}" onclick='renderDetail(${JSON.stringify(r).replace(/'/g, "&#39;")})'><div class="history-meta"><span>${r.dateStr?r.dateStr.split(' ')[0]:'æœªçŸ¥'}</span><span>${r.subFunction}</span></div><h4 class="history-title">${r.title||'ç„¡æ¨™é¡Œ'}</h4></div>`;
            });
        }
        function renderDetail(r) {
            ['historyLevel1','historyLevel2','historyLevel3'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyDetail').style.display='block';
            document.getElementById('teacherBreadcrumb').style.display='none';
            
            let uContent = '';
            // è‹¥ä¸æ˜¯å­¸ç¿’å ±å‘Šï¼Œæ‰é¡¯ç¤ºä½¿ç”¨è€…è¼¸å…¥
            if (r.category !== "å­¸ç¿’å ±å‘Š" && r.userContent) {
                uContent = `<div style="background:#fff;padding:20px;border:1px solid #eee;border-radius:12px;margin-bottom:20px;">${r.userContent.replace(/\n/g, '<br>')}</div>`;
            }
            document.getElementById('historyDetail').innerHTML = `
                <div style="margin-bottom:15px;"><button class="nav-btn" onclick="renderLevel3('${currentSubFunction}',${currentThemeIndex})" style="padding:5px 15px;font-size:0.9em;"><i class="fas fa-arrow-left"></i> è¿”å›</button></div>
                <div class="detail-view">
                    <div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:20px;"><h2 style="margin:0;color:#333;">${r.title}</h2><p style="color:#888;margin-top:5px;">${r.dateStr}</p></div>
                    ${uContent}
                    <div class="detail-ai-box" style="margin-top:20px;">${r.aiContent}</div>
                </div>`;
        }
        function updateBreadcrumb(c,s) { 
            const b=document.getElementById('teacherBreadcrumb'); b.style.display='flex';
            document.getElementById('breadCategory').innerText=c;
            document.getElementById('breadSub').innerText=s||'';
            document.getElementById('breadSep2').style.display=s?'inline':'none';
        }


        // === 3. å­¸å¹´ç®¡ç† ===
        function populateTransferStudentList() {
            const g=document.getElementById('indivFromGrade').value, c=document.getElementById('indivFromClass').value;
            const b=document.getElementById('transferStudentListBox'); b.innerHTML='è¼‰å…¥ä¸­...';
            db.ref(`students/${g}/${c}`).once('value', s=>{
                const d=s.val(); b.innerHTML='';
                if(!d) { b.innerHTML='ç„¡å­¸ç”Ÿ'; return; }
                Object.entries(d).sort((a,b)=>(parseInt(a[1].profile?.number)||99)-(parseInt(b[1].profile?.number)||99)).forEach(([n,i])=>{
                    b.innerHTML+=`<label class="student-select-item"><input type="radio" name="ts" value="${n}"> ${i.profile?.number||'??'}. ${n}</label>`;
                });
            });
        }
        function moveIndividualStudent() {
            const n = document.querySelector('input[name="ts"]:checked')?.value;
            if (!n) return alert("è«‹é¸æ“‡å­¸ç”Ÿ");
            const fg = document.getElementById('indivFromGrade').value;
            const fc = document.getElementById('indivFromClass').value;
            const tg = document.getElementById('indivToGrade').value;
            const tc = document.getElementById('indivToClass').value;
            const nn = document.getElementById('indivNewNumber').value;
            if (!nn) return alert("è«‹è¼¸å…¥æ–°ç­è™Ÿ");
            const oldPath = `students/${fg}/${fc}/${n}`;
            const newPath = `students/${tg}/${tc}/${n}`;
            db.ref(oldPath).once('value', s => {
                const d = s.val();
                if (!d) return;
                d.profile = d.profile || {}; d.profile.grade = tg; d.profile.class = tc; d.profile.number = nn;
                if (oldPath === newPath) {
                    db.ref(newPath).update(d, e => { if (!e) { alert("ç­è™Ÿå·²æ›´æ–°"); populateTransferStudentList(); } else alert("æ›´æ–°å¤±æ•—ï¼š" + e.message); });
                } else {
                    db.ref(newPath).set(d, e => { if (!e) { db.ref(oldPath).remove(); alert("å­¸ç”Ÿå·²æˆåŠŸè½‰ç­"); populateTransferStudentList(); } else alert("ç§»è½‰å¤±æ•—ï¼š" + e.message); });
                }
            });
        }
        function deleteStudent() {
            const n=document.querySelector('input[name="ts"]:checked')?.value;
            if(n && confirm(`åˆªé™¤ ${n}?`)) db.ref(`students/${document.getElementById('indivFromGrade').value}/${document.getElementById('indivFromClass').value}/${n}`).remove(e=>{ if(!e) populateTransferStudentList(); });
        }
        function updateYearConfig() { db.ref('config/currentYear').set(document.getElementById('currentYearInput').value, e=>alert(e?'å¤±æ•—':'æˆåŠŸ')); }
        
        async function runYearTransition() {
            if(prompt("å¯†ç¢¼")!=="23262036") return;
            if(!confirm("ç¢ºå®šå…¨æ ¡å‡ç­ï¼Ÿ")) return;
            const all = (await db.ref('students').once('value')).val();
            if(!all) return;
            const y = document.getElementById('currentYearInput').value;
            await db.ref(`archives/${y}/students`).set(all);
            let n = {};
            for(let g=1; g<=5; g++) {
                if(all[g]) {
                    n[g+1] = all[g];
                    for(let c in n[g+1]) for(let s in n[g+1][c]) if(n[g+1][c][s].profile) n[g+1][c][s].profile.grade=(g+1).toString();
                }
            }
            if(all[6]) await db.ref(`graduates/${y}`).set(all[6]);
            db.ref('students').set(n, e=>alert(e?'å¤±æ•—':'æˆåŠŸ'));
        }


// === [æ–°å¢] æ•¸æ“šçµ±è¨ˆèˆ‡åœ–è¡¨é‚è¼¯ ===

// === [ä¿®æ­£ç‰ˆ] åˆå§‹åŒ–ä»‹é¢ (è§£æ±ºæ™‚å€å•é¡Œ) ===
function initStatUI() {
    // 1. ç²å–æœ¬åœ°æ™‚é–“ (é¦™æ¸¯æ™‚é–“)
    const now = new Date();
    
    // 2. æ‰‹å‹•æ ¼å¼åŒ–ç‚º YYYY-MM-DD (é¿å… UTC èª¤å·®)
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const dateStr = `${y}-${m}-${d}`;

    // 3. è¨­å®šæ—¥æœŸé¸æ“‡å™¨
    const dateInput = document.getElementById('statDate');
    if (dateInput) {
        dateInput.value = dateStr; // è¨­å®šç‚ºä»Šå¤© (ä¾‹å¦‚ 2026-01-11)
    }
    
    // 4. è¨­å®šå¹´ä»½é¸å–®
    const yearSel = document.getElementById('statYear');
    if (yearSel) yearSel.value = y;

    // 5. è¨­å®šæœˆä»½é¸å–®
    const monthSel = document.getElementById('statMonth');
    if (monthSel) {
        monthSel.innerHTML = '';
        for(let i=1; i<=12; i++) {
            const opt = document.createElement('option');
            opt.value = String(i).padStart(2, '0'); // ç¢ºä¿æ˜¯ "01", "02"
            opt.text = i + 'æœˆ';
            if(String(i).padStart(2, '0') === m) opt.selected = true; // é¸ä¸­æœ¬æœˆ
            monthSel.add(opt);
        }
    }

    // 6. åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹
    updateStatInputs();
    updateTimeInputs();
}

// 2. æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤ºç‹€æ…‹
function updateStatInputs() {
    const scope = document.getElementById('statScope').value;
    document.getElementById('statClassInput').style.display = (scope === 'class' || scope === 'student') ? 'inline-block' : 'none';
    document.getElementById('statStudentInput').style.display = (scope === 'student') ? 'inline-block' : 'none';
}

function updateTimeInputs() {
    const mode = document.getElementById('statTimeMode').value;
    document.getElementById('statDate').style.display = (mode === 'day') ? 'inline-block' : 'none';
    document.getElementById('statMonth').style.display = (mode === 'month') ? 'inline-block' : 'none';
    document.getElementById('statYear').style.display = (mode === 'month' || mode === 'year') ? 'inline-block' : 'none';
}

// 3. æŠ“å–æ•¸æ“šä¸¦ç¹ªåœ– (æ ¸å¿ƒé‚è¼¯)
let analyticsChartInstance = null;

// === [ä¿®å¾©ç‰ˆ] æŠ“å–æ•¸æ“šä¸¦ç¹ªåœ– (æ ¸å¿ƒé‚è¼¯) ===
async function fetchAndRenderStats() {
    const scope = document.getElementById('statScope').value;
    const mode = document.getElementById('statTimeMode').value;
    const btn = event.target;
    
    // é–å®šæŒ‰éˆ•
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    // A. æ§‹å»ºè·¯å¾‘åƒæ•¸ (é—œéµä¿®å¾©ï¼šç›´æ¥è™•ç†å­—ä¸²ï¼Œé¿å…æ™‚å€èª¤å·®)
    let year, month, day;
    
    if (mode === 'day') {
        const rawDate = document.getElementById('statDate').value; // æ ¼å¼: "2026-01-11"
        if (!rawDate) {
            alert("è«‹é¸æ“‡æ—¥æœŸ");
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }
        const parts = rawDate.split('-'); // ["2026", "01", "11"]
        year = parts[0];
        month = parts[1];
        day = parts[2];
    } else {
        year = document.getElementById('statYear').value;
        if (mode === 'month') {
            month = document.getElementById('statMonth').value; // ç¢ºä¿é€™è£¡çš„å€¼æ˜¯ "01", "02" (æœ‰è£œé›¶)
        }
    }

    // B. æ±ºå®šè¦è®€å–çš„è³‡æ–™åº«è·¯å¾‘
    let fetchPath = `analytics/${year}`;
    if (mode === 'day') fetchPath += `/${month}/${day}`;
    else if (mode === 'month') fetchPath += `/${month}`;

    // â˜…â˜…â˜… é™¤éŒ¯è¨Šæ¯ (æŒ‰ F12 çœ‹ Console) â˜…â˜…â˜…
    console.log(`æ­£åœ¨è®€å–è·¯å¾‘: ${fetchPath}`);
    console.log(`ç¯©é¸å°è±¡: ${scope}`);

    try {
        const snapshot = await db.ref(fetchPath).once('value');
        const data = snapshot.val();
        
        // â˜…â˜…â˜… é™¤éŒ¯è¨Šæ¯ â˜…â˜…â˜…
        console.log("Firebase å›å‚³è³‡æ–™:", data);

        if (!data) {
            console.warn("âš ï¸ æ­¤è·¯å¾‘ç„¡è³‡æ–™å›å‚³");
            alert(`æ‰¾ä¸åˆ°æ•¸æ“šï¼\næ­£åœ¨è®€å–è·¯å¾‘ï¼š${fetchPath}\n\nè«‹ç¢ºèª Firebase Console ä¸­è©²æ—¥æœŸæ˜¯å¦çœŸçš„æœ‰æ•¸æ“šã€‚`);
            resetCharts();
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        // C. æ•¸æ“šèšåˆ (Aggregation)
        let aggregatedData = {}; // { '01æ—¥': {visits:10, duration:500}, ... }
        let totalStats = { visits: 0, duration: 0 };

        // éè¿´å‡½å¼ï¼šæ‰¾å‡ºç›®æ¨™æ•¸æ“šç¯€é»ä¸¦ç´¯åŠ 
        function processNode(nodeData, dateLabel) {
            if (!nodeData) return; // é˜²å‘†

            let targetNode = null;

            // æ ¹æ“šé¸æ“‡çš„å°è±¡ (Scope) æ·±å…¥æŒ–æ˜
            if (scope === 'global') {
                targetNode = nodeData.global;
            } 
            else if (scope === 'school') {
                targetNode = nodeData.school;
            } 
            else if (scope === 'class') {
                const g = document.getElementById('statGrade').value;
                const c = document.getElementById('statClass').value;
                // æª¢æŸ¥è·¯å¾‘: classes -> 6A
                if (nodeData.classes && nodeData.classes[g+c]) {
                    targetNode = nodeData.classes[g+c];
                }
            }
            else if (scope === 'student') {
                const g = document.getElementById('statGrade').value;
                const c = document.getElementById('statClass').value;
                const n = document.getElementById('statStudentName').value.trim();
                // æª¢æŸ¥è·¯å¾‘
                if (nodeData.students && nodeData.students[g] && nodeData.students[g][c] && nodeData.students[g][c][n]) {
                    targetNode = nodeData.students[g][c][n];
                }
            }

            // å¦‚æœæ‰¾åˆ°äº†æ•¸æ“šï¼Œé€²è¡Œç´¯åŠ 
            if (targetNode) {
                // æ•¸æ“šæ¸…æ´—ï¼šç¢ºä¿æ˜¯æ•¸å­—
                const v = parseInt(targetNode.visits || 0);
                const d = parseInt(targetNode.duration || 0);

                if (!aggregatedData[dateLabel]) aggregatedData[dateLabel] = { visits: 0, duration: 0 };
                
                aggregatedData[dateLabel].visits += v;
                aggregatedData[dateLabel].duration += d;
                
                totalStats.visits += v;
                totalStats.duration += d;
            }
        }

        // æ ¹æ“šæ™‚é–“æ¨¡å¼éæ­·æ•¸æ“š
        if (mode === 'day') {
            // æœ¬æ—¥ï¼šç›´æ¥è™•ç†ç•¶å‰ç¯€é»
            processNode(data, 'æœ¬æ—¥');
        } 
        else if (mode === 'month') {
            // æœ¬æœˆï¼šdata è£¡é¢æ˜¯ {'01':{...}, '02':{...}}
            Object.keys(data).sort().forEach(dKey => {
                processNode(data[dKey], `${parseInt(dKey)}æ—¥`);
            });
        } 
        else if (mode === 'year') {
            // æœ¬å¹´ï¼šdata è£¡é¢æ˜¯ {'01':{...}, '02':{...}} (æœˆä»½)
            Object.keys(data).sort().forEach(mKey => {
                const monthData = data[mKey];
                // è©²æœˆå…§é‚„æœ‰å¾ˆå¤šå¤©ï¼Œéœ€è¦å†éæ­·æ¯ä¸€å¤©
                Object.keys(monthData).forEach(dKey => {
                    processNode(monthData[dKey], `${parseInt(mKey)}æœˆ`);
                });
            });
        }

        // D. æ›´æ–°ä¸Šæ–¹å¤§å­—å ±
        document.getElementById('dispVisits').innerText = totalStats.visits;
        document.getElementById('dispDuration').innerText = Math.round(totalStats.duration / 60); // ç§’è½‰åˆ†
        const avg = totalStats.visits > 0 ? Math.round((totalStats.duration / 60) / totalStats.visits) : 0;
        document.getElementById('dispAvg').innerText = avg;

        // E. ç¹ªè£½åœ–è¡¨
        renderAnalyticsChart(aggregatedData);

    } catch (e) {
        console.error("è®€å–éç¨‹ç™¼ç”ŸéŒ¯èª¤:", e);
        alert("è®€å–æ•¸æ“šå¤±æ•—ï¼š" + e.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// 4. é‡ç½®åœ–è¡¨
function resetCharts() {
    document.getElementById('dispVisits').innerText = 0;
    document.getElementById('dispDuration').innerText = 0;
    document.getElementById('dispAvg').innerText = 0;
    if (analyticsChartInstance) {
        analyticsChartInstance.destroy();
        analyticsChartInstance = null;
    }
}

// 5. æ¸²æŸ“æ··åˆåœ–è¡¨ (Chart.js)
function renderAnalyticsChart(aggData) {
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    if (analyticsChartInstance) analyticsChartInstance.destroy();

    const labels = Object.keys(aggData); // Xè»¸ (æ—¥æœŸ/æœˆä»½)
    const visitData = labels.map(l => aggData[l].visits); // é•·æ¢åœ–æ•¸æ“š
    const durationData = labels.map(l => Math.round(aggData[l].duration / 60)); // æŠ˜ç·šåœ–æ•¸æ“š (åˆ†é˜)

    analyticsChartInstance = new Chart(ctx, {
        type: 'bar', // é è¨­é¡å‹
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'é€²å…¥æ¬¡æ•¸ (æ¬¡)',
                    data: visitData,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    order: 2, // å±¤ç´š (åœ¨æŠ˜ç·šåœ–ä¸‹é¢)
                    yAxisID: 'y'
                },
                {
                    label: 'ä½¿ç”¨æ™‚é•· (åˆ†é˜)',
                    data: durationData,
                    type: 'line', // æ··åˆæŠ˜ç·šåœ–
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    tension: 0.3, // æ›²ç·šå¹³æ»‘åº¦
                    order: 1, // å±¤ç´š (æœ€ä¸Šå±¤)
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) label += context.parsed.y;
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'æ¬¡æ•¸' },
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false }, // ä¸é¡¯ç¤ºå³è»¸ç¶²æ ¼ï¼Œä¿æŒä¹¾æ·¨
                    title: { display: true, text: 'åˆ†é˜' },
                    beginAtZero: true
                }
            }
        }
    });
}

// 6. ä¿®æ”¹ tab åˆ‡æ›å‡½å¼ (ç¢ºä¿åˆå§‹åŒ–)
const originalSwitchTab = window.switchTab;
window.switchTab = function(tabId) {
    originalSwitchTab(tabId); // åŸ·è¡ŒåŸæœ¬çš„åˆ‡æ›é‚è¼¯
    if(tabId === 'analytics') {
        // ç¬¬ä¸€æ¬¡é€²å…¥æ™‚åˆå§‹åŒ– UI
        if(document.getElementById('statMonth').options.length === 0) {
            initStatUI();
        }
    }
};


        
    </script>

<footer class="copyright-footer">
<p>Copyright Â© 2025 é™³å† å¥. All rights reserved.</p>
</footer>

    
</body>
</html>
