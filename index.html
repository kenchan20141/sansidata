<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神思 - 教研平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 引入 Chart.js 以繪製雷達圖 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* === 莫蘭迪色系定義 === */
        :root {
            --m-green: #8fa398;   --m-blue: #94a7b5;    --m-purple: #b6a6ca;
            --m-red: #d69a92;     --m-brown: #c7b299;   --bg-color: #fdfcf8;
            --text-main: #5e5e5e; --border-color: #e0ddd7;
        }

        body {
            font-family: 'Noto Serif TC', serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: url('背景.png') center/cover fixed;
            background-color: #f4f4f4;
            color: var(--text-main);
            overflow-y: scroll;
        }

        /* === 登入遮罩 (安全閘門) === */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdfcf8; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid var(--border-color);
            max-width: 400px; width: 90%;
        }
        .login-btn {
            background-color: var(--m-blue); color: white; padding: 12px 30px;
            border: none; border-radius: 50px; font-size: 1.1em; cursor: pointer;
            margin-top: 20px; transition: all 0.3s; width: 100%;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(148, 167, 181, 0.4); }

        /* === 隱藏主要內容，登入後才顯示 === */
        #mainApp { display: none; }

        /* === 通用容器 === */
        h1, h2 { text-align: center; color: var(--text-main); margin-bottom: 20px; letter-spacing: 2px; }
        h3 { color: var(--m-blue); border-left: 5px solid var(--m-blue); padding-left: 10px; margin-top: 30px; }
        .box { background: rgba(255, 255, 255, 0.98); border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); padding: 30px; margin-bottom: 25px; border: 1px solid var(--border-color); }
        
        /* === 導航與按鈕 === */
        .nav-bar { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .nav-btn { padding: 12px 30px; border-radius: 50px; border: none; background: #e0e0e0; color: #666; cursor: pointer; font-size: 1.05em; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .nav-btn.active { background: var(--m-blue); color: white; box-shadow: 0 4px 12px rgba(148, 167, 181, 0.4); transform: translateY(-2px); }
        .nav-btn:hover:not(.active) { background: #dcdcdc; }
        
        .btn-action { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; color: white; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-action:hover { filter: brightness(95%); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-action:disabled { background: #ccc !important; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-view { background-color: var(--m-blue); } .btn-delete { background-color: var(--m-red); } .btn-manage { background-color: var(--m-brown); }
        .btn-publish { background: linear-gradient(135deg, #8fa398 0%, #7d9186 100%); font-size: 1.2rem; padding: 15px 40px; width: 100%; justify-content: center; font-weight: bold; letter-spacing: 1px; border-radius: 50px; box-shadow: 0 5px 15px rgba(143, 163, 152, 0.4); }

        .filter-group { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 20px; background: #fcfcfc; border-radius: 12px; flex-wrap: wrap; border: 1px solid var(--border-color); }
        select, input { padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Noto Serif TC', serif; font-size: 1rem; outline: none; background: #fff; color: #555; }
        
        /* === 學生列表 === */
        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .student-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); border-top: 5px solid var(--m-blue); box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.3s ease; }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .student-name { font-size: 1.2em; font-weight: bold; color: #444; margin-bottom: 5px; }
        .last-sync { font-size: 0.85em; color: #999; display: flex; align-items: center; gap: 6px; }

        /* === 歷史檢閱 UI === */
        .category-cards-container { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; padding: 20px; }
        .anime-card {
            position: relative; width: 140px; height: 200px; border-radius: 15px;
            background-image: var(--bg-img); background-size: cover; background-position: center;
            cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden; filter: grayscale(20%); margin-bottom: 20px; border: 2px solid #fff;
        }
        .anime-card:hover { transform: translateY(-10px) scale(1.05); filter: grayscale(0%); box-shadow: 0 15px 30px rgba(0,0,0,0.3); z-index: 10; }
        .card-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 60%); }
        .card-content { position: absolute; bottom: 0; left: 0; width: 100%; padding: 15px; text-align: center; }
        .card-zh { display: block; color: #fff; font-size: 18px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); letter-spacing: 2px; }
        .card-en { display: block; color: rgba(255,255,255,0.7); font-size: 10px; letter-spacing: 1px; margin-top: 5px; }

        /* 第二層：子功能 Grid 按鈕 */
        .history-grid-menu { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; padding: 20px 0; }
        .history-folder-btn {
            background-color: #fff; border: 2px solid #e9ecef; border-radius: 12px; padding: 25px 15px; 
            text-align: center; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 120px; color: #555;
        }
        .history-folder-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); background-color: #fff; }
        .history-folder-btn i { font-size: 2em; margin-bottom: 10px; color: #ccc; transition: color 0.3s; }
        
        .history-theme-1 { border-color: #8fa398; color: #8fa398; } .history-theme-1:hover i { color: #8fa398; }
        .history-theme-2 { border-color: #94a7b5; color: #94a7b5; } .history-theme-2:hover i { color: #94a7b5; }
        .history-theme-3 { border-color: #b6a6ca; color: #b6a6ca; } .history-theme-3:hover i { color: #b6a6ca; }
        .history-theme-4 { border-color: #d69a92; color: #d69a92; } .history-theme-4:hover i { color: #d69a92; }
        .history-theme-5 { border-color: #c7b299; color: #c7b299; } .history-theme-5:hover i { color: #c7b299; }

        /* 第三層：紀錄列表卡片 */
        .history-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-top: 10px; }
        .history-card {
            background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 8px; 
            padding: 20px 20px 20px 55px; position: relative; box-shadow: 4px 4px 0px rgba(0,0,0,0.03); 
            cursor: pointer; transition: all 0.3s; overflow: hidden;
            background-image: linear-gradient(to right, transparent 39px, #e0ddd7 40px, transparent 41px), radial-gradient(circle at 20px 50%, #d1cdc5 6px, transparent 7px);
            background-size: 100% 100%, 100% 35px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 12px;
        }
        .history-card:hover { transform: translateY(-3px); box-shadow: 6px 6px 0px rgba(0,0,0,0.08); background-color: #fff; }
        .history-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; z-index: 1; }
        
        .theme-1::before { background: #8fa398; } .theme-2::before { background: #94a7b5; }
        .theme-3::before { background: #b6a6ca; } .theme-4::before { background: #d69a92; } .theme-5::before { background: #c7b299; }

        .history-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: #999; margin-bottom: 10px; border-bottom: 1px dashed #e0ddd7; padding-bottom: 5px; }
        .history-title { margin: 0; font-size: 1.1em; color: #444; font-weight: bold; line-height: 1.4; }

        .history-breadcrumb { display: flex; align-items: center; gap: 8px; font-size: 1rem; color: #999; margin-bottom: 20px; padding: 10px 5px; border-bottom: 1px dashed #ccc; }
        .breadcrumb-item { cursor: pointer; font-weight: bold; color: var(--m-blue); transition: color 0.2s; }
        .breadcrumb-item:hover { color: #5e5e5e; text-decoration: underline; }
        .breadcrumb-current { color: #5e5e5e; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 4px; font-weight: bold; }

        /* === 課業列表 === */
        .assignment-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 12px; background: #fff; transition: all 0.2s; }
        .tag { background-color: #eee; color: #666; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: normal; margin-right: 10px; }
        .publish-area { background: #fdfcf8; padding: 30px; border-radius: 15px; border: 2px dashed var(--m-green); margin-bottom: 40px; display: flex; flex-direction: column; gap: 20px; }
        .publish-inputs { display: flex; gap: 15px; width: 100%; flex-wrap: wrap; }
        .publish-inputs input { flex: 1 1 auto; min-width: 200px; padding: 15px; font-size: 1.1em; border: 1px solid #ddd; }

        /* === Modals === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-body { background: #fff; width: 95%; max-width: 1100px; height: 90vh; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 20px 30px; background: #fdfcf8; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-content-scroll { flex: 1; overflow-y: auto; padding: 20px 30px; -webkit-overflow-scrolling: touch; }
        
        /* 詳情頁內容 */
        .detail-view { background: #fff; padding: 10px; }
        .history-parsed-container { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e1e4e8; border-left: 5px solid var(--m-blue); margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .history-item-block { margin-bottom: 15px; }
        .history-item-label { font-weight: bold; color: var(--m-blue); font-size: 1em; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .history-item-label::before { content: ''; display: block; width: 8px; height: 8px; background-color: var(--m-blue); border-radius: 50%; opacity: 0.8; }
        .history-item-content { background: #fcfcfc; border: 1px solid #e1e4e8; border-radius: 4px; padding: 12px 16px; color: #444; line-height: 1.8; white-space: pre-wrap; }
        
        /* 繳交檢閱 */
        .modal-content-container { display: flex; height: 100%; overflow: hidden; }
        .submission-sidebar { width: 320px; border-right: 1px solid var(--border-color); overflow-y: auto; background: #fafafa; flex-shrink: 0; }
        .submission-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .submission-item:hover { background: #f0f0f0; }
        .submission-item.active { background: #eef2f5; border-left: 4px solid var(--m-blue); }
        .status-badge { font-size: 0.8em; padding: 3px 10px; border-radius: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .status-done { background: #e8edea; color: #5e7067; }
        .status-pending { background: #f7ebea; color: #a67069; }
        .submission-detail-area { flex-grow: 1; padding: 30px; overflow-y: auto; background: #fff; }
        .teacher-feedback-section { background-color: #fffaf5; border: 2px solid #e6dace; border-radius: 12px; padding: 20px; margin-top: 30px; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08); }

        /* 學年管理 */
        .management-section { background: #fff; border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 30px; }
        .transfer-grid { display: flex; gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; align-items: flex-start; }
        .transfer-column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .transfer-list-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; height: 250px; overflow-y: auto; padding: 5px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); }
        .student-select-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; }
        .student-select-item:hover { background-color: #f5f5f5; }
        .student-select-item input[type="radio"] { transform: scale(1.3); accent-color: var(--m-green); cursor: pointer; }
        .year-transition-card { background-color: #fdfcf8; border: 2px solid var(--m-brown); border-radius: 15px; padding: 30px; text-align: center; max-width: 600px; margin: 0 auto; }

        /* ============================================== */
        /* === 學習報告專用樣式 (支援後台檢視) === */
        /* ============================================== */
        .report-section { margin-bottom: 50px; }
        
        /* 1. 範疇標題 (膠囊型標籤) */
        .report-category-badge { display: inline-flex; align-items: center; gap: 10px; padding: 10px 25px; border-radius: 50px; color: white; font-weight: bold; font-size: 1.3rem; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); letter-spacing: 1px; }
        .badge-narrative { background-color: #7da3c0; }
        .badge-argument { background-color: #a692c2; }
        .badge-reading { background-color: #8da399; }
        .badge-expand { background-color: #d69a92; }
        
        /* 2. 整體概況標題容器 (增強版) */
        /* 2. 整體概況標題容器 (修改為無印米色風格) */
.badge-general {
    width: 100%; 
    max-width: 100%; 
    box-sizing: border-box; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
    padding: 20px 10px; 
    margin-bottom: 10px; 
    
    /* === 修改重點：無印風．暖麻米色 === */
    background: linear-gradient(135deg, #C5B4A1 0%, #A99885 100%);
    box-shadow: 0 8px 20px rgba(169, 152, 133, 0.35);
    /* ============================== */

    color: white; 
    border-radius: 12px; 
    position: relative; 
    overflow: hidden;
}
        .badge-general-title { font-size: 1.6rem; font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* 3. 綜合評級 */
        .overall-grade-tag { background-color: #fff; color: #d9534f; padding: 5px 25px; border-radius: 50px; font-size: 1.4rem; font-weight: 900; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid #d69a92; display: flex; align-items: center; gap: 8px; }
        .overall-grade-label { font-size: 0.8rem; color: #888; font-weight: normal; text-transform: uppercase; letter-spacing: 1px; }

        /* 4. 文字分析卡片 */
        .report-text-card { background-color: #fdfcf8; border: 1px solid #e0ddd7; border-radius: 12px; padding: 25px; line-height: 1.9; color: #4a4a4a; font-size: 1.05rem; box-shadow: 0 4px 15px rgba(0,0,0,0.03); text-align: justify; margin-top: 10px; }

        /* 5. 金句容器 (打洞 Note Card) */
        .report-quote-card { position: relative; background-color: #fffefb; border: 1px solid #e0ddd7; border-radius: 8px; padding: 30px 30px 30px 65px; margin-top: 40px; box-shadow: 4px 4px 0px rgba(0,0,0,0.05); text-align: left; background-image: linear-gradient(to right, transparent 49px, #eebdbd 50px, transparent 51px), radial-gradient(circle at 25px 50%, #d1cdc5 8px, transparent 9px); background-size: 100% 100%, 100% 40px; background-repeat: no-repeat, repeat-y; background-position: 0 0, 0 15px; }
        .report-quote-content { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; font-weight: bold; color: #5d4037; font-style: italic; line-height: 1.6; }
        .report-quote-author { margin-top: 10px; font-size: 0.9rem; color: #888; text-align: right; font-style: normal; }

        /* 6. 分隔線 */
        .report-separator { position: relative; height: 1px; border: 0; border-top: 3px dashed #b6a6ca; margin: 40px 0 50px 0; opacity: 0.6; }
        .report-separator::after { content: '▼'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fdfcf8; padding: 0 10px; color: #b6a6ca; font-size: 12px; }

        /* 7. 評分儀表板 (雷達圖、進度條) */
        .report-radar-wrapper { margin-bottom: 30px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .grading-container { margin-top: 0; border-top: none; }
        .grading-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grading-scores, .grading-radar { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; }
        .score-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .slider-container { display: flex; align-items: center; gap: 10px; width: 60%; }
        .progress-bar-container { width: 100%; height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: #007bff; border-radius: 5px; }
        .score-display { font-weight: bold; width: 30px; text-align: right; }
        .total-score-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; }
        .radar-chart-container { position: relative; height: 300px; width: 100%; }
        .radar-chart-history-img { width: 100%; height: auto; max-width: 100%; display: block; margin: 0 auto; }

        @media (max-width: 768px) {
            .grading-grid { display: flex !important; flex-direction: column !important; gap: 20px !important; width: 100% !important; margin: 0 !important; }
            .grading-scores, .grading-radar, .report-radar-wrapper { width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; padding: 15px !important; margin: 0 !important; overflow: hidden !important; }
            .radar-chart-container { width: 100% !important; height: auto !important; aspect-ratio: 1 / 1 !important; max-height: 350px !important; margin: 0 auto !important; }
            
            /* 手機版：整體概況拉寬，其他範疇縮小置中 */
            .badge-general { width: 100% !important; max-width: 100% !important; box-sizing: border-box !important; border-radius: 8px !important; }
            .report-category-badge:not(.badge-general) { width: -moz-fit-content !important; width: fit-content !important; max-width: 90% !important; display: flex !important; justify-content: center !important; margin-left: auto !important; margin-right: auto !important; border-radius: 50px !important; }
            
            .box { padding: 15px; } .nav-btn { width: 100%; } .filter-group { flex-direction: column; }
            .filter-group select, .filter-group input { width: 100%; } .transfer-grid { flex-direction: column; }
            .modal-content-container { flex-direction: column; } .submission-sidebar { width: 100%; height: 40%; }
        }


.copyright-footer {
    position: fixed;
    bottom: 0;
    right: 0;
    padding: 5px 10px;
    background-color: #f1f1f1;
}

.copyright-footer p {
    margin: 0;
    font-size: 14px;
}

@media (max-width: 600px) {
    .copyright-footer p {
        font-size: 12px;
    }
}



        
    </style>
</head>
<body>

    <!-- === 安全登入閘門 === -->
    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color: var(--m-blue); margin-bottom: 10px;">神思・教研平台</h2>
            <p style="color: #888; margin-bottom: 30px;">請使用學校教師帳號登入以存取資料</p>
            <button id="loginBtn" class="login-btn" onclick="teacherLogin()">
                <i class="fab fa-google"></i> Google 帳號登入
            </button>
            <p id="loginMsg" style="color: var(--m-red); margin-top: 15px; font-size: 0.9em;"></p>
        </div>
    </div>

    <!-- === 主要應用程式 === -->
    <div id="mainApp">
        <div class="title-container">
            <div style="float: right; font-size: 0.9rem;">
                <span id="teacherNameDisplay" style="color: var(--m-blue); margin-right: 10px;"></span>
                <button onclick="logout()" style="background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer; color: #666;">登出</button>
            </div>
            <h1>神思・教師後台</h1>
        </div>

        <!-- 導航列 -->
        <div class="nav-bar">
            <button class="nav-btn active" onclick="switchTab('students')"><i class="fas fa-user-graduate"></i> 學生管理</button>
            <button class="nav-btn" onclick="switchTab('assignments')"><i class="fas fa-edit"></i> 課業管理</button>
            <button class="nav-btn" onclick="switchTab('reports')"><i class="fas fa-chart-pie"></i> 學生報告</button>
            <button class="nav-btn" onclick="switchTab('management')"><i class="fas fa-calendar-alt"></i> 學年管理</button>
        </div>

        <!-- 1. 學生管理頁面 -->
        <div id="tab-students" class="box">
            <h2>學生紀錄檢閱</h2>
            <div class="filter-group">
                <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> 篩選：</label>
                <select id="viewGrade" onchange="loadStudentList()">
                    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                    <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
                </select>
                <select id="viewClass" onchange="loadStudentList()">
                    <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
                </select>
                <button class="btn-action btn-view" onclick="loadStudentList()"><i class="fas fa-sync-alt"></i> 刷新列表</button>
            </div>
            <div id="studentListContainer" class="student-grid">
                <p style="text-align:center; width:100%; color:#aaa; padding:30px;">請選擇年級和班別以載入學生列表</p>
            </div>
        </div>

        <!-- 2. 課業派發頁面 -->
        <div id="tab-assignments" class="box" style="display:none;">
            <h2>佈置課業</h2>
            <div class="filter-group">
                <label><i class="fas fa-users" style="color:var(--m-blue);"></i> 對象：</label>
                <select id="assignGrade" onchange="loadAssignmentHistory()">
                    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                    <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
                </select>
                <select id="assignClass" onchange="loadAssignmentHistory()">
                    <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
                </select>
            </div>
            <div class="publish-area">
                <div style="font-weight:bold; color:var(--m-green); margin-bottom:5px; font-size:1.1em;">
                    <i class="fas fa-pen-fancy"></i> 創建新任務
                </div>
                <div class="publish-inputs">
                    <input type="text" id="assignTopic" placeholder="課業題目">
                    <select id="assignType">
                        <option value="閱讀">閱讀</option>
                        <option value="敘事抒情">敘事抒情</option>
                        <option value="議論">議論</option>
                        <option value="整合拓展">整合拓展</option>
                    </select>
                </div>
                <button id="btnPublish" class="btn-action btn-publish" onclick="publishAssignment()">
                    <i class="fas fa-paper-plane"></i> 立即派發
                </button>
            </div>
            <h3>已派發課業列表</h3>
            <div id="assignmentHistoryList"></div>
        </div>

        <!-- 3. 學生報告頁面 (新增) -->
        <div id="tab-reports" class="box" style="display:none;">
            <h2>學生學習報告管理</h2>
            
            <!-- 篩選與操作區 -->
            <div class="filter-group">
                <label><i class="fas fa-filter" style="color:var(--m-blue);"></i> 篩選：</label>
                <select id="reportGrade" onchange="loadReportStudentList()">
                    <option value="1">中一</option><option value="2">中二</option><option value="3">中三</option>
                    <option value="4">中四</option><option value="5">中五</option><option value="6" selected>中六</option>
                </select>
                <select id="reportClass" onchange="loadReportStudentList()">
                    <option value="A">A 班</option><option value="B">B 班</option><option value="C">C 班</option><option value="D">D 班</option>
                </select>
                
                <!-- 生成全班綜合報告按鈕 -->
                <button id="btnClassReport" class="btn-action btn-manage" 
                        style="background: linear-gradient(135deg, #7da3c0 0%, #5e7067 100%); margin-left: auto; box-shadow: 0 4px 10px rgba(94, 112, 103, 0.4);" 
                        onclick="generateClassReport()">
                    <i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)
                </button>
            </div>
            
            <!-- === 新增：全班報告歷史紀錄區塊 === -->
            <!-- 預設隱藏 (display:none)，當 JS 偵測到有紀錄時才會顯示 -->
            <div id="classReportHistoryContainer" style="margin-bottom: 25px; padding: 20px; background: #fdfcf8; border-radius: 12px; border: 1px solid var(--border-color); border-left: 5px solid #7da3c0; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.02);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; border:none; padding:0; font-size:1.1em; color:var(--text-main); display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-history" style="color:#7da3c0;"></i> 過往全班綜合報告紀錄
                    </h3>
                    <small style="color:#999; font-style:italic;">點擊下方按鈕以重看報告</small>
                </div>
                
                <!-- 這裡的內容會由 JS (loadClassReportHistory) 動態填充 -->
                <div id="classReportList" style="display:flex; gap:12px; overflow-x:auto; padding:5px 0; align-items: center; scroll-behavior: smooth;">
                </div>
            </div>
            <!-- === 歷史紀錄區塊結束 === -->

            <!-- 個別學生列表 -->
            <div id="reportStudentListContainer" class="student-grid">
                <p style="text-align:center; width:100%; color:#aaa; padding:30px;">請選擇年級和班別以載入報告列表</p>
            </div>
        </div>

        <!-- 4. 學年管理頁面 -->
        <div id="tab-management" class="box" style="display:none;">
            <h2>學年過渡管理</h2>
            <div style="text-align:center; margin-bottom:30px;">
                <div style="font-size:1.2em; color:var(--m-brown); font-weight:bold; margin-bottom:10px;">當前學年設定</div>
                <div style="display:inline-flex; align-items:center; gap:10px; background:#fff; padding:10px 20px; border-radius:50px; border:1px solid #ccc;">
                    <input type="text" id="currentYearInput" value="2025-2026" style="border:none; text-align:center; font-weight:bold; font-size:1.1em; width:120px;">
                    <button class="btn-action btn-manage" style="padding:5px 15px; font-size:0.8em;" onclick="updateYearConfig()">儲存</button>
                </div>
            </div>
            <div class="management-section">
                <div class="section-title"><i class="fas fa-user-cog"></i> 個別學生調動 / 刪除</div>
                <div class="transfer-grid">
                    <div class="transfer-column">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span style="font-weight:bold; color:var(--m-red);">來源：</span>
                            <select id="indivFromGrade" onchange="populateTransferStudentList()"><option value="6">中六</option><option value="5">中五</option><option value="4">中四</option><option value="3">中三</option><option value="2">中二</option><option value="1">中一</option></select>
                            <select id="indivFromClass" onchange="populateTransferStudentList()"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                        </div>
                        <div id="transferStudentListBox" class="transfer-list-box">
                            <div style="padding:20px; text-align:center; color:#999;">請先選擇班級...</div>
                        </div>
                    </div>
                    <div class="transfer-arrow-icon" style="align-self:center; color:#ccc; font-size:1.5em;"><i class="fas fa-arrow-right"></i></div>
                    <div class="transfer-column" style="justify-content:center;">
                        <div style="background:#fff; border:1px solid #eee; padding:20px; border-radius:10px;">
                            <div style="font-weight:bold; color:var(--m-green); margin-bottom:10px;">目標設定：</div>
                            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                                <select id="indivToGrade" style="flex:1;"><option value="6">中六</option><option value="5">中五</option><option value="4">中四</option><option value="3">中三</option><option value="2">中二</option><option value="1">中一</option></select>
                                <select id="indivToClass" style="flex:1;"><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                            </div>
                            <div style="margin-bottom:20px;">
                                <label style="font-size:0.9em; color:#666;">分配新班號：</label>
                                <input type="number" id="indivNewNumber" placeholder="例如：25" style="width:100%; margin-top:5px; text-align:center; box-sizing:border-box;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:10px;">
                                <button class="btn-action btn-manage" style="justify-content:center;" onclick="moveIndividualStudent()"><i class="fas fa-exchange-alt"></i> 確認調動</button>
                                <button class="btn-action btn-delete" style="justify-content:center;" onclick="deleteStudent()"><i class="fas fa-trash-alt"></i> 刪除此學生</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="year-transition-card">
                <div style="font-size:1.3em; font-weight:bold; color:#555;">一鍵全校升班 (學年過渡)</div>
                <div class="year-arrow"><i class="fas fa-chevron-down"></i></div>
                <button class="btn-action btn-manage" style="padding:15px 40px; font-size:1.1em; width:100%;" onclick="runYearTransition()"><i class="fas fa-rocket"></i> 開始新學年過渡</button>
            </div>
        </div>
    </div>

    <!-- Modal: 學生歷史檢閱 (通用) -->
    <div id="historyViewerModal" class="modal-overlay">
        <div class="modal-body">
            <div class="modal-header">
                <h3 id="viewerTitle" style="margin:0; color:var(--m-blue);">學生歷程</h3>
                <button onclick="document.getElementById('historyViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div class="modal-content-scroll">
                <!-- 麵包屑導航 -->
                <div id="teacherBreadcrumb" class="history-breadcrumb" style="display: none;">
                    <span class="breadcrumb-item" onclick="renderLevel1()"><i class="fas fa-home"></i> 主範疇</span> 
                    <span class="breadcrumb-sep"> &gt; </span>
                    <span class="breadcrumb-item" id="breadCategory" onclick="renderLevel2(currentCategory)"></span>
                    <span class="breadcrumb-sep" id="breadSep2"> &gt; </span>
                    <span class="breadcrumb-current" id="breadSub"></span>
                </div>

                <!-- Level 1: 主範疇卡片 -->
                <div id="historyLevel1" class="category-cards-container"></div>

                <!-- Level 2: 子功能按鈕 -->
                <div id="historyLevel2" class="history-grid-menu" style="display: none;"></div>

                <!-- Level 3: 紀錄列表 -->
                <div id="historyLevel3" class="history-list-container" style="display: none;"></div>

                <!-- Detail: 詳細內容 -->
                <div id="historyDetail" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal: 課業繳交檢閱 -->
    <div id="submissionViewerModal" class="modal-overlay">
        <div class="modal-body">
            <div class="modal-header">
                <h3 id="submissionTitle" style="margin:0; color:var(--m-green);"></h3>
                <div style="font-size:0.9em; color:#888;">已繳交: <span id="submitCount" style="color:var(--m-green); font-weight:bold;">0</span> / 未繳交: <span id="pendingCount" style="color:var(--m-red); font-weight:bold;">0</span></div>
                <button onclick="document.getElementById('submissionViewerModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div class="modal-content-container">
                <div class="submission-sidebar">
                    <ul id="submissionList" style="list-style:none; padding:0; margin:0;"></ul>
                </div>
                <div id="submissionDetailArea" class="submission-detail-area">
                    <div style="text-align:center; color:#ccc; margin-top:100px;"><i class="far fa-file-alt" style="font-size:48px;"></i><p>請選擇學生</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: 全班綜合報告顯示視窗 (新增) -->
    <div id="classReportModal" class="modal-overlay">
        <div class="modal-body" style="max-width: 900px;">
            <div class="modal-header">
                <h3 style="margin:0; color:var(--m-blue);"><i class="fas fa-chart-pie"></i> 全班綜合學習報告</h3>
                <button onclick="document.getElementById('classReportModal').style.display='none'" style="font-size:28px; border:none; background:none; cursor:pointer; color:#999;">&times;</button>
            </div>
            <div id="classReportContent" class="modal-content-scroll" style="background:#f9f9f9; padding: 0;">
                <!-- AI 生成內容將注入此處 -->
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
            authDomain: "sansidata.firebaseapp.com",
            projectId: "sansidata",
            storageBucket: "sansidata.firebasestorage.app",
            messagingSenderId: "580288358575",
            appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
            databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // API Key (用於生成全班報告，請替換為您自己的有效 Key)
        const READING_API_KEYS = [
            "pk_D77NeM4n6GnNCYbo", "pk_c17y17tQ3BY71cpd", "pk_Ax3rRTHkrdTQVIGD", "pk_dGVqEggn4T4dwQI3", "pk_YIFWnDFts0quviE0"
        ];
        const READING_API_URL = "https://gen.pollinations.ai/v1/chat/completions";
        const READING_MODEL = "deepseek";

        // 輔助函式：DSE等級計算
        function determineGrade(score) {
            if (score >= 72) return "5**";
            if (score >= 69) return "5*";
            if (score >= 64) return "5";
            if (score >= 57) return "4";
            if (score >= 50) return "3";
            if (score >= 45) return "2";
            return "1";
        }

        // === 登入與基礎邏輯 ===
        function teacherLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            document.getElementById('loginMsg').innerText = "驗證中...";
            auth.signInWithPopup(provider).then((result) => {
                const user = result.user;
                if (user.email.endsWith('@ccckyc.edu.hk')) { showApp(user); }
                else { auth.signOut(); document.getElementById('loginMsg').innerText = "非授權帳號"; }
            }).catch((error) => { document.getElementById('loginMsg').innerText = "登入失敗：" + error.message; });
        }
        function logout() { auth.signOut().then(() => location.reload()); }
        function showApp(user) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('teacherNameDisplay').innerText = user.displayName || user.email;
            db.ref('config/currentYear').once('value', s => { if(s.exists()) document.getElementById('currentYearInput').value = s.val(); });
        }
        auth.onAuthStateChanged(user => { if (user && user.email.endsWith('@ccckyc.edu.hk')) showApp(user); });

        // === Tab 切換邏輯 ===
        function switchTab(tabId) {
            document.querySelectorAll('.box').forEach(b => b.style.display = 'none');
            document.getElementById('tab-' + tabId).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tabId === 'students') loadStudentList();
            if(tabId === 'assignments') loadAssignmentHistory();
            if(tabId === 'reports') loadReportStudentList();
        }

        // === 歷史檢閱邏輯 (共用) ===
        let currentStudentHistory = [], currentCategory = '', currentSubFunction = '', currentThemeIndex = 1; 
        const HISTORY_STRUCTURE = { 
            "閱讀": ["點評", "指引"], "敘事抒情": ["文章點評", "大綱點評", "解題指引", "敘事物象"], 
            "議論": ["文章點評", "大綱點評", "指引"], "整合拓展": ["點評", "指引"],
            "課外書籍": ["討論紀錄"], "學習報告": ["綜合分析"] 
        };
        const CATEGORY_ASSETS = { 
            "閱讀": { img: '郵筒.png', en: 'READING' }, "敘事抒情": { img: '相機.png', en: 'NARRATIVE' }, 
            "議論": { img: '筆.png', en: 'ARGUMENT' }, "整合拓展": { img: '火車.png', en: 'EXPAND' }, 
            "課外書籍": { img: '書.png', en: 'LIBRARY' }, "學習報告": { img: '書.png', en: 'REPORT' }
        };
        const SUB_ICONS = { "文章點評": "fa-file-alt", "大綱點評": "fa-list-ol", "綜合分析": "fa-chart-pie", "敘事物象": "fa-tree", "解題指引": "fa-compass", "指引": "fa-lightbulb", "點評": "fa-comment-dots", "討論紀錄": "fa-comments" };

        function loadStudentList() {
            const g = document.getElementById('viewGrade').value;
            const c = document.getElementById('viewClass').value;
            const container = document.getElementById('studentListContainer');
            container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> 載入中...</p>';
            db.ref(`students/${g}/${c}`).once('value', snapshot => {
                const data = snapshot.val();
                if (!data) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">暫無資料。</p>'; return; }
                container.innerHTML = '';
                Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99))
                .forEach(([name, d]) => {
                    const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                    const div = document.createElement('div'); div.className = 'student-card';
                    div.innerHTML = `<div class="student-name">${name} <small>(${d.profile?.number||''})</small></div><div class="last-sync"><i class="fas fa-history"></i> 紀錄: ${h.length} 筆</div>`;
                    div.onclick = () => openHistoryModal(name, h);
                    container.appendChild(div);
                });
            });
        }

        // === 新增：載入學生報告列表與歷史紀錄 ===
        function loadReportStudentList() {
            const g = document.getElementById('reportGrade').value;
            const c = document.getElementById('reportClass').value;
            const container = document.getElementById('reportStudentListContainer');
            container.innerHTML = '<p style="text-align:center; padding:20px; width:100%; color:#888;"><i class="fas fa-spinner fa-spin"></i> 載入中...</p>';
            
            // 同時載入歷史報告列表
            loadClassReportHistory();

            db.ref(`students/${g}/${c}`).once('value', snapshot => {
                const data = snapshot.val();
                if (!data) { container.innerHTML = '<p style="text-align:center; width:100%; color:#aaa;">暫無資料。</p>'; return; }
                container.innerHTML = '';
                
                Object.entries(data).sort(([,a], [,b]) => (parseInt(a.profile?.number)||99) - (parseInt(b.profile?.number)||99))
                .forEach(([name, d]) => {
                    const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
                    const reports = h.filter(r => r.category === "學習報告");
                    
                    const div = document.createElement('div'); 
                    div.className = 'student-card';
                    const style = reports.length > 0 ? '' : 'opacity: 0.6; filter: grayscale(100%);';
                    const iconColor = reports.length > 0 ? 'var(--m-red)' : '#ccc';
                    
                    div.style.cssText = style;
                    div.innerHTML = `
                        <div class="student-name">${name} <small>(${d.profile?.number||''})</small></div>
                        <div class="last-sync" style="color:${iconColor}; font-weight:bold;">
                            <i class="fas fa-chart-pie"></i> 已生成報告: ${reports.length} 份
                        </div>`;
                    
                    if (reports.length > 0) {
                        div.onclick = () => {
                            openHistoryModal(name, h);
                            setTimeout(() => {
                                renderLevel2('學習報告');
                                setTimeout(() => renderLevel3('綜合分析', 5), 100);
                            }, 300);
                        };
                    }
                    container.appendChild(div);
                });
            });
        }

        // === 新增：生成全班綜合報告邏輯 ===
// === 最終全功能版 V3：生成全班綜合報告 (含大綱 + 閱讀 + 寫作 + 整合拓展) ===
async function generateClassReport() {
    const btn = document.getElementById('btnClassReport');
    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析全班數據中...';

    try {
        // 1. 抓取全班資料
        const snapshot = await db.ref(`students/${g}/${c}`).once('value');
        const data = snapshot.val();
        
        if (!data) { alert("此班級無學生資料！"); btn.disabled=false; btn.innerHTML = '<i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)'; return; }

        // 2. 聚合數據
        let classSummary = "";      // 成品文章摘要 (過往報告)
        let outlineSummary = "";    // 大綱點評摘要
        let readingSummary = "";    // 閱讀點評摘要
        let expandSummary = "";     // ★ 新增：整合拓展摘要
        let studentCount = 0;
        
        // 分數統計 (寫作)
        let narrativeTotal = { content:0, expr:0, struct:0, count:0 };
        let argumentTotal = { content:0, expr:0, struct:0, count:0 };

        // 遍歷每位學生
        Object.entries(data).forEach(([name, d]) => {
            const h = d.history ? (Array.isArray(d.history) ? d.history : Object.values(d.history)) : [];
            
            // A. 收集過往「學習報告」摘要 (寫作成品表現)
            const reports = h.filter(r => r.category === "學習報告").sort((a,b) => b.timestamp - a.timestamp);
            if (reports.length > 0) {
                studentCount++;
                const latestReport = reports[0].aiContent.replace(/<[^>]*>?/gm, ' ').substring(0, 300);
                classSummary += `學生 ${studentCount}: ${latestReport}...\n`;
            }

            // B. 遍歷所有紀錄 (分數 + 各範疇點評)
            h.forEach(r => {
                // --- 1. 處理寫作分數 ---
                const scoreMatch = r.aiContent.match(/總分:\s*(\d+)/);
                if (scoreMatch) {
                    const score = parseInt(scoreMatch[1]);
                    if (r.category === "敘事抒情") {
                        narrativeTotal.content += score * 0.4;
                        narrativeTotal.expr += score * 0.3;
                        narrativeTotal.struct += score * 0.2;
                        narrativeTotal.count++;
                    } else if (r.category === "議論") {
                        argumentTotal.content += score * 0.4;
                        argumentTotal.expr += score * 0.3;
                        argumentTotal.struct += score * 0.2;
                        argumentTotal.count++;
                    }
                }

                // --- 2. 處理大綱點評 ---
                if (r.subFunction && r.subFunction.includes("大綱")) {
                    let rawText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                    let extract = "";
                    const commentIdx = rawText.indexOf("點評");
                    if (commentIdx !== -1) {
                        extract = rawText.substring(commentIdx, commentIdx + 120);
                        outlineSummary += `[${r.category}大綱表現]: ${extract}...\n`;
                    }
                }

                // --- 3. 處理閱讀理解 ---
                if (r.category === "閱讀" && r.subFunction === "點評") {
                    let rawText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                    let extract = "";
                    const commentIdx = rawText.indexOf("點評");
                    if (commentIdx !== -1) {
                        extract = rawText.substring(commentIdx, commentIdx + 150); 
                        readingSummary += `[閱讀答題表現]: ${extract}...\n`;
                    }
                }

                // --- 4. ★ 新增：處理整合拓展 ---
                if (r.category === "整合拓展" && r.subFunction === "點評") {
                    let rawText = r.aiContent.replace(/<[^>]*>?/gm, ' ');
                    let extract = "";
                    // 整合拓展通常包含「點評」和「建議」
                    const commentIdx = rawText.indexOf("點評");
                    if (commentIdx !== -1) {
                        extract = rawText.substring(commentIdx, commentIdx + 150);
                        expandSummary += `[整合拓展表現]: ${extract}...\n`;
                    }
                }
            });
        });

        // 檢查是否有足夠數據
        if (studentCount === 0 && narrativeTotal.count === 0 && argumentTotal.count === 0 && 
            outlineSummary === "" && readingSummary === "" && expandSummary === "") {
            alert("此班級數據不足，無法生成報告。");
            btn.disabled=false; 
            btn.innerHTML = '<i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)';
            return;
        }

        // 計算平均分 (寫作)
        const narrAvg = {
            content: narrativeTotal.count ? Math.round((narrativeTotal.content / narrativeTotal.count) / 4) : 0, 
            expr: narrativeTotal.count ? Math.round((narrativeTotal.expr / narrativeTotal.count) / 3) : 0,    
            struct: narrativeTotal.count ? Math.round((narrativeTotal.struct / narrativeTotal.count) / 2) : 0 
        };
        const argAvg = {
            content: argumentTotal.count ? Math.round((argumentTotal.content / argumentTotal.count) / 4) : 0,
            expr: argumentTotal.count ? Math.round((argumentTotal.expr / argumentTotal.count) / 3) : 0,
            struct: argumentTotal.count ? Math.round((argumentTotal.struct / argumentTotal.count) / 2) : 0
        };

        // 3. 呼叫 AI 生成 (保留完整的指令與格式要求)
        const prompt = `你是一位資深的中文科科主任。以下是 ${g}年級${c}班 的學習數據摘要。
        
        ### 班級數據概覽 (寫作評分)：
        - 敘事抒情文 (平均分 0-10)：內容${narrAvg.content}, 表達${narrAvg.expr}, 結構${narrAvg.struct}
        - 議論文 (平均分 0-10)：內容${argAvg.content}, 表達${argAvg.expr}, 結構${argAvg.struct}

        ### 學生寫作表現 (大綱構思 + 成品)：
        ${outlineSummary || "（暫無大綱紀錄）"}
        ${classSummary}

        ### 學生閱讀理解表現 (來自閱讀練習紀錄)：
        ${readingSummary || "（暫無閱讀練習紀錄）"}

        ### 學生整合拓展表現 (來自練習紀錄)：
        ${expandSummary || "（暫無整合拓展紀錄）"}

        ### 你的任務：
        請生成一份「全班綜合學習評估報告」。
        **關鍵要求：**
        1. 整合「讀」、「寫」、「聽/說(整合拓展)」的全方位表現。
        2. 將「大綱構思」融合到寫作分析中，分析學生在構思與實作間的落差。
        3. 必須為每個範疇（閱讀、敘事、議論、整合拓展）提供獨立的分析區塊。

        ### 核心指令 (Privacy Protocols)：
        1. **宏觀視角**：報告必須完全聚焦於「班級整體表現」或「大部分學生」。
        2. **嚴禁個別提及**：絕對**不可以**在報告中提及任何特定學生編號或具體個案。
        3. **趨勢分析**：請將個別樣本中的具體問題（如離題、論據不足、拓展方向錯誤）轉化為全班性的強弱項分析。

        ### 輸出格式要求 (嚴格遵守 HTML，樣式需與學生報告一致)：
        請直接輸出 HTML 代碼，不要使用 Markdown。

        1. **班級整體概況**：
           <div class="report-section">
               <div class="report-category-badge badge-general">
                   <div class="badge-general-title"><i class="fas fa-users"></i> ${g}${c}班 綜合評估</div>
               </div>
               <div class="report-text-card">
                   <p>(約150字，總結班級在「讀」、「寫」、「整合」三方面的整體強弱項，並給予一個總體的學習氛圍評價。)</p>
               </div>
           </div>
           <div class="report-separator"></div>

        2. **範疇深入分析**：
           <div class="report-section">
               <div class="report-category-badge badge-reading"><i class="fas fa-book-open"></i> 閱讀</div>
               <div class="report-text-card">
                   <p>(分析班級在閱讀理解上的普遍問題，例如理解題意、推論能力或文本依據運用等。)</p>
               </div>
           </div>
           
           <div class="report-section">
               <div class="report-category-badge badge-narrative"><i class="fas fa-pen-nib"></i> 敘事抒情</div>
               <div class="report-text-card">
                   <p>(分析敘事文的通病與亮點，請融合對大綱構思的觀察，例如立意是否深刻、詳略是否得當。)</p>
               </div>
           </div>
           
           <div class="report-section">
               <div class="report-category-badge badge-argument"><i class="fas fa-gavel"></i> 議論</div>
               <div class="report-text-card">
                   <p>(分析議論文的通病與亮點，請融合對大綱構思的觀察，例如論點是否清晰、論證是否嚴謹。)</p>
               </div>
           </div>

           <div class="report-section">
               <div class="report-category-badge badge-expand"><i class="fas fa-layer-group"></i> 整合拓展</div>
               <div class="report-text-card">
                   <p>(分析班級在整合拓展練習上的表現，例如是否能準確回應主題句、拓展方向是否合理、資料運用是否恰當。)</p>
               </div>
           </div>

        3. **教學建議**：
           <div class="report-quote-card">
               <div class="report-quote-content">「(給任教老師的整體教學策略建議，涵蓋讀寫結合及思維訓練的方向)」</div>
               <div class="report-quote-author">—— AI 科主任</div>
           </div>`;

        const response = await callAPI(prompt);

        // --- 4. 儲存與顯示 ---
        const reportData = {
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            dateStr: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString(),
            stats: {
                narrAvg: narrAvg,
                argAvg: argAvg,
                narrativeTotal: Math.round((narrativeTotal.content+narrativeTotal.expr+narrativeTotal.struct)/narrativeTotal.count) || 0,
                argumentTotal: Math.round((argumentTotal.content+argumentTotal.expr+argumentTotal.struct)/argumentTotal.count) || 0
            },
            aiHtml: response
        };

        await db.ref(`class_reports/${g}/${c}`).push(reportData);
        loadClassReportHistory();
        openClassReportModal(reportData);

    } catch (e) {
        console.error(e);
        alert("生成失敗，請稍後再試。");
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-chart-line"></i> 生成全班綜合報告 (AI)';
    }
}
        // === 新增：載入與顯示歷史全班報告 ===
       function loadClassReportHistory() {
    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;
    const container = document.getElementById('classReportHistoryContainer');
    const list = document.getElementById('classReportList');

    db.ref(`class_reports/${g}/${c}`).once('value', snapshot => {
        const data = snapshot.val();
        if (!data) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        list.innerHTML = '';

        // 將資料轉為陣列並按時間倒序排列
        Object.entries(data)
            .sort(([,a], [,b]) => b.timestamp - a.timestamp)
            .forEach(([key, report]) => {
                
                // 建立一個外層容器 (膠囊狀)
                const wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    display: inline-flex; 
                    align-items: center; 
                    background: #fff; 
                    border: 1px solid #ccc; 
                    border-radius: 50px; 
                    padding: 5px 5px 5px 15px; 
                    flex-shrink: 0; 
                    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                    transition: transform 0.2s;
                `;

                // 1. 檢閱按鈕 (文字部分)
                const viewSpan = document.createElement('span');
                viewSpan.style.cssText = "cursor: pointer; color: #555; font-size: 0.95em; font-weight: bold; margin-right: 10px;";
                viewSpan.innerHTML = `<i class="far fa-file-alt"></i> ${report.dateStr || '未知日期'}`;
                viewSpan.onclick = () => openClassReportModal(report);

                // 2. 刪除按鈕 (紅色圓形圖示，無文字)
                const delBtn = document.createElement('button');
                delBtn.className = 'btn-action';
                delBtn.title = "刪除此報告"; // 滑鼠懸停提示
                delBtn.style.cssText = `
                    background: #fbecec; 
                    color: #d69a92; 
                    border: none; 
                    border-radius: 50%; 
                    width: 32px; 
                    height: 32px; 
                    padding: 0;
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    font-size: 14px;
                    box-shadow: none;
                `;
                
                delBtn.innerHTML = `<i class="fas fa-trash-alt"></i>`;
                
                // 按鈕互動效果
                delBtn.onmouseover = function() { this.style.background = '#d69a92'; this.style.color = 'white'; };
                delBtn.onmouseout = function() { this.style.background = '#fbecec'; this.style.color = '#d69a92'; };
                
                delBtn.onclick = (e) => {
                    e.stopPropagation(); // 防止觸發檢閱
                    deleteClassReport(key);
                };

                // 組合元素
                wrapper.appendChild(viewSpan);
                wrapper.appendChild(delBtn);
                list.appendChild(wrapper);
            });
    });
}

        // === 新增：刪除全班報告邏輯 ===
function deleteClassReport(reportKey) {
    // 二次確認 (雖然不顯示文字按鈕，但 Alert 還是要有文字提示比較安全)
    if (!confirm("確定要刪除這份全班報告嗎？\n(此動作無法復原)")) return;

    const g = document.getElementById('reportGrade').value;
    const c = document.getElementById('reportClass').value;

    // 執行 Firebase 刪除
    db.ref(`class_reports/${g}/${c}/${reportKey}`).remove()
        .then(() => {
            // 刪除成功後，重新載入列表
            loadClassReportHistory();
        })
        .catch(err => {
            console.error(err);
            alert("刪除失敗：" + err.message);
        });
}

        function openClassReportModal(reportData) {
            const modal = document.getElementById('classReportModal');
            const content = document.getElementById('classReportContent');
            
            // 構建 HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = reportData.aiHtml;

            // 處理敘事圖表 (取代 AI 的標籤)
            const narrBadge = tempDiv.querySelector('.badge-narrative');
            if (narrBadge && reportData.stats.narrativeTotal > 0) {
                const chartHTML = generateClassChartHTML('narrative', reportData.stats.narrAvg, reportData.stats.narrativeTotal);
                narrBadge.outerHTML = chartHTML; 
            }

            // 處理議論圖表 (取代 AI 的標籤)
            const argBadge = tempDiv.querySelector('.badge-argument');
            if (argBadge && reportData.stats.argumentTotal > 0) {
                const chartHTML = generateClassChartHTML('argument', reportData.stats.argAvg, reportData.stats.argumentTotal);
                argBadge.outerHTML = chartHTML;
            }

            // 填入內容
            content.innerHTML = `
                <div style="text-align:right; color:#999; padding:20px 20px 0 0;">
                    報告日期：${reportData.dateStr}
                </div>
                <div style="padding:20px;">
                    ${tempDiv.innerHTML}
                </div>`;
            
            modal.style.display = 'flex';

            // 延遲渲染 Canvas 圖表
            setTimeout(() => {
                if(reportData.stats.narrativeTotal > 0) renderClassChart('narrativeClassChart', reportData.stats.narrAvg);
                if(reportData.stats.argumentTotal > 0) renderClassChart('argumentClassChart', reportData.stats.argAvg);
            }, 200);
        }

        // 生成圖表 HTML 結構 (與學生端一致)
        function generateClassChartHTML(type, avg, total) {
            const uniqueId = type === 'narrative' ? 'narrativeClassChart' : 'argumentClassChart';
            const title = type === 'narrative' ? '敘事抒情' : '議論';
            const badgeClass = type === 'narrative' ? 'badge-narrative' : 'badge-argument';
            const level = determineGrade(total);

            return `
            <div class="report-section">
                <div class="report-category-badge ${badgeClass}"><i class="fas fa-book"></i> ${title}</div>
                <div class="report-radar-wrapper">
                    <div class="grading-container" style="margin:0; border:none; padding:0;">
                        <div class="grading-grid">
                            <div class="grading-scores" style="padding:15px;">
                                <h3>班級平均表現</h3>
                                <div class="score-item"><label>內容</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.content * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.content * 4}</span></div></div>
                                <div class="score-item"><label>表達</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.expr * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.expr * 3}</span></div></div>
                                <div class="score-item"><label>結構</label><div class="slider-container"><div class="progress-bar-container"><div style="width:${avg.struct * 10}%" class="progress-bar-fill"></div></div><span class="score-display">${avg.struct * 2}</span></div></div>
                                <div class="total-score-container">
                                    <span style="font-size:1.1em; color:#555;">平均總分: ${total} / 100</span>
                                    <span style="font-size:2em; font-weight:bold; color:#d9534f; margin-left:auto;">${level}</span>
                                </div>
                            </div>
                            <div class="grading-radar" style="padding:15px;">
                                <h3>能力分佈</h3>
                                <div class="radar-chart-container" style="height:250px;">
                                    <canvas id="${uniqueId}"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // 渲染圖表 JS
        function renderClassChart(canvasId, avg) {
            const ctxEl = document.getElementById(canvasId);
            if (!ctxEl) return;
            
            // 估算細項
            const radarData = [
                (avg.content * 0.6 + avg.struct * 0.4).toFixed(1), // 立意
                (avg.content * 0.8 + avg.expr * 0.2).toFixed(1),   // 取材
                (avg.content * 0.7 + avg.struct * 0.3).toFixed(1), // 扣題
                (avg.struct * 0.7 + avg.content * 0.3).toFixed(1), // 詳略
                avg.expr, // 詞彙
                avg.expr  // 文學性
            ];

            new Chart(ctxEl.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['立意', '取材', '扣題', '詳略', '詞彙', '文學性'],
                    datasets: [{
                        label: '班級平均',
                        data: radarData,
                        backgroundColor: 'rgba(94, 112, 103, 0.4)', // 莫蘭迪深綠半透明
                        borderColor: '#5e7067',
                        borderWidth: 2,
                        pointBackgroundColor: '#5e7067',
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0, suggestedMax: 10,
                            pointLabels: { font: { size: 12, family: "'Noto Serif TC', serif" } },
                            ticks: { stepSize: 2, display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function callAPI(prompt) {
            let currentKeyIndex = Math.floor(Math.random() * READING_API_KEYS.length);
            try {
                const response = await fetch(READING_API_URL, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${READING_API_KEYS[currentKeyIndex]}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: READING_MODEL, messages: [{ role: "user", content: prompt }], max_tokens: 4000 })
                });
                const data = await response.json();
                let content = data.choices[0].message.content.trim();
                return content.replace(/<think\s*>.*?<\/think\s*>|<think\s*\/>/gis, '').trim();
            } catch (e) { throw new Error("API Error"); }
        }

        // === 歷史檢閱共用邏輯 ===
        function openHistoryModal(name, h) {
            document.getElementById('viewerTitle').innerHTML = `<i class="fas fa-user-graduate"></i> ${name}`;
            currentStudentHistory = h;
            document.getElementById('historyViewerModal').style.display = 'flex';
            renderLevel1();
        }
        function renderLevel1() {
            ['historyLevel2','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyLevel1').style.display='flex';
            document.getElementById('teacherBreadcrumb').style.display='none';
            const c = document.getElementById('historyLevel1'); c.innerHTML='';
            Object.keys(HISTORY_STRUCTURE).forEach(cat => {
                const count = currentStudentHistory.filter(r => r.category === cat).length;
                const asset = CATEGORY_ASSETS[cat] || { img: '背景.png', en: 'RECORD' };
                const style = count===0 ? 'filter: grayscale(100%); opacity: 0.6;' : '';
                c.innerHTML += `<div class="anime-card" style="--bg-img: url('${asset.img}'); ${style}" onclick="renderLevel2('${cat}')"><div class="card-overlay"></div><div class="card-content"><span class="card-zh">${cat}</span><span class="card-en">${count} 筆</span></div></div>`;
            });
        }
        function renderLevel2(cat) {
            currentCategory=cat; 
            ['historyLevel1','historyLevel3','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyLevel2').style.display='grid';
            updateBreadcrumb(cat);
            const c = document.getElementById('historyLevel2'); c.innerHTML='';
            const subs = HISTORY_STRUCTURE[cat] || [];
            subs.forEach((sub,i)=>{
                const count=currentStudentHistory.filter(r=>r.category===cat&&r.subFunction===sub).length;
                const theme=(i%5)+1;
                c.innerHTML+=`<div class="history-folder-btn history-theme-${theme}" style="${count===0?'opacity:0.6':''}" onclick="renderLevel3('${sub}',${theme})"><i class="fas ${SUB_ICONS[sub]||'fa-file'}"></i><span style="font-weight:bold;font-size:1.1em;">${sub}</span><span style="font-size:0.8em;margin-top:5px;color:#999;">(${count})</span></div>`;
            });
        }
        function renderLevel3(sub, theme) {
            currentSubFunction=sub; currentThemeIndex=theme;
            ['historyLevel1','historyLevel2','historyDetail'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyLevel3').style.display='grid';
            updateBreadcrumb(currentCategory,sub);
            const c=document.getElementById('historyLevel3'); c.innerHTML='';
            const recs=currentStudentHistory.filter(r=>r.category===currentCategory&&r.subFunction===sub).sort((a,b)=>b.timestamp-a.timestamp);
            if(recs.length===0){c.innerHTML='<p style="text-align:center;width:100%;color:#999;grid-column:1/-1;">無紀錄</p>';return;}
            recs.forEach(r=>{
                c.innerHTML+=`<div class="history-card theme-${theme}" onclick='renderDetail(${JSON.stringify(r).replace(/'/g, "&#39;")})'><div class="history-meta"><span>${r.dateStr?r.dateStr.split(' ')[0]:'未知'}</span><span>${r.subFunction}</span></div><h4 class="history-title">${r.title||'無標題'}</h4></div>`;
            });
        }
        function renderDetail(r) {
            ['historyLevel1','historyLevel2','historyLevel3'].forEach(id=>document.getElementById(id).style.display='none');
            document.getElementById('historyDetail').style.display='block';
            document.getElementById('teacherBreadcrumb').style.display='none';
            
            let uContent = '';
            // 若不是學習報告，才顯示使用者輸入
            if (r.category !== "學習報告" && r.userContent) {
                uContent = `<div style="background:#fff;padding:20px;border:1px solid #eee;border-radius:12px;margin-bottom:20px;">${r.userContent.replace(/\n/g, '<br>')}</div>`;
            }
            document.getElementById('historyDetail').innerHTML = `
                <div style="margin-bottom:15px;"><button class="nav-btn" onclick="renderLevel3('${currentSubFunction}',${currentThemeIndex})" style="padding:5px 15px;font-size:0.9em;"><i class="fas fa-arrow-left"></i> 返回</button></div>
                <div class="detail-view">
                    <div style="border-bottom:1px solid #eee;padding-bottom:15px;margin-bottom:20px;"><h2 style="margin:0;color:#333;">${r.title}</h2><p style="color:#888;margin-top:5px;">${r.dateStr}</p></div>
                    ${uContent}
                    <div class="detail-ai-box" style="margin-top:20px;">${r.aiContent}</div>
                </div>`;
        }
        function updateBreadcrumb(c,s) { 
            const b=document.getElementById('teacherBreadcrumb'); b.style.display='flex';
            document.getElementById('breadCategory').innerText=c;
            document.getElementById('breadSub').innerText=s||'';
            document.getElementById('breadSep2').style.display=s?'inline':'none';
        }


        // === 3. 學年管理 ===
        function populateTransferStudentList() {
            const g=document.getElementById('indivFromGrade').value, c=document.getElementById('indivFromClass').value;
            const b=document.getElementById('transferStudentListBox'); b.innerHTML='載入中...';
            db.ref(`students/${g}/${c}`).once('value', s=>{
                const d=s.val(); b.innerHTML='';
                if(!d) { b.innerHTML='無學生'; return; }
                Object.entries(d).sort((a,b)=>(parseInt(a[1].profile?.number)||99)-(parseInt(b[1].profile?.number)||99)).forEach(([n,i])=>{
                    b.innerHTML+=`<label class="student-select-item"><input type="radio" name="ts" value="${n}"> ${i.profile?.number||'??'}. ${n}</label>`;
                });
            });
        }
        function moveIndividualStudent() {
            const n = document.querySelector('input[name="ts"]:checked')?.value;
            if (!n) return alert("請選擇學生");
            const fg = document.getElementById('indivFromGrade').value;
            const fc = document.getElementById('indivFromClass').value;
            const tg = document.getElementById('indivToGrade').value;
            const tc = document.getElementById('indivToClass').value;
            const nn = document.getElementById('indivNewNumber').value;
            if (!nn) return alert("請輸入新班號");
            const oldPath = `students/${fg}/${fc}/${n}`;
            const newPath = `students/${tg}/${tc}/${n}`;
            db.ref(oldPath).once('value', s => {
                const d = s.val();
                if (!d) return;
                d.profile = d.profile || {}; d.profile.grade = tg; d.profile.class = tc; d.profile.number = nn;
                if (oldPath === newPath) {
                    db.ref(newPath).update(d, e => { if (!e) { alert("班號已更新"); populateTransferStudentList(); } else alert("更新失敗：" + e.message); });
                } else {
                    db.ref(newPath).set(d, e => { if (!e) { db.ref(oldPath).remove(); alert("學生已成功轉班"); populateTransferStudentList(); } else alert("移轉失敗：" + e.message); });
                }
            });
        }
        function deleteStudent() {
            const n=document.querySelector('input[name="ts"]:checked')?.value;
            if(n && confirm(`刪除 ${n}?`)) db.ref(`students/${document.getElementById('indivFromGrade').value}/${document.getElementById('indivFromClass').value}/${n}`).remove(e=>{ if(!e) populateTransferStudentList(); });
        }
        function updateYearConfig() { db.ref('config/currentYear').set(document.getElementById('currentYearInput').value, e=>alert(e?'失敗':'成功')); }
        
        async function runYearTransition() {
            if(prompt("密碼")!=="23262036") return;
            if(!confirm("確定全校升班？")) return;
            const all = (await db.ref('students').once('value')).val();
            if(!all) return;
            const y = document.getElementById('currentYearInput').value;
            await db.ref(`archives/${y}/students`).set(all);
            let n = {};
            for(let g=1; g<=5; g++) {
                if(all[g]) {
                    n[g+1] = all[g];
                    for(let c in n[g+1]) for(let s in n[g+1][c]) if(n[g+1][c][s].profile) n[g+1][c][s].profile.grade=(g+1).toString();
                }
            }
            if(all[6]) await db.ref(`graduates/${y}`).set(all[6]);
            db.ref('students').set(n, e=>alert(e?'失敗':'成功'));
        }
    </script>

<footer class="copyright-footer">
<p>Copyright © 2025 陳冠健. All rights reserved.</p>
</footer>

    
</body>
</html>
